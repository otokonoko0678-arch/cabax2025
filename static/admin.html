<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cabax Admin Pro - Complete Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&display=swap');
        
        * { 
            font-family: 'Noto Serif JP', serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(214, 179, 106, 0.4);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(214, 179, 106, 0.6);
        }
        
        :root {
            --cabax-navy: #0b1628;
            --cabax-navy-light: #122040;
            --cabax-navy-dark: #070d18;
            --cabax-gold: #d6b36a;
            --cabax-gold-light: #e8d4a8;
            --cabax-text: #f0f4f8;
            --cabax-text-muted: #8896a8;
        }
        
        body { 
            background: linear-gradient(135deg, var(--cabax-navy-dark) 0%, var(--cabax-navy) 100%);
            color: var(--cabax-text);
            overflow-x: hidden;
        }
        
        .glass-effect {
            background: rgba(11, 22, 40, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(214, 179, 106, 0.15);
        }
        
        .gold-accent {
            background: linear-gradient(135deg, var(--cabax-gold) 0%, var(--cabax-gold-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .luxury-card {
            background: rgba(18, 32, 64, 0.6);
            border: 1px solid rgba(214, 179, 106, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .luxury-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.12);
            transform: translateY(-2px);
        }
        
        .luxury-btn {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .luxury-btn:active {
            transform: scale(0.98);
        }
        
        .luxury-btn:hover {
            box-shadow: 0 8px 24px rgba(214, 179, 106, 0.35);
            transform: translateY(-1px);
        }
        
        .sidebar-luxury {
            background: linear-gradient(180deg, rgba(7, 13, 24, 0.98) 0%, rgba(11, 22, 40, 0.98) 100%);
            border-right: 1px solid rgba(214, 179, 106, 0.15);
            backdrop-filter: blur(10px);
        }
        
        /* „É¢„Éê„Ç§„É´„Éú„Éà„É†„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(7, 13, 24, 0.98) 0%, rgba(11, 22, 40, 0.98) 100%);
            border-top: 1px solid rgba(214, 179, 106, 0.15);
            backdrop-filter: blur(20px);
            z-index: 50;
            padding: 8px 0;
            display: none;
        }
        
        @media (max-width: 768px) {
            .bottom-nav {
                display: block;
            }
            
            .sidebar-luxury {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar-luxury.active {
                transform: translateX(0);
            }
            
            .main-content {
                padding-bottom: 80px;
            }
        }
        
        .bottom-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            color: #9ca3af;
            border-radius: 12px;
            transition: all 0.2s;
        }
        
        .bottom-nav-btn.active {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }
        
        .nav-btn {
            transition: all 0.2s;
        }
        
        .nav-btn.active {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }
        
        .modal {
            display: none;
        }
        
        .modal.active {
            display: flex;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        input, select, textarea {
            background: rgba(42, 42, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f5f5f5;
        }
        
        /* select„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊ≠£„Åó„ÅèË°®Á§∫ */
        select {
            appearance: auto;
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            cursor: pointer;
        }
        
        select option {
            background: #1a1a1a;
            color: #f5f5f5;
            padding: 10px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
        }
        
        .table-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .table-card:hover {
            transform: scale(1.05);
        }
        
        .table-available {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .table-occupied {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .table-reserved {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
        }
        
        .cast-subtab-btn {
            background: rgba(42, 42, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #9ca3af;
        }
        
        .cast-subtab-btn.active {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.3);
            color: #d4af37;
        }
        
        .cast-subtab-content {
            display: none;
        }
        
        .cast-subtab-content.active {
            display: block;
        }
        
        /* ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ */
        .image-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            background: rgba(42, 42, 42, 0.4);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .image-upload-area:hover {
            border-color: rgba(212, 175, 55, 0.5);
            background: rgba(42, 42, 42, 0.6);
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 1rem;
            border-radius: 12px;
        }
        
        /* „É¢„Éº„ÉÄ„É´„Çπ„ÇØ„É≠„Éº„É´ÂØæÂøú */
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: rgba(42, 42, 42, 0.4);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.3);
            border-radius: 4px;
        }
        
        /* „Ç´„É¨„É≥„ÉÄ„Éº */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        @media (max-width: 640px) {
            .calendar-grid {
                gap: 4px;
            }
        }
        
        .calendar-cell {
            min-height: 80px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        @media (max-width: 640px) {
            .calendar-cell {
                min-height: 60px;
                padding: 4px;
            }
        }
        
        .calendar-cell:hover {
            background: rgba(212, 175, 55, 0.05);
        }
        
        .shift-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 6px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
        }
        
        @media (max-width: 640px) {
            .shift-badge {
                font-size: 0.6rem;
                padding: 2px 4px;
            }
        }
        
        /* „Ç¢„Ç§„Ç≥„É≥ */
        .cast-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: #0a0a0a;
            text-transform: uppercase;
        }
        
        .cast-avatar-small {
            width: 48px;
            height: 48px;
            font-size: 18px;
        }
        
        .table-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            margin: 0 auto 1rem;
            background: rgba(42, 42, 42, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .table-icon.vip {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(244, 208, 63, 0.2) 100%);
            border: 2px solid rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        
        .table-icon.occupied {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }
        
        .table-icon.available {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.2) 100%);
            border: 2px solid rgba(34, 197, 94, 0.5);
        }
        
        .table-icon.reserved {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2) 0%, rgba(202, 138, 4, 0.2) 100%);
            border: 2px solid rgba(234, 179, 8, 0.5);
        }
        
        .icon-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
        .login-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .login-screen.hidden {
            display: none;
        }
        
        .login-box {
            width: 100%;
            max-width: 420px;
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 24px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        .login-logo h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .login-logo p {
            color: #9ca3af;
            font-size: 0.875rem;
        }
        
        .login-input {
            width: 100%;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            background: rgba(42, 42, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #f5f5f5;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .login-input:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
            background: rgba(42, 42, 42, 0.8);
        }
        
        .login-input::placeholder {
            color: #6b7280;
        }
        
        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.35);
            transform: translateY(-2px);
        }
        
        .login-btn:active {
            transform: scale(0.98);
        }
        
        .login-error {
            display: none;
            padding: 0.75rem;
            margin-bottom: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #ef4444;
            font-size: 0.875rem;
            text-align: center;
        }
        
        .login-error.active {
            display: block;
        }
        
        .demo-credentials {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(212, 175, 55, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 12px;
        }
        
        .demo-credentials p {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .demo-credentials code {
            color: #d4af37;
            font-size: 0.875rem;
            font-family: 'Courier New', monospace;
        }
        
        /* Âç∞Âà∑Áî®„Çπ„Çø„Ç§„É´ */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            /* Êó•Â†±„Çø„Éñ„ÇíÂç∞Âà∑ÊôÇ„Å´Ë°®Á§∫ */
            #daily-report-tab {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            #dailyReportContent {
                display: block !important;
                color: black !important;
            }
            
            #dailyReportContent * {
                color: black !important;
                background: white !important;
                border-color: #ccc !important;
            }
            
            /* „Çµ„Ç§„Éâ„Éê„Éº„Å®„Éä„Éì„ÇíÈùûË°®Á§∫ */
            #sidebar, .bottom-nav, nav {
                display: none !important;
            }
            
            /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂÖ®ÂπÖ„Å´ */
            .main-content {
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            .luxury-card {
                border: 1px solid #ccc;
                background: white;
            }
            
            .print-page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body>
    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <h1>Cabax</h1>
                <p>Admin Pro - Complete Edition</p>
            </div>
            
            <div id="loginError" class="login-error">
                „É¶„Éº„Ç∂„ÉºÂêç„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        class="login-input" 
                        placeholder="„É¶„Éº„Ç∂„ÉºÂêç"
                        autocomplete="username"
                        required
                    >
                </div>
                <div>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="login-input" 
                        placeholder="„Éë„Çπ„ÉØ„Éº„Éâ"
                        autocomplete="current-password"
                        required
                    >
                </div>
                <button type="submit" class="login-btn">
                    „É≠„Ç∞„Ç§„É≥
                </button>
            </form>
            
            <div class="demo-credentials">
                <p class="font-semibold mb-2 text-gray-300">„Éá„É¢„Ç¢„Ç´„Ç¶„É≥„Éà</p>
                <p>„É¶„Éº„Ç∂„ÉºÂêç: <code>admin</code></p>
                <p>„Éë„Çπ„ÉØ„Éº„Éâ: <code>cabax2024</code></p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="min-h-screen" style="display: none;">
        <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 sidebar-luxury no-print">
            <div class="flex h-full flex-col">
                <div class="flex h-24 items-center justify-between px-6 border-b border-gray-800">
                    <h1 class="text-3xl font-bold gold-accent tracking-tight">Cabax</h1>
                    <button onclick="toggleMobileSidebar()" class="md:hidden text-gray-400 text-2xl">‚úï</button>
                </div>
                
                <div class="border-b border-gray-800 p-6">
                    <p class="text-xs text-gray-500 uppercase tracking-widest mb-2">Âñ∂Ê•≠Êó•</p>
                    <p class="text-sm font-medium text-gray-300" id="businessDate"></p>
                </div>
                
                <nav class="flex-1 overflow-y-auto px-4 py-6 space-y-1">
                    <button onclick="showTab('dashboard')" class="nav-btn active w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">üìä</span>
                        <span>„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
                    </button>
                    <button onclick="showTab('tables')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ü™ë</span>
                        <span>„ÉÜ„Éº„Éñ„É´ÁÆ°ÁêÜ</span>
                    </button>
                    <button onclick="showTab('orders')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">üçΩÔ∏è</span>
                        <span>„Ç™„Éº„ÉÄ„ÉºÁÆ°ÁêÜ</span>
                    </button>
                    <button onclick="showTab('attendance')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">‚è∞</span>
                        <span>Âã§ÊÄ†ÁÆ°ÁêÜ</span>
                    </button>
                    <button onclick="showTab('shifts')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">üìÖ</span>
                        <span>„Ç∑„Éï„ÉàÁÆ°ÁêÜ</span>
                    </button>
                    <button onclick="showTab('menu')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">üìú</span>
                        <span>„É°„Éã„É•„ÉºÁÆ°ÁêÜ</span>
                    </button>
                    <button onclick="showTab('casts')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">üë•</span>
                        <span>„Ç≠„É£„Çπ„ÉàÁÆ°ÁêÜ</span>
                    </button>
                    <button onclick="showTab('checkout-history')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">üßæ</span>
                        <span>‰ºöË®àÂ±•Ê≠¥</span>
                    </button>
                    <button onclick="showTab('daily-report')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">üìã</span>
                        <span>Êó•Â†±</span>
                    </button>
                    <button onclick="showTab('store-settings')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">‚öôÔ∏è</span>
                        <span>Â∫óËàóË®≠ÂÆö</span>
                    </button>
                    <button onclick="showTab('reports')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">üìà</span>
                        <span>Â£≤‰∏ä„É¨„Éù„Éº„Éà</span>
                    </button>
                </nav>
                
                <div class="border-t border-gray-800 p-4">
                    <button onclick="logout()" class="w-full bg-red-900/20 text-red-400 border border-red-800/30 py-3.5 rounded-xl hover:bg-red-900/30 transition text-sm font-medium">
                        „É≠„Ç∞„Ç¢„Ç¶„Éà
                    </button>
                </div>
            </div>
        </div>

        <!-- „É¢„Éê„Ç§„É´„É°„Éã„É•„Éº„Éú„Çø„É≥ -->
        <button onclick="toggleMobileSidebar()" class="md:hidden fixed top-4 left-4 z-50 bg-gray-800/80 backdrop-blur-sm text-gray-300 p-3 rounded-xl no-print">
            ‚ò∞
        </button>

        <!-- „É¢„Éê„Ç§„É´„Éú„Éà„É†„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <div class="bottom-nav no-print">
            <div class="grid grid-cols-4 gap-1 px-2">
                <button onclick="showTab('dashboard')" class="bottom-nav-btn active" data-tab="dashboard">
                    <span class="text-xl">üìä</span>
                    <span class="text-xs">„ÉÄ„ÉÉ„Ç∑„É•</span>
                </button>
                <button onclick="showTab('tables')" class="bottom-nav-btn" data-tab="tables">
                    <span class="text-xl">ü™ë</span>
                    <span class="text-xs">„ÉÜ„Éº„Éñ„É´</span>
                </button>
                <button onclick="showTab('orders')" class="bottom-nav-btn" data-tab="orders">
                    <span class="text-xl">üçΩÔ∏è</span>
                    <span class="text-xs">„Ç™„Éº„ÉÄ„Éº</span>
                </button>
                <button onclick="showTab('daily-report')" class="bottom-nav-btn" data-tab="daily-report">
                    <span class="text-xl">üìã</span>
                    <span class="text-xs">Êó•Â†±</span>
                </button>
            </div>
        </div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="md:pl-72 min-h-screen main-content">
            <main class="p-4 md:p-10">
                
                <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
                <div id="dashboard-tab" class="tab-content active">
                    <div class="mb-8 md:mb-10">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-3 md:mb-4">Dashboard</h1>
                        <p class="text-gray-400 text-base md:text-lg mb-6 md:mb-8">„É™„Ç¢„É´„Çø„Ç§„É†Âñ∂Ê•≠Áä∂Ê≥Å</p>
                        <div class="flex flex-wrap gap-2 md:gap-3">
                            <button onclick="syncWithBackend()" class="luxury-btn px-6 md:px-8 py-3 md:py-3.5 rounded-xl text-sm">
                                üîÑ APIÂêåÊúü
                            </button>
                            <button onclick="printDailyReport()" class="bg-gray-800 text-gray-300 px-6 md:px-8 py-3 md:py-3.5 rounded-xl hover:bg-gray-700 transition text-sm">
                                üñ®Ô∏è Êó•Â†±Âç∞Âà∑
                            </button>
                            <button onclick="exportCSV()" class="bg-gray-800 text-gray-300 px-6 md:px-8 py-3 md:py-3.5 rounded-xl hover:bg-gray-700 transition text-sm">
                                üì• CSVÂá∫Âäõ
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-8 md:mb-10">
                        <div class="luxury-card rounded-2xl p-4 md:p-8 shadow-xl">
                            <p class="text-xs md:text-sm text-gray-400 mb-2 md:mb-3 uppercase tracking-wide">Êú¨Êó•„ÅÆÂ£≤‰∏ä</p>
                            <p class="text-2xl md:text-4xl font-bold gold-accent" id="totalSales">¬•0</p>
                        </div>
                        <div class="luxury-card rounded-2xl p-4 md:p-8 shadow-xl">
                            <p class="text-xs md:text-sm text-gray-400 mb-2 md:mb-3 uppercase tracking-wide">Êù•Â∫óÁµÑÊï∞</p>
                            <p class="text-2xl md:text-4xl font-bold text-gray-200" id="totalCustomers">0ÁµÑ</p>
                        </div>
                        <div class="luxury-card rounded-2xl p-4 md:p-8 shadow-xl">
                            <p class="text-xs md:text-sm text-gray-400 mb-2 md:mb-3 uppercase tracking-wide">Âá∫Âã§‰∏≠</p>
                            <p class="text-2xl md:text-4xl font-bold text-gray-200" id="workingCasts">0Âêç</p>
                        </div>
                        <div class="luxury-card rounded-2xl p-4 md:p-8 shadow-xl">
                            <p class="text-xs md:text-sm text-gray-400 mb-2 md:mb-3 uppercase tracking-wide">ÂÆ¢Âçò‰æ°</p>
                            <p class="text-2xl md:text-4xl font-bold text-gray-200" id="averageSpend">¬•0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                        <div class="luxury-card rounded-2xl p-6 md:p-8 shadow-xl">
                            <h3 class="text-lg md:text-xl font-semibold mb-4 md:mb-6 text-gray-200">ÊôÇÈñìÂ∏ØÂà•Â£≤‰∏ä</h3>
                            <canvas id="salesChart"></canvas>
                        </div>
                        <div class="luxury-card rounded-2xl p-6 md:p-8 shadow-xl">
                            <h3 class="text-lg md:text-xl font-semibold mb-4 md:mb-6 text-gray-200">ÊúÄËøë„ÅÆÊ¥ªÂãï</h3>
                            <div id="recentActivities" class="space-y-3 md:space-y-4"></div>
                        </div>
                    </div>
                </div>

                <!-- „ÉÜ„Éº„Éñ„É´ -->
                <div id="tables-tab" class="tab-content">
                    <div class="flex items-center justify-between mb-8 md:mb-10">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent">„ÉÜ„Éº„Éñ„É´</h1>
                        <button onclick="openTableSettingsModal()" class="luxury-btn px-4 py-2 rounded-xl text-sm flex items-center gap-2">
                            ‚öôÔ∏è Ë®≠ÂÆö
                        </button>
                    </div>

                    <div id="tablesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 md:gap-4">
                    </div>

                    <!-- ‚òÖ „ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞„Éë„Éç„É´ÔºàopenTableDetail„ÅåÊõ∏„ÅçÊèõ„Åà„ÇãÔºâ -->
                    <div id="tableDetailPanel" class="mt-6 hidden"></div>
                </div>

                <!-- „Ç™„Éº„ÉÄ„ÉºÁÆ°ÁêÜ„Çø„Éñ -->
                <div id="orders-tab" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent">„Ç™„Éº„ÉÄ„ÉºÁÆ°ÁêÜ</h1>
                        <div class="flex gap-2">
                            <button onclick="filterOrders('all')" id="orderFilterAll" class="order-filter-btn active px-4 py-2 rounded-xl text-sm font-semibold bg-amber-600 text-white">
                                „Åô„Åπ„Å¶
                            </button>
                            <button onclick="filterOrders('pending')" id="orderFilterPending" class="order-filter-btn px-4 py-2 rounded-xl text-sm font-semibold bg-gray-700 text-gray-300 hover:bg-gray-600">
                                ‚è≥ Êú™Êèê‰æõ
                            </button>
                            <button onclick="filterOrders('served')" id="orderFilterServed" class="order-filter-btn px-4 py-2 rounded-xl text-sm font-semibold bg-gray-700 text-gray-300 hover:bg-gray-600">
                                ‚úì Êèê‰æõÊ∏à
                            </button>
                            <button onclick="loadOrdersFromApi()" class="px-4 py-2 rounded-xl text-sm font-semibold bg-blue-600 text-white hover:bg-blue-500">
                                üîÑ Êõ¥Êñ∞
                            </button>
                        </div>
                    </div>

                    <!-- Êú™Êèê‰æõ„Ç™„Éº„ÉÄ„Éº„Çµ„Éû„É™„Éº -->
                    <div id="pendingOrdersSummary" class="mb-6 p-4 rounded-xl bg-red-900/20 border border-red-800/30 hidden">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">‚ö†Ô∏è</span>
                            <div>
                                <div class="text-lg font-bold text-red-400">Êú™Êèê‰æõ„Ç™„Éº„ÉÄ„Éº„Åå„ÅÇ„Çä„Åæ„Åô</div>
                                <div id="pendingOrdersCount" class="text-sm text-red-300"></div>
                            </div>
                        </div>
                    </div>

                    <!-- „Ç™„Éº„ÉÄ„Éº‰∏ÄË¶ß -->
                    <div id="ordersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- „Ç™„Éº„ÉÄ„Éº„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÂÖ•„Çã -->
                    </div>

                    <div id="noOrdersMessage" class="hidden text-center py-12 text-gray-500">
                        <span class="text-5xl mb-4 block">üì≠</span>
                        <p>„Ç™„Éº„ÉÄ„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    </div>
                </div>


                <!-- Âã§ÊÄ†ÁÆ°ÁêÜ„Çø„Éñ -->
                <div id="attendance-tab" class="tab-content">
                    <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-8 md:mb-10">Âã§ÊÄ†ÁÆ°ÁêÜ</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="luxury-card rounded-xl p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">Âá∫Âã§ÊâìÂàª</h3>
                            <select id="clockInCast" class="w-full px-4 py-3 rounded-xl mb-4 text-sm"></select>
                            <button onclick="clockIn()" class="w-full luxury-btn py-3 rounded-xl text-sm">Âá∫Âã§</button>
                        </div>
                        <div class="luxury-card rounded-xl p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">ÈÄÄÂã§ÊâìÂàª</h3>
                            <select id="clockOutCast" class="w-full px-4 py-3 rounded-xl mb-4 text-sm"></select>
                            <button onclick="clockOut()" class="w-full bg-red-900/20 text-red-400 border border-red-800/30 py-3 rounded-xl hover:bg-red-900/30 transition text-sm">ÈÄÄÂã§</button>
                        </div>
                    </div>

                    <div class="luxury-card rounded-xl p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-200">Âã§ÊÄ†Â±•Ê≠¥</h3>
                            <button onclick="exportAttendanceCSV()" class="luxury-btn px-6 py-2 rounded-xl text-sm">CSVÂá∫Âäõ</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-700">
                                        <th class="text-left py-3 px-4 text-gray-400">Êó•‰ªò</th>
                                        <th class="text-left py-3 px-4 text-gray-400">„Ç≠„É£„Çπ„Éà</th>
                                        <th class="text-center py-3 px-4 text-gray-400">Âá∫Âã§</th>
                                        <th class="text-center py-3 px-4 text-gray-400">ÈÄÄÂã§</th>
                                        <th class="text-center py-3 px-4 text-gray-400">Âã§ÂãôÊôÇÈñì</th>
                                        <th class="text-center py-3 px-4 text-gray-400">Áä∂ÊÖã</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- „Ç∑„Éï„ÉàÁÆ°ÁêÜ -->
                <div id="shifts-tab" class="tab-content">
                    <div class="mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-4">„Ç∑„Éï„ÉàÁÆ°ÁêÜ</h1>
                        <button onclick="openAddShiftModal()" class="luxury-btn px-6 py-3 rounded-xl text-sm">„Ç∑„Éï„ÉàÁôªÈå≤</button>
                    </div>

                    <div class="luxury-card rounded-xl p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="previousMonth()" class="bg-gray-800 text-gray-300 px-4 py-2 rounded-xl hover:bg-gray-700 transition text-sm">ÂâçÊúà</button>
                            <h3 class="text-xl font-semibold text-gray-200" id="currentMonth">2024Âπ¥11Êúà</h3>
                            <button onclick="nextMonth()" class="bg-gray-800 text-gray-300 px-4 py-2 rounded-xl hover:bg-gray-700 transition text-sm">Ê¨°Êúà</button>
                        </div>
                        <div class="calendar-grid" id="shiftCalendar"></div>
                    </div>

                    <div class="luxury-card rounded-xl p-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-200">‰ªäÈÄ±„ÅÆ„Ç∑„Éï„Éà</h3>
                        <div id="weeklyShifts"></div>
                    </div>
                </div>

                <!-- „É°„Éã„É•„ÉºÁÆ°ÁêÜ -->
                <div id="menu-tab" class="tab-content">
                    <div class="mb-6">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-4">„É°„Éã„É•„ÉºÁÆ°ÁêÜ</h1>
                        <button onclick="openAddMenuModal()" class="luxury-btn px-6 py-3 rounded-xl text-sm">„É°„Éã„É•„ÉºËøΩÂä†</button>
                    </div>
                    <!-- „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„Çø„Éñ -->
                    <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                        <button onclick="filterMenuCategory('all')" class="menu-filter-btn active px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-amber-500/20 text-amber-300 border border-amber-500/30" data-category="all">
                            „Åô„Åπ„Å¶
                        </button>
                        <button onclick="filterMenuCategory('drink')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="drink">
                            „Éâ„É™„É≥„ÇØ
                        </button>
                        <button onclick="filterMenuCategory('castdrink')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="castdrink">
                            „Ç≠„É£„Çπ„Éà/„Çπ„Çø„ÉÉ„Éï
                        </button>
                        <button onclick="filterMenuCategory('tableset')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="tableset">
                            Âçì„Çª„ÉÉ„Éà
                        </button>
                        <button onclick="filterMenuCategory('bottle')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="bottle">
                            „Éú„Éà„É´
                        </button>
                        <button onclick="filterMenuCategory('champagne')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="champagne">
                            „Ç∑„É£„É≥„Éë„É≥
                        </button>
                        <button onclick="filterMenuCategory('wine')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="wine">
                            „ÉØ„Ç§„É≥
                        </button>
                        <button onclick="filterMenuCategory('food')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="food">
                            „Éï„Éº„Éâ
                        </button>
                    </div>
                    <div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6"></div>
                </div>

                <!-- „Ç≠„É£„Çπ„ÉàÁÆ°ÁêÜ -->
                <div id="casts-tab" class="tab-content">
                    <div class="mb-6 md:mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-4">„Ç≠„É£„Çπ„ÉàÁÆ°ÁêÜ</h1>
                        
                        <!-- „Çµ„Éñ„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                        <div class="flex gap-2 overflow-x-auto pb-2">
                            <button onclick="showCastSubTab('cast-list')" class="cast-subtab-btn active px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                üë• „Ç≠„É£„Çπ„Éà‰∏ÄË¶ß
                            </button>
                            <button onclick="showCastSubTab('staff-list')" class="cast-subtab-btn px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                üßë‚Äçüíº „Çπ„Çø„ÉÉ„Éï‰∏ÄË¶ß
                            </button>
                            <button onclick="showCastSubTab('drink-back')" class="cast-subtab-btn px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                üíé DBÁç≤Âæó‰∏ÄË¶ß
                            </button>
                            <button onclick="showCastSubTab('salary')" class="cast-subtab-btn px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                üí∞ Áµ¶‰∏éË®àÁÆó
                            </button>
                            <button onclick="showCastSubTab('ranking')" class="cast-subtab-btn px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                üèÜ „É©„É≥„Ç≠„É≥„Ç∞
                            </button>
                        </div>
                    </div>
                    
                    <!-- „Çµ„Éñ„Çø„Éñ1: „Ç≠„É£„Çπ„Éà‰∏ÄË¶ß -->
                    <div id="cast-list-subtab" class="cast-subtab-content active">
                        <div class="mb-6 flex justify-end">
                            <button onclick="openAddCastModal()" class="luxury-btn px-6 md:px-8 py-3 rounded-xl text-sm">
                                ‚ûï „Ç≠„É£„Çπ„ÉàËøΩÂä†
                            </button>
                        </div>
                        <div id="castsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                    </div>
                    
                    <!-- „Çµ„Éñ„Çø„Éñ: „Çπ„Çø„ÉÉ„Éï‰∏ÄË¶ß -->
                    <div id="staff-list-subtab" class="cast-subtab-content">
                        <div class="mb-6 flex justify-end">
                            <button onclick="openAddStaffModal()" class="luxury-btn px-6 md:px-8 py-3 rounded-xl text-sm">
                                ‚ûï „Çπ„Çø„ÉÉ„ÉïËøΩÂä†
                            </button>
                        </div>
                        <div id="staffGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                    </div>
                    
                    <!-- „Çµ„Éñ„Çø„Éñ2: DBÁç≤Âæó‰∏ÄË¶ß -->
                    <div id="drink-back-subtab" class="cast-subtab-content">
                        <div class="mb-6 flex flex-col md:flex-row gap-3">
                            <select id="dbFilterPeriod" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderDrinkBackList()">
                                <option value="today">Êú¨Êó•</option>
                                <option value="week">‰ªäÈÄ±</option>
                                <option value="month">‰ªäÊúà</option>
                            </select>
                            <button onclick="exportDrinkBackCSV()" class="luxury-btn px-6 py-3 rounded-xl text-sm">
                                üì• CSVÂá∫Âäõ
                            </button>
                        </div>
                        
                        <!-- DBÈõÜË®à„Çµ„Éû„É™„Éº -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="luxury-card rounded-xl p-4 text-center">
                                <p class="text-sm text-gray-400 mb-1">Á∑èDBÈ°ç</p>
                                <p class="text-2xl font-bold gold-accent" id="totalDbAmount">¬•0</p>
                            </div>
                            <div class="luxury-card rounded-xl p-4 text-center">
                                <p class="text-sm text-gray-400 mb-1">DBÊ≥®ÊñáÊï∞</p>
                                <p class="text-2xl font-bold text-gray-200" id="totalDbCount">0‰ª∂</p>
                            </div>
                            <div class="luxury-card rounded-xl p-4 text-center">
                                <p class="text-sm text-gray-400 mb-1">TOP „Ç≠„É£„Çπ„Éà</p>
                                <p class="text-lg font-bold text-purple-300" id="topDbCast">-</p>
                            </div>
                            <div class="luxury-card rounded-xl p-4 text-center">
                                <p class="text-sm text-gray-400 mb-1">Âπ≥ÂùáDB/‰∫∫</p>
                                <p class="text-2xl font-bold text-gray-200" id="avgDbAmount">¬•0</p>
                            </div>
                        </div>
                        
                        <!-- „Ç≠„É£„Çπ„ÉàÂà•DB‰∏ÄË¶ß -->
                        <div class="luxury-card rounded-xl p-6 mb-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">„Ç≠„É£„Çπ„ÉàÂà•DBÈõÜË®à</h3>
                            <div id="castDbList" class="space-y-3"></div>
                        </div>
                        
                        <!-- DBË©≥Á¥∞‰∏ÄË¶ß -->
                        <div class="luxury-card rounded-xl p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">DBË©≥Á¥∞</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th class="text-left py-3 px-4 text-gray-400 font-medium">ÊôÇÂàª</th>
                                            <th class="text-left py-3 px-4 text-gray-400 font-medium">„Ç≠„É£„Çπ„Éà</th>
                                            <th class="text-left py-3 px-4 text-gray-400 font-medium">ÂïÜÂìÅ</th>
                                            <th class="text-center py-3 px-4 text-gray-400 font-medium">Êï∞Èáè</th>
                                            <th class="text-right py-3 px-4 text-gray-400 font-medium">DBÈ°ç</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dbDetailTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- „Çµ„Éñ„Çø„Éñ3: Áµ¶‰∏éË®àÁÆó -->
                    <div id="salary-subtab" class="cast-subtab-content">
                        <div class="mb-6 flex flex-col md:flex-row gap-3">
                            <select id="salaryMonth" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderSalaryCalculation()">
                                <option value="2024-11">2024Âπ¥11Êúà</option>
                                <option value="2024-10">2024Âπ¥10Êúà</option>
                                <option value="2024-09">2024Âπ¥9Êúà</option>
                            </select>
                            <button onclick="exportSalaryCSV()" class="luxury-btn px-6 py-3 rounded-xl text-sm">
                                üì• Áµ¶‰∏éÊòéÁ¥∞CSV
                            </button>
                        </div>
                        
                        <div id="salaryList" class="space-y-4"></div>
                    </div>
                    
                    <!-- „Çµ„Éñ„Çø„Éñ4: „É©„É≥„Ç≠„É≥„Ç∞ -->
                    <div id="ranking-subtab" class="cast-subtab-content">
                        <div class="mb-6">
                            <select id="rankingPeriod" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderRankings()">
                                <option value="month">‰ªäÊúà</option>
                                <option value="week">‰ªäÈÄ±</option>
                                <option value="today">Êú¨Êó•</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Â£≤‰∏ä„É©„É≥„Ç≠„É≥„Ç∞ -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                    <span>üí∞</span>
                                    <span>Â£≤‰∏ä„É©„É≥„Ç≠„É≥„Ç∞</span>
                                </h3>
                                <div id="salesRanking" class="space-y-3"></div>
                            </div>
                            
                            <!-- DB„É©„É≥„Ç≠„É≥„Ç∞ -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                    <span>üíé</span>
                                    <span>DBÁç≤Âæó„É©„É≥„Ç≠„É≥„Ç∞</span>
                                </h3>
                                <div id="dbRanking" class="space-y-3"></div>
                            </div>
                            
                            <!-- ÊåáÂêçÊï∞„É©„É≥„Ç≠„É≥„Ç∞ -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                    <span>‚≠ê</span>
                                    <span>ÊåáÂêçÊï∞„É©„É≥„Ç≠„É≥„Ç∞</span>
                                </h3>
                                <div id="nominationRanking" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰ºöË®àÂ±•Ê≠¥„Çø„Éñ -->
                <div id="checkout-history-tab" class="tab-content">
                    <div class="mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-3">‰ºöË®àÂ±•Ê≠¥</h1>
                        <p class="text-gray-400">Êú¨Êó•„ÅÆ‰ºöË®àÂ±•Ê≠¥„ÇíÁ¢∫Ë™ç„Éª‰øÆÊ≠£„Åß„Åç„Åæ„Åô</p>
                    </div>
                    
                    <div id="checkoutHistoryContent" class="space-y-4">
                        <!-- „Åì„Åì„Å´‰ºöË®àÂ±•Ê≠¥„ÅåË°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>

                <!-- Êó•Â†±„Çø„Éñ -->
                <div id="daily-report-tab" class="tab-content">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 no-print">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent">„É¨„Éù„Éº„Éà</h1>
                        <div class="flex items-center gap-3">
                            <!-- Êó•Â†±/ÊúàÂ†±Âàá„ÇäÊõø„Åà -->
                            <div class="flex bg-gray-800 rounded-xl p-1">
                                <button id="btnDailyReport" onclick="switchReportMode('daily')" class="px-4 py-2 rounded-lg text-sm font-semibold transition bg-amber-500 text-black">Êó•Â†±</button>
                                <button id="btnMonthlyReport" onclick="switchReportMode('monthly')" class="px-4 py-2 rounded-lg text-sm font-semibold transition text-gray-400 hover:text-white">ÊúàÂ†±</button>
                            </div>
                            <!-- ÊúàÈÅ∏ÊäûÔºàÊúàÂ†±ÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
                            <div id="monthSelector" class="hidden flex items-center gap-2">
                                <select id="reportYear" class="px-3 py-2 rounded-lg bg-gray-800 text-white text-sm" onchange="loadMonthlyReport()">
                                </select>
                                <select id="reportMonth" class="px-3 py-2 rounded-lg bg-gray-800 text-white text-sm" onchange="loadMonthlyReport()">
                                    <option value="1">1Êúà</option>
                                    <option value="2">2Êúà</option>
                                    <option value="3">3Êúà</option>
                                    <option value="4">4Êúà</option>
                                    <option value="5">5Êúà</option>
                                    <option value="6">6Êúà</option>
                                    <option value="7">7Êúà</option>
                                    <option value="8">8Êúà</option>
                                    <option value="9">9Êúà</option>
                                    <option value="10">10Êúà</option>
                                    <option value="11">11Êúà</option>
                                    <option value="12">12Êúà</option>
                                </select>
                            </div>
                            <button onclick="printFullDailyReport()" class="luxury-btn px-6 py-3 rounded-xl text-sm">
                                üñ®Ô∏è Âç∞Âà∑
                            </button>
                        </div>
                    </div>
                    
                    <div id="dailyReportContent"></div>
                    <div id="monthlyReportContent" class="hidden"></div>
                </div>

                <!-- Â∫óËàóË®≠ÂÆö -->
                <div id="store-settings-tab" class="tab-content">
                    <div class="mb-6 md:mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-4">Â∫óËàóË®≠ÂÆö</h1>
                        <p class="text-gray-400">„Éê„ÉÉ„ÇØÁéá„Å™„Å©Â∫óËàóÂõ∫Êúâ„ÅÆË®≠ÂÆö„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô</p>
                    </div>
                    
                    <!-- „Éê„ÉÉ„ÇØË®≠ÂÆö -->
                    <div class="glass-effect rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold text-white mb-4">„Éê„ÉÉ„ÇØË®≠ÂÆö</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- „Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">„Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØÔºàDBÔºâ</span>
                                    <span class="text-amber-400 font-bold" id="displayDbRate">60%</span>
                                </div>
                                <input type="range" id="settingDbRate" min="0" max="100" value="60" 
                                       onchange="updateBackSetting('db', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">„Ç≠„É£„Çπ„Éà„Éâ„É™„É≥„ÇØ„ÅÆ„Éê„ÉÉ„ÇØÁéá</p>
                            </div>
                            
                            <!-- ÊåáÂêçÊñô„Éê„ÉÉ„ÇØ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">ÊåáÂêçÊñô„Éê„ÉÉ„ÇØ</span>
                                    <span class="text-amber-400 font-bold" id="displayNominationRate">60%</span>
                                </div>
                                <input type="range" id="settingNominationRate" min="0" max="100" value="60" 
                                       onchange="updateBackSetting('nomination', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">ÊåáÂêçÊñô„ÅÆ„Éê„ÉÉ„ÇØÁéáÔºàË§áÊï∞ÊåáÂêçÊôÇ„ÅØÁ≠âÂàÜÂæå„Å´ÈÅ©Áî®Ôºâ</p>
                            </div>
                            
                            <!-- Â£≤‰∏ä„Éê„ÉÉ„ÇØÔºàÊåáÂêçÊôÇÔºâ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">Â£≤‰∏ä„Éê„ÉÉ„ÇØÔºàÊåáÂêçÊôÇÔºâ</span>
                                    <span class="text-amber-400 font-bold" id="displaySalesRate">10%</span>
                                </div>
                                <input type="range" id="settingSalesRate" min="0" max="50" value="10" 
                                       onchange="updateBackSetting('sales', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">ÊåáÂêçÂÆ¢„ÅÆ‰ºöË®à„Å´ÂØæ„Åô„Çã„Éê„ÉÉ„ÇØÁéá</p>
                            </div>
                            
                            <!-- Âêå‰º¥„Éê„ÉÉ„ÇØ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">Âêå‰º¥„Éê„ÉÉ„ÇØ</span>
                                    <span class="text-amber-400 font-bold" id="displayCompanionRate">100%</span>
                                </div>
                                <input type="range" id="settingCompanionRate" min="0" max="100" value="100" 
                                       onchange="updateBackSetting('companion', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">Âêå‰º¥Êñô„ÅÆ„Éê„ÉÉ„ÇØÁéá</p>
                            </div>
                            
                            <!-- „Ç∑„É£„É≥„Éë„É≥„Éê„ÉÉ„ÇØ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">„Ç∑„É£„É≥„Éë„É≥„Éê„ÉÉ„ÇØ</span>
                                    <span class="text-amber-400 font-bold" id="displayChampagneRate">10%</span>
                                </div>
                                <input type="range" id="settingChampagneRate" min="0" max="50" value="10" 
                                       onchange="updateBackSetting('champagne', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">„Ç∑„É£„É≥„Éë„É≥Â£≤‰∏ä„Å´ÂØæ„Åô„Çã„Éê„ÉÉ„ÇØÁéá</p>
                            </div>
                            
                            <!-- „Éú„Éà„É´„Éê„ÉÉ„ÇØ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">„Éú„Éà„É´„Éê„ÉÉ„ÇØ</span>
                                    <span class="text-amber-400 font-bold" id="displayBottleRate">10%</span>
                                </div>
                                <input type="range" id="settingBottleRate" min="0" max="50" value="10" 
                                       onchange="updateBackSetting('bottle', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">„Éú„Éà„É´Â£≤‰∏ä„Å´ÂØæ„Åô„Çã„Éê„ÉÉ„ÇØÁéá</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button onclick="saveStoreSettings()" class="luxury-btn px-6 py-3 rounded-xl">
                                Ë®≠ÂÆö„Çí‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                    
                    <!-- „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ -->
                    <div class="glass-effect rounded-2xl p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ</h2>
                            <button onclick="openAddStaffModal()" class="luxury-btn px-4 py-2 rounded-xl text-sm">
                                Ôºã „Çπ„Çø„ÉÉ„ÉïËøΩÂä†
                            </button>
                        </div>
                        
                        <div id="staffList" class="space-y-3">
                            <!-- „Çπ„Çø„ÉÉ„Éï„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                    
                    <!-- Êú¨Êó•„ÅÆ„Çπ„Çø„ÉÉ„ÉïÂã§ÊÄ† -->
                    <div class="glass-effect rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold text-white mb-4">Êú¨Êó•„ÅÆ„Çπ„Çø„ÉÉ„ÉïÂã§ÊÄ†</h2>
                        
                        <div id="staffAttendanceList" class="space-y-3">
                            <!-- Âã§ÊÄ†„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                        
                        <div class="mt-4 p-4 bg-amber-900/20 rounded-xl border border-amber-800/30">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Êú¨Êó•„ÅÆ„Çπ„Çø„ÉÉ„Éï‰∫∫‰ª∂Ë≤ª</span>
                                <span id="todayStaffCost" class="text-2xl font-bold gold-accent">¬•0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Â£≤‰∏ä„É¨„Éù„Éº„Éà -->
                <div id="reports-tab" class="tab-content">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent">Â£≤‰∏ä„É¨„Éù„Éº„Éà</h1>
                        <div class="flex gap-3">
                            <select id="reportPeriod" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderReports()">
                                <option value="today">Êú¨Êó•</option>
                                <option value="week">‰ªäÈÄ±</option>
                                <option value="month" selected>‰ªäÊúà</option>
                                <option value="year">‰ªäÂπ¥</option>
                            </select>
                            <button onclick="exportReportCSV()" class="luxury-btn px-6 py-3 rounded-xl text-sm">
                                üì• CSVÂá∫Âäõ
                            </button>
                        </div>
                    </div>
                    
                    <div id="reportsContent">
                        <!-- Â£≤‰∏ä„Çµ„Éû„É™„Éº -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div class="luxury-card rounded-xl p-6">
                                <p class="text-sm text-gray-400 mb-2">Á∑èÂ£≤‰∏ä</p>
                                <p class="text-3xl font-bold gold-accent" id="reportTotalSales">¬•0</p>
                                <p class="text-xs text-green-400 mt-1" id="reportSalesChange">ÂâçÊúàÊØî +0%</p>
                            </div>
                            <div class="luxury-card rounded-xl p-6">
                                <p class="text-sm text-gray-400 mb-2">Êù•Â∫óÁµÑÊï∞</p>
                                <p class="text-3xl font-bold text-gray-200" id="reportTotalCustomers">0ÁµÑ</p>
                                <p class="text-xs text-green-400 mt-1" id="reportCustomersChange">ÂâçÊúàÊØî +0%</p>
                            </div>
                            <div class="luxury-card rounded-xl p-6">
                                <p class="text-sm text-gray-400 mb-2">ÂÆ¢Âçò‰æ°</p>
                                <p class="text-3xl font-bold text-blue-300" id="reportAvgSpend">¬•0</p>
                                <p class="text-xs text-green-400 mt-1" id="reportAvgChange">ÂâçÊúàÊØî +0%</p>
                            </div>
                            <div class="luxury-card rounded-xl p-6">
                                <p class="text-sm text-gray-400 mb-2">Á≤óÂà©</p>
                                <p class="text-3xl font-bold text-green-400" id="reportGrossProfit">¬•0</p>
                                <p class="text-xs text-gray-400 mt-1" id="reportProfitRate">Á≤óÂà©Áéá 60%</p>
                            </div>
                        </div>
                        
                        <!-- „Ç∞„É©„Éï„Ç®„É™„Ç¢ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- Â£≤‰∏äÊé®Áßª„Ç∞„É©„Éï -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-200">Â£≤‰∏äÊé®Áßª</h3>
                                <canvas id="salesTrendChart"></canvas>
                            </div>
                            
                            <!-- „Ç´„ÉÜ„Ç¥„É™Âà•Â£≤‰∏ä -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-200">„Ç´„ÉÜ„Ç¥„É™Âà•Â£≤‰∏ä</h3>
                                <canvas id="categorySalesChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- ÊôÇÈñìÂ∏ØÂà•Â£≤‰∏ä -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-200">ÊôÇÈñìÂ∏ØÂà•Â£≤‰∏ä</h3>
                                <canvas id="hourlyChart"></canvas>
                            </div>
                            
                            <!-- Âéü‰æ°ÁéáÂàÜÊûê -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-200">„Ç´„ÉÜ„Ç¥„É™Âà•Âéü‰æ°Áéá</h3>
                                <div class="space-y-3" id="costRateList"></div>
                            </div>
                        </div>
                        
                        <!-- „Ç≠„É£„ÉÉ„ÉÅ„Çπ„Çø„ÉÉ„ÉïÊàêÁ∏æ -->
                        <div class="luxury-card rounded-xl p-6 mb-8">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">„Ç≠„É£„ÉÉ„ÉÅ„Çπ„Çø„ÉÉ„ÉïÊàêÁ∏æ</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-700">
                                            <th class="text-left py-3 px-4 text-gray-400">„Çπ„Çø„ÉÉ„ÉïÂêç</th>
                                            <th class="text-center py-3 px-4 text-gray-400">Êù•Â∫óÁµÑÊï∞</th>
                                            <th class="text-right py-3 px-4 text-gray-400">Á∑èÂ£≤‰∏ä</th>
                                            <th class="text-right py-3 px-4 text-gray-400">Âπ≥ÂùáÂÆ¢Âçò‰æ°</th>
                                            <th class="text-center py-3 px-4 text-gray-400">Ë≤¢ÁåÆÂ∫¶</th>
                                        </tr>
                                    </thead>
                                    <tbody id="catchStaffTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- TOPÂïÜÂìÅ„É©„É≥„Ç≠„É≥„Ç∞ -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <span>üçæ</span>
                                    <span>„Éú„Éà„É´TOP5</span>
                                </h3>
                                <div id="topBottles" class="space-y-3"></div>
                            </div>
                            
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <span>ü•É</span>
                                    <span>„Éâ„É™„É≥„ÇØTOP5</span>
                                </h3>
                                <div id="topDrinks" class="space-y-3"></div>
                            </div>
                            
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <span>üçΩ</span>
                                    <span>„Éï„Éº„ÉâTOP5</span>
                                </h3>
                                <div id="topFoods" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „Çπ„Çø„ÉÉ„ÉïËøΩÂä† -->
    <div id="addStaffModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-lg modal-content glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 py-5 flex items-center justify-between">
                <h2 class="text-xl font-bold gold-accent">„Çπ„Çø„ÉÉ„ÉïËøΩÂä†</h2>
                <button onclick="closeModal('addStaffModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6">
                <form onsubmit="addStaff(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ÂêçÂâç</label>
                        <input type="text" id="staffName" placeholder="ÂêçÂâç" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ÂΩπÂâ≤</label>
                        <select id="staffRole" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white">
                            <option value="waiter">„Ç¶„Çß„Ç§„Çø„Éº</option>
                            <option value="kitchen">„Ç≠„ÉÉ„ÉÅ„É≥</option>
                            <option value="manager">„Éû„Éç„Éº„Ç∏„É£„Éº</option>
                            <option value="catch">„Ç≠„É£„ÉÉ„ÉÅ</option>
                            <option value="driver">„Éâ„É©„Ç§„Éê„Éº</option>
                            <option value="other">„Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Áµ¶‰∏é„Çø„Ç§„Éó</label>
                        <select id="staffSalaryType" onchange="updateSalaryLabel()" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white">
                            <option value="hourly">ÊôÇÁµ¶</option>
                            <option value="daily">Êó•Áµ¶</option>
                            <option value="monthly">ÊúàÁµ¶</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2" id="salaryAmountLabel">ÊôÇÁµ¶</label>
                        <input type="number" id="staffSalaryAmount" placeholder="1000" value="1000" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ÈõªË©±Áï™Âè∑Ôºà‰ªªÊÑèÔºâ</label>
                        <input type="tel" id="staffPhone" placeholder="090-1234-5678" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 rounded-xl font-semibold text-sm">ËøΩÂä†</button>
                        <button type="button" onclick="closeModal('addStaffModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „É°„Éã„É•„ÉºËøΩÂä† -->
    <div id="addMenuModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-lg modal-content glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„É°„Éã„É•„ÉºËøΩÂä†</h2>
                <button onclick="closeModal('addMenuModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="addMenuItem(event)" class="space-y-4 md:space-y-5">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ÂïÜÂìÅÁîªÂÉè</label>
                        <div class="image-upload-area rounded-xl p-6 text-center" onclick="document.getElementById('menuImageInput').click()">
                            <input type="file" id="menuImageInput" accept="image/*" class="hidden" onchange="previewMenuImage(event, 'add')">
                            <p class="text-gray-400 mb-2 text-sm">üì∏ „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</p>
                            <p class="text-xs text-gray-500">JPG, PNG, GIF (ÊúÄÂ§ß5MB)</p>
                        </div>
                        <img id="menuImagePreview" class="image-preview hidden" />
                    </div>
                    <input type="text" id="menuName" placeholder="ÂïÜÂìÅÂêç" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">„Ç´„ÉÜ„Ç¥„É™</label>
                        <select id="menuCategory" style="width:100%; padding:12px 16px; border-radius:12px; background:#2a2a2a; color:#f5f5f5; border:1px solid #444; font-size:14px; cursor:pointer;">
                            <option value="drink">„Éâ„É™„É≥„ÇØ</option>
                            <option value="castdrink">„Ç≠„É£„Çπ„Éà/„Çπ„Çø„ÉÉ„Éï„Éâ„É™„É≥„ÇØ</option>
                            <option value="tableset">Âçì„Çª„ÉÉ„Éà</option>
                            <option value="bottle" selected>„Éú„Éà„É´</option>
                            <option value="champagne">„Ç∑„É£„É≥„Éë„É≥</option>
                            <option value="wine">„ÉØ„Ç§„É≥</option>
                            <option value="food">„Éï„Éº„Éâ</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Â£≤‰æ°</label>
                            <input type="number" id="menuPrice" placeholder="Â£≤‰æ°" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Âéü‰æ°</label>
                            <input type="number" id="menuCost" placeholder="Âéü‰æ°Ôºà‰ªªÊÑèÔºâ" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        </div>
                    </div>
                    <textarea id="menuDescription" placeholder="Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ" rows="3" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm"></textarea>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">ËøΩÂä†</button>
                        <button type="button" onclick="closeModal('addMenuModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „É°„Éã„É•„ÉºÁ∑®ÈõÜ -->
    <div id="editMenuModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-lg modal-content glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„É°„Éã„É•„ÉºÁ∑®ÈõÜ</h2>
                <button onclick="closeModal('editMenuModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="updateMenuItem(event)" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="editMenuId">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ÂïÜÂìÅÁîªÂÉè</label>
                        <div class="image-upload-area rounded-xl p-6 text-center" onclick="document.getElementById('editMenuImageInput').click()">
                            <input type="file" id="editMenuImageInput" accept="image/*" class="hidden" onchange="previewMenuImage(event, 'edit')">
                            <p class="text-gray-400 mb-2 text-sm">üì∏ „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁîªÂÉè„ÇíÂ§âÊõ¥</p>
                            <p class="text-xs text-gray-500">JPG, PNG, GIF (ÊúÄÂ§ß5MB)</p>
                        </div>
                        <img id="editMenuImagePreview" class="image-preview hidden" />
                    </div>
                    <input type="text" id="editMenuName" placeholder="ÂïÜÂìÅÂêç" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">„Ç´„ÉÜ„Ç¥„É™</label>
                        <select id="editMenuCategory" style="width:100%; padding:12px 16px; border-radius:12px; background:#2a2a2a; color:#f5f5f5; border:1px solid #444; font-size:14px; cursor:pointer;">
                            <option value="drink">„Éâ„É™„É≥„ÇØ</option>
                            <option value="castdrink">„Ç≠„É£„Çπ„Éà/„Çπ„Çø„ÉÉ„Éï„Éâ„É™„É≥„ÇØ</option>
                            <option value="tableset">Âçì„Çª„ÉÉ„Éà</option>
                            <option value="bottle">„Éú„Éà„É´</option>
                            <option value="champagne">„Ç∑„É£„É≥„Éë„É≥</option>
                            <option value="wine">„ÉØ„Ç§„É≥</option>
                            <option value="food">„Éï„Éº„Éâ</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Â£≤‰æ°</label>
                            <input type="number" id="editMenuPrice" placeholder="Â£≤‰æ°" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Âéü‰æ°</label>
                            <input type="number" id="editMenuCost" placeholder="Âéü‰æ°Ôºà‰ªªÊÑèÔºâ" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        </div>
                    </div>
                    <textarea id="editMenuDescription" placeholder="Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ" rows="3" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm"></textarea>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">Êõ¥Êñ∞</button>
                        <button type="button" onclick="closeModal('editMenuModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆöÔºà‰∏ÄË¶ßÔºâ -->
    <div id="tableSettingsModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-2xl glass-effect rounded-2xl shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö</h2>
                <button onclick="closeModal('tableSettingsModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8 overflow-y-auto flex-1">
                <div class="mb-4 flex justify-end">
                    <button onclick="closeModal('tableSettingsModal'); openAddTableModal();" class="luxury-btn px-4 py-2 rounded-xl text-sm">
                        ‚ûï „ÉÜ„Éº„Éñ„É´ËøΩÂä†
                    </button>
                </div>
                <div id="tableSettingsList" class="space-y-3">
                    <!-- „ÉÜ„Éº„Éñ„É´‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÂÖ•„Çã -->
                </div>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „ÉÜ„Éº„Éñ„É´ËøΩÂä† -->
    <div id="addTableModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„ÉÜ„Éº„Éñ„É´ËøΩÂä†</h2>
                <button onclick="closeModal('addTableModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="addTable(event)" class="space-y-4 md:space-y-5">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">„ÉÜ„Éº„Éñ„É´Âêç</label>
                        <input type="text" id="tableName" placeholder="‰æã: 1, 2, VIP1, „Ç´„Ç¶„É≥„Çø„Éº" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">VIP„ÉÜ„Éº„Éñ„É´</label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="tableIsVip" class="w-5 h-5 rounded">
                            <span class="text-gray-300">VIP„ÉÜ„Éº„Éñ„É´„Å®„Åó„Å¶Ë®≠ÂÆö</span>
                        </label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">ËøΩÂä†</button>
                        <button type="button" onclick="closeModal('addTableModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „ÉÜ„Éº„Éñ„É´Á∑®ÈõÜ -->
    <div id="editTableModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„ÉÜ„Éº„Éñ„É´Á∑®ÈõÜ</h2>
                <button onclick="closeModal('editTableModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="updateTable(event)" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="editTableId">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">„ÉÜ„Éº„Éñ„É´Âêç</label>
                        <input type="text" id="editTableName" placeholder="‰æã: 1, 2, VIP1, „Ç´„Ç¶„É≥„Çø„Éº" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">VIP„ÉÜ„Éº„Éñ„É´</label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="editTableIsVip" class="w-5 h-5 rounded">
                            <span class="text-gray-300">VIP„ÉÜ„Éº„Éñ„É´„Å®„Åó„Å¶Ë®≠ÂÆö</span>
                        </label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">Êõ¥Êñ∞</button>
                        <button type="button" onclick="closeModal('editTableModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <button onclick="deleteTable()" class="w-full bg-red-900/20 text-red-400 border border-red-800/30 py-3 rounded-xl hover:bg-red-900/30 transition text-sm">
                        „Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„ÇíÂâäÈô§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞„ÉªËøΩÂä†Ê≥®Êñá -->
    <div id="tableDetailModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-4xl modal-content glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent" id="tableDetailTitle">„ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞</h2>
                <button onclick="closeModal('tableDetailModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <div id="tableDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „Ç≠„É£„Çπ„ÉàËøΩÂä† -->
    <div id="addCastModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between sticky top-0 bg-gray-900/95 backdrop-blur">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„Ç≠„É£„Çπ„ÉàËøΩÂä†</h2>
                <button onclick="closeModal('addCastModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="addCast(event)" class="space-y-4 md:space-y-5">
                    <input type="text" id="castName" placeholder="ÂêçÂâç" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <select id="castRank" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        <option value="regular">„É¨„ÇÆ„É•„É©„Éº</option>
                        <option value="chief">„ÉÅ„Éº„Éï</option>
                        <option value="manager">„Éû„Éç„Éº„Ç∏„É£„Éº</option>
                    </select>
                    <input type="number" id="castHourlyRate" placeholder="ÊôÇÁµ¶" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    
                    <!-- „Éê„ÉÉ„ÇØË®≠ÂÆö -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">üí∞ „Éê„ÉÉ„ÇØË®≠ÂÆö</p>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Âêå‰º¥„Éê„ÉÉ„ÇØÔºàÂÜÜÔºâ</label>
                                <input type="number" id="castCompanionBack" value="3000" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ÊåáÂêç„Éê„ÉÉ„ÇØÔºàÂÜÜÔºâ</label>
                                <input type="number" id="castNominationBack" value="1000" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">„Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØÁéáÔºà%Ôºâ</label>
                                <input type="number" id="castDrinkBackRate" value="10" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Â£≤‰∏ä„Éê„ÉÉ„ÇØÁéáÔºà%Ôºâ</label>
                                <input type="number" id="castSalesBackRate" value="0" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">ËøΩÂä†</button>
                        <button type="button" onclick="closeModal('addCastModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „Ç≠„É£„Çπ„ÉàÁ∑®ÈõÜ -->
    <div id="editCastModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between sticky top-0 bg-gray-900/95 backdrop-blur">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„Ç≠„É£„Çπ„ÉàÁ∑®ÈõÜ</h2>
                <button onclick="closeModal('editCastModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="updateCast(event)" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="editCastId">
                    <input type="text" id="editCastName" placeholder="ÂêçÂâç" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <select id="editCastRank" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        <option value="regular">„É¨„ÇÆ„É•„É©„Éº</option>
                        <option value="chief">„ÉÅ„Éº„Éï</option>
                        <option value="manager">„Éû„Éç„Éº„Ç∏„É£„Éº</option>
                    </select>
                    <input type="number" id="editCastHourlyRate" placeholder="ÊôÇÁµ¶" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    
                    <!-- „Éê„ÉÉ„ÇØË®≠ÂÆö -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">üí∞ „Éê„ÉÉ„ÇØË®≠ÂÆö</p>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Âêå‰º¥„Éê„ÉÉ„ÇØÔºàÂÜÜÔºâ</label>
                                <input type="number" id="editCastCompanionBack" placeholder="3000" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ÊåáÂêç„Éê„ÉÉ„ÇØÔºàÂÜÜÔºâ</label>
                                <input type="number" id="editCastNominationBack" placeholder="1000" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">„Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØÁéáÔºà%Ôºâ</label>
                                <input type="number" id="editCastDrinkBackRate" placeholder="10" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Â£≤‰∏ä„Éê„ÉÉ„ÇØÁéáÔºà%Ôºâ</label>
                                <input type="number" id="editCastSalesBackRate" placeholder="0" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">Êõ¥Êñ∞</button>
                        <button type="button" onclick="closeModal('editCastModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „Çπ„Çø„ÉÉ„ÉïËøΩÂä† -->
    <div id="addStaffModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„Çπ„Çø„ÉÉ„ÉïËøΩÂä†</h2>
                <button onclick="closeModal('addStaffModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="addStaff(event)" class="space-y-4 md:space-y-5">
                    <input type="text" id="staffName" placeholder="ÂêçÂâç" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <select id="staffRole" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        <option value="waiter">„Éú„Éº„Ç§</option>
                        <option value="kitchen">„Ç≠„ÉÉ„ÉÅ„É≥</option>
                        <option value="manager">„Éû„Éç„Éº„Ç∏„É£„Éº</option>
                        <option value="catch">„Ç≠„É£„ÉÉ„ÉÅ</option>
                        <option value="driver">„Éâ„É©„Ç§„Éê„Éº</option>
                        <option value="other">„Åù„ÅÆ‰ªñ</option>
                    </select>
                    <input type="number" id="staffHourlyRate" placeholder="ÊôÇÁµ¶" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <input type="tel" id="staffPhone" placeholder="ÈõªË©±Áï™Âè∑Ôºà‰ªªÊÑèÔºâ" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">ËøΩÂä†</button>
                        <button type="button" onclick="closeModal('addStaffModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „Çπ„Çø„ÉÉ„ÉïÁ∑®ÈõÜ -->
    <div id="editStaffModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„Çπ„Çø„ÉÉ„ÉïÁ∑®ÈõÜ</h2>
                <button onclick="closeModal('editStaffModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="updateStaff(event)" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="editStaffId">
                    <input type="text" id="editStaffName" placeholder="ÂêçÂâç" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <select id="editStaffRole" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        <option value="waiter">„Éú„Éº„Ç§</option>
                        <option value="kitchen">„Ç≠„ÉÉ„ÉÅ„É≥</option>
                        <option value="manager">„Éû„Éç„Éº„Ç∏„É£„Éº</option>
                        <option value="catch">„Ç≠„É£„ÉÉ„ÉÅ</option>
                        <option value="driver">„Éâ„É©„Ç§„Éê„Éº</option>
                        <option value="other">„Åù„ÅÆ‰ªñ</option>
                    </select>
                    <input type="number" id="editStaffHourlyRate" placeholder="ÊôÇÁµ¶" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <input type="tel" id="editStaffPhone" placeholder="ÈõªË©±Áï™Âè∑Ôºà‰ªªÊÑèÔºâ" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">Êõ¥Êñ∞</button>
                        <button type="button" onclick="closeModal('editStaffModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „Ç∑„Éï„ÉàËøΩÂä† -->
    <div id="addShiftModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">„Ç∑„Éï„ÉàÁôªÈå≤</h2>
                <button onclick="closeModal('addShiftModal')" class="text-gray-400 hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="saveShift(event)" class="space-y-4 md:space-y-5">
                    <select id="shiftCast" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm"></select>
                    <input type="date" id="shiftDate" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <input type="time" id="shiftStart" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <input type="time" id="shiftEnd" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">ÁôªÈå≤</button>
                        <button type="button" onclick="closeModal('addShiftModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
// „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áä∂ÊÖã
const appState = {
  currentUser: null,
  currentMonth: new Date(),
  tables: [],
  sessions: [],
  menuItems: [],
  casts: [],
  orders: [],
  shifts: [],
  attendances: [],
  sales: 0,
  apiConnected: false,
  currentMenuImage: null,

  activeSessions: [],
  checkoutHistory: [],

  // ‚òÖ „ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞Áî®Ôºà„Åì„Çå„Å†„Åë„ÅßOKÔºâ
  currentTableId: null,
  isTableDetailOpen: false,
  currentTableDetail: null,
  currentTableSession: null,

  currentEditingMenuId: null,
};

// „Éá„Éê„ÉÉ„Ç∞Áî®„Å´„Ç∞„É≠„Éº„Éê„É´ÂÖ¨Èñã
window.appState = appState;

// Â∫óËàóÊÉÖÂ†±ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Êõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºâ
const SHOP_INFO = {
    name: 'Cabax Sample Â∫ó',                // Â∫óÂêç
    address: 'Êù±‰∫¨ÈÉΩ„Äá„ÄáÂå∫„Äá„Äá 1-2-3',      // ‰ΩèÊâÄ
    tel: '03-1234-5678'                    // ÈõªË©±Áï™Âè∑
};        
// ‚òÖ ÁÆ°ÁêÜÁîªÈù¢Áî® API Ë®≠ÂÆöÔºàÊ≥®Êñá„Ç¢„Éó„É™„Å®ÊèÉ„Åà„ÇãÔºâ
// API„Éô„Éº„ÇπURL„ÇíÂãïÁöÑ„Å´Ë®≠ÂÆö
const API_BASE_URL = (() => {
    // Êú¨Áï™Áí∞Â¢É: Âêå„Åò„Éâ„É°„Ç§„É≥„ÅÆAPI„Çí‰ΩøÁî®
    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        return `${window.location.origin}/api`;
    }
    // ÈñãÁô∫Áí∞Â¢É
    return 'http://localhost:8000/api';
})();

console.log('[Cabax Admin] API_BASE_URL:', API_BASE_URL);

const API_ENDPOINTS = {
    menu: '/menu',
    tables: '/tables',
    casts: '/casts',
    sessions: '/sessions',
    sessionsActive: '/sessions/active',
    orders: '/orders',
};


// ÂÖ±ÈÄöAPI„É™„ÇØ„Ç®„Çπ„ÉàÈñ¢Êï∞
async function apiRequest(endpointOrPath, options = {}) {
  // 'menu' „Åø„Åü„ÅÑ„Å™„Ç≠„Éº„Åß„ÇÇ '/menu' „Åø„Åü„ÅÑ„Å™„Éë„Çπ„Åß„ÇÇOK
  const path =
    (typeof API_ENDPOINTS === 'object' && API_ENDPOINTS && API_ENDPOINTS[endpointOrPath])
      ? API_ENDPOINTS[endpointOrPath]
      : endpointOrPath;

  const url = path.startsWith('http')
    ? path
    : `${API_BASE_URL}${String(path).startsWith('/') ? '' : '/'}${path}`;

  const headers = { ...(options.headers || {}) };
  if (!headers['Content-Type'] && options.body !== undefined) {
    headers['Content-Type'] = 'application/json';
  }

  const res = await fetch(url, { ...options, headers });
  const text = await res.text();

  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

  if (!res.ok) {
    const msg = data?.detail
      ? (typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail))
      : (text || 'API error');
    const err = new Error(`API ${res.status}: ${msg}`);
    err.status = res.status;
    err.data = data;
    throw err;
  }
  return data;
}

// ‚òÖ loadActiveSessionsFromApi„ÅØÂæåÊñπ„ÅßÂÆöÁæ©ÔºàÈáçË§áÂâäÈô§Ôºâ

async function fetchOrdersForSession(sessionId) {
    try {
        const data = await apiRequest(`/sessions/${sessionId}/orders`);
        return Array.isArray(data) ? data : [];
    } catch (e) {
        console.error('[admin] fetchOrdersForSession error', e);
        return [];
    }
}

// „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„ÅÆÊèèÁîªÔºà„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁúüÂÆüÔºâ
function renderTables() {
    const grid = document.getElementById('tablesGrid');
    if (!grid) return;

    const WARN_MINUTES = 10; // „ÉÅ„Çß„ÉÉ„ÇØ10ÂàÜÂâç„ÅßË≠¶ÂëäË°®Á§∫

    // ‚òÖ API„ÅÆÊó•‰ªò„ÇíUTC„Å®„Åó„Å¶Ëß£ÈáàÔºàZ„ÇÑ+09:00„ÅåÁÑ°„ÅÑÂ†¥Âêà„Å†„ÅëZ„ÇíË∂≥„ÅôÔºâ
    const parseApiDate = (iso) => {
        if (!iso || typeof iso !== 'string') return null;
        const s = iso.trim();
        const hasTZ = /Z$|[+\-]\d{2}:\d{2}$/.test(s);
        return new Date(hasTZ ? s : (s + 'Z'));
    };

    // casts „Åã„ÇâÊãÖÂΩìÂêçÂºï„Åç
    const casts = Array.isArray(appState.casts) ? appState.casts : [];
    const getCastName = (castId) => {
        const c = casts.find(x => Number(x.id) === Number(castId));
        return c ? (c.name || c.display_name || c.nickname || `#${c.id}`) : '';
    };

    const now = Date.now();
    const active = Array.isArray(appState.activeSessions) ? appState.activeSessions : [];
    const tables = Array.isArray(appState.tables) ? appState.tables : [];

    grid.innerHTML = tables.map(table => {
        const tId = Number(table.id);

        const session = active.find(s => Number(s.tableId ?? s.table_id) === tId) || null;

        const effectiveStatus = session ? 'occupied' : 'available';

        const statusClass =
            effectiveStatus === 'available' ? 'table-available'
          : effectiveStatus === 'occupied' ? 'table-occupied'
          : 'table-reserved';

        const statusText =
            effectiveStatus === 'available' ? 'Á©∫Â∏≠'
          : effectiveStatus === 'occupied' ? '‰ΩøÁî®‰∏≠'
          : '‰∫àÁ¥Ñ';

        const iconClass = `table-icon ${effectiveStatus}${table.isVip ? ' vip' : ''}`;

        // ---- Ë°®Á§∫Áî®Ôºàsession„Åå„ÅÇ„ÇãÊôÇ„Å†„ÅëÔºâ ----
        let castName = '';
        let guests = 0;
        let total = 0;

        // ‚òÖ „ÉÅ„Çß„ÉÉ„ÇØÈñ¢ÈÄ£
        let checkTimeText = '-';
        let checkRemainText = '-';
        let checkBadgeClass = 'text-gray-300';
        let cardBorderClass = '';

        if (session) {
            const castId = session.castId ?? session.cast_id ?? null;
            castName = session.castName || getCastName(castId) || 'Êú™Ë®≠ÂÆö';

            guests = Number(session.guests ?? 0);
            total = Number(session.currentTotal ?? session.current_total ?? 0);

            const startStr = session.startTime ?? session.start_time ?? null;
            const startTime = parseApiDate(startStr);

            // ‚òÖ „Çª„ÉÉ„ÉàÂàÜÊï∞/Âª∂Èï∑ÂàÜÊï∞Ôºà„Çª„ÉÉ„Ç∑„Éß„É≥„Åî„Å®„Å´Ôºâ
            const setMin = Number(session.setMinutes ?? session.set_minutes ?? 60);
            const extraMin = Number(session.extraMinutes ?? session.extra_minutes ?? 0);
            const totalMin = Math.max(0, setMin + extraMin);

            if (startTime) {
                const checkAt = new Date(startTime.getTime() + totalMin * 60 * 1000);
                const remainingMin = Math.ceil((checkAt.getTime() - now) / (60 * 1000));

                const hh = String(checkAt.getHours()).padStart(2, '0');
                const mm = String(checkAt.getMinutes()).padStart(2, '0');
                checkTimeText = `${hh}:${mm}`;

                if (remainingMin >= 0) {
                    checkRemainText = `„ÅÇ„Å®${remainingMin}ÂàÜ`;
                } else {
                    checkRemainText = `Ë∂ÖÈÅé${Math.abs(remainingMin)}ÂàÜ`;
                }

                // Ëâ≤ÂàÜ„ÅëÔºàÊÆã„ÇäÂ∞ë„Å™„ÅÑ/Ë∂ÖÈÅéÔºâ
                if (remainingMin < 0) {
                    checkBadgeClass = 'text-red-300';
                    cardBorderClass = 'ring-2 ring-red-500/40';
                } else if (remainingMin <= WARN_MINUTES) {
                    checkBadgeClass = 'text-amber-300';
                    cardBorderClass = 'ring-2 ring-amber-500/30';
                } else {
                    checkBadgeClass = 'text-emerald-300';
                }
            }
        }

        // ‚òÖ Êú™Êèê‰æõÊ≥®ÊñáÊï∞„Çí„Ç´„Ç¶„É≥„Éà
        let pendingOrderCount = 0;
        if (session && session.orders) {
            pendingOrderCount = session.orders.filter(o => 
                o.status !== 'served' && !o.is_served
            ).length;
        }

        return `
            <div class="table-card luxury-card rounded-2xl p-6 text-center ${statusClass} ${cardBorderClass}"
                 onclick="openTableDetail(${tId})">

                <div class="${iconClass}">
                    ${table.isVip ? '‚òÖ' : (table.name ?? table.id)}
                </div>

                <h3 class="text-2xl font-bold mb-2 text-gray-200">
                    „ÉÜ„Éº„Éñ„É´ ${table.name ?? table.id}
                </h3>

                <p class="text-sm font-semibold mb-3 ${
                    effectiveStatus === 'available' ? 'text-green-400'
                  : effectiveStatus === 'occupied' ? 'text-red-400'
                  : 'text-yellow-400'
                }">${statusText}</p>

                ${session ? `
                    <div class="text-xs text-gray-300 space-y-1 text-left bg-gray-900/40 border border-gray-800 rounded-xl p-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">ÊãÖÂΩì</span>
                            <span class="font-semibold text-gray-200">${castName}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">‰∫∫Êï∞</span>
                            <span class="font-semibold text-gray-200">${guests}Âêç</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">„ÉÅ„Çß„ÉÉ„ÇØ</span>
                            <span class="font-semibold ${checkBadgeClass}">
                                ${checkTimeText}Ôºà${checkRemainText}Ôºâ
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Â∞èË®à</span>
                            <span class="font-bold text-amber-300">¬•${total.toLocaleString()}</span>
                        </div>
                        ${pendingOrderCount > 0 ? `
                        <div class="flex justify-between mt-1 pt-1 border-t border-gray-700">
                            <span class="text-gray-400">Êú™Êèê‰æõ</span>
                            <span class="font-bold text-red-400 animate-pulse">‚ö† ${pendingOrderCount}‰ª∂</span>
                        </div>
                        ` : ''}
                    </div>
                ` : `
                    <p class="text-xs text-gray-500">Êú™ÂÖ•Â∫ó</p>
                `}
            </div>
        `;
    }).join('');
}

async function handleTableCardClick(tableId) {
    // „Åæ„ÅöÊúÄÊñ∞Áä∂ÊÖã„Å´ÂêåÊúü
    if (typeof syncWithBackend === 'function') {
        await syncWithBackend();
    }

    // ÂêåÊúüÂæå„ÅÆ tables / activeSessions „Åã„ÇâÊãæ„ÅÑÁõ¥„Åô
    const table = appState.tables.find(t => Number(t.id) === Number(tableId)) || null;
    const session = Array.isArray(appState.activeSessions)
        ? appState.activeSessions.find(
            s => Number(s.tableId ?? s.table_id) === Number(tableId)
        )
        : null;

    appState.currentTableDetail = table;
    appState.currentTableSession = session;

    // Ë©≥Á¥∞„Éë„Éç„É´Èñã„Åè
    if (typeof openTableDetailPanel === 'function') {
        openTableDetailPanel();
    }

    // ‰∏≠Ë∫´„ÇíÊèèÁîª
    if (typeof renderTableDetailPanel === 'function') {
        renderTableDetailPanel();
    }
}

function renderTableDetailPanel(session) {
  const panel = document.getElementById('tableDetailPanel');
  if (!panel) return;
  panel.classList.remove('hidden');

  const s = session || {};
  const hasSession = !!s?.id && s.id !== '-' && s.id !== null && s.id !== undefined;

  const menu = Array.isArray(s._menu) ? s._menu : [];
  const orders = Array.isArray(s._orders) ? s._orders : [];
  const casts = Array.isArray(s._casts) ? s._casts : [];

  const fmtDT = (iso) => {
    if (!iso) return '‚Äî';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return String(iso);
    return d.toLocaleString('ja-JP', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  };

  const yen = (n) => (Number(n || 0)).toLocaleString('ja-JP');

  const setMinutes = Number(s.set_minutes ?? 60);
  const extraMinutes = Number(s.extra_minutes ?? 0);

  const optSet = (v) => `<option value="${v}" ${setMinutes === v ? 'selected' : ''}>${v}ÂàÜ</option>`;

  // ===== Cabax: Dark + Navy + Gold accent =====
  const gold = "text-[#d6b36a]";
  const borderGold = "border-[#3a2a0a]";
  const card = "bg-[#0f141b]/80 border border-white/10";
  const shadowLux = "shadow-[0_20px_60px_rgba(0,0,0,0.55)]";

  const btnBase = "px-4 py-2 rounded-xl font-semibold transition active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed";
  const btnPri = `${btnBase} bg-[#0b1b3a] text-white hover:bg-[#0e234a] border border-white/10`;
  const btnSec = `${btnBase} bg-white/5 text-white hover:bg-white/10 border border-white/10`;
  const btnDis = `${btnBase} bg-white/5 text-white/30 border border-white/10`;

  // „Éâ„É™„É≥„ÇØ‰æ°Ê†ºË°®Á§∫
  const customerDrinkNames = ['„É¨„É¢„É≥„Çµ„ÉØ„Éº', '„Ç≥„Éº„ÇØ„Éè„Ç§', '„Ç∏„É≥„Ç∏„É£„Éº„Éè„Ç§', '„Éì„Éº„É´', '„Ç´„ÇØ„ÉÜ„É´', '„ÇΩ„Éï„Éà„Éâ„É™„É≥„ÇØ'];
  const castDrinkNames = ['È∫¶ÁÑºÈÖé', '„Ç¶„Ç§„Çπ„Ç≠„Éº'];
  const paidDrinkNames = ['„Ç∑„Éß„ÉÉ„Éà', '„Ç∞„É©„Çπ„ÉØ„Ç§„É≥'];
  const tableSetNames = ['„Ç¢„Ç§„Çπ„Çª„ÉÉ„Éà', '„Ç¢„Ç§„ÇπÔºàËøΩÂä†Ôºâ', '„Ç∞„É©„ÇπÔºàËøΩÂä†Ôºâ', '„Ç¶„Éº„É≠„É≥Ëå∂„Éî„ÉÉ„ÉÅ„É£„Éº', 'Á∑ëËå∂„Éî„ÉÉ„ÉÅ„É£„Éº', 'ÁÇ≠ÈÖ∏Ê∞¥', 'Á¥ÖËå∂„Éî„ÉÉ„ÉÅ„É£„Éº', '„Ç∏„É£„Çπ„Éü„É≥Ëå∂„Éî„ÉÉ„ÉÅ„É£„Éº', '„Ç≥„Éº„Éí„Éº„Éî„ÉÉ„ÉÅ„É£„Éº', '„Éü„Éç„É©„É´„Ç¶„Ç©„Éº„Çø„Éº'];
  
  const menuOptions = menu.length
    ? menu.map(m => {
        let priceLabel = `¬•${yen(m.price)}`;
        if (customerDrinkNames.includes(m.name)) {
          priceLabel = '„Çª„ÉÉ„ÉàËæº';
        } else if (castDrinkNames.includes(m.name)) {
          priceLabel = '„Çµ„Ç§„Ç∫Âà•';
        } else if (tableSetNames.includes(m.name)) {
          priceLabel = '„Çª„ÉÉ„ÉàËæº';
        } else if (paidDrinkNames.includes(m.name)) {
          priceLabel = `¬•${yen(m.price)}`;
        }
        return `<option value="${m.id}">${m.name}Ôºà${priceLabel}Ôºâ</option>`;
      }).join('')
    : `<option value="">Ôºà„É°„Éã„É•„ÉºÊú™ÂèñÂæóÔºâ</option>`;

  const castOptions = (() => {
  const freeOpt = `<option value="free">„Éï„É™„Éº</option>`;
  if (!casts.length) return `${freeOpt}<option value="">Ôºà„Ç≠„É£„Çπ„ÉàÊú™ÂèñÂæóÔºâ</option>`;
  const list = casts
    .map(c => `<option value="${c.id}">${c.stage_name ?? c.name ?? `Cast#${c.id}`}</option>`)
    .join('');
  return `${freeOpt}${list}`;
})();

  // Ë§áÊï∞ÊåáÂêç„Ç≠„É£„Çπ„ÉàÁî®„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ
  const castCheckboxes = (() => {
    if (!casts.length) return '<div class="text-white/50 text-sm">„Ç≠„É£„Çπ„ÉàÊú™ÂèñÂæó</div>';
    return casts.map(c => `
      <label class="flex items-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30 hover:border-amber-500/30">
        <input type="checkbox" class="shimei-cast-checkbox w-4 h-4 accent-[#d6b36a]" value="${c.id}" data-name="${c.stage_name ?? c.name ?? `Cast#${c.id}`}">
        <span class="text-sm text-white/90">${c.stage_name ?? c.name ?? `Cast#${c.id}`}</span>
      </label>
    `).join('');
  })();

  const ordersHtml = orders.length
    ? orders.map((o, idx) => {
        const line = (Number(o.price || 0) * Number(o.quantity || 0));
        const isServed = o.status === 'served' || o.is_served;
        const statusClass = isServed 
          ? 'bg-green-500/20 text-green-400 border-green-500/30' 
          : 'bg-amber-500/20 text-amber-400 border-amber-500/30';
        const statusText = isServed ? '‚úì Êèê‰æõÊ∏à' : '‚è≥ Êú™Êèê‰æõ';
        const statusBtnClass = isServed
          ? 'bg-gray-600/50 text-gray-400 hover:bg-red-500/30 hover:text-red-400'
          : 'bg-green-600/30 text-green-400 hover:bg-green-500/50';
        const statusBtnText = isServed ? 'Êú™Êèê‰æõ„Å´Êàª„Åô' : 'Êèê‰æõÊ∏à„Åø„Å´„Åô„Çã';
        
        return `
          <div class="flex items-center justify-between gap-3 py-3 border-b border-white/10" data-order-id="${o.id}" data-order-idx="${idx}">
            <div class="min-w-0 flex-1">
              <div class="flex items-center gap-2">
                <span class="text-white/90 font-semibold truncate">${o.item_name ?? `#${o.menu_item_id}`}</span>
                <span class="px-2 py-0.5 text-[10px] font-bold rounded-full border ${statusClass}">${statusText}</span>
              </div>
              <div class="text-xs text-white/45 mt-1">${fmtDT(o.created_at)} / Êï∞Èáè ${o.quantity}</div>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <div class="text-white/90 font-bold">¬•${yen(line)}</div>
                <div class="text-xs text-white/45">Âçò‰æ° ¬•${yen(o.price)}</div>
              </div>
              <button 
                onclick="toggleOrderStatus(${s.id}, ${o.id}, ${isServed ? 'false' : 'true'})"
                class="px-2 py-1 text-xs rounded-lg transition ${statusBtnClass}"
              >${statusBtnText}</button>
            </div>
          </div>
        `;
      }).join('')
    : `<div class="text-white/50 text-sm">Ê≥®Êñá„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;

  panel.innerHTML = `
  <div id="tableDetailOverlay" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-3">
    <div id="tableDetailModal" class="w-full max-w-2xl max-h-[92vh] flex flex-col rounded-2xl overflow-hidden ${shadowLux} border ${borderGold} bg-gradient-to-b from-[#0b0f14] to-[#070a0d]">

      <div class="sticky top-0 z-10 p-4 border-b border-white/10 bg-[#070a0d]/90 backdrop-blur">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-[11px] tracking-widest uppercase text-white/50">Table Detail</div>
            <div class="text-2xl font-extrabold text-white">
              „ÉÜ„Éº„Éñ„É´ <span class="${gold}">${s.table_id ?? '‚Äî'}</span>
            </div>
            <div class="text-xs text-white/50 mt-1">
              Session: <span class="text-white/80">${hasSession ? s.id : '„Å™„Åó'}</span>
            </div>
          </div>
          <button id="btnCloseTableDetail" class="${btnSec}">Èñâ„Åò„Çã</button>
        </div>
        <div id="tableDetailMsg" class="text-sm text-white/70 mt-3"></div>
      </div>

      <div class="p-4 space-y-4 overflow-y-auto">

        ${
          !hasSession ? `
          <!-- „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÔºàÁÆ°ÁêÜ„Åã„ÇâÈñãÂßã„Åß„Åç„Çã„Çà„ÅÜ„Å´Âæ©Ê¥ªÔºâ -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÔºàÁÆ°ÁêÜÔºâ</div>
            
            <!-- Âü∫Êú¨ÊÉÖÂ†± -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">ÂÆ¢‰∫∫Êï∞</div>
                <input id="inpStartGuests" type="number" min="1" value="1"
                       onchange="updateStartCharges()"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
              </label>
              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">„Ç≠„É£„ÉÉ„ÉÅÔºà‰ªªÊÑèÔºâ</div>
                <input id="inpStartCatch" type="text" placeholder="‰æãÔºâÂ±±Áî∞"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
              </label>
            </div>
            
            <!-- ÊåáÂêç„Ç≠„É£„Çπ„ÉàÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ -->
            <div class="border-t border-white/10 pt-4 mt-4">
              <div class="font-bold text-white mb-3 flex items-center gap-2">
                üëë ÊåáÂêç
                <span class="text-xs text-white/40">ÔºàË§áÊï∞ÂèØ„Éª„Éê„ÉÉ„ÇØ„ÅØ‰∫∫Êï∞„ÅßÁ≠âÂàÜÔºâ</span>
              </div>
              <div class="text-xs text-white/50 mb-2">‚Äª ÊåáÂêç„Å™„Åó„ÅÆÂ†¥Âêà„ÅØ„Äå„Éï„É™„Éº„ÄçÊâ±„ÅÑ</div>
              <div id="shimeiCastList" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto pr-2 scrollbar-thin">
                ${castCheckboxes}
              </div>
              <div id="shimeiCastPreview" class="mt-2 text-sm text-amber-400"></div>
            </div>
            
            <!-- ÊñôÈáëË®≠ÂÆö -->
            <div class="border-t border-white/10 pt-4 mt-4">
              <div class="font-bold text-white mb-3 flex items-center gap-2">
                üí∞ ÊñôÈáëË®≠ÂÆö
                <span class="text-xs text-white/40">Ôºà„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊôÇ„Å´Ëá™ÂãïË®à‰∏äÔºâ</span>
              </div>
              
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                <!-- „Çª„ÉÉ„ÉàÊñôÈáë -->
                <label class="block">
                  <div class="text-[11px] text-white/50 mb-1">„Çª„ÉÉ„ÉàÊñôÈáëÔºà1Âêç„ÅÇ„Åü„ÇäÔºâ</div>
                  <input id="inpSetPrice" type="number" min="0" step="100" value="5000"
                         onchange="updateStartCharges()"
                         class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                </label>
                
                <!-- TAX/„Çµ„Éº„Éì„ÇπÊñô -->
                <label class="block">
                  <div class="text-[11px] text-white/50 mb-1">TAX/„Çµ„Éº„Éì„ÇπÊñôÔºà%Ôºâ</div>
                  <select id="selTaxRate" onchange="updateStartCharges()"
                          class="rounded-xl px-3 py-2 w-full bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                    <option value="0">0%Ôºà„Ç´„ÉÉ„ÉàÔºâ</option>
                    <option value="10">10%</option>
                    <option value="15">15%</option>
                    <option value="20" selected>20%</option>
                    <option value="25">25%</option>
                    <option value="30">30%</option>
                  </select>
                </label>
              </div>
              
              <!-- „Ç™„Éó„Ç∑„Éß„É≥ÊñôÈáë -->
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-3">
                <label class="flex items-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                  <input id="chkDouhan" type="checkbox" onchange="updateStartCharges()" class="w-4 h-4 accent-[#d6b36a]">
                  <span class="text-sm text-white/90">Âêå‰º¥ <span class="text-amber-400">¬•3,000</span></span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                  <input id="chkSingle" type="checkbox" onchange="updateStartCharges()" class="w-4 h-4 accent-[#d6b36a]">
                  <span class="text-sm text-white/90">„Ç∑„É≥„Ç∞„É´ <span class="text-amber-400">¬•2,000</span></span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                  <input id="chkFree" type="checkbox" onchange="updateStartCharges()" class="w-4 h-4 accent-[#d6b36a]">
                  <span class="text-sm text-white/90">„Éï„É™„Éº <span class="text-gray-400">Ââ≤Âºï</span></span>
                </label>
              </div>
              
              <!-- ÊñôÈáë„Éó„É¨„Éì„É•„Éº -->
              <div id="startChargesPreview" class="p-3 rounded-xl bg-gradient-to-r from-amber-900/20 to-transparent border border-amber-500/20">
                <div class="text-xs text-white/50 mb-2">ÈñãÂßãÊôÇ„ÅÆËá™ÂãïË®à‰∏äÈ°çÔºàÁ®é„ÇµËæºÔºâ</div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div class="text-white/70">„Çª„ÉÉ„ÉàÊñôÈáë:</div>
                  <div id="previewSetTotal" class="text-right text-white font-semibold">¬•5,000</div>
                  <div class="text-white/70">„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏:</div>
                  <div id="previewSingle" class="text-right text-white font-semibold">¬•2,000</div>
                  <div class="text-white/70">Âêå‰º¥Êñô:</div>
                  <div id="previewDouhan" class="text-right text-white font-semibold">¬•0</div>
                  <div class="text-white/70">ÊåáÂêçÊñô:</div>
                  <div id="previewShimei" class="text-right text-white font-semibold">¬•0</div>
                  <div class="text-white/70">TAX/„Çµ„Éº„Éì„Çπ:</div>
                  <div id="previewTax" class="text-right text-white font-semibold">¬•0</div>
                  <div class="border-t border-white/20 pt-2 text-white font-bold">ÂêàË®à:</div>
                  <div id="previewTotal" class="border-t border-white/20 pt-2 text-right text-amber-400 font-bold text-lg">¬•0</div>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end mt-4">
              <button id="btnStartSession" class="${btnPri}">„Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„ÅßÈñãÂßã</button>
            </div>
            <div class="text-xs text-white/45 mt-2">
              ‚ÄªÈñãÂßã„Åô„Çã„Å®„ÉÜ„Éº„Éñ„É´„ÅØ„Äå‰ΩøÁî®‰∏≠„ÄçÊâ±„ÅÑ„Å´„Å™„Çä„ÄÅ‰ª•Âæå„ÅØÂª∂Èï∑/Ê≥®Êñá/Á≤æÁÆó„ÅåÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ
            </div>
          </div>
          ` : `
          <!-- KPI -->
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">ÈñãÂßã</div>
              <div class="font-semibold text-white/90">${fmtDT(s.start_time)}</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">„ÉÅ„Çß„ÉÉ„ÇØ‰∫àÂÆö</div>
              <div class="font-semibold ${gold}">${fmtDT(s.check_due_at)}</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">Â∞èË®àÔºàDBÔºâ</div>
              <div class="font-extrabold text-lg text-white">¬•${yen(s.current_total)}</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">„Çª„ÉÉ„ÉàÂàÜÊï∞</div>
              <div class="font-semibold text-white/90">${setMinutes}ÂàÜ</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">Âª∂Èï∑ÂàÜ</div>
              <div class="font-semibold text-white/90">+${extraMinutes}ÂàÜ</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">Âª∂Èï∑ÂõûÊï∞</div>
              <div class="font-semibold text-white/90">${Number(s.extension_count ?? 0)}Âõû</div>
            </div>
          </div>

          <!-- ‰ºöË®à„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ -->
          ${(() => {
            const taxRate = Number(s.tax_rate ?? 20);
            const currentSubtotal = Number(s.current_total ?? 0);
            const guests = Number(s.guests ?? 1);
            
            // ÊåáÂêç„Ç≠„É£„Çπ„ÉàÊï∞„ÇíÂèñÂæó
            const shimeiCastsStr = s.shimei_casts || '';
            const shimeiCount = shimeiCastsStr ? shimeiCastsStr.split(',').filter(n => n.trim()).length : 0;
            
            // „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏Ôºà1Âêç„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            const singleCharge = guests === 1 ? 2000 : 0;
            
            // 30ÂàÜÂª∂Èï∑ÊñôÈáëÔºà„Éè„Éº„ÉïÔºâ= ‰∫∫Êï∞√ó3000 + ÊåáÂêçÊï∞√ó2000 + „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏
            const halfExtension = (guests * 3000) + (shimeiCount * 2000) + singleCharge;
            // 60ÂàÜÂª∂Èï∑ÊñôÈáëÔºà1„Çª„ÉÉ„ÉàÔºâ= ‰∫∫Êï∞√ó5000 + ÊåáÂêçÊï∞√ó2000 + „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏
            const fullExtension = (guests * 5000) + (shimeiCount * 2000) + singleCharge;
            
            // ÁèæÂú®„ÅÆ‰ºöË®à
            const currentTax = Math.floor(currentSubtotal * (taxRate / 100));
            const currentTotal = currentSubtotal + currentTax;
            
            // 30ÂàÜÂª∂Èï∑ÊôÇ
            const subtotal30 = currentSubtotal + halfExtension;
            const tax30 = Math.floor(subtotal30 * (taxRate / 100));
            const total30 = subtotal30 + tax30;
            
            // 60ÂàÜÂª∂Èï∑ÊôÇ
            const subtotal60 = currentSubtotal + fullExtension;
            const tax60 = Math.floor(subtotal60 * (taxRate / 100));
            const total60 = subtotal60 + tax60;
            
            // Âª∂Èï∑ÂÜÖË®≥„ÅÆË™¨ÊòéÊñá
            const ext30Desc = `${guests}Âêç√ó3000${singleCharge > 0 ? ' + SC' : ''}${shimeiCount > 0 ? ` + ÊåáÂêç${shimeiCount}√ó2000` : ''}`;
            const ext60Desc = `${guests}Âêç√ó5000${singleCharge > 0 ? ' + SC' : ''}${shimeiCount > 0 ? ` + ÊåáÂêç${shimeiCount}√ó2000` : ''}`;
            
            return `
          <div class="p-4 rounded-2xl border border-amber-500/30 bg-amber-500/5">
            <div class="font-bold text-white mb-3">üí∞ ‰ºöË®à„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ <span class="text-white/40 text-xs">ÔºàTAX ${taxRate}%ËæºÔºâ</span></div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div class="p-3 rounded-xl bg-black/30 border border-white/10">
                <div class="text-[11px] text-white/50 mb-1">‰ªä„Åô„Åê‰ºöË®à</div>
                <div class="text-xs text-white/60">Â∞èË®à: ¬•${yen(currentSubtotal)}</div>
                <div class="text-xs text-white/60">TAX: ¬•${yen(currentTax)}</div>
                <div class="font-extrabold text-xl ${gold}">¬•${yen(currentTotal)}</div>
              </div>
              <div class="p-3 rounded-xl bg-black/30 border border-blue-500/30">
                <div class="text-[11px] text-blue-400 mb-1">+30ÂàÜÂª∂Èï∑Âæå</div>
                <div class="text-xs text-white/60">+¬•${yen(halfExtension)}Ôºà${ext30Desc}Ôºâ</div>
                <div class="text-xs text-white/60">Â∞èË®à: ¬•${yen(subtotal30)} / TAX: ¬•${yen(tax30)}</div>
                <div class="font-extrabold text-xl text-blue-300">¬•${yen(total30)}</div>
                <div class="text-[10px] text-white/40 mt-1">Ôºà+¬•${yen(total30 - currentTotal)}Ôºâ</div>
              </div>
              <div class="p-3 rounded-xl bg-black/30 border border-purple-500/30">
                <div class="text-[11px] text-purple-400 mb-1">+60ÂàÜÂª∂Èï∑Âæå</div>
                <div class="text-xs text-white/60">+¬•${yen(fullExtension)}Ôºà${ext60Desc}Ôºâ</div>
                <div class="text-xs text-white/60">Â∞èË®à: ¬•${yen(subtotal60)} / TAX: ¬•${yen(tax60)}</div>
                <div class="font-extrabold text-xl text-purple-300">¬•${yen(total60)}</div>
                <div class="text-[10px] text-white/40 mt-1">Ôºà+¬•${yen(total60 - currentTotal)}Ôºâ</div>
              </div>
            </div>
          </div>
            `;
          })()}

          <!-- Âª∂Èï∑Ë®àÁÆóÂÖ•Âäõ -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">Âª∂Èï∑Ë®àÁÆó„ÅÆÂÖ•Âäõ <span class="text-white/40 text-xs">ÔºàÊ¨°ÂõûÂª∂Èï∑„Åã„ÇâÂèçÊò†Ôºâ</span></div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">ÂÆ¢‰∫∫Êï∞</div>
                <input id="inpGuests" type="number" min="0"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60"
                       value="${Number(s.guests ?? 0)}">
              </label>

              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">Â†¥ÂÜÖÊåáÂêç‰∫∫Êï∞</div>
                <input id="inpInhouse" type="number" min="0"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60"
                       value="${Number(s.inhouse_nomination_count ?? 0)}">
              </label>

              <label class="flex items-center gap-2 mt-2 sm:mt-7">
                <input id="chkHon" type="checkbox" class="w-4 h-4 accent-[#d6b36a]"
                       ${s.has_hon_nomination ? 'checked' : ''}>
                <span class="font-semibold text-white/90">Êú¨ÊåáÂêç <span class="${gold}">Ôºà+3000Ôºâ</span></span>
              </label>
            </div>
            <div class="flex justify-end mt-4">
              <button id="btnSaveAttrs" class="${btnSec}">‰øùÂ≠ò</button>
            </div>
          </div>

          <!-- „Çª„ÉÉ„ÉàÂàÜÊï∞ -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">„Çª„ÉÉ„ÉàÂàÜÊï∞„ÅÆÂ§âÊõ¥</div>
            <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
              <select id="selSetMinutes"
                      class="rounded-xl px-3 py-2 w-full sm:w-48 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                ${optSet(30)}${optSet(45)}${optSet(60)}${optSet(90)}${optSet(120)}${optSet(150)}${optSet(180)}
              </select>
              <button id="btnUpdateTiming" class="${btnSec}">
                „Çª„ÉÉ„ÉàÂàÜÊï∞„ÇíÊõ¥Êñ∞
              </button>
            </div>
            <div class="text-xs text-white/45 mt-2">
              ‚Äª„ÉÅ„Çß„ÉÉ„ÇØ‰∫àÂÆöÊôÇÂàª„ÅØ„ÄåÈñãÂßã + „Çª„ÉÉ„ÉàÂàÜÊï∞ + Âª∂Èï∑ÂàÜ„Äç„ÄÇ
            </div>
          </div>

          <!-- Âª∂Èï∑ -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">Âª∂Èï∑ <span class="${gold}">ÔºàËá™ÂãïÊ≥®Êñá„ÅåÂÖ•„Çä„Åæ„ÅôÔºâ</span></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <button id="btnExtend30" class="${btnPri}">
                „Éè„Éº„ÉïÂª∂Èï∑ 30ÂàÜÔºàËá™ÂãïÊ≥®ÊñáÔºâ
              </button>
              <button id="btnExtend60" class="${btnPri}">
                1„Çª„ÉÉ„ÉàÂª∂Èï∑ 60ÂàÜÔºàËá™ÂãïÊ≥®ÊñáÔºâ
              </button>
            </div>
          </div>

          <!-- ËøΩÂä†Ê≥®Êñá -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">ËøΩÂä†Ê≥®Êñá</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="block sm:col-span-2">
                <div class="text-[11px] text-white/50 mb-1">„É°„Éã„É•„Éº</div>
                <select id="selAddOrderItem" onchange="onOrderMenuChange()"
                        class="rounded-xl px-3 py-2 w-full bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                  ${menuOptions}
                </select>
              </label>
              
              <!-- „Éâ„É™„É≥„ÇØ„Çµ„Ç§„Ç∫ÈÅ∏ÊäûÔºà„Éâ„É™„É≥„ÇØ„Ç´„ÉÜ„Ç¥„É™ÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
              <div id="drinkSizeSection" class="sm:col-span-2 hidden">
                <div class="text-[11px] text-white/50 mb-1">„Éâ„É™„É≥„ÇØ„Çµ„Ç§„Ç∫</div>
                <div class="grid grid-cols-3 gap-2">
                  <label class="drink-size-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border-2 border-amber-500 bg-amber-500/20 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkSize" value="single" checked onchange="updateDrinkSizeStyle()" class="hidden">
                    <span class="text-sm text-white/90 text-center">„Ç∑„É≥„Ç∞„É´<br><span class="text-amber-400 font-bold">¬•1,000</span></span>
                  </label>
                  <label class="drink-size-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkSize" value="double" onchange="updateDrinkSizeStyle()" class="hidden">
                    <span class="text-sm text-white/90 text-center">„ÉÄ„Éñ„É´<br><span class="text-amber-400 font-bold">¬•2,000</span></span>
                  </label>
                  <label class="drink-size-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkSize" value="triple" onchange="updateDrinkSizeStyle()" class="hidden">
                    <span class="text-sm text-white/90 text-center">„Éà„É™„Éó„É´<br><span class="text-amber-400 font-bold">¬•3,000</span></span>
                  </label>
                </div>
              </div>
              
              <!-- Ââ≤„ÇäÊñπ„ÉªÁ®ÆÈ°ûÈÅ∏ÊäûÔºàÈ∫¶ÁÑºÈÖé„ÄÅ„Ç¶„Ç§„Çπ„Ç≠„Éº„ÄÅ„Éì„Éº„É´„ÄÅ„Ç´„ÇØ„ÉÜ„É´„ÄÅ„ÇΩ„Éï„Éà„Éâ„É™„É≥„ÇØ„ÄÅ„Ç∑„Éß„ÉÉ„Éà„ÄÅ„Ç∞„É©„Çπ„ÉØ„Ç§„É≥ÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
              <div id="mixStyleSection" class="sm:col-span-2 hidden">
                <div class="text-[11px] text-white/50 mb-1">Á®ÆÈ°û„ÇíÈÅ∏Êäû</div>
                <div id="mixStyleOptions" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                  <!-- JS„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
              </div>
              
              <!-- Ë™∞„ÅåÈ£≤„ÇÄ„ÅãÈÅ∏ÊäûÔºà„Éâ„É™„É≥„ÇØ/„Éú„Éà„É´/„Ç∑„É£„É≥„Éë„É≥ÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
              <div id="drinkForSection" class="sm:col-span-2 hidden">
                <div class="text-[11px] text-white/50 mb-1">Ë™∞„ÅåÈ£≤„ÇÄÔºü</div>
                <div class="grid grid-cols-3 gap-2 mb-2">
                  <label class="drink-for-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border-2 border-blue-500 bg-blue-500/20 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkFor" value="customer" checked onchange="onDrinkForChange(); updateDrinkForStyle()" class="hidden">
                    <span class="text-sm text-white/90">üë§ „ÅäÂÆ¢Êßò</span>
                  </label>
                  <label class="drink-for-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkFor" value="staff" onchange="onDrinkForChange(); updateDrinkForStyle()" class="hidden">
                    <span class="text-sm text-white/90">üßë‚Äçüíº „Çπ„Çø„ÉÉ„Éï</span>
                  </label>
                  <label class="drink-for-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkFor" value="cast" onchange="onDrinkForChange(); updateDrinkForStyle()" class="hidden">
                    <span class="text-sm text-white/90">„Ç≠„É£„Çπ„Éà</span>
                  </label>
                </div>
                
                <!-- „Ç≠„É£„Çπ„Éà/„Çπ„Çø„ÉÉ„ÉïÈÅ∏ÊäûÔºà„Ç≠„É£„Çπ„Éàor„Çπ„Çø„ÉÉ„ÉïÈÅ∏ÊäûÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
                <div id="personSelectSection" class="hidden">
                  <select id="selDrinkPerson"
                          class="rounded-xl px-3 py-2 w-full bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                  </select>
                  <div id="drinkBackInfo" class="mt-2 text-xs text-purple-400 hidden">
                    
                  </div>
                </div>
              </div>
              
              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">Êï∞Èáè</div>
                <input id="inpAddOrderQty" type="number" min="1" value="1"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
              </label>
            </div>
            <div class="flex justify-end mt-4">
              <button id="btnAddOrder" class="${btnPri}">
                Ê≥®Êñá„ÇíËøΩÂä†
              </button>
            </div>
          </div>

          <!-- Ê≥®ÊñáÂ±•Ê≠¥ -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">Ê≥®ÊñáÂ±•Ê≠¥ÔºàDBÔºâ</div>
            <div class="max-h-64 overflow-y-auto pr-1">
              ${ordersHtml}
            </div>
          </div>

          <!-- Á≤æÁÆó -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="font-bold text-white">Á≤æÁÆó</div>
                <div class="text-xs text-white/45">‚ÄªDBÊ≥®ÊñáÂêàË®à„Åã„ÇâÂÜçË®àÁÆóÔºàcheckoutÔºâ</div>
              </div>
              <button id="btnCheckout" class="${btnPri}">
                Á≤æÁÆó„Åô„Çã
              </button>
            </div>
          </div>
          `
        }

        <div class="h-2"></div>
      </div>
    </div>
  </div>
  `;
}


function showTableDetailPanel({ tableId, session, orders }) {
    const panel = document.getElementById('tableDetailPanel');
    if (!panel) {
        console.error('[admin] tableDetailPanel „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
    }

    // ‚òÖ „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁÑ°„ÅÑÔºàÔºùÁ©∫Â∏≠„Éª„Åæ„Å†ÂÖ•Â∫ó„Åó„Å¶„ÅÑ„Å™„ÅÑÔºâ
    if (!session) {
        panel.innerHTML = `
            <div class="p-4 space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-100">
                        „ÉÜ„Éº„Éñ„É´ ${tableId}
                    </h2>
                    <button class="text-sm text-gray-400" onclick="closeTableDetailPanel()">‚úï</button>
                </div>
                <p class="text-sm text-gray-400">„Åæ„Å†ÂÖ•Â∫óÂá¶ÁêÜ„Åå„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
            </div>
        `;
        panel.classList.remove('hidden');
        return;
    }

    const total = (
        session.currentTotal ?? session.current_total ?? 0
    );

    panel.innerHTML = `
        <div class="p-4 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-100">
                    „ÉÜ„Éº„Éñ„É´ ${tableId}Ôºà„Çª„ÉÉ„Ç∑„Éß„É≥ID: ${session.id}Ôºâ
                </h2>
                <button class="text-sm text-gray-400" onclick="closeTableDetailPanel()">‚úï</button>
            </div>

            <div class="space-y-1 text-sm text-gray-300">
                <p>‰∫∫Êï∞Ôºö${session.guests}Âêç</p>
                <p>„Ç≠„É£„ÉÉ„ÉÅÔºö${session.catchStaff || '„Å™„Åó'}</p>
                <p class="font-semibold text-amber-300">
                    ÁèæÂú®ÂêàË®àÔºö¬•${total.toLocaleString()}
                </p>
            </div>

            <div class="pt-2 border-t border-gray-700">
                <h3 class="text-sm font-semibold text-gray-200 mb-2">Ê≥®ÊñáÂ±•Ê≠¥</h3>
                <p class="text-sm text-gray-500">
                    ‚Äª ‰ªä„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ current_total „ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàÂ±•Ê≠¥„ÅØÂæå„ÅßËøΩÂä†Ôºâ
                </p>
            </div>

            <div class="flex gap-2 pt-4 border-t border-gray-700">
                <button class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg text-sm"
                        onclick="checkoutSession(${session.id})">
                    Ê∏ÖÁÆóÔºà„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÔºâ
                </button>
            </div>
        </div>
    `;

    panel.classList.remove('hidden');
}

// ‚òÖ Ê∏ÖÁÆó„Éú„Çø„É≥Ôºö„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅßÊ∏ÖÁÆó ‚Üí API„Åã„ÇâÊúÄÊñ∞Áä∂ÊÖã„ÇíÂèñ„ÇäÁõ¥„Åó„Å¶ÂèçÊò†
async function checkoutSession(sessionId) {
    
    
    
    if (!confirm('„Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„ÇíÊ∏ÖÁÆó„Åó„Å¶Á©∫Â∏≠„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')) {
        return;
    }

    try {
        // ‚òÖ Á≤æÁÆóÂâç„Å´„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„Çí‰øùÂ≠òÔºàAPI„Åã„ÇâÊ∂à„Åà„ÇãÂâç„Å´Ôºâ
        // Âûã„Çí‰∏°ÊñπË©¶„ÅôÔºàÊï∞ÂÄ§„Å®ÊñáÂ≠óÂàóÔºâ
        const numId = Number(sessionId);
        const sessionToCheckout = appState.activeSessions.find(s => 
            Number(s.id) === numId
        );
        
        // ‚òÖ ‰ºùÁ•®Áî®„Å´„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„Å®Ê≥®Êñá„ÇíÂèñÂæó
        let ordersForReceipt = [];
        try {
            const ordersData = await apiRequest(`/sessions/${sessionId}/orders`);
            ordersForReceipt = Array.isArray(ordersData) ? ordersData : [];
        } catch (e) {
            console.warn('[checkout] orders fetch failed:', e);
            ordersForReceipt = sessionToCheckout?.orders || [];
        }
        
        // ‚òÖ ‰ºöË®àÊôÇ„Å´TAX„ÇíË®àÁÆó
        const taxRate = sessionToCheckout?.taxRate || sessionToCheckout?.tax_rate || 20;
        const subtotalAmount = ordersForReceipt.reduce((sum, o) => sum + (o.price * o.quantity), 0);
        const taxAmount = Math.floor(subtotalAmount * (taxRate / 100));
        const totalWithTax = subtotalAmount + taxAmount;
        
        // TAX„ÇíÊ≥®Êñá„É™„Çπ„Éà„Å´ËøΩÂä†Ôºà„É¨„Ç∑„Éº„ÉàË°®Á§∫Áî®Ôºâ
        if (taxAmount > 0) {
            ordersForReceipt.push({
                item_name: `TAX/„Çµ„Éº„Éì„ÇπÔºà${taxRate}%Ôºâ`,
                quantity: 1,
                price: taxAmount
            });
        }
        
        // 1. „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÂÅ¥„ÅßÊ∏ÖÁÆó
        const result = await apiRequest(`${API_ENDPOINTS.sessions}/${sessionId}/checkout`, {
            method: 'PUT',
        });
        

        // ‚òÖ checkoutHistory„Å´ËøΩÂä†ÔºàÁ≤æÁÆóÊ∏à„Åø„Çª„ÉÉ„Ç∑„Éß„É≥„Çí‰øùÊåÅÔºâ
        if (sessionToCheckout) {
            const checkoutRecord = {
                ...sessionToCheckout,
                checkoutTime: new Date().toISOString(),
                totalAmount: totalWithTax,
                orders: ordersForReceipt, // Ê≥®ÊñáÂ±•Ê≠¥„Çí‰øùÂ≠ò
                status: 'completed'
            };
            appState.checkoutHistory.push(checkoutRecord);
            
            
            
            // localStorage„Å´„ÇÇ‰øùÂ≠ò
            try {
                localStorage.setItem('cabax_checkoutHistory', JSON.stringify(appState.checkoutHistory));
                
            } catch (e) {
                console.warn('localStorage‰øùÂ≠ò„Å´Â§±Êïó:', e);
            }
            
            // ‚òÖ ‰ºùÁ•®„ÇíË°®Á§∫
            console.log('[checkout] showReceiptÂëº„Å≥Âá∫„Åó', sessionToCheckout, ordersForReceipt);
            showReceipt(sessionToCheckout, ordersForReceipt);
        } else {
            console.warn('[checkout] sessionToCheckout not found!');
            // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„Åè„Å¶„ÇÇÊúÄ‰ΩéÈôê„ÅÆ‰ºùÁ•®„ÇíË°®Á§∫
            showReceipt({ 
                guests: 0, 
                castName: '‰∏çÊòé', 
                tableName: '‰∏çÊòé', 
                currentTotal: 0 
            }, ordersForReceipt);
        }

        // 2. „ÉÜ„Éº„Éñ„É´„Å®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÉÉ„Ç∑„Éß„É≥„Çí API „Åã„ÇâÂèñ„ÇäÁõ¥„Åô
        if (typeof loadTablesFromApi === 'function') {
            await loadTablesFromApi();
        }
        if (typeof loadActiveSessionsFromApi === 'function') {
            await loadActiveSessionsFromApi();
        }

        // 3. ÂÜçÊèèÁîª & Ë©≥Á¥∞„Éë„Éç„É´„ÇíÈñâ„Åò„Çã
        if (typeof renderTables === 'function') {
            renderTables();
        }
        if (typeof closeTableDetailPanel === 'function') {
            closeTableDetailPanel();
        }
        
        // ‚òÖ „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÉªÊó•Â†±„Éª„É¨„Éù„Éº„Éà„ÇíÊõ¥Êñ∞
        if (typeof updateDashboard === 'function') updateDashboard();
        if (typeof renderDailyReport === 'function') renderDailyReport();
        if (typeof renderReports === 'function') renderReports();
        

    } catch (e) {
        console.error('[admin] checkoutSession error', e);
        alert('Ê∏ÖÁÆó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇAPI„ÇÑ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
}

// ‚òÖ ‰ºùÁ•®„ÇíË°®Á§∫
function showReceipt(session, orders) {
    console.log('[showReceipt] ÈñãÂßã', session, orders);
    
    const guests = session.guests || 0;
    // „Ç≠„É£„Çπ„ÉàÂêç„ÇíÁõ¥Êé•ÂèñÂæóÔºàgetCastName„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„Å´ÂÇô„Åà„ÇãÔºâ
    let castName = session.castName || session.cast_name || '';
    if (!castName && (session.castId || session.cast_id)) {
        const castId = session.castId || session.cast_id;
        const cast = (appState.casts || []).find(c => Number(c.id) === Number(castId));
        castName = cast ? (cast.stage_name || cast.name) : '';
    }
    castName = castName || 'Êú™Ë®≠ÂÆö';
    
    const tableName = session.tableName || session.table_name || session.tableId || '?';
    const now = new Date();
    
    // Ê≥®Êñá„ÇíÊï¥ÂΩ¢
    const orderItems = orders.map(o => {
        const itemName = o.item_name || o.itemName || 'ÂïÜÂìÅ';
        const qty = o.quantity || 1;
        const price = o.price || 0;
        const subtotal = price * qty;
        return { name: itemName, qty, price, subtotal };
    });
    
    // TAX/„Çµ„Éº„Éì„ÇπÊñô„ÇíÂàÜÈõ¢„Åó„Å¶Ë®àÁÆó
    const taxItem = orderItems.find(item => item.name.includes('TAX') || item.name.includes('„Çµ„Éº„Éì„Çπ'));
    const itemsWithoutTax = orderItems.filter(item => !item.name.includes('TAX') && !item.name.includes('„Çµ„Éº„Éì„Çπ'));
    
    // „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏„Çí„Åæ„Å®„ÇÅ„Çã
    const singleChargeItems = itemsWithoutTax.filter(item => item.name.includes('„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏'));
    const otherItems = itemsWithoutTax.filter(item => !item.name.includes('„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏'));
    
    // „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏„Çí1Ë°å„Å´„Åæ„Å®„ÇÅ„Çã
    let consolidatedItems = [...otherItems];
    if (singleChargeItems.length > 0) {
        const totalSingleQty = singleChargeItems.reduce((sum, item) => sum + item.qty, 0);
        const totalSingleAmount = singleChargeItems.reduce((sum, item) => sum + item.subtotal, 0);
        consolidatedItems.push({
            name: '„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏',
            qty: totalSingleQty,
            price: 2000,
            subtotal: totalSingleAmount
        });
    }
    
    // ‰∏¶„Å≥È†Ü: „Çª„ÉÉ„ÉàÊñôÈáë ‚Üí ÊåáÂêçÊñô ‚Üí Âêå‰º¥Êñô ‚Üí Âª∂Èï∑ÊñôÈáë ‚Üí „Éâ„É™„É≥„ÇØÁ≠â ‚Üí „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏
    const sortOrder = (name) => {
        if (name.includes('„Çª„ÉÉ„ÉàÊñôÈáë')) return 1;
        if (name.includes('ÊåáÂêçÊñô') && !name.includes('Âª∂Èï∑')) return 2;
        if (name.includes('Âêå‰º¥')) return 3;
        if (name.includes('Âª∂Èï∑')) return 4;
        if (name.includes('„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏')) return 99; // ÊúÄÂæå
        return 50; // „Åù„ÅÆ‰ªñÔºà„Éâ„É™„É≥„ÇØÁ≠âÔºâ
    };
    
    consolidatedItems.sort((a, b) => sortOrder(a.name) - sortOrder(b.name));
    
    const subtotalAmount = consolidatedItems.reduce((sum, item) => sum + item.subtotal, 0);
    const taxAmount = taxItem ? taxItem.subtotal : 0;
    
    // ÂêàË®à„ÅØTAXËæº„Åø„ÅßË®àÁÆó
    const total = subtotalAmount + taxAmount;
    
    // ‰ºùÁ•®HTMLÁîüÊàê
    const receiptHtml = `
        <div class="text-center border-b-2 border-dashed border-gray-400 pb-4 mb-4">
            <h1 class="text-2xl font-bold">Cabax</h1>
            <p class="text-sm text-gray-600">${now.toLocaleDateString('ja-JP')} ${now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</p>
        </div>
        
        <div class="mb-4 text-sm">
            <div class="flex justify-between py-1">
                <span>„ÉÜ„Éº„Éñ„É´ÁÆ°ÁêÜ</span>
                <span class="font-bold">${tableName}</span>
            </div>
            <div class="flex justify-between py-1">
                <span>Êù•Â∫ó‰∫∫Êï∞</span>
                <span class="font-bold">${guests}Âêç</span>
            </div>
            <div class="flex justify-between py-1">
                <span>ÊãÖÂΩì</span>
                <span class="font-bold">${castName}</span>
            </div>
        </div>
        
        <div class="border-t-2 border-dashed border-gray-400 pt-4 mb-4">
            <h2 class="font-bold mb-2">„ÅîÊ≥®ÊñáÊòéÁ¥∞</h2>
            <div class="text-sm space-y-1">
                ${consolidatedItems.length > 0 ? consolidatedItems.map(item => `
                    <div class="flex justify-between">
                        <span>${item.name} √ó ${item.qty}</span>
                        <span>¬•${item.subtotal.toLocaleString()}</span>
                    </div>
                `).join('') : '<p class="text-gray-500">Ê≥®Êñá„Å™„Åó</p>'}
            </div>
        </div>
        
        <div class="border-t-2 border-dashed border-gray-400 pt-4 mb-2">
            <div class="flex justify-between text-sm">
                <span>Â∞èË®à</span>
                <span>¬•${subtotalAmount.toLocaleString()}</span>
            </div>
            ${taxAmount > 0 ? `
            <div class="flex justify-between text-sm">
                <span>TAX/„Çµ„Éº„Éì„ÇπÊñô</span>
                <span>¬•${taxAmount.toLocaleString()}</span>
            </div>
            ` : ''}
        </div>
        
        <div class="border-t-2 border-gray-800 pt-4">
            <div class="flex justify-between text-xl font-bold">
                <span>ÂêàË®à</span>
                <span>¬•${total.toLocaleString()}</span>
            </div>
        </div>
        
        <div class="text-center mt-6 text-sm text-gray-500">
            <p>„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü</p>
            <p>„Åæ„Åü„ÅÆ„ÅîÊù•Â∫ó„Çí„ÅäÂæÖ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô</p>
        </div>
    `;
    
    document.getElementById('receiptContent').innerHTML = receiptHtml;
    document.getElementById('receiptModal').classList.remove('hidden');
    document.getElementById('receiptModal').classList.add('flex');
}

function closeReceiptModal() {
    document.getElementById('receiptModal').classList.add('hidden');
    document.getElementById('receiptModal').classList.remove('flex');
}

function printReceipt() {
    window.print();
}

async function createSessionForTable(tableId) {
    try {
        const castId = Number(document.getElementById('entryCastSelect')?.value || 1);
        const guests = Number(document.getElementById('entryGuests')?.value || 1);
        const catchStaff = (document.getElementById('entryCatchStaff')?.value || '').trim();

        const payload = {
            table_id: Number(tableId),
            cast_id: castId,
            guests: guests
        };
        if (catchStaff) payload.catch_staff = catchStaff;

        // POST /api/sessions
        await apiRequest(API_ENDPOINTS.sessions, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });

        showNotification('ÂÖ•Â∫óÔºà„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÔºâ„Åó„Åæ„Åó„Åü', 'success');

        // ÊúÄÊñ∞Âåñ„Åó„Å¶Ë©≥Á¥∞„ÇíÊõ¥Êñ∞
        if (typeof syncWithBackend === 'function') await syncWithBackend();
        if (typeof openTableDetail === 'function') await openTableDetail(tableId);

    } catch (e) {
        console.error('[admin] createSessionForTable error', e);
        showNotification('ÂÖ•Â∫ó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàAPI/ConsoleÁ¢∫Ë™çÔºâ', 'error');
    }
}

// ‚òÖ „ÉÜ„Éº„Éñ„É´‰∏ÄË¶ß„Çí API „Åã„ÇâÂèñÂæó„Åó„Å¶ state „Å´ÂèçÊò†ÔºàÁÆ°ÁêÜÁîªÈù¢Áî®Ôºâ

async function loadTablesFromApi() {
    try {
        const data = await apiRequest(API_ENDPOINTS.tables);

        if (!Array.isArray(data)) {
            console.error("„ÉÜ„Éº„Éñ„É´API„ÅÆÊàª„ÇäÂÄ§„ÅåÈÖçÂàó„Åò„ÇÉ„Å™„ÅÑ:", data);
            return;
        }

        appState.tables = data.map((t) => {
            const name =
                t.name ??
                t.table_name ??
                (t.number !== undefined ? String(t.number) : String(t.id));

            return {
                id: t.id,
                name: name,
                status: t.status ?? "available",
                // FastAPIÂÅ¥„ÅØ is_vip „Å™„ÅÆ„Åß„Åì„Åì„Åß„Ç≠„É£„É°„É´„Å´ÊèÉ„Åà„Çã
                isVip: t.isVip ?? t.is_vip ?? false,
            };
        });

        renderTables();
    } catch (error) {
        console.error("„ÉÜ„Éº„Éñ„É´ÂèñÂæó„Å´Â§±Êïó:", error);
        alert("„ÉÜ„Éº„Éñ„É´ÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÔºàÁÆ°ÁêÜÁîªÈù¢Ôºâ");
    }
}

// ‚òÖ loadActiveSessionsFromApi„ÅØÂæåÊñπ„ÅßÂÆöÁæ©ÔºàÈáçË§áÂâäÈô§Ôºâ

// ‚òÖ „ÉÜ„Éº„Éñ„É´„Åã„ÇâÊñ∞Ë¶è„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈñãÂßãÔºàÁÆ°ÁêÜÁîªÈù¢Ôºâ

async function startSessionForTable(tableId, options = {}) {
    // options „Å´„ÅØ UI „Åã„ÇâÊãæ„Å£„ÅüÂÄ§„ÇíÊ∏°„Åô„Ç§„É°„Éº„Ç∏
    const {
        castId,
        guests,
        catchStaff = "",
        hasCompanion = false,
        companionName = "",
        nominationType = null,
        nominationFee = 0,
        shimeiCasts = "",
    } = options;

    const payload = {
        table_id: tableId,
        cast_id: castId,
        guests: guests,
        catch_staff: catchStaff || null,
        has_companion: hasCompanion,
        companion_name: companionName || null,
        nomination_type: nominationType,
        nomination_fee: nominationFee,
        shimei_casts: shimeiCasts || null,
    };

    try {
        // FastAPI „Å´„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„É™„ÇØ„Ç®„Çπ„Éà
        const session = await apiRequest(API_ENDPOINTS.sessions, {
            method: "POST",
            body: JSON.stringify(payload),
        });

        // appState ÂÅ¥„Å´ÂèçÊò†Ôºà„Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß„ÇíÊåÅ„Å£„Å¶„ÅÑ„ÇãÂâçÊèêÔºâ
        if (!Array.isArray(appState.sessions)) {
            appState.sessions = [];
        }
        appState.sessions.push(session);

        // Ë©≤ÂΩì„ÉÜ„Éº„Éñ„É´„ÅÆÁä∂ÊÖã„ÇÇ„Äå‰ΩøÁî®‰∏≠„Äç„Å´Êõ¥Êñ∞
        const table = appState.tables.find(t => t.id === tableId);
        if (table) {
            table.status = "occupied";
        }

        // ‚òÖ „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÂæå„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
        await loadActiveSessionsFromApi();

        // „ÉÜ„Éº„Éñ„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞
        renderTables();  // Êó¢Â≠ò„ÅÆ„ÉÜ„Éº„Éñ„É´ÊèèÁîªÈñ¢Êï∞

        console.log("„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊàêÂäü:", session);
        return session;
    } catch (error) {
        console.error("„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„Å´Â§±Êïó:", error);
        alert("„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÖ•ÂäõÂÜÖÂÆπ or API „ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        throw error;
    }
}

// ‚òÖ „ÉÜ„Éº„Éñ„É´„Å´ÂØæ„Åó„Å¶Ê≥®Êñá„Çí‰ΩúÊàê„Åó„Å¶ API „Å´ÈÄÅ„Çã

async function createOrderForTable(tableId, menuItemId, quantity, options = {}) {
    const {
        isDrinkBack = false,
        castName = null,   // „Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØ„ÅÆÂØæË±°„Ç≠„É£„Çπ„ÉàÂêç„Å™„Å©
    } = options;

    // 1. „Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÊé¢„Åô
    const session = appState.activeSessions.find(s => s.tableId === tableId);

    if (!session) {
        alert("„Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„Å´„ÅØ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖà„Å´ÂÖ•Â∫óÂá¶ÁêÜ„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        throw new Error("No active session for table " + tableId);
    }

    const payload = {
        session_id: session.id,
        menu_item_id: menuItemId,
        quantity: quantity,
        is_drink_back: isDrinkBack,
        cast_name: castName,
    };

    try {
        const order = await apiRequest(API_ENDPOINTS.orders, {
            method: "POST",
            body: JSON.stringify(payload),
        });

        console.log("Ê≥®Êñá‰ΩúÊàêÊàêÂäü:", order);

        // ‚òÖ ÈáëÈ°ç„Å™„Å©„ÇíÊúÄÊñ∞Âåñ„Åó„Åü„ÅÑ„ÅÆ„Åß„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñ„ÇäÁõ¥„Åô
        await loadActiveSessionsFromApi();

        // ÂøÖË¶Å„Å™„Çâ„ÄÅ„ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞„ÇÑÊ≥®Êñá‰∏ÄË¶ß„ÅÆÂÜçÊèèÁîª„ÇÇ„Åì„Åì„ÅßÂëº„Å∂
        renderTables();
        // renderTableDetail(tableId); ‚Üê „Åù„ÅÜ„ÅÑ„ÅÜÈñ¢Êï∞„Åå„ÅÇ„Çã„Å™„Çâ

        return order;
    } catch (e) {
        console.error("Ê≥®Êñá‰ΩúÊàê„Å´Â§±Êïó:", e);
        alert("Ê≥®Êñá„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇAPI „ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        throw e;
    }
}

// ‚òÖ Ê≥®ÊñáËøΩÂä†„Éú„Çø„É≥Áî®„ÅÆ„Éè„É≥„Éâ„É©Ôºà„Ç§„É°„Éº„Ç∏Ôºâ
async function handleAddOrder() {
    const tableId = currentTableId;          // ‰ªäË°®Á§∫‰∏≠„ÅÆ„ÉÜ„Éº„Éñ„É´ID
    const menuItemId = selectedMenuItemId;  // ÈÅ∏Êäû‰∏≠„É°„Éã„É•„Éº
    const quantity = selectedQuantity || 1;  // Êú™ÊåáÂÆö„Å™„Çâ1

    // ÂøÖË¶Å„Å™„Çâ UI „Åã„Çâ„Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØÊÉÖÂ†±„ÇÑ„Ç≠„É£„Çπ„ÉàÂêç„ÇÇÂèñ„Å£„Å¶„Åè„Çã
    const isDrinkBack = false;              // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åã„ÇâÊãæ„ÅÜ„Å™„Å©
    const castName = null;                  // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„Å™„Å©„Åã„Çâ

    try {
        await createOrderForTable(tableId, menuItemId, quantity, {
            isDrinkBack,
            castName,
        });
        alert("Ê≥®Êñá„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü");
    } catch (e) {
        // createOrderForTable ÂÜÖ„Åß alert Ê∏à„Åø„Å™„ÅÆ„Åß„Åì„Åì„ÅØ„É≠„Ç∞„Å†„Åë„Åß„ÇÇOK
        console.error(e);
    }
}

// „É°„Éã„É•„Éº‰∏ÄË¶ß„ÇíAPI„Åã„ÇâÂèñÂæóÔºà„Åì„Çå„ÅØÊó¢„Å´„ÅÇ„Çã„ÅØ„ÅöÔºâ
async function loadMenuFromApi() {
  try {
    const data = await apiRequest('menu', { method: 'GET' });
    const items = Array.isArray(data) ? data : (data?.items || data?.menu || []);
    
    // image_url „Çí image „Å´„ÇÇ„Éû„ÉÉ„Éî„É≥„Ç∞Ôºà„Éï„É≠„É≥„ÉàË°®Á§∫Áî®Ôºâ
    appState.menuItems = items.map(item => ({
        ...item,
        image: item.image || item.image_url
    }));

    // Êó¢Â≠òUI„Å´Âêà„Çè„Åõ„Å¶„ÄåÂ≠òÂú®„Åô„Çã„ÇÇ„ÅÆ„Å†„Åë„ÄçÂëº„Å∂
    if (typeof renderMenu === 'function') renderMenu();
    if (typeof renderMenuItems === 'function') renderMenuItems();
    if (typeof renderMenuManagement === 'function') renderMenuManagement();
    if (typeof populateMenuSelects === 'function') populateMenuSelects();

    console.log('‚úÖ loadMenuFromApi OK:', items.length);
    return items;
  } catch (e) {
    console.error('‚ùå loadMenuFromApi failed:', e);
    return [];
  }
}

// ‚òÖ „Ç≠„É£„Çπ„Éà‰∏ÄË¶ß„ÇíAPI„Åã„ÇâÂèñÂæó„Åó„Å¶ state „Å´ÂèçÊò†
async function loadCastsFromApi() {
  try {
    const data = await apiRequest('casts', { method: 'GET' });
    const casts = Array.isArray(data) ? data : (data?.casts || data?.items || []);
    appState.casts = casts;

    // „Çª„É¨„ÇØ„ÉàÂæ©Ê¥ª„ÅØ„Åì„Çå„ÅåÂøÖÈ†à
    if (typeof populateCastSelects === 'function') populateCastSelects();
    if (typeof renderCasts === 'function') renderCasts();
    if (typeof renderCastManagement === 'function') renderCastManagement();

    console.log('‚úÖ loadCastsFromApi OK:', casts.length);
    return casts;
  } catch (e) {
    console.error('‚ùå loadCastsFromApi failed:', e);
    return [];
  }
}

async function loadActiveSessionsFromApi() {
    try {
        
        const data = await apiRequest(API_ENDPOINTS.sessionsActive);
        

        // ‚òÖ data „Åå [] „Åß„ÇÇ„ÄåÁ©∫Â∏≠„Äç„ÅåÁúüÂÆü„Å™„ÅÆ„ÅßÂøÖ„Åö‰∏äÊõ∏„Åç„Åô„Çã
        if (!Array.isArray(data)) {
            console.warn('[admin] Invalid active sessions payload', data);
            appState.activeSessions = [];
            if (typeof renderTables === 'function') renderTables();
            return;
        }

        appState.activeSessions = data.map(raw => {
            const tableId = raw.tableId ?? raw.table_id ?? null;

            const tableName =
                raw.tableName ??
                raw.table_name ??
                (tableId != null ? String(tableId) : '');

            const guests = raw.guests ?? raw.guest_count ?? 0;

            const castName = raw.castName ?? raw.cast_name ?? '';

            const catchStaff = raw.catchStaff ?? raw.catch_staff ?? '';

            const startTime = raw.startTime ?? raw.start_time ?? new Date().toISOString();

            const currentTotal =
                raw.currentTotal ??
                raw.current_total ??
                raw.totalAmount ??
                raw.total_amount ??
                0;

            const hasCompanion = raw.hasCompanion ?? raw.has_companion ?? false;

            const companionName = raw.companionName ?? raw.companion_name ?? '';

            const extensionCount = raw.extensionCount ?? raw.extension_count ?? 0;

            let orders = [];
            if (Array.isArray(raw.orders)) {
                orders = raw.orders.map(o => {
                    const menuItemId = o.menuItemId ?? o.menu_item_id ?? null;
                    const menuItem =
                        (Array.isArray(appState.menuItems) ? appState.menuItems : [])
                            .find(m => Number(m.id) === Number(menuItemId)) || null;

                    const price = o.price ?? (menuItem ? menuItem.price : 0);
                    const itemName = o.itemName ?? o.item_name ?? (menuItem ? menuItem.name : '');
                    const category = o.category ?? (menuItem ? menuItem.category : 'other');

                    return {
                        id: o.id ?? null, // order_id‰øùÊåÅ
                        itemName,
                        category,
                        price,
                        quantity: o.quantity ?? 1,
                        isDrinkBack: o.isDrinkBack ?? o.is_drink_back ?? false,
                        castName: o.castName ?? o.cast_name ?? null
                    };
                });
            }

            return {
                id: raw.id,
                tableId,
                tableName,
                guests,
                castName,
                catchStaff,
                startTime,
                currentTotal,
                hasCompanion,
                companionName,
                extensionCount,
                orders
            };
        });

        
        if (typeof renderTables === 'function') renderTables();

    } catch (e) {
        console.error('[admin] loadActiveSessionsFromApi error', e);

        // ÈÄö‰ø°„Ç®„É©„ÉºÊôÇ„ÅÆÊåôÂãïÔºöÂπΩÈúä„ÇíÊÆã„Åó„Åü„Åè„Å™„ÅÑ„Å™„ÇâÁ©∫„Å´„Åô„Çã
        appState.activeSessions = [];
        if (typeof renderTables === 'function') renderTables();
    }
}

function applyCastsToAllSelects() {
  const casts = Array.isArray(appState.casts) ? appState.casts : [];

  // „Ç≠„É£„Çπ„ÉàÈÅ∏Êäû„Å£„ÅΩ„ÅÑ select „ÇíÁ∑èÂΩì„Åü„Çä„ÅßÂüã„ÇÅ„ÇãÔºàÊó¢Â≠òUI„ÅåÂ£ä„Çå„Å¶„Å¶„ÇÇÂæ©Ê¥ª„Åô„ÇãÔºâ
  const selects = Array.from(document.querySelectorAll('select'))
    .filter(sel => /cast/i.test(sel.id || '') || /cast/i.test(sel.name || ''));

  if (!selects.length) return;

  const optionsHtml = [
    `<option value="free">„Éï„É™„Éº</option>`,
    ...casts.map(c => `<option value="${c.id}">${c.stage_name ?? c.name ?? `Cast#${c.id}`}</option>`)
  ].join('');

  selects.forEach(sel => {
    // ÁèæÂú®ÈÅ∏Êäû„Çí‰øùÊåÅ
    const current = sel.value;
    sel.innerHTML = optionsHtml;
    if (current) sel.value = current;
  });
}

function applyMenuToAllSelects() {
  const items = Array.isArray(appState.menuItems) ? appState.menuItems : [];

  const selects = Array.from(document.querySelectorAll('select'))
    .filter(sel => /menu/i.test(sel.id || '') || /item/i.test(sel.id || ''));

  if (!selects.length) return;

  const optionsHtml = items.map(it => {
    const label = `${it.name}Ôºà¬•${Number(it.price||0).toLocaleString('ja-JP')}Ôºâ`;
    return `<option value="${it.id}">${label}</option>`;
  }).join('');

  selects.forEach(sel => {
    const current = sel.value;
    sel.innerHTML = optionsHtml;
    if (current) sel.value = current;
  });
}

function initializeApp() {
    // ‚òÖ localStorage„Åã„ÇâcheckoutHistory„ÇíÂæ©ÂÖÉ
    try {
        const saved = localStorage.getItem('cabax_checkoutHistory');
        if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
                // ‰ªäÊó•„ÅÆÂàÜ„Å†„ÅëÂæ©ÂÖÉÔºàÊó•‰ªò„Åß„Éï„Ç£„É´„ÇøÔºâ
                const today = new Date().toISOString().split('T')[0];
                appState.checkoutHistory = parsed.filter(s => {
                    const checkoutDate = s.checkoutTime || s.end_time || s.startTime || s.start_time;
                    return checkoutDate && checkoutDate.startsWith(today);
                });
                console.log('‚úÖ checkoutHistoryÂæ©ÂÖÉ:', appState.checkoutHistory.length, '‰ª∂');
            }
        }
    } catch (e) {
        console.warn('checkoutHistoryÂæ©ÂÖÉ„Å´Â§±Êïó:', e);
    }
    
    setupBusinessDate();
    // loadDemoData();  // ‚òÖ „ÉÜ„Éº„Éñ„É´Ôºè„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„ÉÄ„Éü„ÉºÂàùÊúüÂåñ„ÅØ„ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑ

    // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁ≥ª„ÅØ„Åù„ÅÆ„Åæ„Åæ
    setupCharts();
    updateDashboard();
    initializeShiftCalendar();
    renderAttendance();
    populateCastSelects();
    renderDailyReport();
    renderReports();
    applyCastsToAllSelects();
    applyMenuToAllSelects();



    // ‚òÖ „Ç§„Éô„É≥„ÉàÂßîË≠≤Áâà„Çí1Âõû„Å†„ÅëÈÖçÁ∑öÔºàÂæå„Åã„ÇâDOM„ÅåÁîüÊàê„Åï„Çå„Å¶„ÇÇÊãæ„ÅÜÔºâ
    if (typeof wireDelegatedCheckout === 'function') {
        wireDelegatedCheckout();
    }

    // ‚òÖ APIÂêåÊúüÔºàÊúÄÂàù„Å´1ÂõûÔºâ
    if (typeof syncWithBackend === 'function') {
        syncWithBackend();
    }

    // ‚òÖ „É°„Éã„É•„Éº/„Ç≠„É£„Çπ„ÉàÂæ©Ê¥ªÔºà„Åì„Åì„Åß1ÂõûÔºâ
    if (typeof loadMenuFromApi === 'function') {
        loadMenuFromApi().catch(err => console.error('loadMenuFromApi failed:', err));
    }
    if (typeof loadCastsFromApi === 'function') {
        loadCastsFromApi().catch(err => console.error('loadCastsFromApi failed:', err));
    }

    // ‚òÖ ÂÆöÊúüÂêåÊúüÔºà‰∫åÈáçËµ∑ÂãïÈò≤Ê≠¢Ôºâ
    if (!window.__cabaxSyncInterval) {
        window.__cabaxSyncInterval = setInterval(() => {
            if (document.visibilityState === 'visible' &&
                typeof syncWithBackend === 'function') {
                syncWithBackend();
            }
        }, 15000);
    }

    // ‚òÖ „Çø„ÉñÂæ©Â∏∞ÊôÇ„Å´ÂêåÊúüÔºà‰∫åÈáçÁôªÈå≤Èò≤Ê≠¢Ôºâ
    if (!window.__cabaxVisibilityHandlerAdded) {
        window.__cabaxVisibilityHandlerAdded = true;
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {

                // ‚ë† „Åæ„Åö„Çª„ÉÉ„Ç∑„Éß„É≥/„ÉÜ„Éº„Éñ„É´ÂêåÊúü
                if (typeof syncWithBackend === 'function') {
                    syncWithBackend();
                }

                // ‚ë° „Åù„ÅÆÊ¨°„Å´„É°„Éã„É•„Éº/„Ç≠„É£„Çπ„Éà„ÇÇÊõ¥Êñ∞ÔºàÂ§±Êïó„Åó„Å¶„ÇÇÊ≠¢„ÇÅ„Å™„ÅÑÔºâ
                if (typeof loadMenuFromApi === 'function') {
                    loadMenuFromApi().catch(err => console.error('loadMenuFromApi failed:', err));
                }
                if (typeof loadCastsFromApi === 'function') {
                    loadCastsFromApi().catch(err => console.error('loadCastsFromApi failed:', err));
                }
            }
        });
    }
}

        // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            // „Éá„Éê„ÉÉ„Ç∞
            console.log('„É≠„Ç∞„Ç§„É≥Ë©¶Ë°å:', { username, password, len: password.length });
            
            // „Éá„É¢„Ç¢„Ç´„Ç¶„É≥„ÉàË™çË®ºÔºàÂ§ßÊñáÂ≠óÂ∞èÊñáÂ≠ó„ÇíÁÑ°Ë¶ñÔºâ
            if (username.toLowerCase() === 'admin' && password === 'cabax2024') {
                // „É≠„Ç∞„Ç§„É≥ÊàêÂäü
                console.log('„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ');
                sessionStorage.setItem('cabax_logged_in', 'true');
                sessionStorage.setItem('cabax_user', username);
                
                errorDiv.classList.remove('active');
                showMainApp();
                initializeApp();
                
                showNotification('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü', 'success');
            } else {
                // „É≠„Ç∞„Ç§„É≥Â§±Êïó
                console.log('„É≠„Ç∞„Ç§„É≥Â§±Êïó - ÊúüÂæÖÂÄ§: admin / cabax2024');
                errorDiv.classList.add('active');
                document.getElementById('loginPassword').value = '';
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').style.display = 'block';
        }

        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                sessionStorage.removeItem('cabax_logged_in');
                sessionStorage.removeItem('cabax_user');
                
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').style.display = 'none';
                
                // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').classList.remove('active');
                
                showNotification('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'info');
            }
        }

        function setupBusinessDate() {
            const now = new Date();
            const businessDate = now.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('businessDate').textContent = businessDate;
        }

        function loadDemoData() {
            // „ÉÜ„Éº„Éñ„É´„Çí1„Äú6„ÅÆÁï™Âè∑„Å´Â§âÊõ¥
            appState.tables = [
                { id: 1, name: '1', status: 'available' },
                { id: 2, name: '2', status: 'occupied' },
                { id: 3, name: '3', status: 'occupied', isVip: true },
                { id: 4, name: '4', status: 'available' },
                { id: 5, name: '5', status: 'reserved' },
                { id: 6, name: '6', status: 'available' }
            ];

            appState.menuItems = [
                { 
                    id: 1, 
                    name: '„Éâ„É≥„Éö„É™„Éã„É®„É≥ „É≠„Çº', 
                    category: 'bottle', 
                    price: 150000, 
                    stock: 5,
                    description: '„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„É• „Ç∑„É£„É≥„Éë„É≥',
                    image: null
                },
                { 
                    id: 2, 
                    name: '„Éè„Ç§„Éú„Éº„É´', 
                    category: 'drink', 
                    price: 800, 
                    stock: 100,
                    description: '„ÇØ„É©„Ç∑„ÉÉ„ÇØ„Éè„Ç§„Éú„Éº„É´',
                    image: null
                },
                { 
                    id: 3, 
                    name: '„Ç´„Ç∑„Çπ„Ç™„É¨„É≥„Ç∏', 
                    category: 'drink', 
                    price: 800, 
                    stock: 100,
                    description: '„Éï„É´„Éº„ÉÜ„Ç£„Éº„Ç´„ÇØ„ÉÜ„É´',
                    image: null
                },
                { 
                    id: 4, 
                    name: '90ÂàÜ„Çª„ÉÉ„Éà', 
                    category: 'set', 
                    price: 5000, 
                    stock: null,
                    description: 'È£≤„ÅøÊîæÈ°å‰ªò„Åç',
                    image: null
                },
                { 
                    id: 5, 
                    name: '„Éï„É´„Éº„ÉÑÁõõ„ÇäÂêà„Çè„Åõ', 
                    category: 'food', 
                    price: 8000, 
                    stock: 20,
                    description: 'Â≠£ÁØÄ„ÅÆ„Éï„É´„Éº„ÉÑ',
                    image: null
                }
            ];

            appState.casts = [
                { id: 1, name: '„Åï„Åè„Çâ', rank: 'chief', hourlyRate: 3500, sales: 285000 },
                { id: 2, name: '„ÇÜ„Åç', rank: 'regular', hourlyRate: 2500, sales: 168000 },
                { id: 3, name: '„Åø„Åã', rank: 'manager', hourlyRate: 4000, sales: 342000 }
            ];

            appState.sessions = [
                { id: 1, tableId: 2, startTime: '21:30', guests: 4, total: 26400 },
                { id: 2, tableId: 3, startTime: '20:00', guests: 6, total: 160000 }
            ];

            appState.attendances = [
                { id: 1, castId: 1, castName: '„Åï„Åè„Çâ', date: new Date().toISOString().split('T')[0], clockIn: '20:00', clockOut: null, status: 'working' },
                { id: 2, castId: 3, castName: '„Åø„Åã', date: new Date().toISOString().split('T')[0], clockIn: '19:30', clockOut: null, status: 'working' }
            ];

            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„Éá„É¢„Éá„Éº„ÇøÔºàÊã°ÂºµÊ©üËÉΩÁî®Ôºâ
            appState.activeSessions = [
                {
                    id: 1,
                    tableId: 2,
                    tableName: '2',
                    guests: 3,
                    castName: '„Åï„Åè„Çâ',
                    catchStaff: 'Â±±Áî∞',
                    startTime: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                    currentTotal: 45000,
                    hasCompanion: true,
                    companionName: 'Áî∞‰∏≠Êßò',
                    extensionCount: 2,
                    orders: [
                        { itemName: '„Éâ„É≥„Éö„É™„Éã„É®„É≥ „É≠„Çº', category: 'bottle', price: 30000, quantity: 1 },
                        { itemName: '„Éè„Ç§„Éú„Éº„É´', category: 'drink', price: 800, quantity: 3, castName: '„Åï„Åè„Çâ', isDrinkBack: true },
                        { itemName: '„Ç´„Ç∑„Çπ„Ç™„É¨„É≥„Ç∏', category: 'drink', price: 800, quantity: 2, castName: '„Åï„Åè„Çâ', isDrinkBack: true },
                        { itemName: '„Éï„É´„Éº„ÉÑÁõõ„ÇäÂêà„Çè„Åõ', category: 'food', price: 8000, quantity: 1 }
                    ],
                    nomination: {
                        type: 'in-house',
                        castName: '„Åï„Åè„Çâ',
                        fee: 2000
                    }
                },
                {
                    id: 2,
                    tableId: 3,
                    tableName: '3',
                    guests: 4,
                    castName: '„Åø„Åã',
                    catchStaff: '‰ΩêËó§',
                    startTime: new Date(Date.now() - 1.5 * 60 * 60 * 1000).toISOString(),
                    currentTotal: 160000,
                    hasCompanion: false,
                    companionName: null,
                    extensionCount: 1,
                    orders: [
                        { itemName: '„Éâ„É≥„Éö„É™„Éã„É®„É≥ „É≠„Çº', category: 'bottle', price: 150000, quantity: 1 },
                        { itemName: '„Éè„Ç§„Éú„Éº„É´', category: 'drink', price: 800, quantity: 5, castName: '„Åø„Åã', isDrinkBack: true },
                        { itemName: '90ÂàÜ„Çª„ÉÉ„Éà', category: 'set', price: 5000, quantity: 1 }
                    ],
                    nomination: {
                        type: 'main',
                        castName: '„Åø„Åã',
                        fee: 5000
                    }
                }
            ];

            // Á≤æÁÆóÊ∏à„Åø„Çª„ÉÉ„Ç∑„Éß„É≥ÔºàÊó•Â†±„Éá„Éº„ÇøÁî®Ôºâ
            appState.checkoutHistory = [
                {
                    id: 101,
                    tableId: 4,
                    tableName: '4',
                    guests: 2,
                    castName: '„ÇÜ„Åç',
                    catchStaff: 'È´òÊ©ã',
                    startTime: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                    checkoutTime: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(),
                    totalAmount: 28000,
                    hasCompanion: true,
                    companionName: '‰Ωê„ÄÖÊú®Êßò',
                    extensionCount: 1,
                    orders: [
                        { itemName: '90ÂàÜ„Çª„ÉÉ„Éà', category: 'set', price: 5000, quantity: 2 },
                        { itemName: '„Éè„Ç§„Éú„Éº„É´', category: 'drink', price: 800, quantity: 4, castName: '„ÇÜ„Åç', isDrinkBack: true },
                        { itemName: '„Éï„É´„Éº„ÉÑÁõõ„ÇäÂêà„Çè„Åõ', category: 'food', price: 8000, quantity: 1 }
                    ],
                    nomination: {
                        type: 'main',
                        castName: '„ÇÜ„Åç',
                        fee: 5000
                    }
                }
            ];

            renderTables();
            renderMenu();
            renderCasts();
            renderReports();
        }

async function syncWithBackend() {
    // showNotification('APIÂêåÊúü„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü', 'info'); // ÈÄöÁü•‰∏çË¶Å

    try {
        await Promise.all([
            (typeof loadMenuFromApi === 'function') ? loadMenuFromApi() : Promise.resolve(),
            (typeof loadCastsFromApi === 'function') ? loadCastsFromApi() : Promise.resolve(),
            (typeof loadTablesFromApi === 'function') ? loadTablesFromApi() : Promise.resolve(),
            (typeof loadActiveSessionsFromApi === 'function') ? loadActiveSessionsFromApi() : Promise.resolve(),
            (typeof loadStaffFromApi === 'function') ? loadStaffFromApi() : Promise.resolve()
        ]);

        appState.apiConnected = true;
        // showNotification('„É°„Éã„É•„Éº„Éª„Ç≠„É£„Çπ„Éà„Éª„ÉÜ„Éº„Éñ„É´„Éª„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíAPI„Å®ÂêåÊúü„Åó„Åæ„Åó„Åü', 'success'); // ÈÄöÁü•‰∏çË¶Å

        // Â∫óËàóË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        if (typeof loadStoreSettings === 'function') loadStoreSettings();

        // ‚òÖ ÂêåÊúüÂæå„ÅÆÂÜçÊèèÁîª
        if (typeof renderTables === 'function') renderTables();
        if (typeof renderMenu === 'function') renderMenu();
        if (typeof renderCasts === 'function') renderCasts();
        if (typeof renderStaff === 'function') renderStaff();
        if (typeof populateCastSelects === 'function') populateCastSelects();
        if (typeof updateDashboard === 'function') updateDashboard();
        if (typeof renderDailyReport === 'function') renderDailyReport();
        if (typeof renderReports === 'function') renderReports();

        // ‚òÖ Ê≥®ÊÑèÔºöË©≥Á¥∞„É¢„Éº„ÉÄ„É´Êõ¥Êñ∞„ÅØ openTableDetail „ÅÆË≤¨ÂãôÔºà„Åì„Åì„Åß„ÅØÁµ∂ÂØæ„ÇÑ„Çâ„Å™„ÅÑÔºâ
        return true;

    } catch (error) {
        console.error(error);
        appState.apiConnected = false;
        showNotification('APIÂêåÊúü„Å´Â§±Êïó„Åó„Åü„Åü„ÇÅ„ÄÅ„Éá„É¢„Éá„Éº„Çø„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');

        if (typeof renderMenu === 'function') renderMenu();
        if (typeof renderCasts === 'function') renderCasts();
        if (typeof renderStaff === 'function') renderStaff();
        if (typeof renderTables === 'function') renderTables();
        if (typeof populateCastSelects === 'function') populateCastSelects();

        return false;
    }
}


        // „É°„Éã„É•„ÉºÁÆ°ÁêÜ
        function previewMenuImage(event, mode) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (mode === 'add') {
                        appState.currentMenuImage = e.target.result;
                        const preview = document.getElementById('menuImagePreview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                    } else if (mode === 'edit') {
                        appState.currentMenuImage = e.target.result;
                        const preview = document.getElementById('editMenuImagePreview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // „Ç´„ÉÜ„Ç¥„É™Ê≠£Ë¶èÂåñÔºàAPIÂÄ§ ‚Üí Áµ±‰∏Ä„Ç≠„ÉºÔºâ
        function normalizeCategory(category, itemName = '') {
            // item_name„Åã„Çâ„Ç´„ÉÜ„Ç¥„É™„ÇíÊé®ÂÆö
            if (itemName) {
                const name = String(itemName).toLowerCase();
                if (name.includes('„Çª„ÉÉ„ÉàÊñôÈáë') || name.includes('ÊåáÂêçÊñô') || name.includes('„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏') || name.includes('Âêå‰º¥Êñô') || name.includes('Âª∂Èï∑')) {
                    return 'set';
                }
                if (name.includes('tax') || name.includes('„Çµ„Éº„Éì„Çπ')) {
                    return 'set'; // TAX„ÇÇ„Çª„ÉÉ„Éà„Å´Âê´„ÇÅ„Çã
                }
            }
            
            if (!category) return 'other';
            const c = String(category).toLowerCase().trim();
            const map = {
                'set': 'set',
                '„Çª„ÉÉ„Éà': 'set',
                'tableset': 'set',
                'fee_set': 'set',
                'fee_inhouse': 'set',
                'fee_hon': 'set',
                'bottle': 'bottle',
                '„Éú„Éà„É´': 'bottle',
                'champagne': 'champagne',
                '„Ç∑„É£„É≥„Éë„É≥': 'champagne',
                'wine': 'wine',
                '„ÉØ„Ç§„É≥': 'wine',
                'drink': 'drink',
                '„Éâ„É™„É≥„ÇØ': 'drink',
                'castdrink': 'drink',
                'food': 'food',
                '„Éï„Éº„Éâ': 'food'
            };
            return map[c] || 'other';
        }

        // ÁèæÂú®„ÅÆ„Éï„Ç£„É´„ÇøÁä∂ÊÖã
        let currentMenuFilter = 'all';

        function filterMenuCategory(category) {
            currentMenuFilter = category;
            
            // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.menu-filter-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.remove('bg-gray-800', 'text-gray-300', 'border-gray-700');
                    btn.classList.add('bg-amber-500/20', 'text-amber-300', 'border-amber-500/30', 'active');
                } else {
                    btn.classList.remove('bg-amber-500/20', 'text-amber-300', 'border-amber-500/30', 'active');
                    btn.classList.add('bg-gray-800', 'text-gray-300', 'border-gray-700');
                }
            });
            
            renderMenu();
        }

        // ========== Â∫óËàóË®≠ÂÆö ==========
        
        // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Éê„ÉÉ„ÇØË®≠ÂÆö
        const defaultBackSettings = {
            db: 60,           // „Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØ
            nomination: 60,   // ÊåáÂêçÊñô„Éê„ÉÉ„ÇØ
            sales: 10,        // Â£≤‰∏ä„Éê„ÉÉ„ÇØÔºàÊåáÂêçÊôÇÔºâ
            companion: 100,   // Âêå‰º¥„Éê„ÉÉ„ÇØ
            champagne: 10,    // „Ç∑„É£„É≥„Éë„É≥„Éê„ÉÉ„ÇØ
            bottle: 10        // „Éú„Éà„É´„Éê„ÉÉ„ÇØ
        };
        
        // Â∫óËàóË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        function loadStoreSettings() {
            const saved = localStorage.getItem('cabax_store_settings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    Object.assign(appState.backSettings, settings);
                } catch (e) {
                    console.error('Failed to load store settings:', e);
                }
            }
            
            // UI„Å´ÂèçÊò†
            updateBackSettingsUI();
        }
        
        // UI„Å´Ë®≠ÂÆö„ÇíÂèçÊò†
        function updateBackSettingsUI() {
            const settings = appState.backSettings || defaultBackSettings;
            
            const fields = ['db', 'nomination', 'sales', 'companion', 'champagne', 'bottle'];
            fields.forEach(field => {
                const input = document.getElementById(`setting${field.charAt(0).toUpperCase() + field.slice(1)}Rate`);
                const display = document.getElementById(`display${field.charAt(0).toUpperCase() + field.slice(1)}Rate`);
                if (input) input.value = settings[field] ?? defaultBackSettings[field];
                if (display) display.textContent = `${settings[field] ?? defaultBackSettings[field]}%`;
            });
        }
        
        // „Éê„ÉÉ„ÇØË®≠ÂÆö„ÇíÊõ¥Êñ∞
        function updateBackSetting(type, value) {
            if (!appState.backSettings) appState.backSettings = { ...defaultBackSettings };
            appState.backSettings[type] = Number(value);
            
            const display = document.getElementById(`display${type.charAt(0).toUpperCase() + type.slice(1)}Rate`);
            if (display) display.textContent = `${value}%`;
        }
        
        // Â∫óËàóË®≠ÂÆö„Çí‰øùÂ≠ò
        function saveStoreSettings() {
            localStorage.setItem('cabax_store_settings', JSON.stringify(appState.backSettings));
            showNotification('Â∫óËàóË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
        }
        
        // appState„Å´„Éê„ÉÉ„ÇØË®≠ÂÆö„ÇíËøΩÂä†
        if (!appState.backSettings) {
            appState.backSettings = { ...defaultBackSettings };
        }
        
        // ========== „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ ==========
        
        appState.staffList = [];
        appState.staffAttendances = [];
        
        async function loadStaffList() {
            try {
                const staff = await apiRequest('/api/staff');
                appState.staffList = staff || [];
                renderStaffList();
            } catch (e) {
                console.error('„Çπ„Çø„ÉÉ„Éï‰∏ÄË¶ßÂèñÂæóÂ§±Êïó:', e);
            }
        }
        
        async function loadStaffAttendances() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const attendances = await apiRequest(`/api/staff-attendance?date=${today}`);
                appState.staffAttendances = attendances || [];
                renderStaffAttendanceList();
                updateTodayStaffCost();
            } catch (e) {
                console.error('„Çπ„Çø„ÉÉ„ÉïÂã§ÊÄ†ÂèñÂæóÂ§±Êïó:', e);
            }
        }
        
        function renderStaffList() {
            const container = document.getElementById('staffList');
            if (!container) return;
            
            if (appState.staffList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">„Çπ„Çø„ÉÉ„Éï„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }
            
            const roleLabels = {
                waiter: '„Ç¶„Çß„Ç§„Çø„Éº',
                kitchen: '„Ç≠„ÉÉ„ÉÅ„É≥',
                manager: '„Éû„Éç„Éº„Ç∏„É£„Éº',
                catch: '„Ç≠„É£„ÉÉ„ÉÅ',
                driver: '„Éâ„É©„Ç§„Éê„Éº',
                other: '„Åù„ÅÆ‰ªñ'
            };
            
            const salaryTypeLabels = {
                hourly: 'ÊôÇÁµ¶',
                daily: 'Êó•Áµ¶',
                monthly: 'ÊúàÁµ¶'
            };
            
            container.innerHTML = appState.staffList.map(staff => `
                <div class="p-4 bg-black/20 rounded-xl border border-white/10 flex items-center justify-between">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="text-white font-semibold">${staff.name}</span>
                            <span class="text-xs px-2 py-1 bg-gray-700 rounded">${roleLabels[staff.role] || staff.role}</span>
                        </div>
                        <div class="text-sm text-gray-400 mt-1">
                            ${salaryTypeLabels[staff.salary_type] || 'ÊôÇÁµ¶'}: ¬•${(staff.salary_amount || 0).toLocaleString()}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="staffClockIn(${staff.id})" class="px-3 py-1 bg-green-900/30 text-green-400 border border-green-800/30 rounded-lg text-sm hover:bg-green-900/50">
                            Âá∫Âã§
                        </button>
                        <button onclick="deleteStaff(${staff.id})" class="px-3 py-1 bg-red-900/30 text-red-400 border border-red-800/30 rounded-lg text-sm hover:bg-red-900/50">
                            ÂâäÈô§
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderStaffAttendanceList() {
            const container = document.getElementById('staffAttendanceList');
            if (!container) return;
            
            if (appState.staffAttendances.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Êú¨Êó•„ÅÆÂá∫Âã§Ë®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            container.innerHTML = appState.staffAttendances.map(att => `
                <div class="p-4 bg-black/20 rounded-xl border border-white/10 flex items-center justify-between">
                    <div>
                        <div class="text-white font-semibold">${att.staff_name}</div>
                        <div class="text-sm text-gray-400">
                            ${att.clock_in} ${att.clock_out ? '„Äú ' + att.clock_out : '„Äú Âã§Âãô‰∏≠'}
                            ${att.hours_worked > 0 ? `Ôºà${att.hours_worked.toFixed(1)}hÔºâ` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        ${att.daily_wage > 0 ? `<span class="text-amber-400 font-bold">¬•${att.daily_wage.toLocaleString()}</span>` : ''}
                        ${!att.clock_out ? `
                            <button onclick="staffClockOut(${att.id})" class="px-3 py-1 bg-amber-900/30 text-amber-400 border border-amber-800/30 rounded-lg text-sm hover:bg-amber-900/50">
                                ÈÄÄÂã§
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function updateTodayStaffCost() {
            const total = appState.staffAttendances.reduce((sum, att) => sum + (att.daily_wage || 0), 0);
            const el = document.getElementById('todayStaffCost');
            if (el) el.textContent = `¬•${total.toLocaleString()}`;
        }
        
        function openAddStaffModal() {
            document.getElementById('staffName').value = '';
            document.getElementById('staffRole').value = 'waiter';
            document.getElementById('staffSalaryType').value = 'hourly';
            document.getElementById('staffSalaryAmount').value = '1000';
            document.getElementById('staffPhone').value = '';
            updateSalaryLabel();
            document.getElementById('addStaffModal').classList.add('active');
        }
        
        function updateSalaryLabel() {
            const type = document.getElementById('staffSalaryType').value;
            const label = document.getElementById('salaryAmountLabel');
            const labels = { hourly: 'ÊôÇÁµ¶', daily: 'Êó•Áµ¶', monthly: 'ÊúàÁµ¶' };
            if (label) label.textContent = labels[type] || 'ÈáëÈ°ç';
        }
        
        async function addStaff(event) {
            event.preventDefault();
            
            const payload = {
                name: document.getElementById('staffName').value,
                role: document.getElementById('staffRole').value,
                salary_type: document.getElementById('staffSalaryType').value,
                salary_amount: parseInt(document.getElementById('staffSalaryAmount').value) || 1000,
                phone: document.getElementById('staffPhone').value || null
            };
            
            try {
                await apiRequest('/api/staff', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                closeModal('addStaffModal');
                showNotification('„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
                await loadStaffList();
            } catch (e) {
                console.error(e);
                showNotification('„Çπ„Çø„ÉÉ„Éï„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        async function deleteStaff(staffId) {
            if (!confirm('„Åì„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            try {
                await apiRequest(`/api/staff/${staffId}`, { method: 'DELETE' });
                showNotification('„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                await loadStaffList();
            } catch (e) {
                console.error(e);
                showNotification('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        async function staffClockIn(staffId) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const clockIn = now.toTimeString().slice(0, 5);
            
            try {
                await apiRequest('/api/staff-attendance', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: staffId,
                        date: today,
                        clock_in: clockIn
                    })
                });
                showNotification('Âá∫Âã§„Åó„Åæ„Åó„Åü', 'success');
                await loadStaffAttendances();
            } catch (e) {
                console.error(e);
                if (e.message.includes('400')) {
                    showNotification('Êó¢„Å´Âá∫Âã§„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
                } else {
                    showNotification('Âá∫Âã§Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            }
        }
        
        async function staffClockOut(attendanceId) {
            const now = new Date();
            const clockOut = now.toTimeString().slice(0, 5);
            
            try {
                await apiRequest(`/api/staff-attendance/${attendanceId}/clock-out`, {
                    method: 'PUT',
                    body: JSON.stringify({ clock_out: clockOut })
                });
                showNotification('ÈÄÄÂã§„Åó„Åæ„Åó„Åü', 'success');
                await loadStaffAttendances();
            } catch (e) {
                console.error(e);
                showNotification('ÈÄÄÂã§Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // ========== „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö ==========
        
        function openTableSettingsModal() {
            renderTableSettingsList();
            document.getElementById('tableSettingsModal').classList.add('active');
        }
        
        function renderTableSettingsList() {
            const list = document.getElementById('tableSettingsList');
            if (!list) return;
            
            if (appState.tables.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">„ÉÜ„Éº„Éñ„É´„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            list.innerHTML = appState.tables.map(table => `
                <div class="glass-effect rounded-xl p-4 border border-white/10 hover:border-amber-500/30 transition flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold text-white">${table.name}</span>
                        ${table.is_vip ? '<span class="px-2 py-1 bg-amber-500/20 text-amber-300 text-xs rounded-full">VIP</span>' : ''}
                        <span class="text-sm ${table.status === 'available' ? 'text-green-400' : 'text-amber-400'}">${table.status === 'available' ? 'Á©∫Â∏≠' : '‰ΩøÁî®‰∏≠'}</span>
                    </div>
                    <button onclick="closeModal('tableSettingsModal'); openEditTableModal(${table.id});" class="px-3 py-1 bg-gray-700 text-gray-300 rounded-lg text-sm hover:bg-gray-600">
                        Á∑®ÈõÜ
                    </button>
                </div>
            `).join('');
        }
        
        function openAddTableModal() {
            document.getElementById('tableName').value = '';
            document.getElementById('tableIsVip').checked = false;
            document.getElementById('addTableModal').classList.add('active');
        }
        
        async function addTable(event) {
            event.preventDefault();
            
            const name = document.getElementById('tableName').value.trim();
            const isVip = document.getElementById('tableIsVip').checked;
            
            if (!name) {
                showNotification('„ÉÜ„Éº„Éñ„É´Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/tables`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, is_vip: isVip })
                });
                
                if (res.ok) {
                    const newTable = await res.json();
                    appState.tables.push(newTable);
                    renderTableSettingsList();
                    renderTables();
                    closeModal('addTableModal');
                    showNotification('„ÉÜ„Éº„Éñ„É´„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
                } else {
                    const err = await res.json();
                    showNotification(err.detail || 'ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (e) {
                console.error('„ÉÜ„Éº„Éñ„É´ËøΩÂä†„Ç®„É©„Éº:', e);
                showNotification('„ÉÜ„Éº„Éñ„É´ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        function openEditTableModal(tableId) {
            const table = appState.tables.find(t => t.id === tableId);
            if (!table) return;
            
            document.getElementById('editTableId').value = tableId;
            document.getElementById('editTableName').value = table.name;
            document.getElementById('editTableIsVip').checked = table.is_vip || false;
            document.getElementById('editTableModal').classList.add('active');
        }
        
        async function updateTable(event) {
            event.preventDefault();
            
            const tableId = document.getElementById('editTableId').value;
            const name = document.getElementById('editTableName').value.trim();
            const isVip = document.getElementById('editTableIsVip').checked;
            
            if (!name) {
                showNotification('„ÉÜ„Éº„Éñ„É´Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/tables/${tableId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, is_vip: isVip })
                });
                
                if (res.ok) {
                    const updated = await res.json();
                    const idx = appState.tables.findIndex(t => t.id == tableId);
                    if (idx !== -1) {
                        appState.tables[idx] = updated;
                    }
                    renderTableSettingsList();
                    renderTables();
                    closeModal('editTableModal');
                    showNotification('„ÉÜ„Éº„Éñ„É´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                } else {
                    const err = await res.json();
                    showNotification(err.detail || 'Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (e) {
                console.error('„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞„Ç®„É©„Éº:', e);
                showNotification('„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        async function deleteTable() {
            const tableId = document.getElementById('editTableId').value;
            const table = appState.tables.find(t => t.id == tableId);
            
            if (!confirm(`„ÉÜ„Éº„Éñ„É´„Äå${table?.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n‚Äª‰ΩøÁî®‰∏≠„ÅÆ„ÉÜ„Éº„Éñ„É´„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/tables/${tableId}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    appState.tables = appState.tables.filter(t => t.id != tableId);
                    renderTableSettingsList();
                    renderTables();
                    closeModal('editTableModal');
                    showNotification('„ÉÜ„Éº„Éñ„É´„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                } else {
                    const err = await res.json();
                    showNotification(err.detail || 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (e) {
                console.error('„ÉÜ„Éº„Éñ„É´ÂâäÈô§„Ç®„É©„Éº:', e);
                showNotification('„ÉÜ„Éº„Éñ„É´ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        function renderMenu() {
            const menuGrid = document.getElementById('menuGrid');
            
            // API„Åã„ÇâÂèñÂæó„Åó„Åü„Ç´„ÉÜ„Ç¥„É™„Çí„É≠„Ç∞Âá∫ÂäõÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
            if (appState.menuItems.length > 0) {
                const categories = [...new Set(appState.menuItems.map(i => i.category))];
                console.log('üì¶ „É°„Éã„É•„Éº„Ç´„ÉÜ„Ç¥„É™‰∏ÄË¶ß:', categories);
            }
            
            if (appState.menuItems.length === 0) {
                menuGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">„É°„Éã„É•„Éº„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            // „Éï„Ç£„É´„ÇøÈÅ©Áî®
            const filtered = appState.menuItems.filter(item => {
                if (currentMenuFilter === 'all') return true;
                return normalizeCategory(item.category) === currentMenuFilter;
            });

            if (filtered.length === 0) {
                menuGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">Ë©≤ÂΩì„Åô„Çã„É°„Éã„É•„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            menuGrid.innerHTML = filtered.map(item => {
                const normCat = normalizeCategory(item.category);
                return `
                <div class="luxury-card rounded-2xl overflow-hidden">
                    ${item.image ? 
                        `<img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover">` :
                        `<div class="w-full h-48 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center text-6xl">
                            ${getCategoryEmoji(normCat)}
                        </div>`
                    }
                    <div class="p-6">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getCategoryColor(normCat)}">
                                ${getCategoryLabel(normCat)}
                            </span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-200 mb-2">${item.name}</h3>
                        <p class="text-gray-400 text-sm mb-4">${item.description || ''}</p>
                        <div class="flex items-center justify-between">
                            <p class="text-2xl font-bold gold-accent">¬•${item.price.toLocaleString()}</p>
                            ${item.stock !== null ? 
                                `<p class="text-sm text-gray-400">Âú®Â∫´: ${item.stock}</p>` : 
                                ''}
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="editMenuItem(${item.id})" class="flex-1 bg-blue-900/20 text-blue-400 border border-blue-800/30 py-2 rounded-xl hover:bg-blue-900/30 transition text-sm">
                                Á∑®ÈõÜ
                            </button>
                            <button onclick="deleteMenuItem(${item.id})" class="flex-1 bg-red-900/20 text-red-400 border border-red-800/30 py-2 rounded-xl hover:bg-red-900/30 transition text-sm">
                                ÂâäÈô§
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function getCategoryEmoji(category) {
            const icons = {
                'bottle': 'üçæ',
                'drink': 'ü•É',
                'food': 'üçΩ',
                'set': 'üé´',
                'champagne': 'ü•Ç',
                'wine': 'üç∑',
                'other': 'üì¶'
            };
            return icons[category] || 'üì¶';
        }

        function getCategoryColor(category) {
            const colors = {
                'bottle': 'bg-purple-900/30 text-purple-300 border border-purple-800/30',
                'drink': 'bg-blue-900/30 text-blue-300 border border-blue-800/30',
                'food': 'bg-green-900/30 text-green-300 border border-green-800/30',
                'set': 'bg-yellow-900/30 text-yellow-300 border border-yellow-800/30',
                'champagne': 'bg-amber-900/30 text-amber-300 border border-amber-800/30',
                'wine': 'bg-rose-900/30 text-rose-300 border border-rose-800/30',
                'other': 'bg-gray-900/30 text-gray-300 border border-gray-800/30'
            };
            return colors[category] || 'bg-gray-900/30 text-gray-300 border border-gray-800/30';
        }

        function getCategoryLabel(category) {
            const labels = {
                'bottle': '„Éú„Éà„É´',
                'drink': '„Éâ„É™„É≥„ÇØ',
                'food': '„Éï„Éº„Éâ',
                'set': '„Çª„ÉÉ„Éà',
                'champagne': '„Ç∑„É£„É≥„Éë„É≥',
                'wine': '„ÉØ„Ç§„É≥',
                'other': '„Åù„ÅÆ‰ªñ'
            };
            return labels[category] || '„Åù„ÅÆ‰ªñ';
        }

        function openAddMenuModal() {
            document.getElementById('addMenuModal').classList.add('active');
            appState.currentMenuImage = null;
            document.getElementById('menuImagePreview').classList.add('hidden');
            
            // select„ÅÆoptions„ÇíÂãïÁöÑ„Å´Ë®≠ÂÆöÔºàHTML„Éë„Éº„Çπ„ÅÆÂïèÈ°åÂõûÈÅøÔºâ
            const sel = document.getElementById('menuCategory');
            if (sel && sel.options.length === 0) {
                const categories = [
                    { value: 'set', label: '„Çª„ÉÉ„Éà' },
                    { value: 'bottle', label: '„Éú„Éà„É´' },
                    { value: 'champagne', label: '„Ç∑„É£„É≥„Éë„É≥' },
                    { value: 'wine', label: '„ÉØ„Ç§„É≥' },
                    { value: 'drink', label: '„Éâ„É™„É≥„ÇØ' },
                    { value: 'food', label: '„Éï„Éº„Éâ' }
                ];
                categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.value;
                    opt.textContent = cat.label;
                    sel.appendChild(opt);
                });
                sel.value = 'bottle'; // „Éá„Éï„Ç©„É´„Éà
            }
        }

async function addMenuItem(event) {
    event.preventDefault();
    
    // ÂÖà„Å´„ÄåAPI„Å´Êäï„Åí„ÇãÁî®„ÅÆ„Éá„Éº„Çø„Äç„Çí‰Ωú„ÇãÔºàid„ÅØ‰ªò„Åë„Å™„ÅÑÔºâ
    const payload = {
        name: document.getElementById('menuName').value,
        category: document.getElementById('menuCategory').value,
        price: parseInt(document.getElementById('menuPrice').value),
        cost: parseInt(document.getElementById('menuCost').value) || 0,
        description: document.getElementById('menuDescription').value,
        image_url: appState.currentMenuImage,  // API„ÅØimage_url„ÇíÊúüÂæÖ
        stock: ['bottle', 'drink', 'food'].includes(document.getElementById('menuCategory').value) ? 100 : null
    };

    try {
        let createdItem;

        if (appState.apiConnected) {
            // ‚òÖ API„ÅåÁîü„Åç„Å¶„ÅÑ„Çã„Å®„Åç ‚Üí APIÁµåÁî±„ÅßÁôªÈå≤
            // „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÂÅ¥„ÅØ„ÄÅ‰ΩúÊàê„Åó„Åü„É°„Éã„É•„Éº„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºàid‰ªò„ÅçÔºâ„ÇíËøî„ÅôÊÉ≥ÂÆö
            createdItem = await apiRequest(API_ENDPOINTS.menu, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            // API„É¨„Çπ„Éù„É≥„Çπ„Å´image„Éó„É≠„Éë„ÉÜ„Ç£„ÇÇËøΩÂä†Ôºà„Éï„É≠„É≥„ÉàË°®Á§∫Áî®Ôºâ
            createdItem.image = createdItem.image_url;
        } else {
            // ‚òÖ API„Åå„Ç™„Éï„ÅÆ„Å®„Åç ‚Üí „Åì„Çå„Åæ„ÅßÈÄö„Çä„Éï„É≠„É≥„Éà„ÅÆ„Åø„ÅßÂÆåÁµê
            createdItem = {
                ...payload,
                id: appState.menuItems.length + 1,
                image: payload.image_url
            };
        }

        appState.menuItems.push(createdItem);
        renderMenu();
        closeModal('addMenuModal');
        showNotification('„É°„Éã„É•„Éº„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');

        // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
        document.getElementById('menuName').value = '';
        document.getElementById('menuPrice').value = '';
        document.getElementById('menuCost').value = '';
        document.getElementById('menuDescription').value = '';
    } catch (error) {
        console.error(error);
        showNotification('„É°„Éã„É•„Éº„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
}

        function editMenuItem(id) {
            const item = appState.menuItems.find(m => m.id === id);
            if (!item) return;

            appState.currentEditingMenuId = id;
            appState.currentMenuImage = item.image;
            
            // select„ÅÆoptions„ÇíÂãïÁöÑ„Å´Ë®≠ÂÆöÔºàHTML„Éë„Éº„Çπ„ÅÆÂïèÈ°åÂõûÈÅøÔºâ
            const sel = document.getElementById('editMenuCategory');
            if (sel && sel.options.length === 0) {
                const categories = [
                    { value: 'set', label: '„Çª„ÉÉ„Éà' },
                    { value: 'bottle', label: '„Éú„Éà„É´' },
                    { value: 'champagne', label: '„Ç∑„É£„É≥„Éë„É≥' },
                    { value: 'wine', label: '„ÉØ„Ç§„É≥' },
                    { value: 'drink', label: '„Éâ„É™„É≥„ÇØ' },
                    { value: 'food', label: '„Éï„Éº„Éâ' }
                ];
                categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.value;
                    opt.textContent = cat.label;
                    sel.appendChild(opt);
                });
            }
            
            document.getElementById('editMenuId').value = item.id;
            document.getElementById('editMenuName').value = item.name;
            document.getElementById('editMenuCategory').value = normalizeCategory(item.category);
            document.getElementById('editMenuPrice').value = item.price;
            document.getElementById('editMenuCost').value = item.cost || 0;
            document.getElementById('editMenuDescription').value = item.description || '';
            
            if (item.image) {
                const preview = document.getElementById('editMenuImagePreview');
                preview.src = item.image;
                preview.classList.remove('hidden');
            } else {
                document.getElementById('editMenuImagePreview').classList.add('hidden');
            }
            
            document.getElementById('editMenuModal').classList.add('active');
        }

async function updateMenuItem(event) {
    event.preventDefault();
    
    const id = parseInt(document.getElementById('editMenuId').value);
    const itemIndex = appState.menuItems.findIndex(m => m.id === id);
    
    if (itemIndex === -1) return;

    const updatedItem = {
        ...appState.menuItems[itemIndex],
        name: document.getElementById('editMenuName').value,
        category: document.getElementById('editMenuCategory').value,
        price: parseInt(document.getElementById('editMenuPrice').value),
        cost: parseInt(document.getElementById('editMenuCost').value) || 0,
        description: document.getElementById('editMenuDescription').value,
        image_url: appState.currentMenuImage,  // API„ÅØimage_url„ÇíÊúüÂæÖ
        image: appState.currentMenuImage       // „Éï„É≠„É≥„ÉàË°®Á§∫Áî®
    };

    try {
        if (appState.apiConnected) {
            // ‚òÖ „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´Êõ¥Êñ∞„ÇíÂèçÊò†
            await apiRequest(`${API_ENDPOINTS.menu}/${id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    name: updatedItem.name,
                    category: updatedItem.category,
                    price: updatedItem.price,
                    cost: updatedItem.cost,
                    description: updatedItem.description,
                    image_url: updatedItem.image_url
                })
            });
        }

        // „É≠„Éº„Ç´„É´Áä∂ÊÖã„ÅØÂøÖ„ÅöÊõ¥Êñ∞
        appState.menuItems[itemIndex] = updatedItem;
        renderMenu();
        closeModal('editMenuModal');
        showNotification('„É°„Éã„É•„Éº„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
    } catch (error) {
        console.error(error);
        showNotification('„É°„Éã„É•„Éº„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
}

async function deleteMenuItem(id) {
    if (!confirm('„Åì„ÅÆ„É°„Éã„É•„Éº„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

    try {
        if (appState.apiConnected) {
            // ‚òÖ „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÂâäÈô§„ÇíÂèçÊò†
            await apiRequest(`${API_ENDPOINTS.menu}/${id}`, {
                method: 'DELETE'
            });
        }

        // „É≠„Éº„Ç´„É´Áä∂ÊÖã„Åã„ÇâÂâäÈô§
        appState.menuItems = appState.menuItems.filter(item => item.id !== id);
        renderMenu();
        showNotification('„É°„Éã„É•„Éº„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    } catch (error) {
        console.error(error);
        showNotification('„É°„Éã„É•„Éº„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
}


function closeTableDetailPanel() {
    appState.isTableDetailOpen = false;
    appState.currentTableId = null;
    appState.currentTableDetail = null;
    appState.currentTableSession = null;

    const panel = document.getElementById('tableDetailPanel');
    if (panel) panel.classList.add('hidden');
}
function getActiveSessionByTableId(tableId) {
    const list = Array.isArray(appState.activeSessions) ? appState.activeSessions : [];
    return list.find(s => Number(s.tableId ?? s.table_id) === Number(tableId)) || null;
}

function getCastNameById(castId) {
    const casts = Array.isArray(appState.casts) ? appState.casts : [];
    const c = casts.find(x => Number(x.id) === Number(castId));
    return c ? (c.name || c.display_name || c.nickname || `#${c.id}`) : '';
}

// „Ç™„Éº„ÉÄ„Éº„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂàá„ÇäÊõø„ÅàÔºàÊú™Êèê‰æõ‚áîÊèê‰æõÊ∏à„ÅøÔºâ
async function toggleOrderStatus(sessionId, orderId, setServed) {
    try {
        // API„Åß„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
        await apiRequest(`/sessions/${sessionId}/orders/${orderId}/status`, {
            method: 'PUT',
            body: JSON.stringify({ is_served: setServed })
        });
        
        // „ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞„ÇíÂÜçË™≠„ÅøËæº„Åø
        const tableId = appState.currentTableId;
        if (tableId && typeof openTableDetail === 'function') {
            await openTableDetail(tableId);
        }
        
        showNotification(setServed ? 'Êèê‰æõÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü' : 'Êú™Êèê‰æõ„Å´Êàª„Åó„Åæ„Åó„Åü', 'success');
    } catch (e) {
        console.error('[toggleOrderStatus] error:', e);
        
        // API„Åå„Å™„Åè„Å¶„ÇÇ„Éï„É≠„É≥„Éà„ÅßÁä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºà„Éá„É¢Áî®Ôºâ
        const session = appState.activeSessions.find(s => Number(s.id) === Number(sessionId));
        if (session && session.orders) {
            const order = session.orders.find(o => Number(o.id) === Number(orderId));
            if (order) {
                order.is_served = setServed;
                order.status = setServed ? 'served' : 'pending';
            }
        }
        
        // Ë©≥Á¥∞„Éë„Éç„É´„ÇíÂÜçÊèèÁîª
        const tableId = appState.currentTableId;
        if (tableId && typeof openTableDetail === 'function') {
            await openTableDetail(tableId);
        }
        
        showNotification(setServed ? 'Êèê‰æõÊ∏à„Åø„Å´„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´Ôºâ' : 'Êú™Êèê‰æõ„Å´Êàª„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´Ôºâ', 'info');
    }
}

// ========== „Ç™„Éº„ÉÄ„ÉºÁÆ°ÁêÜ ==========
let currentOrderFilter = 'all';
let allOrders = [];

async function loadOrdersFromApi() {
    try {
        const data = await apiRequest('/orders');
        allOrders = Array.isArray(data) ? data : [];
        renderOrders();
    } catch (e) {
        console.error('[loadOrdersFromApi] error:', e);
        // API„Åå„Å™„ÅÑÂ†¥Âêà„ÅØactiveSessions„Åã„ÇâÂèñÂæó
        allOrders = [];
        (appState.activeSessions || []).forEach(session => {
            if (session.orders) {
                session.orders.forEach(order => {
                    allOrders.push({
                        ...order,
                        session_id: session.id,
                        table_id: session.tableId || session.table_id,
                        table_name: session.tableName || session.table_name || '?',
                        item_name: order.itemName || order.item_name || '?',
                        is_served: order.is_served || order.status === 'served'
                    });
                });
            }
        });
        renderOrders();
    }
}

function filterOrders(filter) {
    currentOrderFilter = filter;
    
    // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    document.querySelectorAll('.order-filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-amber-600', 'text-white');
        btn.classList.add('bg-gray-700', 'text-gray-300');
    });
    
    const activeBtn = document.getElementById(`orderFilter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
    if (activeBtn) {
        activeBtn.classList.add('active', 'bg-amber-600', 'text-white');
        activeBtn.classList.remove('bg-gray-700', 'text-gray-300');
    }
    
    renderOrders();
}

function renderOrders() {
    const grid = document.getElementById('ordersGrid');
    const noOrdersMsg = document.getElementById('noOrdersMessage');
    const pendingSummary = document.getElementById('pendingOrdersSummary');
    const pendingCount = document.getElementById('pendingOrdersCount');
    
    if (!grid) return;
    
    // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞
    let filteredOrders = allOrders;
    if (currentOrderFilter === 'pending') {
        filteredOrders = allOrders.filter(o => !o.is_served);
    } else if (currentOrderFilter === 'served') {
        filteredOrders = allOrders.filter(o => o.is_served);
    }
    
    // Êú™Êèê‰æõ„Çµ„Éû„É™„Éº
    const pendingOrders = allOrders.filter(o => !o.is_served);
    if (pendingOrders.length > 0) {
        pendingSummary.classList.remove('hidden');
        
        // „ÉÜ„Éº„Éñ„É´„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
        const byTable = {};
        pendingOrders.forEach(o => {
            const tName = o.table_name || '?';
            if (!byTable[tName]) byTable[tName] = [];
            byTable[tName].push(o);
        });
        
        const tableInfo = Object.entries(byTable)
            .map(([table, orders]) => `„ÉÜ„Éº„Éñ„É´${table}: ${orders.length}‰ª∂`)
            .join('„ÄÅ');
        
        pendingCount.textContent = `${pendingOrders.length}‰ª∂„ÅÆÊú™Êèê‰æõ„Ç™„Éº„ÉÄ„ÉºÔºà${tableInfo}Ôºâ`;
    } else {
        pendingSummary.classList.add('hidden');
    }
    
    if (filteredOrders.length === 0) {
        grid.innerHTML = '';
        noOrdersMsg.classList.remove('hidden');
        return;
    }
    
    noOrdersMsg.classList.add('hidden');
    
    // ÊôÇÈñì„Åß„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
    filteredOrders.sort((a, b) => {
        const dateA = new Date(a.created_at || 0);
        const dateB = new Date(b.created_at || 0);
        return dateB - dateA;
    });
    
    grid.innerHTML = filteredOrders.map(order => {
        const isServed = order.is_served;
        const statusClass = isServed 
            ? 'border-green-500/30 bg-green-900/10' 
            : 'border-amber-500/30 bg-amber-900/10';
        const statusBadge = isServed 
            ? '<span class="px-2 py-1 text-xs font-bold rounded-full bg-green-500/20 text-green-400 border border-green-500/30">‚úì Êèê‰æõÊ∏à</span>'
            : '<span class="px-2 py-1 text-xs font-bold rounded-full bg-amber-500/20 text-amber-400 border border-amber-500/30 animate-pulse">‚è≥ Êú™Êèê‰æõ</span>';
        
        // created_at„Çí„Éë„Éº„ÇπÔºàUTC„Å®„Åó„Å¶Ëß£Èáà„Åï„Çå„Çã„ÅÆ„ÅßJST„Å´Â§âÊèõÔºâ
        let createdAt = null;
        if (order.created_at) {
            // ISOÊñáÂ≠óÂàó„Å´Z„Åå„Å™„Åë„Çå„Å∞UTC„Å®„Åó„Å¶Êâ±„ÅÜ
            const isoStr = order.created_at.includes('Z') || order.created_at.includes('+') 
                ? order.created_at 
                : order.created_at + 'Z';
            createdAt = new Date(isoStr);
        }
        
        const timeStr = createdAt 
            ? createdAt.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
            : '--:--';
        
        // ÁµåÈÅéÊôÇÈñì
        let elapsedStr = '';
        if (createdAt && !isServed) {
            const now = new Date();
            // ÂàÜÂçò‰Ωç„ÅÆÂ∑ÆÂàÜ„ÇíË®àÁÆó
            const elapsed = Math.floor((now.getTime() - createdAt.getTime()) / 60000);
            // Ë≤†„ÅÆÂÄ§„ÇÑÁï∞Â∏∏„Å™ÂÄ§„ÅØË°®Á§∫„Åó„Å™„ÅÑ
            if (elapsed >= 0 && elapsed < 1440) { // 24ÊôÇÈñì‰ª•ÂÜÖ
                if (elapsed >= 10) {
                    elapsedStr = `<span class="text-red-400 font-bold">${elapsed}ÂàÜÁµåÈÅé</span>`;
                } else if (elapsed >= 5) {
                    elapsedStr = `<span class="text-amber-400">${elapsed}ÂàÜÁµåÈÅé</span>`;
                } else {
                    elapsedStr = `<span class="text-gray-400">${elapsed}ÂàÜÁµåÈÅé</span>`;
                }
            }
        }
        
        const categoryEmoji = {
            'set': 'üé´', 'bottle': 'üçæ', 'champagne': 'ü•Ç', 
            'wine': 'üç∑', 'drink': 'ü•É', 'food': 'üçΩÔ∏è'
        };
        const emoji = categoryEmoji[order.category] || 'üì¶';
        
        return `
            <div class="luxury-card rounded-xl p-4 border ${statusClass}">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-bold text-amber-400">T${order.table_name}</span>
                        ${statusBadge}
                    </div>
                    <span class="text-xs text-gray-500">${timeStr}</span>
                </div>
                
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-2xl">${emoji}</span>
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-semibold truncate">${order.item_name || '?'}</div>
                        <div class="text-sm text-gray-400">√ó${order.quantity} / ¬•${(order.price * order.quantity).toLocaleString()}</div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="text-xs text-gray-500">${elapsedStr}</div>
                    <button 
                        onclick="toggleOrderStatusFromList(${order.session_id}, ${order.id}, ${isServed ? 'false' : 'true'})"
                        class="px-3 py-1.5 text-sm rounded-lg font-semibold transition ${isServed 
                            ? 'bg-gray-600/50 text-gray-400 hover:bg-red-500/30 hover:text-red-400' 
                            : 'bg-green-600/30 text-green-400 hover:bg-green-500/50'}"
                    >${isServed ? 'Êú™Êèê‰æõ„Å´Êàª„Åô' : 'Êèê‰æõÊ∏à„Åø„Å´„Åô„Çã'}</button>
                </div>
            </div>
        `;
    }).join('');
}

async function toggleOrderStatusFromList(sessionId, orderId, setServed) {
    try {
        await apiRequest(`/sessions/${sessionId}/orders/${orderId}/status`, {
            method: 'PUT',
            body: JSON.stringify({ is_served: setServed })
        });
        
        // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        await loadOrdersFromApi();
        
        // „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„ÇÇÊõ¥Êñ∞
        if (typeof loadActiveSessionsFromApi === 'function') {
            await loadActiveSessionsFromApi();
        }
        
        showNotification(setServed ? 'Êèê‰æõÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü' : 'Êú™Êèê‰æõ„Å´Êàª„Åó„Åæ„Åó„Åü', 'success');
    } catch (e) {
        console.error('[toggleOrderStatusFromList] error:', e);
        
        // „É≠„Éº„Ç´„É´„ÅßÊõ¥Êñ∞
        const order = allOrders.find(o => o.id === orderId);
        if (order) {
            order.is_served = setServed;
        }
        renderOrders();
        
        showNotification(setServed ? 'Êèê‰æõÊ∏à„Åø„Å´„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´Ôºâ' : 'Êú™Êèê‰æõ„Å´Êàª„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´Ôºâ', 'info');
    }
}

// ========== „Éâ„É™„É≥„ÇØÊ≥®ÊñáÈñ¢ÈÄ£ ==========

// Ââ≤„ÇäÊñπ„ÉªÁ®ÆÈ°û„ÅÆÂÆöÁæ©Ôºà„ÅäÂÆ¢ÊßòÁî®„Éâ„É™„É≥„ÇØÔºâ
const mixStylesAdmin = {
    '„Éì„Éº„É´': ['Áîü„Éì„Éº„É´', '„Ç¢„Ç§„Çπ„Éì„Éº„É´', '„Ç∑„É£„É≥„Éá„Ç£„Ç¨„Éï', '„É¨„ÉÉ„Éâ„Ç¢„Ç§'],
    '„Ç´„ÇØ„ÉÜ„É´': ['„Ç´„Ç∑„Çπ„Ç™„É¨„É≥„Ç∏', '„Ç´„Ç∑„Çπ„ÇΩ„Éº„ÉÄ', '„Ç´„Ç∑„Çπ„Ç¶„Éº„É≠„É≥', '„Éî„Éº„ÉÅ„Ç™„É¨„É≥„Ç∏', '„Éî„Éº„ÉÅ„Ç¶„Éº„É≠„É≥', '„Éï„Ç°„Ç∏„Éº„Éç„Éº„Éñ„É´', '„Ç´„É´„Éº„Ç¢„Éü„É´„ÇØ'],
    '„ÇΩ„Éï„Éà„Éâ„É™„É≥„ÇØ': ['„Ç¶„Éº„É≠„É≥Ëå∂', 'Á∑ëËå∂', '„Ç™„É¨„É≥„Ç∏„Ç∏„É•„Éº„Çπ', '„Ç∞„É¨„Éº„Éó„Éï„É´„Éº„ÉÑ„Ç∏„É•„Éº„Çπ', '„Ç≥„Éº„É©', '„Ç∏„É≥„Ç∏„É£„Ç®„Éº„É´', 'ÁÇ≠ÈÖ∏Ê∞¥', '„Ç´„É´„Éî„Çπ', '„Ç´„É´„Éî„Çπ„ÇΩ„Éº„ÉÄ'],
    '„Ç∑„Éß„ÉÉ„Éà': ['„ÉÜ„Ç≠„Éº„É©', '„Ç§„Çß„Éº„Ç¨„Éº', '„Ç≥„Ç´„É¨„É≠', '„ÇØ„É©„Ç§„Éä„Éº'],
    '„Ç∞„É©„Çπ„ÉØ„Ç§„É≥': ['„Ç∞„É©„Çπ„ÉØ„Ç§„É≥ÔºàËµ§Ôºâ', '„Ç∞„É©„Çπ„ÉØ„Ç§„É≥ÔºàÁôΩÔºâ', '„Ç≠„ÉÜ„Ç£', '„Ç™„Éö„É¨„Éº„Çø„Éº']
};

// „Ç≠„É£„Çπ„Éà„Éª„Çπ„Çø„ÉÉ„Éï„Éâ„É™„É≥„ÇØÁî®„ÅÆÂâ≤„ÇäÊñπ
const castDrinkMixStylesAdmin = {
    'È∫¶ÁÑºÈÖé': ['„É≠„ÉÉ„ÇØ', 'Ê∞¥Ââ≤„Çä', '„ÇΩ„Éº„ÉÄÂâ≤„Çä', 'Á∑ëËå∂Ââ≤„Çä', 'Á¥ÖËå∂Ââ≤„Çä', '„Ç¶„Éº„É≠„É≥Ëå∂Ââ≤„Çä', '„Ç∏„É£„Çπ„Éü„É≥Ââ≤„Çä', '„Ç≥„Éº„Éí„ÉºÂâ≤„Çä', '„ÅäÊπØÂâ≤„Çä', '„É¨„É¢„É≥„Çµ„ÉØ„Éº'],
    '„Ç¶„Ç§„Çπ„Ç≠„Éº': ['„É≠„ÉÉ„ÇØ', '„Çπ„Éà„É¨„Éº„Éà', 'Ê∞¥Ââ≤„Çä', '„Éè„Ç§„Éú„Éº„É´', '„Ç≥„Éº„ÇØÂâ≤„Çä', '„Ç∏„É≥„Ç∏„É£„ÉºÂâ≤„Çä']
};

// ÊúâÊñô„Éâ„É™„É≥„ÇØÔºà„ÅäÂÆ¢Êßò„ÇÇ„Çª„ÉÉ„ÉàËæº„Åø„Åß„ÅØ„Å™„ÅèË™≤ÈáëÔºâ
const paidDrinksAdmin = ['„Ç∑„Éß„ÉÉ„Éà', '„Ç∞„É©„Çπ„ÉØ„Ç§„É≥'];

// „Ç≠„É£„Çπ„Éà„Éª„Çπ„Çø„ÉÉ„ÉïÂ∞ÇÁî®„Éâ„É™„É≥„ÇØ
const castOnlyDrinksAdmin = ['È∫¶ÁÑºÈÖé', '„Ç¶„Ç§„Çπ„Ç≠„Éº'];

// ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆÂâ≤„ÇäÊñπ
let selectedMixStyleAdmin = null;

// „É°„Éã„É•„ÉºÈÅ∏Êäû„ÅåÂ§â„Çè„Å£„ÅüÊôÇ
function onOrderMenuChange() {
    const select = document.getElementById('selAddOrderItem');
    if (!select) return;
    
    const itemId = Number(select.value);
    const menuItem = (appState.menuItems || []).find(m => m.id === itemId);
    const category = (menuItem?.category || '').toLowerCase();
    const itemName = menuItem?.name || '';
    
    const drinkSizeSection = document.getElementById('drinkSizeSection');
    const drinkForSection = document.getElementById('drinkForSection');
    const mixStyleSection = document.getElementById('mixStyleSection');
    const mixStyleOptions = document.getElementById('mixStyleOptions');
    
    // „Ç´„ÉÜ„Ç¥„É™Âà§ÂÆö
    const isCastDrink = category === 'castdrink';
    const isTableSet = category === 'tableset';
    const isDrinkCategory = ['drink', 'castdrink', 'bottle', 'champagne', 'wine'].includes(category);
    const isDrinkOnly = ['drink', 'castdrink'].includes(category);
    const isPaidDrink = paidDrinksAdmin.includes(itemName);
    const isCastOnlyDrink = castOnlyDrinksAdmin.includes(itemName);
    
    // Ââ≤„ÇäÊñπ„Çπ„Çø„Ç§„É´„ÇíÂèñÂæó
    const hasMixStyle = isCastDrink 
        ? castDrinkMixStylesAdmin[itemName] !== undefined 
        : mixStylesAdmin[itemName] !== undefined;
    const currentMixStyles = isCastDrink ? castDrinkMixStylesAdmin : mixStylesAdmin;
    
    // Ââ≤„ÇäÊñπÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥
    if (mixStyleSection && mixStyleOptions) {
        if (hasMixStyle) {
            mixStyleSection.classList.remove('hidden');
            const styles = currentMixStyles[itemName];
            mixStyleOptions.innerHTML = styles.map((style, index) => `
                <label class="mix-style-admin-label flex items-center justify-center p-2 rounded-xl bg-black/20 ${index === 0 ? 'border-2 border-amber-500 bg-amber-500/20' : 'border border-white/10'} cursor-pointer hover:bg-black/30">
                    <input type="radio" name="mixStyleAdmin" value="${style}" ${index === 0 ? 'checked' : ''} onchange="updateMixStyleAdminStyle()" class="hidden">
                    <span class="text-sm text-white/90">${style}</span>
                </label>
            `).join('');
            selectedMixStyleAdmin = styles[0];
        } else {
            mixStyleSection.classList.add('hidden');
            mixStyleOptions.innerHTML = '';
            selectedMixStyleAdmin = null;
        }
    }
    
    // Ë™∞„ÅåÈ£≤„ÇÄ„ÅãÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥
    const customerLabel = document.querySelector('.drink-for-label input[value="customer"]')?.parentElement;
    
    if (isCastDrink) {
        // „Ç≠„É£„Çπ„Éà„Éª„Çπ„Çø„ÉÉ„Éï„Éâ„É™„É≥„ÇØ„ÅØ„ÅäÂÆ¢ÊßòÈÅ∏Êäû„Å™„Åó
        if (customerLabel) customerLabel.classList.add('hidden');
        if (drinkForSection) drinkForSection.classList.remove('hidden');
        // „Éá„Éï„Ç©„É´„Éà„Åß„Ç≠„É£„Çπ„Éà„ÇíÈÅ∏Êäû
        const castRadio = document.querySelector('input[name="drinkFor"][value="cast"]');
        if (castRadio) castRadio.checked = true;
        updateDrinkForStyle();
        // „Çµ„Ç§„Ç∫ÈÅ∏Êäû„ÇíË°®Á§∫
        if (drinkSizeSection) drinkSizeSection.classList.remove('hidden');
        // ‰∫∫Áâ©ÈÅ∏Êäû„ÇíË°®Á§∫
        onDrinkForChange();
    } else if (isTableSet) {
        // Âçì„Çª„ÉÉ„Éà„ÅØË™∞„ÅåÈ£≤„ÇÄ„Åã‰∏çË¶Å
        if (drinkForSection) drinkForSection.classList.add('hidden');
        if (drinkSizeSection) drinkSizeSection.classList.add('hidden');
    } else {
        // ÈÄöÂ∏∏„Éâ„É™„É≥„ÇØ„ÅØ„ÅäÂÆ¢ÊßòÈÅ∏Êäû„ÅÇ„Çä
        if (customerLabel) customerLabel.classList.remove('hidden');
        if (drinkForSection) drinkForSection.classList.toggle('hidden', !isDrinkCategory);
        // ÂàùÊúüË°®Á§∫„ÅØ„ÅäÂÆ¢Êßò„Å™„ÅÆ„Åß„Çµ„Ç§„Ç∫ÈÅ∏Êäû„ÅØÈùûË°®Á§∫
        if (drinkSizeSection) drinkSizeSection.classList.add('hidden');
        // „É™„Çª„ÉÉ„Éà
        const customerRadio = document.querySelector('input[name="drinkFor"][value="customer"]');
        if (customerRadio) customerRadio.checked = true;
        updateDrinkForStyle();
    }
    
    // ‰∫∫Áâ©ÈÅ∏Êäû„É™„Çª„ÉÉ„Éà
    const personSection = document.getElementById('personSelectSection');
    if (personSection && !isCastDrink) personSection.classList.add('hidden');
}

// Ââ≤„ÇäÊñπÈÅ∏Êäû„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
function updateMixStyleAdminStyle() {
    document.querySelectorAll('.mix-style-admin-label').forEach(label => {
        const input = label.querySelector('input');
        if (input?.checked) {
            label.classList.remove('border', 'border-white/10');
            label.classList.add('border-2', 'border-amber-500', 'bg-amber-500/20');
            selectedMixStyleAdmin = input.value;
        } else {
            label.classList.remove('border-2', 'border-amber-500', 'bg-amber-500/20');
            label.classList.add('border', 'border-white/10');
        }
    });
}

// Ë™∞„ÅåÈ£≤„ÇÄ„ÅãÈÅ∏Êäû„ÅåÂ§â„Çè„Å£„ÅüÊôÇ
function onDrinkForChange() {
    const drinkFor = document.querySelector('input[name="drinkFor"]:checked')?.value || 'customer';
    const personSection = document.getElementById('personSelectSection');
    const personSelect = document.getElementById('selDrinkPerson');
    const drinkBackInfo = document.getElementById('drinkBackInfo');
    const drinkSizeSection = document.getElementById('drinkSizeSection');
    
    // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„É°„Éã„É•„Éº„ÇíÂèñÂæó
    const select = document.getElementById('selAddOrderItem');
    const itemId = Number(select?.value);
    const menuItem = (appState.menuItems || []).find(m => m.id === itemId);
    const itemName = menuItem?.name || '';
    const category = (menuItem?.category || '').toLowerCase();
    const isPaidDrink = paidDrinksAdmin.includes(itemName);
    const isDrinkOnly = category === 'drink';
    
    if (drinkFor === 'customer') {
        // „ÅäÂÆ¢Êßò„ÅÆÂ†¥Âêà„ÅØÈÅ∏Êäû‰∏çË¶Å
        personSection?.classList.add('hidden');
        drinkBackInfo?.classList.add('hidden');
        // „ÅäÂÆ¢Êßò„ÅØ„Çµ„Ç§„Ç∫ÈÅ∏Êäû‰∏çË¶ÅÔºà„Çª„ÉÉ„ÉàÊñôÈáëËæº„Åø or ÊúâÊñô„Éâ„É™„É≥„ÇØÁµ±‰∏Ä‰æ°Ê†ºÔºâ
        drinkSizeSection?.classList.add('hidden');
    } else {
        // „Ç≠„É£„Çπ„Éà„Åæ„Åü„ÅØ„Çπ„Çø„ÉÉ„Éï„ÅÆÂ†¥Âêà
        personSection?.classList.remove('hidden');
        
        // „Çµ„Ç§„Ç∫ÈÅ∏ÊäûË°®Á§∫ÔºàÊúâÊñô„Éâ„É™„É≥„ÇØ‰ª•Â§ñ„ÅÆ„Éâ„É™„É≥„ÇØ„Ç´„ÉÜ„Ç¥„É™Ôºâ
        if (drinkSizeSection && isDrinkOnly && !isPaidDrink) {
            drinkSizeSection.classList.remove('hidden');
        }
        
        // „Ç™„Éó„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
        if (personSelect) {
            let options = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            
            if (drinkFor === 'cast') {
                (appState.casts || []).forEach(c => {
                    const name = c.stage_name || c.name || `Cast#${c.id}`;
                    options += `<option value="${name}">${name}</option>`;
                });
                drinkBackInfo?.classList.remove('hidden');
            } else if (drinkFor === 'staff') {
                (appState.staff || []).forEach(s => {
                    options += `<option value="${s.name}">${s.name}Ôºà${getStaffRoleLabel(s.role)}Ôºâ</option>`;
                });
                drinkBackInfo?.classList.add('hidden');
            }
            
            personSelect.innerHTML = options;
        }
    }
}

// „Éâ„É™„É≥„ÇØ„Çµ„Ç§„Ç∫ÈÅ∏Êäû„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
function updateDrinkSizeStyle() {
    document.querySelectorAll('.drink-size-label').forEach(label => {
        const input = label.querySelector('input');
        if (input?.checked) {
            label.classList.remove('border', 'border-white/10');
            label.classList.add('border-2', 'border-amber-500', 'bg-amber-500/20');
        } else {
            label.classList.remove('border-2', 'border-amber-500', 'bg-amber-500/20');
            label.classList.add('border', 'border-white/10');
        }
    });
}

// Ë™∞„ÅåÈ£≤„ÇÄ„ÅãÈÅ∏Êäû„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
function updateDrinkForStyle() {
    const colors = {
        'customer': { border: 'border-blue-500', bg: 'bg-blue-500/20' },
        'staff': { border: 'border-green-500', bg: 'bg-green-500/20' },
        'cast': { border: 'border-purple-500', bg: 'bg-purple-500/20' }
    };
    
    document.querySelectorAll('.drink-for-label').forEach(label => {
        const input = label.querySelector('input');
        const value = input?.value;
        const color = colors[value] || colors['customer'];
        
        // „É™„Çª„ÉÉ„Éà
        label.classList.remove('border-2', 'border-blue-500', 'border-green-500', 'border-purple-500', 
                               'bg-blue-500/20', 'bg-green-500/20', 'bg-purple-500/20');
        
        if (input?.checked) {
            label.classList.remove('border', 'border-white/10');
            label.classList.add('border-2', color.border, color.bg);
        } else {
            label.classList.add('border', 'border-white/10');
        }
    });
}

// ========== „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊôÇ„ÅÆÊñôÈáëË®àÁÆó ==========

// ÊñôÈáë„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
function updateStartCharges() {
    const charges = calculateStartCharges();
    
    document.getElementById('previewSetTotal').textContent = `¬•${charges.setTotal.toLocaleString()}`;
    document.getElementById('previewSingle').textContent = `¬•${charges.single.toLocaleString()}`;
    document.getElementById('previewDouhan').textContent = `¬•${charges.douhan.toLocaleString()}`;
    document.getElementById('previewShimei').textContent = `¬•${charges.shimei.toLocaleString()}`;
    document.getElementById('previewTax').textContent = `¬•${charges.tax.toLocaleString()}`;
    document.getElementById('previewTotal').textContent = `¬•${charges.total.toLocaleString()}`;
    
    // ÊåáÂêç„Ç≠„É£„Çπ„Éà„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
    const shimeiPreview = document.getElementById('shimeiCastPreview');
    if (shimeiPreview) {
        const checkedCasts = document.querySelectorAll('.shimei-cast-checkbox:checked');
        if (checkedCasts.length > 0) {
            const names = Array.from(checkedCasts).map(c => c.dataset.name).join(', ');
            shimeiPreview.textContent = `ÈÅ∏Êäû‰∏≠: ${names}ÔºàÊåáÂêçÊñô ¬•${(checkedCasts.length * 2000).toLocaleString()}Ôºâ`;
        } else {
            shimeiPreview.textContent = '';
        }
    }
    
    // „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏„ÅÆËá™Âãï„ÉÅ„Çß„ÉÉ„ÇØÔºà1Âêç„ÅÆÂ†¥ÂêàÔºâ
    const guests = Number(document.getElementById('inpStartGuests')?.value ?? 1);
    const chkSingle = document.getElementById('chkSingle');
    if (chkSingle && guests === 1) {
        chkSingle.checked = true;
    } else if (chkSingle && guests > 1) {
        chkSingle.checked = false;
    }
}

// ÊñôÈáë„ÇíË®àÁÆó
function calculateStartCharges() {
    const guests = Number(document.getElementById('inpStartGuests')?.value ?? 1);
    const setPrice = Number(document.getElementById('inpSetPrice')?.value ?? 5000);
    const taxRate = Number(document.getElementById('selTaxRate')?.value ?? 20);
    const hasDouhan = document.getElementById('chkDouhan')?.checked ?? false;
    const hasSingle = document.getElementById('chkSingle')?.checked ?? false;
    const isFree = document.getElementById('chkFree')?.checked ?? false;
    
    // ÊåáÂêç„Ç≠„É£„Çπ„Éà„ÅÆÊï∞„ÇíÂèñÂæó
    const shimeiCastCount = document.querySelectorAll('.shimei-cast-checkbox:checked').length;
    
    // „Éï„É™„ÉºÂÆ¢„ÅÆÂ†¥Âêà„ÅØÂâ≤ÂºïÈÅ©Áî®
    const discount = isFree ? 0.8 : 1; // 20%OFF
    
    // „Çª„ÉÉ„ÉàÊñôÈáëÔºà1Âêç„ÅÇ„Åü„Çä √ó ‰∫∫Êï∞Ôºâ
    const setTotal = Math.floor(setPrice * guests * discount);
    
    // „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏Ôºà1Âêç„ÅÆ„Åø„ÅÆÂ†¥ÂêàÔºâ
    const single = (hasSingle && guests === 1) ? 2000 : 0;
    
    // Âêå‰º¥Êñô
    const douhan = hasDouhan ? 3000 : 0;
    
    // ÊåáÂêçÊñôÔºà1‰∫∫„ÅÇ„Åü„Çä2000ÂÜÜ √ó ÊåáÂêç„Ç≠„É£„Çπ„ÉàÊï∞Ôºâ
    const shimei = shimeiCastCount * 2000;
    
    // Â∞èË®à
    const subtotal = setTotal + single + douhan + shimei;
    
    // TAX/„Çµ„Éº„Éì„ÇπÊñô
    const tax = Math.floor(subtotal * (taxRate / 100));
    
    // ÂêàË®à
    const total = subtotal + tax;
    
    return { setTotal, single, douhan, shimei, tax, total, subtotal, taxRate, shimeiCastCount };
}

// ÂàùÊúüÊñôÈáë„ÇíÊ≥®Êñá„Å®„Åó„Å¶ËøΩÂä†
async function addInitialCharge(sessionId, itemName, price, quantity) {
    try {
        // „Åæ„Åö„É°„Éã„É•„Éº„Å´„Äå„Çª„ÉÉ„ÉàÊñôÈáë„ÄçÁ≠â„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç„ÄÅ„Å™„Åë„Çå„Å∞„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶„Çª„ÉÉ„Ç∑„Éß„É≥ÂêàË®à„Å´Áõ¥Êé•ËøΩÂä†
        // Á∞°ÊòìÂÆüË£ÖÔºö„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ current_total „ÇíÁõ¥Êé•Êõ¥Êñ∞
        await apiRequest(`/sessions/${sessionId}/add-charge`, {
            method: 'POST',
            body: JSON.stringify({
                item_name: itemName,
                price: price,
                quantity: quantity
            })
        });
    } catch (e) {
        console.warn(`[addInitialCharge] ${itemName} „ÅÆËøΩÂä†„Å´Â§±ÊïóÔºàAPIÊú™ÂØæÂøú„ÅÆÂèØËÉΩÊÄßÔºâ:`, e);
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºö„É≠„Éº„Ç´„É´„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„Å´ËøΩÂä†
        const session = appState.activeSessions.find(s => Number(s.id) === Number(sessionId));
        if (session) {
            if (!session.orders) session.orders = [];
            session.orders.push({
                id: Date.now(),
                item_name: itemName,
                price: price,
                quantity: quantity,
                is_served: true,
                created_at: new Date().toISOString()
            });
            session.currentTotal = (session.currentTotal || 0) + (price * quantity);
        }
    }
}

async function openTableDetail(tableId) {
  const tId = Number(tableId);

  appState.currentTableId = tId;
  appState.isTableDetailOpen = true;

  const panel = document.getElementById('tableDetailPanel');
  if (panel) {
    panel.dataset.tableId = String(tId);
    panel.classList.remove('hidden');
  }

  const API = API_BASE_URL;

  const msg = (s, isErr = false) => {
    const el = document.getElementById('tableDetailMsg');
    if (el) el.innerHTML = `<div class="${isErr ? 'text-rose-300' : 'text-white/70'}">${s}</div>`;
  };

  const fetchJson = async (path, options = {}) => {
    const res = await fetch(`${API}${path}`, {
      headers: { 'Content-Type': 'application/json' },
      ...options,
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
    if (!res.ok) throw new Error(`HTTP ${res.status} ${text}`);
    return data;
  };

  const closePanel = () => {
    appState.isTableDetailOpen = false;
    const p = document.getElementById('tableDetailPanel');
    if (p) {
      p.innerHTML = '';
      p.classList.add('hidden');
    }
  };

  const fetchActiveForTable = async () => {
    const active = await fetchJson('/sessions/active', { method: 'GET' });
    const list = Array.isArray(active) ? active : (active.sessions || []);
    return list.find(s => Number(s.table_id) === tId) || null;
  };

  const fetchBundle = async (sessionId) => {
    const [menu, orders, casts] = await Promise.all([
      fetchJson('/menu', { method: 'GET' }).catch(() => []),
      fetchJson(`/sessions/${sessionId}/orders`, { method: 'GET' }).catch(() => []),
      fetchJson('/casts', { method: 'GET' }).catch(() => []),
    ]);
    return { menu, orders, casts };
  };

  const fetchCastsOnly = async () => {
    return await fetchJson('/casts', { method: 'GET' }).catch(() => []);
  };

  try {
    const session = await fetchActiveForTable();

    // „Çª„ÉÉ„Ç∑„Éß„É≥ÁÑ°„Åó ‚Üí ‚ÄúÁÆ°ÁêÜ„Åã„ÇâÈñãÂßã‚ÄùUI„ÇíÂá∫„Åô
    if (!session) {
      const casts = await fetchCastsOnly();
      renderTableDetailPanel({
        id: '-',
        table_id: tId,
        guests: 0,
        inhouse_nomination_count: 0,
        has_hon_nomination: false,
        set_minutes: 60,
        extra_minutes: 0,
        current_total: 0,
        start_time: null,
        check_due_at: null,
        extension_count: 0,
        _menu: [],
        _orders: [],
        _casts: casts,
      });
      msg('„Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„ÅØÊú™ÈñãÂßã„Åß„Åô„ÄÇÁÆ°ÁêÜ„Åã„ÇâÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ');
      wireTableDetailEvents(null);
      return;
    }

    // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅÇ„Çä ‚Üí Ë©≥Á¥∞‰∏ÄÂºèË°®Á§∫
    const b = await fetchBundle(session.id);
    renderTableDetailPanel({ ...session, _menu: b.menu, _orders: b.orders, _casts: b.casts });
    msg('Ë™≠„ÅøËæº„ÅøOK');
    wireTableDetailEvents(session.id);

    async function refreshPanel() {
      const s2 = await fetchActiveForTable();
      if (!s2) {
        // ÈÄî‰∏≠„ÅßÁ≤æÁÆó„Å™„Å©„ÅßÊ∂à„Åà„Åü
        const casts = await fetchCastsOnly();
        renderTableDetailPanel({ id:'-', table_id:tId, _casts:casts, _menu:[], _orders:[] });
        msg('„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', true);
        wireTableDetailEvents(null);
        return;
      }
      const b2 = await fetchBundle(s2.id);
      renderTableDetailPanel({ ...s2, _menu: b2.menu, _orders: b2.orders, _casts: b2.casts });
      wireTableDetailEvents(s2.id);

      if (typeof syncWithBackend === 'function') await syncWithBackend();
    }

    function wireTableDetailEvents(sessionId) {
      // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã + ‰∏≠Ë∫´„ÇØ„É™„ÉÉ„ÇØ„ÅØÈñâ„Åò„Å™„ÅÑ
      const overlay = document.getElementById('tableDetailOverlay');
      const modal = document.getElementById('tableDetailModal');
      if (overlay) overlay.onclick = closePanel;
      if (modal) modal.onclick = (e) => e.stopPropagation();

      const btnClose = document.getElementById('btnCloseTableDetail');
      if (btnClose) btnClose.onclick = closePanel;

      // ‚úÖ „Çª„ÉÉ„Ç∑„Éß„É≥ÁÑ°„Åó„Åß„ÇÇ„ÄåÈñãÂßã„Äç„ÇíÈÖçÁ∑ö
      const btnStart = document.getElementById('btnStartSession');
      if (!sessionId) {
        if (btnStart) {
          btnStart.onclick = async () => {
            try {
              msg('„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã‰∏≠...');
              const guests = Number(document.getElementById('inpStartGuests')?.value ?? 1);
              const catchStaff = (document.getElementById('inpStartCatch')?.value ?? '').trim();
              
              // ÊñôÈáë„Ç™„Éó„Ç∑„Éß„É≥
              const hasDouhan = document.getElementById('chkDouhan')?.checked ?? false;
              
              // ÊåáÂêç„Ç≠„É£„Çπ„Éà„ÇíÂèñÂæóÔºàË§áÊï∞ÂØæÂøúÔºâ
              const shimeiCasts = Array.from(document.querySelectorAll('.shimei-cast-checkbox:checked')).map(c => ({
                id: Number(c.value),
                name: c.dataset.name
              }));
              const hasShimei = shimeiCasts.length > 0;
              
              // ÊúÄÂàù„ÅÆÊåáÂêç„Ç≠„É£„Çπ„Éà„Çícast_id„Å®„Åó„Å¶‰ΩøÁî®ÔºàÊåáÂêç„Å™„Åó„Å™„Çâ0=„Éï„É™„ÉºÔºâ
              const castId = hasShimei ? shimeiCasts[0].id : 0;
              
              // TAXÁéá„ÇíÂèñÂæó
              const taxRate = Number(document.getElementById('selTaxRate')?.value ?? 20);

              if (!guests || guests <= 0) throw new Error('ÂÆ¢‰∫∫Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

              // „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê
              const sessionRes = await fetchJson('/sessions', {
                method: 'POST',
                body: JSON.stringify({
                  table_id: tId,
                  cast_id: castId,
                  guests: guests,
                  catch_staff: catchStaff || null,
                  has_companion: hasDouhan,
                  companion_name: null,
                  nomination_type: hasShimei ? 'shimei' : (hasDouhan ? 'douhan' : null),
                  nomination_fee: shimeiCasts.length * 2000,
                  shimei_casts: shimeiCasts.map(c => c.name).join(', '),
                  tax_rate: taxRate
                })
              });
              
              // ÂàùÊúüÊñôÈáë„ÇíËøΩÂä†
              const newSessionId = sessionRes?.id;
              if (newSessionId && typeof calculateStartCharges === 'function') {
                const charges = calculateStartCharges();
                if (charges.setTotal > 0) await addInitialCharge(newSessionId, '„Çª„ÉÉ„ÉàÊñôÈáë', charges.setTotal, 1);
                if (charges.single > 0) await addInitialCharge(newSessionId, '„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏', charges.single, 1);
                if (charges.douhan > 0) await addInitialCharge(newSessionId, 'Âêå‰º¥Êñô', charges.douhan, 1);
                // ÊåáÂêçÊñô„ÅØÂêÑ„Ç≠„É£„Çπ„Éà„Åî„Å®„Å´Ë®òÈå≤
                if (shimeiCasts.length > 0) {
                  for (const cast of shimeiCasts) {
                    await addInitialCharge(newSessionId, `ÊåáÂêçÊñôÔºà${cast.name}Ôºâ`, 2000, 1);
                  }
                }
                // TAX„ÅØ‰ºöË®àÊôÇ„Å´ÂÖ®‰Ωì„ÅÆÂ∞èË®à„Å´ÂØæ„Åó„Å¶Ë®àÁÆóÔºàÁ®éÁéá„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥„Å´‰øùÂ≠òÊ∏à„ÅøÔºâ
              }

              msg('ÈñãÂßã„Åó„Åæ„Åó„Åü');
              await openTableDetail(tId);
              if (typeof syncWithBackend === 'function') await syncWithBackend();
            } catch (e) {
              console.error(e);
              msg(`ÈñãÂßãÂ§±Êïó: ${e.message}`, true);
            }
          };
        }
        // ÊñôÈáë„Éó„É¨„Éì„É•„ÉºÂàùÊúüÂåñ
        if (typeof updateStartCharges === 'function') setTimeout(() => updateStartCharges(), 100);
        
        // ÊåáÂêç„Ç≠„É£„Çπ„Éà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
        document.querySelectorAll('.shimei-cast-checkbox').forEach(cb => {
          cb.addEventListener('change', updateStartCharges);
        });
        return;
      }

      // ---- „Åì„Åì„Åã„ÇâÊó¢Â≠òÔºàÂª∂Èï∑/Ê≥®Êñá/Á≤æÁÆóÔºâ ----
      const btnSaveAttrs = document.getElementById('btnSaveAttrs');
      const btnUpdateTiming = document.getElementById('btnUpdateTiming');
      const btnExtend30 = document.getElementById('btnExtend30');
      const btnExtend60 = document.getElementById('btnExtend60');
      const btnAddOrder = document.getElementById('btnAddOrder');
      const btnCheckout = document.getElementById('btnCheckout');
      
      // ‚òÖ ËøΩÂä†Ê≥®Êñá„ÅÆ„É°„Éã„É•„ÉºÈÅ∏ÊäûÂàùÊúüÂåñÔºàÂâ≤„ÇäÊñπÈÅ∏Êäû„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅÔºâ
      if (typeof onOrderMenuChange === 'function') {
        onOrderMenuChange();
      }

      if (btnSaveAttrs) {
        btnSaveAttrs.onclick = async () => {
          try {
            msg('‰øùÂ≠ò‰∏≠...');
            const guests = Number(document.getElementById('inpGuests')?.value ?? 0);
            const inhouse = Number(document.getElementById('inpInhouse')?.value ?? 0);
            const hon = !!document.getElementById('chkHon')?.checked;

            await fetchJson(`/sessions/${sessionId}/attributes`, {
              method: 'PUT',
              body: JSON.stringify({
                guests,
                inhouse_nomination_count: inhouse,
                has_hon_nomination: hon
              })
            });

            msg('‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºàÊ¨°ÂõûÂª∂Èï∑„Åã„ÇâÂèçÊò†Ôºâ');
            await refreshPanel();
          } catch (e) {
            console.error(e);
            msg(`‰øùÂ≠òÂ§±Êïó: ${e.message}`, true);
          }
        };
      }

      if (btnUpdateTiming) {
        btnUpdateTiming.onclick = async () => {
          try {
            msg('„Çª„ÉÉ„ÉàÂàÜÊï∞„ÇíÊõ¥Êñ∞‰∏≠...');
            const setMinutes = Number(document.getElementById('selSetMinutes')?.value ?? 60);

            await fetchJson(`/sessions/${sessionId}/timing`, {
              method: 'PUT',
              body: JSON.stringify({ set_minutes: setMinutes })
            });

            msg('„Çª„ÉÉ„ÉàÂàÜÊï∞„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            await refreshPanel();
          } catch (e) {
            console.error(e);
            msg(`Êõ¥Êñ∞Â§±Êïó: ${e.message}`, true);
          }
        };
      }

      if (btnExtend30) {
        btnExtend30.onclick = async () => {
          try {
            msg('30ÂàÜÂª∂Èï∑ÔºàËá™ÂãïÊ≥®ÊñáËøΩÂä†Ôºâ‰∏≠...');
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÂèñÂæó
            const sessionData = appState.activeSessions.find(s => Number(s.id) === Number(sessionId));
            const guests = Number(sessionData?.guests ?? 1);
            const shimeiCastsStr = sessionData?.shimei_casts || '';
            const shimeiCount = shimeiCastsStr ? shimeiCastsStr.split(',').filter(n => n.trim()).length : 0;
            
            // Âª∂Èï∑ÊñôÈáëË®àÁÆó: ‰∫∫Êï∞√ó3000 + ÊåáÂêçÊï∞√ó2000 + „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏Ôºà1Âêç„ÅÆ„ÅøÔºâ
            const setExtension = guests * 3000;
            const shimeiExtension = shimeiCount * 2000;
            const singleCharge = guests === 1 ? 2000 : 0;
            
            // Âª∂Èï∑API„ÇíÂëº„Å∂
            await fetchJson(`/sessions/${sessionId}/extend`, {
              method: 'POST'
            });
            
            // Âª∂Èï∑„Çª„ÉÉ„ÉàÊñôÈáë„ÇíÊ≥®Êñá„Å´ËøΩÂä†
            if (setExtension > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: `Âª∂Èï∑30ÂàÜÔºà${guests}Âêç√ó3000Ôºâ`,
                  price: setExtension,
                  quantity: 1
                })
              });
            }
            
            // „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏„ÇíÊ≥®Êñá„Å´ËøΩÂä†Ôºà1Âêç„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (singleCharge > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: '„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏ÔºàÂª∂Èï∑Ôºâ',
                  price: singleCharge,
                  quantity: 1
                })
              });
            }
            
            // Âª∂Èï∑ÊåáÂêçÊñô„ÇíÊ≥®Êñá„Å´ËøΩÂä†
            if (shimeiExtension > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: `Âª∂Èï∑ÊåáÂêçÊñôÔºà${shimeiCount}Âêç√ó2000Ôºâ`,
                  price: shimeiExtension,
                  quantity: 1
                })
              });
            }
            
            msg('30ÂàÜÂª∂Èï∑„Åó„Åæ„Åó„Åü');
            await refreshPanel();
            if (typeof syncWithBackend === 'function') await syncWithBackend();
          } catch (e) {
            console.error(e);
            msg(`Âª∂Èï∑Â§±Êïó: ${e.message}`, true);
          }
        };
      }

      if (btnExtend60) {
        btnExtend60.onclick = async () => {
          try {
            msg('60ÂàÜÂª∂Èï∑ÔºàËá™ÂãïÊ≥®ÊñáËøΩÂä†Ôºâ‰∏≠...');
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÂèñÂæó
            const sessionData = appState.activeSessions.find(s => Number(s.id) === Number(sessionId));
            const guests = Number(sessionData?.guests ?? 1);
            const shimeiCastsStr = sessionData?.shimei_casts || '';
            const shimeiCount = shimeiCastsStr ? shimeiCastsStr.split(',').filter(n => n.trim()).length : 0;
            
            // Âª∂Èï∑ÊñôÈáëË®àÁÆó: ‰∫∫Êï∞√ó5000 + ÊåáÂêçÊï∞√ó2000 + „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏Ôºà1Âêç„ÅÆ„ÅøÔºâ
            const setExtension = guests * 5000;
            const shimeiExtension = shimeiCount * 2000;
            const singleCharge = guests === 1 ? 2000 : 0;
            
            // Âª∂Èï∑API„ÇíÂëº„Å∂
            await fetchJson(`/sessions/${sessionId}/extend`, {
              method: 'POST'
            });
            
            // Âª∂Èï∑„Çª„ÉÉ„ÉàÊñôÈáë„ÇíÊ≥®Êñá„Å´ËøΩÂä†
            if (setExtension > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: `Âª∂Èï∑60ÂàÜÔºà${guests}Âêç√ó5000Ôºâ`,
                  price: setExtension,
                  quantity: 1
                })
              });
            }
            
            // „Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏„ÇíÊ≥®Êñá„Å´ËøΩÂä†Ôºà1Âêç„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (singleCharge > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: '„Ç∑„É≥„Ç∞„É´„ÉÅ„É£„Éº„Ç∏ÔºàÂª∂Èï∑Ôºâ',
                  price: singleCharge,
                  quantity: 1
                })
              });
            }
            
            // Âª∂Èï∑ÊåáÂêçÊñô„ÇíÊ≥®Êñá„Å´ËøΩÂä†
            if (shimeiExtension > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: `Âª∂Èï∑ÊåáÂêçÊñôÔºà${shimeiCount}Âêç√ó2000Ôºâ`,
                  price: shimeiExtension,
                  quantity: 1
                })
              });
            }
            
            msg('60ÂàÜÂª∂Èï∑„Åó„Åæ„Åó„Åü');
            await refreshPanel();
            if (typeof syncWithBackend === 'function') await syncWithBackend();
          } catch (e) {
            console.error(e);
            msg(`Âª∂Èï∑Â§±Êïó: ${e.message}`, true);
          }
        };
      }

      if (btnAddOrder) {
        btnAddOrder.onclick = async () => {
          try {
            msg('Ê≥®ÊñáËøΩÂä†‰∏≠...');
            const itemId = Number(document.getElementById('selAddOrderItem')?.value);
            let qty = Number(document.getElementById('inpAddOrderQty')?.value ?? 1);
            if (!itemId || qty <= 0) throw new Error('„É°„Éã„É•„Éº/Êï∞Èáè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            
            // „É°„Éã„É•„ÉºÊÉÖÂ†±„ÇíÂèñÂæóÔºàAPI„Åã„ÇâÔºâ
            const menuData = await fetchJson('/menu', { method: 'GET' }).catch(() => []);
            const menuItem = menuData.find(m => m.id === itemId);
            const category = menuItem?.category?.toLowerCase() || '';
            const itemName = menuItem?.name || '';
            const isDrinkCategory = ['drink', 'bottle', 'champagne', 'wine'].includes(category);
            
            // ÊúâÊñô„Éâ„É™„É≥„ÇØÔºà„Ç∑„Éß„ÉÉ„Éà„Éª„Ç∞„É©„Çπ„ÉØ„Ç§„É≥Ôºâ
            const isPaidDrink = paidDrinksAdmin.includes(itemName);
            
            // Ââ≤„ÇäÊñπ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const hasMixStyle = mixStylesAdmin[itemName] !== undefined;
            
            // „Éâ„É™„É≥„ÇØ„Çµ„Ç§„Ç∫„Å´„Çà„Çã‰æ°Ê†ºË™øÊï¥
            let finalPrice = menuItem?.price || 0;
            let itemNameSuffix = '';
            
            // Ââ≤„ÇäÊñπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂêçÂâç„Å´ËøΩÂä†
            if (hasMixStyle && selectedMixStyleAdmin) {
              itemNameSuffix = 'Ôºà' + selectedMixStyleAdmin + 'Ôºâ';
            }
            
            if (isPaidDrink) {
              // „Ç∑„Éß„ÉÉ„Éà„Éª„Ç∞„É©„Çπ„ÉØ„Ç§„É≥„ÅØÁµ±‰∏Ä‰æ°Ê†º„ÄÅ„Çµ„Ç§„Ç∫„Å™„Åó
              finalPrice = menuItem?.price || 2000;
            } else if (category === 'drink') {
              const drinkFor = document.querySelector('input[name="drinkFor"]:checked')?.value || 'customer';
              if (drinkFor === 'customer') {
                // „ÅäÂÆ¢Êßò„ÅÆ„Çª„ÉÉ„Éà„Éâ„É™„É≥„ÇØ„ÅØ0ÂÜÜ
                finalPrice = 0;
              } else {
                // „Ç≠„É£„Çπ„Éà/„Çπ„Çø„ÉÉ„Éï„ÅØ„Çµ„Ç§„Ç∫„Åß‰æ°Ê†ºÊ±∫ÂÆö
                const drinkSize = document.querySelector('input[name="drinkSize"]:checked')?.value || 'single';
                const drinkPrices = { single: 1000, double: 2000, triple: 3000 };
                finalPrice = drinkPrices[drinkSize];
                const sizeLabel = drinkSize === 'single' ? '„Ç∑„É≥„Ç∞„É´' : drinkSize === 'double' ? '„ÉÄ„Éñ„É´' : '„Éà„É™„Éó„É´';
                // Ââ≤„ÇäÊñπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄåÈ∫¶ÁÑºÈÖéÔºà„É≠„ÉÉ„ÇØ„Éª„Ç∑„É≥„Ç∞„É´Ôºâ„Äç„ÅÆ„Çà„ÅÜ„Å´Ë°®Á§∫
                if (hasMixStyle && selectedMixStyleAdmin) {
                  itemNameSuffix = 'Ôºà' + selectedMixStyleAdmin + '„Éª' + sizeLabel + 'Ôºâ';
                } else {
                  itemNameSuffix = 'Ôºà' + sizeLabel + 'Ôºâ';
                }
              }
            }
            
            // Ë™∞„ÅåÈ£≤„ÇÄ„Åã
            let drinkFor = 'customer';
            let personName = null;
            let isDrinkBack = false;
            
            if (isDrinkCategory) {
              drinkFor = document.querySelector('input[name="drinkFor"]:checked')?.value || 'customer';
              
              if (drinkFor === 'cast' || drinkFor === 'staff') {
                personName = document.getElementById('selDrinkPerson')?.value || null;
                if (!personName) throw new Error('„Ç≠„É£„Çπ„Éà„Åæ„Åü„ÅØ„Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                isDrinkBack = (drinkFor === 'cast'); // „Ç≠„É£„Çπ„Éà„ÅÆÂ†¥Âêà„ÅÆ„Åø„Éê„ÉÉ„ÇØÁô∫Áîü
              }
            }

            await fetchJson('/orders', {
              method: 'POST',
              body: JSON.stringify({
                session_id: sessionId,
                menu_item_id: itemId,
                quantity: qty,
                is_drink_back: isDrinkBack,
                cast_name: personName,
                drink_for: drinkFor,
                custom_price: finalPrice,
                item_suffix: itemNameSuffix
              })
            });

            msg('Ê≥®Êñá„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºàDBÂèçÊò†Ôºâ');
            await refreshPanel();
          } catch (e) {
            console.error(e);
            msg(`Ê≥®ÊñáËøΩÂä†Â§±Êïó: ${e.message}`, true);
          }
        };
      }

      if (btnCheckout) {
        btnCheckout.onclick = async () => {
          try {
            if (!confirm('Á≤æÁÆó„Åó„Åæ„Åô„ÅãÔºüÔºàDBÊ≥®ÊñáÂêàË®à„Åã„ÇâÂÜçË®àÁÆó„Åó„Å¶Á¢∫ÂÆöÔºâ')) return;
            
            // ‚òÖ Á≤æÁÆóÂâç„Å´„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„Çí‰øùÂ≠ò
            const sessionToCheckout = appState.activeSessions.find(s => 
              Number(s.id) === Number(sessionId)
            );
            
            // ‚òÖ ‰ºùÁ•®Áî®„Å´Ê≥®Êñá„ÇíÂèñÂæó
            let ordersForReceipt = [];
            try {
              const ordersData = await fetchJson(`/sessions/${sessionId}/orders`);
              ordersForReceipt = Array.isArray(ordersData) ? ordersData : [];
            } catch (e) {
              console.warn('[checkout] orders fetch failed:', e);
            }
            
            // ‚òÖ ‰ºöË®àÊôÇ„Å´TAX„ÇíË®àÁÆó
            const taxRate = sessionToCheckout?.taxRate || sessionToCheckout?.tax_rate || 20;
            const subtotalAmount = ordersForReceipt.reduce((sum, o) => sum + (o.price * o.quantity), 0);
            const taxAmount = Math.floor(subtotalAmount * (taxRate / 100));
            const totalWithTax = subtotalAmount + taxAmount;
            
            // TAX„ÇíÊ≥®Êñá„É™„Çπ„Éà„Å´ËøΩÂä†Ôºà„É¨„Ç∑„Éº„ÉàË°®Á§∫Áî®Ôºâ
            if (taxAmount > 0) {
              ordersForReceipt.push({
                item_name: `TAX/„Çµ„Éº„Éì„ÇπÔºà${taxRate}%Ôºâ`,
                quantity: 1,
                price: taxAmount
              });
            }
            
            msg('Á≤æÁÆó‰∏≠...');
            const result = await fetchJson(`/sessions/${sessionId}/checkout`, { method: 'PUT' });
            
            
            // ‚òÖ checkoutHistory„Å´ËøΩÂä†
            if (sessionToCheckout) {
              const checkoutRecord = {
                ...sessionToCheckout,
                checkoutTime: new Date().toISOString(),
                totalAmount: totalWithTax,
                orders: ordersForReceipt, // Ê≥®ÊñáÂ±•Ê≠¥„Çí‰øùÂ≠ò
                status: 'completed'
              };
              appState.checkoutHistory.push(checkoutRecord);
              
              
              // localStorage„Å´„ÇÇ‰øùÂ≠ò
              try {
                localStorage.setItem('cabax_checkoutHistory', JSON.stringify(appState.checkoutHistory));
              } catch (e) {
                console.warn('localStorage‰øùÂ≠ò„Å´Â§±Êïó:', e);
              }
              
              // ‚òÖ ‰ºùÁ•®„ÇíË°®Á§∫
              console.log('[checkout] showReceiptÂëº„Å≥Âá∫„Åó', sessionToCheckout, ordersForReceipt);
              showReceipt(sessionToCheckout, ordersForReceipt);
            } else {
              // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„Åè„Å¶„ÇÇ‰ºùÁ•®„ÇíË°®Á§∫
              showReceipt({ guests: 0, castName: '‰∏çÊòé', tableName: '‰∏çÊòé', currentTotal: result?.final_total || 0 }, ordersForReceipt);
            }
            
            msg('Á≤æÁÆó„Åó„Åæ„Åó„Åü');
            closePanel();
            if (typeof syncWithBackend === 'function') await syncWithBackend();
            
            // ‚òÖ „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÉªÊó•Â†±„Éª„É¨„Éù„Éº„Éà„ÇíÊõ¥Êñ∞
            if (typeof updateDashboard === 'function') updateDashboard();
            if (typeof renderDailyReport === 'function') renderDailyReport();
            if (typeof renderReports === 'function') renderReports();
            
          } catch (e) {
            console.error(e);
            msg(`Á≤æÁÆóÂ§±Êïó: ${e.message}`, true);
          }
        };
      }
    }

  } catch (e) {
    console.error(e);
    // Â§±Êïó„Åó„Å¶„ÇÇ‚ÄúÈñâ„Åò„Çã‚Äù„Å†„Åë„ÅØÊäº„Åõ„ÇãÁä∂ÊÖã„Å´„Åô„Çã
    renderTableDetailPanel({ id:'-', table_id:tId, _casts:[], _menu:[], _orders:[] });
    msg(`„ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞„ÅÆÂèñÂæó„Å´Â§±Êïó: ${e.message}`, true);

    const btnClose = document.getElementById('btnCloseTableDetail');
    if (btnClose) btnClose.onclick = closePanel;
    const overlay = document.getElementById('tableDetailOverlay');
    const modal = document.getElementById('tableDetailModal');
    if (overlay) overlay.onclick = closePanel;
    if (modal) modal.onclick = (ev) => ev.stopPropagation();
  }
}



// „Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÂêàË®àÈáëÈ°ç„Çí„Åæ„Å®„ÇÅ„Å¶ÂÜçË®àÁÆóÔºàÂ∞èË®àÔºãË™øÊï¥Ôºâ
function recalcSessionTotal(session) {
    const orders = session.orders || [];
    const adjustments = session.adjustments || [];

    // Ê≥®ÊñáÂ∞èË®à
    const ordersTotal = orders.reduce((sum, o) => {
        const q = o.quantity || 1;
        const p = o.price || 0;
        return sum + p * q;
    }, 0);

    // Ë™øÊï¥ÂêàË®àÔºàÂâ≤Âºï„ÅØ„Éû„Ç§„Éä„Çπ„ÄÅ„Çµ„Éº„Éì„Çπ„ÅØ„Éó„É©„ÇπÔºâ
    const adjustmentsTotal = adjustments.reduce((sum, adj) => {
        return sum + (adj.amount || 0);
    }, 0);

    // ÂèÇÁÖß„Åó„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´„Éï„Ç£„Éº„É´„Éâ„Å´ÊåÅ„Å£„Å¶„Åä„Åè
    session.ordersTotal = ordersTotal;
    session.adjustmentsTotal = adjustmentsTotal;
    session.currentTotal = ordersTotal + adjustmentsTotal;
}


// Êï∞Èáè„Çí +1 / -1 „Åô„Çã
function changeOrderQuantity(tableId, orderIndex, delta) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    const orders = session.orders || [];
    const order = orders[orderIndex];
    if (!order) return;

    const currentQty = order.quantity || 1;
    const newQty = currentQty + delta;

    if (newQty <= 0) {
        // 0‰ª•‰∏ã„Å´„Å™„Å£„Åü„ÇâÂâäÈô§Êâ±„ÅÑ
        if (!confirm(`${order.itemName} „ÇíÊ≥®Êñá„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
            return;
        }
        orders.splice(orderIndex, 1);
        showNotification(`${order.itemName} „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
    } else {
        order.quantity = newQty;
        showNotification(`${order.itemName} „ÅÆÊï∞Èáè„Çí ${newQty} „Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
    }

    recalcSessionTotal(session);
    renderTables();
    openTableDetail(tableId);
}

// ÂÆåÂÖ®„Å´ÂâäÈô§„Éú„Çø„É≥„ÇíÊäº„Åó„Åü„Å®„Åç
function deleteOrder(tableId, orderIndex) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    const orders = session.orders || [];
    const order = orders[orderIndex];
    if (!order) return;

    if (!confirm(`${order.itemName} „ÇíÊ≥®Êñá„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
        return;
    }

    orders.splice(orderIndex, 1);
    recalcSessionTotal(session);

    renderTables();
    openTableDetail(tableId);
    showNotification(`${order.itemName} „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
}
// Ë™øÊï¥Ë°å„ÅÆËøΩÂä†ÔºàÂâ≤Âºï„Éª„Çµ„Éº„Éì„Çπ„Éª„Åù„ÅÆ‰ªñÔºâ
function addAdjustment(tableId, type) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    if (!session.adjustments) {
        session.adjustments = [];
    }

    let defaultLabel = '';
    let sign = 1;

    if (type === 'discount') {
        defaultLabel = 'Ââ≤Âºï';
        sign = -1; // Ââ≤Âºï„ÅØ„Éû„Ç§„Éä„Çπ
    } else if (type === 'service') {
        defaultLabel = '„Çµ„Éº„Éì„Çπ';
        sign = 1;  // „Çµ„Éº„Éì„Çπ„ÅØ„Éó„É©„Çπ
    } else {
        defaultLabel = 'Ë™øÊï¥';
        sign = 1;
    }

    const label = prompt('ÂÜÖÂÆπÔºà‰æãÔºö„Éú„Éà„É´„Çµ„Éº„Éì„Çπ„ÄÅVIPÂâ≤Âºï„Å™„Å©Ôºâ', defaultLabel);
    if (label === null) return;

    const raw = prompt('ÈáëÈ°çÔºàÂÜÜÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æãÔºö1000Ôºâ', '1000');
    if (raw === null) return;

    const amountValue = parseInt(raw, 10);
    if (isNaN(amountValue)) {
        showNotification('ÈáëÈ°ç„ÅØÊï∞Â≠ó„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
    }

    const amount = sign * Math.abs(amountValue);

    session.adjustments.push({
        type,           // 'discount' | 'service' | 'other'
        label,
        amount          // Ââ≤Âºï„Å™„Çâ„Éû„Ç§„Éä„Çπ„ÄÅ„Çµ„Éº„Éì„Çπ„Å™„Çâ„Éó„É©„Çπ
    });

    recalcSessionTotal(session);
    renderTables();
    openTableDetail(tableId);
    showNotification(`${label} „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`, 'success');
}

// Ë™øÊï¥Ë°å„ÅÆÂâäÈô§
function removeAdjustment(tableId, index) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session || !session.adjustments) return;

    const adj = session.adjustments[index];
    if (!adj) return;

    if (!confirm(`${adj.label}Ôºà${adj.amount}ÂÜÜÔºâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
        return;
    }

    session.adjustments.splice(index, 1);
    recalcSessionTotal(session);
    renderTables();
    openTableDetail(tableId);
    showNotification(`${adj.label} „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
}

function addOrderToTable(menuItemId) {
    const tableId = appState.currentTableId;
    if (!tableId) {
        showNotification('„ÉÜ„Éº„Éñ„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
        return;
    }

    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) {
        showNotification('„Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„ÅØÁèæÂú®‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
        return;
    }

    const menuItem = appState.menuItems.find(m => m.id === menuItemId);
    if (!menuItem) return;

    // DBÊ≥®Êñá„Åã„Å©„ÅÜ„ÅãÔºà„Éâ„É™„É≥„ÇØ„Å†„ÅëÁ¢∫Ë™çÔºâ
    let isDrinkBack = false;
    let castName = null;

    if (menuItem.category === 'drink') {
        const confirmDb = confirm(
            `${menuItem.name} „ÇíDBÊ≥®Êñá„Å´„Åó„Åæ„Åô„ÅãÔºü\n\n` +
            `OK = DBÊ≥®ÊñáÔºà${session.castName || ''}Ôºâ\n„Ç≠„É£„É≥„Çª„É´ = ÈÄöÂ∏∏Ê≥®Êñá`
        );
        if (confirmDb) {
            isDrinkBack = true;
            castName = session.castName;
        }
    }

    // ‚òÖ „Åô„Åß„Å´Âêå„ÅòÊù°‰ª∂„ÅÆÊ≥®Êñá„Åå„ÅÇ„Çã„ÅãÊé¢„Åô
    const existingOrder = (session.orders || []).find(o =>
        o.itemName === menuItem.name &&
        (o.price || 0) === menuItem.price &&
        (o.category || 'other') === (menuItem.category || 'other') &&
        !!o.isDrinkBack === isDrinkBack &&
        (o.castName || '') === (castName || '')
    );

    if (existingOrder) {
        // Êó¢Â≠òË°å„ÅÆÊï∞Èáè„Å†„Åë +1
        existingOrder.quantity = (existingOrder.quantity || 1) + 1;
    } else {
        // „Å™„Åë„Çå„Å∞Êñ∞Ë¶èË°å„ÇíËøΩÂä†
        session.orders.push({
            itemName: menuItem.name,
            category: menuItem.category,
            price: menuItem.price,
            quantity: 1,
            isDrinkBack,
            castName
        });
    }

    // ÂêàË®àÈáëÈ°ç„ÇíÂÜçË®àÁÆóÔºà„Åï„Å£„Åç‰Ωú„Å£„Åü„ÇÑ„Å§„ÇíÂà©Áî®Ôºâ
    recalcSessionTotal(session);

    renderTables();
    openTableDetail(tableId);
    showNotification(`${menuItem.name} „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`, 'success');
}


function checkoutTable(tableId) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    // Âøµ„ÅÆ„Åü„ÇÅÊúÄÊñ∞„ÅÆÈáëÈ°ç„ÇíÂÜçË®àÁÆóÔºàrecalcSessionTotal „Çí‰Ωø„Å£„Å¶„ÅÑ„ÇãÂâçÊèêÔºâ
    if (typeof recalcSessionTotal === 'function') {
        recalcSessionTotal(session);
    }

    const confirmMsg =
        '„ÉÜ„Éº„Éñ„É´ ' + (session.tableName || '') + ' „ÅÆÁ≤æÁÆó„ÇíË°å„ÅÑ„Åæ„Åô„ÅãÔºü\n\n' +
        'ÂêàË®à: ¬•' + (session.currentTotal || 0).toLocaleString();

    if (!confirm(confirmMsg)) {
        return;
    }

    // ‰ºùÁ•®„ÇíË°®Á§∫„Åô„Çã„ÅãÁ¢∫Ë™ç
    const wantReceipt = confirm(
        '„Åì„ÅÆÂÜÖÂÆπ„Åß‰ºùÁ•®ÔºàÂç∞Âà∑Áî®Ôºâ„ÇíË°®Á§∫„Åó„Åæ„Åô„ÅãÔºü\n\n' +
        'OK = ‰ºùÁ•®ÁîªÈù¢„ÇíÈñã„Åè\n„Ç≠„É£„É≥„Çª„É´ = Èñã„Åã„Å™„ÅÑ'
    );

    if (wantReceipt) {
        // „Ç≥„Éî„Éº„Çí‰Ωú„Å£„Å¶Ê∏°„ÅôÔºà„ÅÇ„Å®„ÅßÊõ∏„ÅçÊèõ„Åà„Çâ„Çå„Å¶„ÇÇ„ÅÑ„ÅÑ„Çà„ÅÜ„Å´Ôºâ
        const sessionCopy = JSON.parse(JSON.stringify(session));
        if (typeof recalcSessionTotal === 'function') {
            recalcSessionTotal(sessionCopy);
        }
        openReceiptWindow(tableId, sessionCopy);
    }

    // „Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁ≤æÁÆóÊ∏à„Åø„Å´ÁßªÂãï
    session.checkoutTime = new Date().toISOString();
    session.totalAmount = session.currentTotal;

    appState.checkoutHistory.push({ ...session });
    appState.activeSessions = appState.activeSessions.filter(s => s.id !== session.id);
    
    // ‚òÖ checkoutHistory„ÇílocalStorage„Å´‰øùÂ≠òÔºà„É™„É≠„Éº„ÉâÂæå„ÇÇ‰øùÊåÅÔºâ
    try {
        localStorage.setItem('cabax_checkoutHistory', JSON.stringify(appState.checkoutHistory));
    } catch (e) {
        console.warn('localStorage‰øùÂ≠ò„Å´Â§±Êïó:', e);
    }

    // „ÉÜ„Éº„Éñ„É´„ÇíÁ©∫Â∏≠„Å´
    const table = appState.tables.find(t => t.id === tableId);
    if (table) table.status = 'available';

    renderTables();
    updateDashboard();
    renderDailyReport();
    closeModal('tableDetailModal');
    showNotification('Á≤æÁÆó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success');
}
function openReceiptWindow(tableId, session) {
    const table = appState.tables.find(t => t.id === tableId);
    if (!table) return;

    const orders = session.orders || [];
    const adjustments = session.adjustments || [];
    const ordersTotal = session.ordersTotal || 0;
    const adjustmentsTotal = session.adjustmentsTotal || 0;
    const finalTotal = session.currentTotal || 0;

    const checkoutDate = session.checkoutTime ? new Date(session.checkoutTime) : new Date();
    const dateStr =
        checkoutDate.getFullYear() + '-' +
        String(checkoutDate.getMonth() + 1).padStart(2, '0') + '-' +
        String(checkoutDate.getDate()).padStart(2, '0') + ' ' +
        String(checkoutDate.getHours()).padStart(2, '0') + ':' +
        String(checkoutDate.getMinutes()).padStart(2, '0');

    const shopName = (SHOP_INFO && SHOP_INFO.name) || 'Cabax';
    const shopAddress = (SHOP_INFO && SHOP_INFO.address) || '';
    const shopTel = (SHOP_INFO && SHOP_INFO.tel) || '';

    // Ê≥®ÊñáË°å
    let rowsHtml = '';
    orders.forEach(function(order) {
        const name = order.itemName || '';
        const qty = order.quantity || 1;
        const price = order.price || 0;
        const lineTotal = price * qty;
        rowsHtml +=
            '<tr>' +
                '<td>' + name + '</td>' +
                '<td class="num">' + qty + '</td>' +
                '<td class="num">¬•' + price.toLocaleString() + '</td>' +
                '<td class="num">¬•' + lineTotal.toLocaleString() + '</td>' +
            '</tr>';
    });

    // Ââ≤Âºï„Éª„Çµ„Éº„Éì„ÇπË°å
    if (adjustments.length > 0) {
        rowsHtml +=
            '<tr><td colspan="4" class="section-title">Ââ≤Âºï„Éª„Çµ„Éº„Éì„Çπ</td></tr>';
        adjustments.forEach(function(adj) {
            const label = adj.label || '';
            const amount = adj.amount || 0;
            rowsHtml +=
                '<tr>' +
                    '<td>' + label + '</td>' +
                    '<td></td>' +
                    '<td></td>' +
                    '<td class="num ' + (amount < 0 ? 'minus' : 'plus') + '">' +
                        (amount < 0 ? '‚àí' : '+') + '¬•' + Math.abs(amount).toLocaleString() +
                    '</td>' +
                '</tr>';
        });
    }

    // Âç∞Âà∑Áî®HTMLÂÖ®‰Ωì
    const html =
        '<!DOCTYPE html>' +
        '<html lang="ja">' +
        '<head>' +
            '<meta charset="UTF-8">' +
            '<title>‰ºùÁ•® - ' + table.name + '</title>' +
            '<style>' +
                'body{font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;margin:16px;font-size:12px;}' +
                'h1{font-size:18px;margin:0 0 4px;}' +
                'h2{font-size:13px;margin:12px 0 4px;}' +
                'table{width:100%;border-collapse:collapse;margin-top:8px;}' +
                'th,td{border-bottom:1px solid #ccc;padding:4px 2px;}' +
                'th{background:#f3f4f6;font-weight:600;text-align:left;}' +
                'td.num{text-align:right;white-space:nowrap;}' +
                '.section-title{padding-top:8px;font-weight:600;}' +
                '.total-box{margin-top:12px;border-top:1px solid #000;padding-top:8px;}' +
                '.total-box table{width:auto;margin-left:auto;}' +
                '.label{padding-right:12px;}' +
                '.value{text-align:right;}' +
                '.minus{color:#b91c1c;}' +
                '.plus{color:#15803d;}' +
                '.meta{font-size:11px;color:#555;margin-bottom:2px;}' +
                '.header{margin-bottom:12px;border-bottom:1px solid #ddd;padding-bottom:8px;}' +
                '.header-line{font-size:11px;color:#444;}' +
                '.receipt-title{font-size:14px;font-weight:600;margin-top:6px;}' +
                '.header-top{display:flex;justify-content:space-between;align-items:flex-start;}' +
                '.stamp-box{width:90px;height:70px;border:1px solid #000;margin-left:12px;display:flex;align-items:center;justify-content:center;font-size:11px;}' +
                '.stamp-text{writing-mode:vertical-rl;}' +
            '</style>' +
        '</head>' +
        '<body>' +

            // „Éò„ÉÉ„ÉÄ„ÉºÔºàÂ∫óÂêç„Éª‰ΩèÊâÄ„ÉªÈõªË©±„ÉªÈ†òÂèéÂç∞Ê¨ÑÔºâ
            '<div class="header">' +
                '<div class="header-top">' +
                    '<div>' +
                        '<h1>' + shopName + '</h1>' +
                        (shopAddress ? '<div class="header-line">‰ΩèÊâÄ: ' + shopAddress + '</div>' : '') +
                        (shopTel ? '<div class="header-line">TEL: ' + shopTel + '</div>' : '') +
                        '<div class="receipt-title">È†òÂèéÊõ∏ / ‰ºùÁ•®</div>' +
                    '</div>' +
                    '<div class="stamp-box">' +
                        '<div class="stamp-text">È†òÂèéÂç∞</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +

            '<div class="meta">„ÉÜ„Éº„Éñ„É´: ' + table.name + '</div>' +
            '<div class="meta">ÊãÖÂΩì: ' + (session.castName || '') + '</div>' +
            '<div class="meta">‰∫∫Êï∞: ' + (session.guests || 0) + 'Âêç</div>' +
            '<div class="meta">‰ºöË®àÊôÇÂàª: ' + dateStr + '</div>' +

            '<h2>„ÅîÊ≥®ÊñáÂÜÖÂÆπ</h2>' +
            '<table>' +
                '<thead>' +
                    '<tr>' +
                        '<th>ÂïÜÂìÅ</th>' +
                        '<th class="num">Êï∞</th>' +
                        '<th class="num">Âçò‰æ°</th>' +
                        '<th class="num">ÈáëÈ°ç</th>' +
                    '</tr>' +
                '</thead>' +
                '<tbody>' +
                    rowsHtml +
                '</tbody>' +
            '</table>' +
            '<div class="total-box">' +
                '<table>' +
                    '<tr><td class="label">Â∞èË®à</td><td class="value">¬•' + ordersTotal.toLocaleString() + '</td></tr>' +
                    '<tr><td class="label">Ë™øÊï¥</td><td class="value">' +
                        (adjustmentsTotal >= 0 ? '+' : '‚àí') + '¬•' + Math.abs(adjustmentsTotal).toLocaleString() +
                    '</td></tr>' +
                    '<tr><td class="label"><strong>ÂêàË®à</strong></td><td class="value"><strong>¬•' + finalTotal.toLocaleString() + '</strong></td></tr>' +
                '</table>' +
            '</div>' +
        '</body>' +
        '</html>';

    const win = window.open('', 'cabaxReceipt', 'width=480,height=640');
    if (!win) {
        alert('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
    }
    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
    try {
        win.print();
    } catch (e) {
        console.warn('Âç∞Âà∑„ÇíËá™Âãï„ÅßÈñã„Åë„Åæ„Åõ„Çì„Åß„Åó„Åü:', e);
    }
}

function cancelOneFromGroup(tableId, groupIndex) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    const grouped = getGroupedOrders(session);
    const group = grouped[groupIndex];
    if (!group) return;

    const idx = session.orders.findIndex(order =>
        order.itemName === group.itemName &&
        (order.price || 0) === group.price &&
        (order.category || 'other') === group.category &&
        !!order.isDrinkBack === !!group.isDrinkBack &&
        (order.castName || '') === (group.castName || '')
    );

    if (idx === -1) return;

    const target = session.orders[idx];

    // ‚òÖ API„Å´„ÇÇÂèñÊ∂à„ÇíÂèçÊò†Ôºàorder.id „Åå„ÅÇ„Å£„Å¶Êé•Á∂ö‰∏≠„ÅÆ„Å®„Åç„Å†„ÅëÔºâ
    if (appState.apiConnected && target.id) {
        apiRequest(`${API_ENDPOINTS.orders}/${target.id}`, {
            method: 'DELETE'
        }).catch(err => {
            console.warn('Order delete API failed (one):', err);
        });
    }

    const q = target.quantity || 1;
    const diff = (target.price || 0) * q;

    session.currentTotal = Math.max(0, (session.currentTotal || 0) - diff);
    session.orders.splice(idx, 1);

    renderTables();
    openTableDetail(tableId);
    showNotification(`${group.itemName} „Çí1‰ª∂Âèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü`, 'success');
}

 // „Ç≠„É£„Çπ„ÉàÁÆ°ÁêÜ
 function renderCasts() {
            const grid = document.getElementById('castsGrid');
            if (!grid) return;
            
            // „Ç≠„É£„Çπ„Éà„Åå„Å™„ÅÑÂ†¥Âêà
            if (!appState.casts || appState.casts.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">„Ç≠„É£„Çπ„Éà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
                return;
            }
            
            grid.innerHTML = appState.casts.map(cast => {
                // undefined/nullÂØæÁ≠ñ: stage_name ‚Üí name ‚Üí 'Cast#id' „ÅÆÈ†Ü„ÅßÂèñÂæó
                const displayName = cast.stage_name || cast.name || `Cast#${cast.id || '?'}`;
                const initial = displayName.charAt(0) || '?';
                const hourlyRate = Number(cast.hourly_rate || cast.hourlyRate || 0);
                const sales = Number(cast.sales || 0);
                
                return `
                <div class="luxury-card rounded-2xl p-6">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="cast-avatar">
                            ${initial}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-200">${displayName}</h3>
                            <p class="text-sm ${getRankColor(cast.rank)}">${getRankLabel(cast.rank)}</p>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">ÊôÇÁµ¶</span>
                            <span class="font-semibold text-gray-200">¬•${hourlyRate.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Êú¨Êó•Â£≤‰∏ä</span>
                            <span class="font-bold gold-accent">¬•${sales.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCast(${cast.id})" class="flex-1 bg-blue-900/20 text-blue-400 border border-blue-800/30 py-2 rounded-xl hover:bg-blue-900/30 transition text-sm">
                            Á∑®ÈõÜ
                        </button>
                        <button onclick="deleteCast(${cast.id})" class="flex-1 bg-red-900/20 text-red-400 border border-red-800/30 py-2 rounded-xl hover:bg-red-900/30 transition text-sm">
                            ÂâäÈô§
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function getRankColor(rank) {
            const colors = {
                'regular': 'text-gray-400',
                'chief': 'text-blue-400',
                'manager': 'text-purple-400'
            };
            return colors[rank] || 'text-gray-400';
        }

        function getRankLabel(rank) {
            const labels = {
                'regular': '„É¨„ÇÆ„É•„É©„Éº',
                'chief': '„ÉÅ„Éº„Éï',
                'manager': '„Éû„Éç„Éº„Ç∏„É£„Éº'
            };
            return labels[rank] || rank;
        }

        // ========== „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ ==========
        
        // „Çπ„Çø„ÉÉ„Éï„Éá„Éº„Çø„ÇíAPI„Åã„ÇâÂèñÂæó
        async function loadStaffFromApi() {
            try {
                const data = await apiRequest('/staff');
                appState.staff = Array.isArray(data) ? data : [];
                renderStaff();
            } catch (e) {
                console.error('[loadStaffFromApi] error:', e);
                appState.staff = [];
            }
        }
        
        function renderStaff() {
            const grid = document.getElementById('staffGrid');
            if (!grid) return;
            
            if (!appState.staff || appState.staff.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">„Çπ„Çø„ÉÉ„Éï„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
                return;
            }
            
            grid.innerHTML = appState.staff.map(staff => {
                const displayName = staff.name || `Staff#${staff.id || '?'}`;
                const initial = displayName.charAt(0) || '?';
                const hourlyRate = Number(staff.hourly_rate || staff.hourlyRate || 0);
                
                return `
                <div class="luxury-card rounded-2xl p-6">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="cast-avatar" style="background: linear-gradient(135deg, #4a5568, #2d3748);">
                            ${initial}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-200">${displayName}</h3>
                            <p class="text-sm ${getStaffRoleColor(staff.role)}">${getStaffRoleLabel(staff.role)}</p>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">ÊôÇÁµ¶</span>
                            <span class="font-semibold text-gray-200">¬•${hourlyRate.toLocaleString()}</span>
                        </div>
                        ${staff.phone ? `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">ÈõªË©±Áï™Âè∑</span>
                            <span class="text-gray-200">${staff.phone}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editStaff(${staff.id})" class="flex-1 bg-blue-900/20 text-blue-400 border border-blue-800/30 py-2 rounded-xl hover:bg-blue-900/30 transition text-sm">
                            Á∑®ÈõÜ
                        </button>
                        <button onclick="deleteStaff(${staff.id})" class="flex-1 bg-red-900/20 text-red-400 border border-red-800/30 py-2 rounded-xl hover:bg-red-900/30 transition text-sm">
                            ÂâäÈô§
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function getStaffRoleColor(role) {
            const colors = {
                'waiter': 'text-blue-400',
                'kitchen': 'text-orange-400',
                'manager': 'text-purple-400',
                'catch': 'text-green-400',
                'driver': 'text-cyan-400',
                'other': 'text-gray-400'
            };
            return colors[role] || 'text-gray-400';
        }
        
        function getStaffRoleLabel(role) {
            const labels = {
                'waiter': '„Éú„Éº„Ç§',
                'kitchen': '„Ç≠„ÉÉ„ÉÅ„É≥',
                'manager': '„Éû„Éç„Éº„Ç∏„É£„Éº',
                'catch': '„Ç≠„É£„ÉÉ„ÉÅ',
                'driver': '„Éâ„É©„Ç§„Éê„Éº',
                'other': '„Åù„ÅÆ‰ªñ'
            };
            return labels[role] || role;
        }
        
        function openAddStaffModal() {
            document.getElementById('addStaffModal').classList.add('active');
        }
        
        async function addStaff(event) {
            event.preventDefault();
            
            const name = document.getElementById('staffName').value;
            const role = document.getElementById('staffRole').value;
            const hourlyRate = parseInt(document.getElementById('staffHourlyRate').value);
            const phone = document.getElementById('staffPhone').value;
            
            try {
                await apiRequest('/staff', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: name,
                        role: role,
                        hourly_rate: hourlyRate,
                        phone: phone || null
                    })
                });
                
                closeModal('addStaffModal');
                await loadStaffFromApi();
                showNotification('„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
                
                // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
                document.getElementById('staffName').value = '';
                document.getElementById('staffRole').value = 'waiter';
                document.getElementById('staffHourlyRate').value = '';
                document.getElementById('staffPhone').value = '';
            } catch (e) {
                console.error('[addStaff] error:', e);
                showNotification('„Çπ„Çø„ÉÉ„Éï„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        function editStaff(staffId) {
            const staff = appState.staff.find(s => s.id === staffId);
            if (!staff) return;
            
            document.getElementById('editStaffId').value = staff.id;
            document.getElementById('editStaffName').value = staff.name;
            document.getElementById('editStaffRole').value = staff.role;
            document.getElementById('editStaffHourlyRate').value = staff.hourly_rate || staff.hourlyRate || 0;
            document.getElementById('editStaffPhone').value = staff.phone || '';
            
            document.getElementById('editStaffModal').classList.add('active');
        }
        
        async function updateStaff(event) {
            event.preventDefault();
            
            const staffId = parseInt(document.getElementById('editStaffId').value);
            
            try {
                await apiRequest(`/staff/${staffId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('editStaffName').value,
                        role: document.getElementById('editStaffRole').value,
                        hourly_rate: parseInt(document.getElementById('editStaffHourlyRate').value),
                        phone: document.getElementById('editStaffPhone').value || null
                    })
                });
                
                closeModal('editStaffModal');
                await loadStaffFromApi();
                showNotification('„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
            } catch (e) {
                console.error('[updateStaff] error:', e);
                showNotification('„Çπ„Çø„ÉÉ„Éï„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        async function deleteStaff(staffId) {
            if (!confirm('„Åì„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            try {
                await apiRequest(`/staff/${staffId}`, {
                    method: 'DELETE'
                });
                
                await loadStaffFromApi();
                showNotification('„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
            } catch (e) {
                console.error('[deleteStaff] error:', e);
                showNotification('„Çπ„Çø„ÉÉ„Éï„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        function openAddCastModal() {
            document.getElementById('addCastModal').classList.add('active');
        }

async function addCast(event) {
    event.preventDefault();

    const name = document.getElementById('castName').value;
    const rank = document.getElementById('castRank').value;
    const hourlyRate = parseInt(document.getElementById('castHourlyRate').value);
    const companionBack = parseInt(document.getElementById('castCompanionBack').value) || 3000;
    const nominationBack = parseInt(document.getElementById('castNominationBack').value) || 1000;
    const drinkBackRate = parseInt(document.getElementById('castDrinkBackRate').value) || 10;
    const salesBackRate = parseInt(document.getElementById('castSalesBackRate').value) || 0;

    // ‚òÖ „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÁî®„Éö„Ç§„É≠„Éº„ÉâÔºàstage_name ÂøÖÈ†àÔºâ
    const payload = {
        name: name,
        stage_name: name,
        rank: rank,
        hourly_rate: hourlyRate,
        companion_back: companionBack,
        nomination_back: nominationBack,
        drink_back_rate: drinkBackRate,
        sales_back_rate: salesBackRate
    };

    console.log('addCast payload:', payload);

    try {
        let createdCast;

        if (appState.apiConnected) {
            // APIÁµåÁî±„Åß‰ΩúÊàê
            createdCast = await apiRequest(API_ENDPOINTS.casts, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
        } else {
            // „Ç™„Éï„É©„Ç§„É≥ÊôÇ„ÅØ„É≠„Éº„Ç´„É´„Å†„Åë
            createdCast = {
                id: appState.casts.length + 1,
                sales: 0,
                ...payload
            };
        }

        const hourlyRateFromApi =
            createdCast.hourlyRate ??
            createdCast.hourly_rate ??
            hourlyRate;

        appState.casts.push({
            id: createdCast.id,
            name: createdCast.name ?? createdCast.stage_name ?? name,
            rank: createdCast.rank ?? rank,
            hourlyRate: hourlyRateFromApi,
            companionBack: createdCast.companion_back ?? companionBack,
            nominationBack: createdCast.nomination_back ?? nominationBack,
            drinkBackRate: createdCast.drink_back_rate ?? drinkBackRate,
            salesBackRate: createdCast.sales_back_rate ?? salesBackRate,
            sales: createdCast.sales ?? 0
        });

        renderCasts();
        populateCastSelects();
        closeModal('addCastModal');
        showNotification('„Ç≠„É£„Çπ„Éà„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');

        document.getElementById('castName').value = '';
        document.getElementById('castHourlyRate').value = '';
        document.getElementById('castCompanionBack').value = '3000';
        document.getElementById('castNominationBack').value = '1000';
        document.getElementById('castDrinkBackRate').value = '10';
        document.getElementById('castSalesBackRate').value = '0';
    } catch (error) {
        console.error(error);
        showNotification('„Ç≠„É£„Çπ„Éà„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
}


        function editCast(id) {
            const cast = appState.casts.find(c => c.id === id);
            if (!cast) return;

            document.getElementById('editCastId').value = cast.id;
            document.getElementById('editCastName').value = cast.name || cast.stage_name || '';
            document.getElementById('editCastRank').value = cast.rank;
            document.getElementById('editCastHourlyRate').value = cast.hourlyRate ?? cast.hourly_rate ?? 0;
            document.getElementById('editCastCompanionBack').value = cast.companionBack ?? cast.companion_back ?? 3000;
            document.getElementById('editCastNominationBack').value = cast.nominationBack ?? cast.nomination_back ?? 1000;
            document.getElementById('editCastDrinkBackRate').value = cast.drinkBackRate ?? cast.drink_back_rate ?? 10;
            document.getElementById('editCastSalesBackRate').value = cast.salesBackRate ?? cast.sales_back_rate ?? 0;
            
            document.getElementById('editCastModal').classList.add('active');
        }

async function updateCast(event) {
    event.preventDefault();
    
    const id = parseInt(document.getElementById('editCastId').value);
    const castIndex = appState.casts.findIndex(c => c.id === id);
    if (castIndex === -1) return;

    const name = document.getElementById('editCastName').value;
    const rank = document.getElementById('editCastRank').value;
    const hourlyRate = parseInt(document.getElementById('editCastHourlyRate').value);
    const companionBack = parseInt(document.getElementById('editCastCompanionBack').value) || 3000;
    const nominationBack = parseInt(document.getElementById('editCastNominationBack').value) || 1000;
    const drinkBackRate = parseInt(document.getElementById('editCastDrinkBackRate').value) || 10;
    const salesBackRate = parseInt(document.getElementById('editCastSalesBackRate').value) || 0;

    // ‚òÖ „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÈÄÅ„Çã„Éá„Éº„ÇøÔºàstage_name ÂøÖÈ†àÔºâ
    const payload = {
        ...appState.casts[castIndex],
        name: name,
        stage_name: name,
        rank: rank,
        hourly_rate: hourlyRate,
        companion_back: companionBack,
        nomination_back: nominationBack,
        drink_back_rate: drinkBackRate,
        sales_back_rate: salesBackRate
    };

    try {
        if (appState.apiConnected) {
            // API „Å´ÂèçÊò†
            await apiRequest(`${API_ENDPOINTS.casts}/${id}`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });
        }

        // „Éï„É≠„É≥„ÉàÂÅ¥„ÅÆ state „ÇÇÊõ¥Êñ∞
        appState.casts[castIndex] = {
            ...appState.casts[castIndex],
            name: name,
            rank: rank,
            hourlyRate: hourlyRate,
            companionBack: companionBack,
            nominationBack: nominationBack,
            drinkBackRate: drinkBackRate,
            salesBackRate: salesBackRate
        };

        renderCasts();
        populateCastSelects();
        closeModal('editCastModal');
        showNotification('„Ç≠„É£„Çπ„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
    } catch (error) {
        console.error(error);
        showNotification('„Ç≠„É£„Çπ„ÉàÊÉÖÂ†±„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
}

async function deleteCast(id) {
    if (!confirm('„Åì„ÅÆ„Ç≠„É£„Çπ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

    try {
        if (appState.apiConnected) {
            // ‚òÖ API ‰∏ä„Åã„Çâ„ÇÇÂâäÈô§
            await apiRequest(`${API_ENDPOINTS.casts}/${id}`, {
                method: 'DELETE'
            });
        }

        // „É≠„Éº„Ç´„É´ state „Åã„ÇâÂâäÈô§
        appState.casts = appState.casts.filter(cast => cast.id !== id);
        renderCasts();
        populateCastSelects();
        showNotification('„Ç≠„É£„Çπ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    } catch (error) {
        console.error(error);
        showNotification('„Ç≠„É£„Çπ„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
}

function populateCastSelects() {
    const selects = ['clockInCast', 'clockOutCast', 'shiftCast'];
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
                appState.casts
                    .map(cast => {
                        const displayName = cast.stage_name || cast.name || `Cast#${cast.id}`;
                        return `<option value="${cast.id}">${displayName}</option>`;
                    })
                    .join('');
        }
    });
}
        // Âã§ÊÄ†ÁÆ°ÁêÜ
        function clockIn() {
            const castId = document.getElementById('clockInCast').value;
            if (!castId) {
                showNotification('„Ç≠„É£„Çπ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const cast = appState.casts.find(c => c.id === parseInt(castId));
            const castName = cast.stage_name || cast.name || `Cast#${cast.id}`;
            const now = new Date();
            
            const attendance = {
                id: appState.attendances.length + 1,
                castId: cast.id,
                castName: castName,
                date: now.toISOString().split('T')[0],
                clockIn: now.toTimeString().slice(0, 5),
                clockOut: null,
                status: 'working'
            };

            appState.attendances.push(attendance);
            renderAttendance();
            updateDashboard();
            showNotification(`${castName}„ÅåÂá∫Âã§„Åó„Åæ„Åó„Åü`, 'success');
        }

        function clockOut() {
            const castId = document.getElementById('clockOutCast').value;
            if (!castId) {
                showNotification('„Ç≠„É£„Çπ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const cast = appState.casts.find(c => c.id === parseInt(castId));
            const castName = cast.stage_name || cast.name || `Cast#${cast.id}`;
            const attendance = appState.attendances.find(a => 
                a.castId === cast.id && 
                a.status === 'working' &&
                a.date === new Date().toISOString().split('T')[0]
            );

            if (!attendance) {
                showNotification('Âá∫Âã§Ë®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }

            const now = new Date();
            attendance.clockOut = now.toTimeString().slice(0, 5);
            attendance.status = 'completed';

            renderAttendance();
            updateDashboard();
            showNotification(`${castName}„ÅåÈÄÄÂã§„Åó„Åæ„Åó„Åü`, 'success');
        }

        function renderAttendance() {
            const tbody = document.getElementById('attendanceTableBody');
            const today = new Date().toISOString().split('T')[0];
            const todayAttendances = appState.attendances.filter(a => a.date === today);

            if (todayAttendances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-gray-500">Êú¨Êó•„ÅÆÂã§ÊÄ†„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
                return;
            }

            tbody.innerHTML = todayAttendances.map(attendance => {
                const hours = calculateHours(attendance.clockIn, attendance.clockOut);
                return `
                    <tr class="border-b border-gray-800">
                        <td class="py-3 px-4 text-gray-300">${attendance.date}</td>
                        <td class="py-3 px-4 text-gray-300">${attendance.castName}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${attendance.clockIn}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${attendance.clockOut || '-'}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${hours}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                attendance.status === 'working' ? 'bg-green-900/30 text-green-300' : 'bg-gray-800 text-gray-400'
                            }">
                                ${attendance.status === 'working' ? 'Âã§Âãô‰∏≠' : 'ÈÄÄÂã§'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateHours(clockIn, clockOut) {
            if (!clockOut) return '-';
            const [inH, inM] = clockIn.split(':').map(Number);
            const [outH, outM] = clockOut.split(':').map(Number);
            const totalMinutes = (outH * 60 + outM) - (inH * 60 + inM);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours}ÊôÇÈñì${minutes}ÂàÜ`;
        }

        function exportAttendanceCSV() {
            showNotification('Âã§ÊÄ†„Éá„Éº„Çø„ÇíCSVÂá∫Âäõ„Åó„Åæ„Åó„Åü', 'success');
        }

        // „Ç∑„Éï„ÉàÁÆ°ÁêÜ
        function initializeShiftCalendar() {
            appState.shifts = [
                { id: 1, castId: 1, date: '2024-11-15', start: '20:00', end: '01:00' },
                { id: 2, castId: 2, date: '2024-11-15', start: '21:00', end: '02:00' },
                { id: 3, castId: 3, date: '2024-11-16', start: '19:30', end: '00:30' }
            ];
            renderShiftCalendar();
            renderWeeklyShifts();
        }

        function renderShiftCalendar() {
            const calendar = document.getElementById('shiftCalendar');
            if (!calendar) return;

            const year = appState.currentMonth.getFullYear();
            const month = appState.currentMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            document.getElementById('currentMonth').textContent = `${year}Âπ¥${month + 1}Êúà`;

            let html = '';
            const weekDays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            weekDays.forEach(day => {
                html += `<div class="text-center font-semibold p-2 md:p-3 text-gray-400 text-xs md:text-sm">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += `<div class="p-2"></div>`;
            }

            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const shiftsForDate = appState.shifts.filter(s => s.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                
                html += `<div class="calendar-cell border border-gray-800 ${isToday ? 'bg-yellow-900/10 border-yellow-700/30' : ''}">
                    <div class="font-semibold text-xs md:text-sm mb-1 md:mb-2 ${isToday ? 'text-yellow-500' : 'text-gray-400'}">${date}</div>
                    <div class="space-y-1">
                        ${shiftsForDate.map(shift => {
                            const cast = appState.casts.find(c => c.id === shift.castId);
                            const castName = cast ? (cast.stage_name || cast.name || `Cast#${cast.id}`) : '‰∏çÊòé';
                            return `<div class="shift-badge">${castName}</div>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            calendar.innerHTML = html;
        }

        function renderWeeklyShifts() {
            const container = document.getElementById('weeklyShifts');
            if (!container) return;

            const today = new Date();
            const weekShifts = appState.shifts.filter(s => {
                const shiftDate = new Date(s.date);
                const diff = Math.floor((shiftDate - today) / (1000 * 60 * 60 * 24));
                return diff >= 0 && diff < 7;
            });

            container.innerHTML = weekShifts.length === 0 
                ? '<p class="text-gray-500 text-center py-6 text-sm">‰ªäÈÄ±„ÅÆ„Ç∑„Éï„Éà„Å™„Åó</p>'
                : weekShifts.map(shift => {
                    const cast = appState.casts.find(c => c.id === shift.castId);
                    const castName = cast ? (cast.stage_name || cast.name || `Cast#${cast.id}`) : '‰∏çÊòé';
                    return `
                        <div class="flex justify-between items-center p-4 md:p-5 bg-gray-800/30 rounded-xl hover:bg-gray-800/50 transition">
                            <div>
                                <p class="font-bold text-base md:text-lg text-gray-200">${castName}</p>
                                <p class="text-xs md:text-sm text-gray-400">${shift.date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs md:text-sm text-gray-300">${shift.start} - ${shift.end}</p>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function openAddShiftModal() {
            populateCastSelects();
            document.getElementById('addShiftModal').classList.add('active');
        }

        async function saveShift(event) {
            event.preventDefault();
            
            const castId = parseInt(document.getElementById('shiftCast').value);
            if (!castId) {
                showNotification('„Ç≠„É£„Çπ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            const shift = {
                id: appState.shifts.length + 1,
                castId: castId,
                date: document.getElementById('shiftDate').value,
                start: document.getElementById('shiftStart').value,
                end: document.getElementById('shiftEnd').value
            };

            appState.shifts.push(shift);
            
            renderShiftCalendar();
            renderWeeklyShifts();
            closeModal('addShiftModal');
            showNotification('„Ç∑„Éï„Éà„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü', 'success');
            
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('shiftDate').value = '';
            document.getElementById('shiftStart').value = '';
            document.getElementById('shiftEnd').value = '';
        }

        function previousMonth() {
            appState.currentMonth.setMonth(appState.currentMonth.getMonth() - 1);
            renderShiftCalendar();
        }

        function nextMonth() {
            appState.currentMonth.setMonth(appState.currentMonth.getMonth() + 1);
            renderShiftCalendar();
        }

        // „Ç≠„É£„Çπ„Éà„Çµ„Éñ„Çø„Éñ
        function showCastSubTab(tabName) {
            document.querySelectorAll('.cast-subtab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.cast-subtab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-subtab`).classList.add('active');
            
            if (tabName === 'staff-list') {
                renderStaff();
            } else if (tabName === 'drink-back') {
                renderDrinkBackList();
            } else if (tabName === 'salary') {
                renderSalaryCalculation();
            } else if (tabName === 'ranking') {
                renderRankings();
            }
        }

        function renderDrinkBackList() {
            const period = document.getElementById('dbFilterPeriod')?.value || 'today';
            
            const dbOrders = [];
            const allSessions = [
                ...(appState.activeSessions || []),
                ...(appState.checkoutHistory || [])
            ];
            
            allSessions.forEach(session => {
                if (session.orders) {
                    session.orders.filter(o => o.isDrinkBack).forEach(order => {
                        const dbAmount = Math.floor(order.price * order.quantity * 0.6);
                        dbOrders.push({
                            castName: order.castName,
                            itemName: order.itemName,
                            quantity: order.quantity,
                            price: order.price,
                            dbAmount: dbAmount,
                            time: session.startTime
                        });
                    });
                }
            });
            
            const castDbMap = {};
            dbOrders.forEach(order => {
                if (!castDbMap[order.castName]) {
                    castDbMap[order.castName] = {
                        name: order.castName,
                        totalDb: 0,
                        count: 0,
                        orders: []
                    };
                }
                castDbMap[order.castName].totalDb += order.dbAmount;
                castDbMap[order.castName].count += order.quantity;
                castDbMap[order.castName].orders.push(order);
            });
            
            const castDbList = Object.values(castDbMap).sort((a, b) => b.totalDb - a.totalDb);
            
            const totalDb = dbOrders.reduce((sum, o) => sum + o.dbAmount, 0);
            const totalCount = dbOrders.length;
            const topCast = castDbList[0]?.name || '-';
            const avgDb = castDbList.length > 0 ? Math.floor(totalDb / castDbList.length) : 0;
            
            document.getElementById('totalDbAmount').textContent = `¬•${totalDb.toLocaleString()}`;
            document.getElementById('totalDbCount').textContent = `${totalCount}‰ª∂`;
            document.getElementById('topDbCast').textContent = topCast;
            document.getElementById('avgDbAmount').textContent = `¬•${avgDb.toLocaleString()}`;
            
            const castDbListEl = document.getElementById('castDbList');
            if (castDbList.length === 0) {
                castDbListEl.innerHTML = '<p class="text-gray-500 text-center py-6">DBÊ≥®Êñá„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            } else {
                castDbListEl.innerHTML = castDbList.map(cast => {
                    const initial = cast.name.charAt(0);
                    return `
                    <div class="flex items-center justify-between p-4 bg-gray-800/30 rounded-xl hover:bg-gray-800/50 transition">
                        <div class="flex items-center gap-4">
                            <div class="cast-avatar cast-avatar-small">
                                ${initial}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-200">${cast.name}</p>
                                <p class="text-sm text-gray-400">${cast.count}‰ª∂„ÅÆÊ≥®Êñá</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-pink-300">¬•${cast.totalDb.toLocaleString()}</p>
                            <p class="text-xs text-gray-400">DBÂêàË®à</p>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            const dbDetailTable = document.getElementById('dbDetailTableBody');
            if (dbOrders.length === 0) {
                dbDetailTable.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-500">DBÊ≥®Êñá„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
            } else {
                dbDetailTable.innerHTML = dbOrders.map(order => `
                    <tr>
                        <td class="py-3 px-4 text-gray-300">${new Date(order.time).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</td>
                        <td class="py-3 px-4 text-purple-300 font-semibold">${order.castName}</td>
                        <td class="py-3 px-4 text-gray-300">${order.itemName}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${order.quantity}</td>
                        <td class="py-3 px-4 text-right font-semibold text-pink-300">¬•${order.dbAmount.toLocaleString()}</td>
                    </tr>
                `).join('');
            }
        }

        function renderSalaryCalculation() {
            const month = document.getElementById('salaryMonth')?.value || '2024-11';
            
            // „Éê„ÉÉ„ÇØË®≠ÂÆö„ÇíÂèñÂæó
            const backSettings = appState.backSettings || {
                db: 60, nomination: 60, sales: 10, companion: 100, champagne: 10, bottle: 10
            };
            
            const salaryData = appState.casts.map(cast => {
                const workDays = 20;
                const hoursPerDay = 8;
                const totalHours = workDays * hoursPerDay;
                const hourlyWage = (cast.hourlyRate || 2500) * totalHours;
                
                let totalDb = 0;
                let nominationFees = 0;
                let companionBack = 0;
                let salesBack = 0;
                let champagneBack = 0;
                let bottleBack = 0;
                
                const allSessions = [
                    ...(appState.activeSessions || []),
                    ...(appState.checkoutHistory || [])
                ];
                
                allSessions.forEach(session => {
                    // „Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØË®àÁÆó
                    if (session.castName === cast.name && session.orders) {
                        session.orders.filter(o => o.isDrinkBack && o.castName === cast.name).forEach(order => {
                            totalDb += Math.floor(order.price * order.quantity * (backSettings.db / 100));
                        });
                    }
                    
                    // ÊåáÂêçÈñ¢ÈÄ£„ÅÆ„Éê„ÉÉ„ÇØË®àÁÆó
                    if (session.shimei_casts) {
                        const shimeiNames = session.shimei_casts.split(',').map(n => n.trim());
                        if (shimeiNames.includes(cast.name) || shimeiNames.includes(cast.stage_name)) {
                            // ÊåáÂêçÊñô„Çí‰∫∫Êï∞„ÅßÁ≠âÂàÜ
                            const perCast = Math.floor(session.nomination_fee / shimeiNames.length * (backSettings.nomination / 100));
                            nominationFees += perCast;
                            
                            // Â£≤‰∏ä„Éê„ÉÉ„ÇØÔºà‰∫∫Êï∞„ÅßÁ≠âÂàÜÔºâ
                            const sessionTotal = session.current_total || session.total || 0;
                            const salesBackPerCast = Math.floor(sessionTotal * (backSettings.sales / 100) / shimeiNames.length);
                            salesBack += salesBackPerCast;
                        }
                    } else if (session.nomination && session.nomination.castName === cast.name) {
                        // ÂæìÊù•ÊñπÂºèÔºàÂæåÊñπ‰∫íÊèõÔºâ
                        nominationFees += Math.floor(session.nomination.fee * (backSettings.nomination / 100));
                        const sessionTotal = session.current_total || session.total || 0;
                        salesBack += Math.floor(sessionTotal * (backSettings.sales / 100));
                    }
                    
                    // Âêå‰º¥„Éê„ÉÉ„ÇØ
                    if (session.has_companion && session.castName === cast.name) {
                        companionBack += Math.floor(3000 * (backSettings.companion / 100));
                    }
                    
                    // „Ç∑„É£„É≥„Éë„É≥„Éª„Éú„Éà„É´„Éê„ÉÉ„ÇØË®àÁÆóÔºàorders„Åã„ÇâÔºâ
                    if (session.orders) {
                        session.orders.forEach(order => {
                            const cat = (order.category || '').toLowerCase();
                            if (cat === 'champagne' && session.castName === cast.name) {
                                champagneBack += Math.floor(order.price * order.quantity * (backSettings.champagne / 100));
                            }
                            if (cat === 'bottle' && session.castName === cast.name) {
                                bottleBack += Math.floor(order.price * order.quantity * (backSettings.bottle / 100));
                            }
                        });
                    }
                });
                
                const totalSalary = hourlyWage + totalDb + nominationFees + companionBack + salesBack + champagneBack + bottleBack;
                
                return {
                    cast: cast,
                    workDays: workDays,
                    totalHours: totalHours,
                    hourlyWage: hourlyWage,
                    totalDb: totalDb,
                    nominationFees: nominationFees,
                    companionBack: companionBack,
                    salesBack: salesBack,
                    champagneBack: champagneBack,
                    bottleBack: bottleBack,
                    totalSalary: totalSalary
                };
            });
            
            const salaryListEl = document.getElementById('salaryList');
            salaryListEl.innerHTML = salaryData.map(data => {
                const initial = data.cast.name.charAt(0);
                return `
                <div class="luxury-card rounded-xl overflow-hidden">
                    <div class="bg-gray-800/50 p-4 border-b border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="cast-avatar cast-avatar-small">
                                    ${initial}
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-200">${data.cast.name}</h3>
                                    <p class="text-sm text-gray-400">${month}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-400">Á∑èÊîØÁµ¶È°ç</p>
                                <p class="text-3xl font-bold gold-accent">¬•${data.totalSalary.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1">Âá∫Âã§Êó•Êï∞</p>
                            <p class="text-xl font-semibold text-gray-200">${data.workDays}Êó•</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1">Âã§ÂãôÊôÇÈñì</p>
                            <p class="text-xl font-semibold text-gray-200">${data.totalHours}h</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1">ÊôÇÁµ¶</p>
                            <p class="text-xl font-semibold text-gray-200">¬•${data.cast.hourlyRate.toLocaleString()}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1">ÊôÇÁµ¶Ë®à</p>
                            <p class="text-xl font-semibold text-blue-300">¬•${data.hourlyWage.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-gray-700 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">üíé DBÂêàË®à</span>
                            <span class="font-semibold text-pink-300">¬•${data.totalDb.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">‚≠ê ÊåáÂêçÊñô„Éê„ÉÉ„ÇØ</span>
                            <span class="font-semibold text-purple-300">¬•${data.nominationFees.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">üí∞ Â£≤‰∏ä„Éê„ÉÉ„ÇØ</span>
                            <span class="font-semibold text-green-300">¬•${data.salesBack.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">üöó Âêå‰º¥„Éê„ÉÉ„ÇØ</span>
                            <span class="font-semibold text-amber-300">¬•${data.companionBack.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">üçæ „Ç∑„É£„É≥„Éë„É≥„Éê„ÉÉ„ÇØ</span>
                            <span class="font-semibold text-yellow-300">¬•${data.champagneBack.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">ü•É „Éú„Éà„É´„Éê„ÉÉ„ÇØ</span>
                            <span class="font-semibold text-orange-300">¬•${data.bottleBack.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 border-t-2 border-yellow-700/50">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-gray-200">Á∑èÊîØÁµ¶È°ç</span>
                            <span class="text-2xl font-bold gold-accent">¬•${data.totalSalary.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderRankings() {
            const period = document.getElementById('rankingPeriod')?.value || 'month';
            
            const salesRanking = [...appState.casts].sort((a, b) => (b.sales || 0) - (a.sales || 0));
            
            const dbRanking = appState.casts.map(cast => {
                let totalDb = 0;
                const allSessions = [
                    ...(appState.activeSessions || []),
                    ...(appState.checkoutHistory || [])
                ];
                
                allSessions.forEach(session => {
                    if (session.castName === cast.name && session.orders) {
                        session.orders.filter(o => o.isDrinkBack && o.castName === cast.name).forEach(order => {
                            totalDb += Math.floor(order.price * order.quantity * 0.6);
                        });
                    }
                });
                
                return { cast: cast, totalDb: totalDb };
            }).sort((a, b) => b.totalDb - a.totalDb);
            
            const nominationRanking = appState.casts.map(cast => {
                let nominationCount = 0;
                const allSessions = [
                    ...(appState.activeSessions || []),
                    ...(appState.checkoutHistory || [])
                ];
                
                allSessions.forEach(session => {
                    if (session.nomination && session.nomination.castName === cast.name) {
                        nominationCount++;
                    }
                });
                
                return { cast: cast, nominationCount: nominationCount };
            }).sort((a, b) => b.nominationCount - a.nominationCount);
            
            document.getElementById('salesRanking').innerHTML = salesRanking.slice(0, 5).map((cast, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const medal = medals[index] || `${index + 1}‰Ωç`;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${medal}</span>
                            <span class="font-semibold text-gray-200">${cast.name}</span>
                        </div>
                        <span class="font-bold gold-accent">¬•${(cast.sales || 0).toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dbRanking').innerHTML = dbRanking.slice(0, 5).map((data, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const medal = medals[index] || `${index + 1}‰Ωç`;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${medal}</span>
                            <span class="font-semibold text-gray-200">${data.cast.name}</span>
                        </div>
                        <span class="font-bold text-pink-300">¬•${data.totalDb.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('nominationRanking').innerHTML = nominationRanking.slice(0, 5).map((data, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const medal = medals[index] || `${index + 1}‰Ωç`;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${medal}</span>
                            <span class="font-semibold text-gray-200">${data.cast.name}</span>
                        </div>
                        <span class="font-bold text-purple-300">${data.nominationCount}Âõû</span>
                    </div>
                `;
            }).join('');
        }

        function exportDrinkBackCSV() {
            showNotification('DB‰∏ÄË¶ßCSV„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü', 'success');
        }

        function exportSalaryCSV() {
            showNotification('Áµ¶‰∏éÊòéÁ¥∞CSV„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü', 'success');
        }
„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄfunction getAllSessionsFromAppState(app) {
    if (!app) return [];

    const result = [];

    // „Åæ„Åö‰ªä„Åæ„ÅßÈÄö„Çä„ÅÆ2„Å§
    if (Array.isArray(app.activeSessions)) {
        result.push(...app.activeSessions);
    }
    if (Array.isArray(app.checkoutHistory)) {
        result.push(...app.checkoutHistory);
    }

    // ‰ªñ„Å´„ÇÇ„Åù„Çå„Å£„ÅΩ„ÅÑÈÖçÂàó„Åå„ÅÇ„Çå„Å∞ËøΩÂä†
    for (const [key, value] of Object.entries(app)) {
        if (!Array.isArray(value)) continue;
        // castName „ÇÑ orders „ÇíÊåÅ„Å£„Å¶„ÅÑ„Çã„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅåÊ∑∑„Åñ„Å£„Å¶„ÅÑ„ÇãÈÖçÂàó„Å†„ÅëÂÄôË£ú„Å´„Åô„Çã
        if (value.some(v => v && (v.castName || v.orders || v.tableId))) {
            // Êó¢„Å´ËøΩÂä†Ê∏à„Åø„ÅÆ active/checkout „Åß„Å™„ÅÑ„Ç≠„Éº„Å†„ÅëË∂≥„Åô
            if (key !== 'activeSessions' && key !== 'checkoutHistory') {
                result.push(...value);
            }
        }
    }
    return result;
    }

// ‚òÖ ‰ºöË®àÂ±•Ê≠¥Ê©üËÉΩ
function renderCheckoutHistory() {
    const container = document.getElementById('checkoutHistoryContent');
    if (!container) return;
    
    // ‰ªäÊó•„ÅÆÊó•‰ªò
    const today = new Date();
    const todayStr = today.toLocaleDateString('ja-JP');
    
    // ‰ªäÊó•„ÅÆ‰ºöË®à„ÅÆ„Åø„Éï„Ç£„É´„Çø
    const todayHistory = (appState.checkoutHistory || []).filter(session => {
        const checkoutTime = new Date(session.checkoutTime);
        return checkoutTime.toLocaleDateString('ja-JP') === todayStr;
    }).sort((a, b) => new Date(b.checkoutTime) - new Date(a.checkoutTime));
    
    if (todayHistory.length === 0) {
        container.innerHTML = `
            <div class="luxury-card rounded-2xl p-8 text-center text-gray-500">
                <p class="text-lg">Êú¨Êó•„ÅÆ‰ºöË®àÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = todayHistory.map((session, index) => {
        const checkoutTime = new Date(session.checkoutTime);
        const timeStr = checkoutTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const tableName = session.tableName || session.table_name || session.tableId || '?';
        const guests = session.guests || 0;
        const castName = session.castName || session.cast_name || 'Êú™Ë®≠ÂÆö';
        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
        const historyIndex = appState.checkoutHistory.indexOf(session);
        
        return `
            <div class="luxury-card rounded-2xl p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-2xl font-bold text-gray-200">„ÉÜ„Éº„Éñ„É´ ${tableName}</span>
                            <span class="text-sm text-gray-500">${timeStr}</span>
                        </div>
                        <div class="flex flex-wrap gap-4 text-sm text-gray-400">
                            <span>üë• ${guests}Âêç</span>
                            <span>üíÉ ${castName}</span>
                            <span class="text-lg font-bold gold-accent">¬•${total.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showReceiptFromHistory(${historyIndex})" 
                                class="bg-blue-900/20 text-blue-400 border border-blue-800/30 px-4 py-2 rounded-xl hover:bg-blue-900/30 transition text-sm">
                            üßæ ‰ºùÁ•®
                        </button>
                        <button onclick="openEditCheckoutModal(${historyIndex})" 
                                class="bg-amber-900/20 text-amber-400 border border-amber-800/30 px-4 py-2 rounded-xl hover:bg-amber-900/30 transition text-sm">
                            ‚úèÔ∏è ‰øÆÊ≠£
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Â±•Ê≠¥„Åã„Çâ‰ºùÁ•®„ÇíÂÜçË°®Á§∫
function showReceiptFromHistory(historyIndex) {
    const session = appState.checkoutHistory[historyIndex];
    if (!session) return;
    
    // Ê≥®Êñá„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥„Å´‰øùÂ≠ò„Åï„Çå„Å¶„Çã„ÇÇ„ÅÆ„Çí‰Ωø„ÅÜ
    const orders = session.orders || [];
    showReceipt(session, orders);
}

// ‰ºöË®à‰øÆÊ≠£„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
function openEditCheckoutModal(historyIndex) {
    const session = appState.checkoutHistory[historyIndex];
    if (!session) return;
    
    const total = session.totalAmount || session.currentTotal || session.current_total || 0;
    const guests = session.guests || 0;
    const tableName = session.tableName || session.table_name || session.tableId || '?';
    const castName = session.castName || session.cast_name || 'Êú™Ë®≠ÂÆö';
    const shimeiCasts = session.shimei_casts || '';
    const catchStaff = session.catchStaff || session.catch_staff || '';
    const taxRate = session.taxRate || session.tax_rate || 20;
    const orders = session.orders || [];
    
    // Ê≥®ÊñáÊòéÁ¥∞„ÅÆHTMLÁîüÊàê
    const ordersHtml = orders.length > 0 ? orders.map((o, idx) => {
        const itemName = o.item_name || o.itemName || 'ÂïÜÂìÅ';
        const price = o.price || 0;
        const qty = o.quantity || 1;
        return `
            <div class="flex items-center gap-2 py-2 border-b border-gray-700">
                <input type="text" id="editOrderName_${idx}" value="${itemName}" 
                       class="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm">
                <input type="number" id="editOrderQty_${idx}" value="${qty}" min="0"
                       class="w-16 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm text-center">
                <input type="number" id="editOrderPrice_${idx}" value="${price}" 
                       class="w-24 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm text-right">
            </div>
        `;
    }).join('') : '<p class="text-gray-500 text-sm">Ê≥®Êñá„Éá„Éº„Çø„Å™„Åó</p>';
    
    // ‰øÆÊ≠£Áî®„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    const modalHtml = `
        <div id="editCheckoutModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-y-auto">
            <div class="luxury-card rounded-2xl max-w-2xl w-full p-6 my-4">
                <h2 class="text-xl font-bold gold-accent mb-4">‰ºöË®à‰øÆÊ≠£ - „ÉÜ„Éº„Éñ„É´${tableName}</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm text-gray-400 block mb-1">Êù•Â∫ó‰∫∫Êï∞</label>
                        <input type="number" id="editGuests" value="${guests}" min="1" 
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 block mb-1">TAX/„Çµ„Éº„Éì„ÇπÁéáÔºà%Ôºâ</label>
                        <input type="number" id="editTaxRate" value="${taxRate}" min="0" max="100"
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 block mb-1">ÊãÖÂΩì„Ç≠„É£„Çπ„Éà</label>
                        <input type="text" id="editCastName" value="${castName}" 
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 block mb-1">ÊåáÂêç„Ç≠„É£„Çπ„Éà</label>
                        <input type="text" id="editShimeiCasts" value="${shimeiCasts}" 
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white"
                               placeholder="„Ç´„É≥„ÉûÂå∫Âàá„Çä">
                    </div>
                    <div class="col-span-2">
                        <label class="text-sm text-gray-400 block mb-1">„Ç≠„É£„ÉÉ„ÉÅÊãÖÂΩì</label>
                        <input type="text" id="editCatchStaff" value="${catchStaff}" 
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="text-sm text-gray-400 block mb-2">Ê≥®ÊñáÊòéÁ¥∞ÔºàÂìÅÂêç / Êï∞Èáè / Âçò‰æ°Ôºâ</label>
                    <div class="max-h-48 overflow-y-auto bg-gray-900/50 rounded-xl p-2" id="editOrdersList">
                        ${ordersHtml}
                    </div>
                    <button onclick="addEditOrderRow(${historyIndex})" 
                            class="mt-2 text-sm text-amber-400 hover:text-amber-300">
                        Ôºã Ë°å„ÇíËøΩÂä†
                    </button>
                </div>
                
                <div class="mb-4 p-3 bg-amber-900/20 rounded-xl border border-amber-800/30">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">ÂêàË®àÈáëÈ°çÔºàËá™ÂãïË®àÁÆóÔºâ</span>
                        <span id="editCalculatedTotal" class="text-xl font-bold gold-accent">¬•${total.toLocaleString()}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ‰øùÂ≠òÊôÇ„Å´Ê≥®ÊñáÊòéÁ¥∞„Åã„ÇâËá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="saveEditCheckout(${historyIndex})" 
                            class="flex-1 luxury-btn py-3 rounded-xl font-bold">
                        ‰øùÂ≠ò
                    </button>
                    <button onclick="closeEditCheckoutModal()" 
                            class="flex-1 bg-gray-700 text-white py-3 rounded-xl font-bold">
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
    const existing = document.getElementById('editCheckoutModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Ê≥®ÊñáË°å„ÇíËøΩÂä†
function addEditOrderRow(historyIndex) {
    const container = document.getElementById('editOrdersList');
    if (!container) return;
    
    const idx = container.querySelectorAll('.flex.items-center').length;
    const newRow = document.createElement('div');
    newRow.className = 'flex items-center gap-2 py-2 border-b border-gray-700';
    newRow.innerHTML = `
        <input type="text" id="editOrderName_${idx}" value="" 
               class="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm"
               placeholder="ÂìÅÂêç">
        <input type="number" id="editOrderQty_${idx}" value="1" min="0"
               class="w-16 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm text-center">
        <input type="number" id="editOrderPrice_${idx}" value="0" 
               class="w-24 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm text-right">
    `;
    container.appendChild(newRow);
}

function closeEditCheckoutModal() {
    const modal = document.getElementById('editCheckoutModal');
    if (modal) modal.remove();
}

function saveEditCheckout(historyIndex) {
    const session = appState.checkoutHistory[historyIndex];
    if (!session) return;
    
    const newGuests = parseInt(document.getElementById('editGuests').value) || 0;
    const newTaxRate = parseInt(document.getElementById('editTaxRate').value) || 20;
    const newCastName = document.getElementById('editCastName').value || '';
    const newShimeiCasts = document.getElementById('editShimeiCasts').value || '';
    const newCatchStaff = document.getElementById('editCatchStaff').value || '';
    
    // Ê≥®ÊñáÊòéÁ¥∞„ÇíÂèéÈõÜ
    const orderRows = document.querySelectorAll('#editOrdersList .flex.items-center');
    const newOrders = [];
    let subtotal = 0;
    
    orderRows.forEach((row, idx) => {
        const name = document.getElementById(`editOrderName_${idx}`)?.value || '';
        const qty = parseInt(document.getElementById(`editOrderQty_${idx}`)?.value) || 0;
        const price = parseInt(document.getElementById(`editOrderPrice_${idx}`)?.value) || 0;
        
        if (name && qty > 0) {
            newOrders.push({
                item_name: name,
                quantity: qty,
                price: price
            });
            subtotal += price * qty;
        }
    });
    
    // TAX„ÇíË®àÁÆó
    const taxAmount = Math.floor(subtotal * (newTaxRate / 100));
    const newTotal = subtotal + taxAmount;
    
    // Êõ¥Êñ∞
    session.guests = newGuests;
    session.taxRate = newTaxRate;
    session.tax_rate = newTaxRate;
    session.castName = newCastName;
    session.cast_name = newCastName;
    session.shimei_casts = newShimeiCasts;
    session.catchStaff = newCatchStaff;
    session.catch_staff = newCatchStaff;
    session.orders = newOrders;
    session.totalAmount = newTotal;
    session.currentTotal = newTotal;
    session.current_total = newTotal;
    
    // localStorage„Å´‰øùÂ≠ò
    try {
        localStorage.setItem('cabax_checkoutHistory', JSON.stringify(appState.checkoutHistory));
    } catch (e) {
        console.warn('localStorage‰øùÂ≠òÂ§±Êïó:', e);
    }
    
    closeEditCheckoutModal();
    renderCheckoutHistory();
    
    // Êó•Â†±„ÇÇÊõ¥Êñ∞
    if (typeof renderDailyReport === 'function') renderDailyReport();
    
    showNotification('‰ºöË®àÊÉÖÂ†±„Çí‰øÆÊ≠£„Åó„Åæ„Åó„Åü', 'success');
}

// Êó•Â†±Ê©üËÉΩ
function renderDailyReport() {
    console.log('[renderDailyReport] start');

    const container = document.getElementById('dailyReportContent');
    console.log('[renderDailyReport] container =', container);
    if (!container) return;

    try {
        // ‚òÖ „Åì„Åì„Çí‰øÆÊ≠£
        // const app = window.appState || {};
        const app = (typeof appState !== 'undefined' && appState) ? appState : {};

        const activeSessions  = Array.isArray(app.activeSessions)  ? app.activeSessions  : [];
        const checkoutHistory = Array.isArray(app.checkoutHistory) ? app.checkoutHistory : [];
        const allSessions     = activeSessions.concat(checkoutHistory);

        console.log('[renderDailyReport] sessions', {
            active: activeSessions.length,
            history: checkoutHistory.length,
            all: allSessions.length
        });
        console.log('[renderDailyReport] sample session 0', allSessions[0]);
        console.log('[renderDailyReport] sample session 1', allSessions[1]);

        const casts        = Array.isArray(app.casts)        ? app.casts        : [];
        const attendances  = Array.isArray(app.attendances)  ? app.attendances  : [];
        const today        = new Date().toISOString().split('T')[0];

        // ===== „Çª„ÉÉ„Ç∑„Éß„É≥1‰ª∂„ÅÇ„Åü„Çä„ÅÆÂ£≤‰∏ä„ÇíÂèñ„Çã„Éò„É´„Éë„Éº =====
        function getSessionTotal(session) {
            if (!session) return 0;

            const candidates = [
                session.currentTotal,
                session.totalAmount,
                session.total,
                session.subtotal,
                session.grandTotal,
                session.totalWithTax
            ];

            for (const v of candidates) {
                if (typeof v === 'number' && !isNaN(v)) return v;
                if (typeof v === 'string' && v.trim() !== '' && !isNaN(Number(v))) {
                    return Number(v);
                }
            }

            // „Åù„Çå„Åß„ÇÇÁÑ°„Åë„Çå„Å∞ orders „Åã„ÇâÂêàË®à
            if (Array.isArray(session.orders)) {
                return session.orders.reduce((sum, o) => {
                    const price = Number(o?.price) || 0;
                    const qty   = Number(o?.quantity) || 0;
                    return sum + price * qty;
                }, 0);
            }

            return 0;
        }

        // ===== Êó•Ê¨°Â£≤‰∏äÈõÜË®à =====
        const totalSales = allSessions.reduce((sum, s) => {
            return sum + getSessionTotal(s);
        }, 0);

        const totalCustomers = allSessions.length;
        const averageSpend   = totalCustomers > 0
            ? Math.floor(totalSales / totalCustomers)
            : 0;

        const totalOrdersAmount = allSessions.reduce((sum, s) => {
            if (!s || !Array.isArray(s.orders)) return sum;
            const orderTotal = s.orders.reduce((os, o) => {
                const price = Number(o?.price) || 0;
                const qty   = Number(o?.quantity) || 0;
                return os + price * qty;
            }, 0);
            return sum + orderTotal;
        }, 0);
        console.log('[renderDailyReport] totalOrdersAmount =', totalOrdersAmount);

        // ===== ÈÖíÈ°ûÂéü‰æ°Ë®àÁÆóÔºà„É°„Éã„É•„Éº„ÅÆÂéü‰æ°„Åã„ÇâË®àÁÆóÔºâ=====
        const menuItems = Array.isArray(app.menuItems) ? app.menuItems : [];
        let totalCost = 0;
        let totalGuestCount = 0;
        
        allSessions.forEach(session => {
            // Êù•ÂÆ¢Êï∞„ÇíÈõÜË®à
            totalGuestCount += Number(session.guests) || 0;
            
            if (Array.isArray(session.orders)) {
                session.orders.forEach(order => {
                    // „É°„Éã„É•„Éº„Ç¢„Ç§„ÉÜ„É†„ÇíÊé¢„Åô
                    const menuItem = menuItems.find(m => 
                        m.name === order.item_name || 
                        m.id === order.menu_item_id
                    );
                    
                    if (menuItem && menuItem.cost > 0) {
                        // Âéü‰æ°„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
                        totalCost += (menuItem.cost || 0) * (order.quantity || 1);
                    }
                });
            }
        });
        
        // „Çπ„Çø„ÉÉ„Éï‰∫∫‰ª∂Ë≤ª„ÇíÂèñÂæó
        const staffAttendances = Array.isArray(app.staffAttendances) ? app.staffAttendances : [];
        const todayStaffCost = staffAttendances.reduce((sum, att) => sum + (att.daily_wage || 0), 0);
        
        // ===== „Ç≠„É£„Çπ„Éà„Éê„ÉÉ„ÇØË®àÁÆó =====
        let companionBackTotal = 0;
        let nominationBackTotal = 0;
        let drinkBackTotal = 0;
        let salesBackTotal = 0;
        
        // „Ç≠„É£„Çπ„Éà„Åî„Å®„ÅÆÂ£≤‰∏ä„ÇíÈõÜË®à
        const castSales = {};
        allSessions.forEach(session => {
            if (!session) return;
            const castName = session.castName || session.cast_name;
            if (castName) {
                if (!castSales[castName]) castSales[castName] = 0;
                castSales[castName] += getSessionTotal(session);
            }
            
            // Âêå‰º¥„Éê„ÉÉ„ÇØ
            if (session.hasCompanion && session.companionName) {
                const cast = casts.find(c => c.name === session.companionName || c.stage_name === session.companionName);
                if (cast) {
                    companionBackTotal += cast.companionBack ?? cast.companion_back ?? 3000;
                }
            }
            
            // ÊåáÂêç„Éê„ÉÉ„ÇØ
            if (session.nomination && session.nomination.type) {
                const castName = session.castName || session.cast_name;
                const cast = casts.find(c => c.name === castName || c.stage_name === castName);
                if (cast) {
                    nominationBackTotal += cast.nominationBack ?? cast.nomination_back ?? 1000;
                }
            }
            
            // „Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØ
            if (Array.isArray(session.orders)) {
                session.orders.forEach(order => {
                    if (order.isDrinkBack && order.castName) {
                        const cast = casts.find(c => c.name === order.castName || c.stage_name === order.castName);
                        if (cast) {
                            const rate = cast.drinkBackRate ?? cast.drink_back_rate ?? 10;
                            drinkBackTotal += Math.floor((order.price || 0) * (order.quantity || 1) * rate / 100);
                        }
                    }
                });
            }
        });
        
        // Â£≤‰∏ä„Éê„ÉÉ„ÇØ
        Object.entries(castSales).forEach(([castName, sales]) => {
            const cast = casts.find(c => c.name === castName || c.stage_name === castName);
            if (cast) {
                const rate = cast.salesBackRate ?? cast.sales_back_rate ?? 0;
                salesBackTotal += Math.floor(sales * rate / 100);
            }
        });
        
        const castPayrollTotal = companionBackTotal + nominationBackTotal + drinkBackTotal + salesBackTotal;
        
        // Á≤óÂà© = Â£≤‰∏ä - ÈÖíÈ°ûÂéü‰æ° - „Çπ„Çø„ÉÉ„Éï‰∫∫‰ª∂Ë≤ª - „Ç≠„É£„Çπ„Éà„Éê„ÉÉ„ÇØ
        const grossProfit = totalSales - totalCost - todayStaffCost - castPayrollTotal;
        
        // ÂÆ¢Âçò‰æ° = Â£≤‰∏äÂêàË®à √∑ Êù•ÂÆ¢Êï∞Ôºà‰∫∫Êï∞„ÅÆÂêàË®àÔºâ
        const avgSpendPerPerson = totalGuestCount > 0 
            ? Math.floor(totalSales / totalGuestCount) 
            : 0;

        // ===== ÊåáÂêç„ÉªÂêå‰º¥„ÉªÂª∂Èï∑ÈõÜË®à =====
        const companionCount = allSessions.filter(s => s && s.hasCompanion).length;
        const mainNominationCount = allSessions.filter(
            s => s && s.nomination && s.nomination.type === 'main'
        ).length;
        const inHouseNominationCount = allSessions.filter(
            s => s && s.nomination && s.nomination.type === 'in-house'
        ).length;
        const totalNominations = mainNominationCount + inHouseNominationCount;

        const totalExtensions = allSessions.reduce((sum, s) => {
            const v = s && s.extensionCount ? Number(s.extensionCount) : 0;
            return sum + (isNaN(v) ? 0 : v);
        }, 0);

        // ===== „Ç≠„É£„Çπ„ÉàÂà•ÈõÜË®à =====
        const castData = {};

        allSessions.forEach(session => {
            if (!session) return;
            const castName = session.castName || 'Êú™Ë®≠ÂÆö';

            if (!castData[castName]) {
                const cast = casts.find(c => c && c.name === castName);
                const attendance = attendances.find(
                    a => a && a.castName === castName && a.date === today
                );

                const hourlyRate = cast && typeof cast.hourlyRate === 'number'
                    ? cast.hourlyRate
                    : 0;

                castData[castName] = {
                    name: castName,
                    hourlyRate,
                    clockIn:  attendance?.clockIn || '-',
                    clockOut: attendance?.clockOut || '-',
                    mainNominations: 0,
                    inHouseNominations: 0,
                    companions: 0,
                    companionNames: [],
                    extensions: 0,
                    drinkCount: 0,
                    bottles: [],
                    totalSales: 0,
                    personalBack: 0
                };
            }

            const cd = castData[castName];

            // ÊåáÂêç
            if (session.nomination) {
                if (session.nomination.type === 'main') {
                    cd.mainNominations++;
                } else if (session.nomination.type === 'in-house') {
                    cd.inHouseNominations++;
                }
            }

            // Âêå‰º¥
            if (session.hasCompanion) {
                cd.companions++;
                if (session.companionName) {
                    cd.companionNames.push(session.companionName);
                }
            }

            // Âª∂Èï∑
            const ext = session.extensionCount ? Number(session.extensionCount) : 0;
            cd.extensions += isNaN(ext) ? 0 : ext;

            // Ê≥®Êñá
            if (Array.isArray(session.orders)) {
                session.orders.forEach(order => {
                    if (!order) return;
                    const price = Number(order.price) || 0;
                    const qty   = Number(order.quantity) || 0;

                    if (order.isDrinkBack && order.castName === castName) {
                        cd.drinkCount += qty;
                        cd.personalBack += Math.floor(price * qty * 0.6);
                    }

                    if (order.category === 'bottle') {
                        cd.bottles.push({
                            name: order.itemName || '',
                            price,
                            quantity: qty
                        });
                    }
                });
            }

            cd.totalSales += getSessionTotal(session);
        });

        const castDataArray = Object.values(castData).sort(
            (a, b) => Number(b.totalSales) - Number(a.totalSales)
        );
        console.log('[renderDailyReport] castDataArray length =', castDataArray.length);

        // ===== ÊèèÁîª =====
        const content = `
            <div class="space-y-6">
                <!-- Êó•Ê¨°„Çµ„Éû„É™„Éº -->
                <div class="luxury-card rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-6 gold-accent">Êó•Ê¨°Â£≤‰∏ä„Çµ„Éû„É™„Éº</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">Á∑èÂ£≤‰∏ä</p>
                            <p class="text-2xl font-bold gold-accent">
                                ¬•${Number(totalSales).toLocaleString()}
                            </p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">Á≤óÂà©</p>
                            <p class="text-2xl font-bold text-green-400">
                                ¬•${Number(grossProfit).toLocaleString()}
                            </p>
                            <p class="text-xs text-gray-500">Âéü‰æ°: ¬•${Number(totalCost).toLocaleString()} / ‰∫∫‰ª∂Ë≤ª: ¬•${Number(todayStaffCost).toLocaleString()} / „Ç≠„É£„Çπ„Éà: ¬•${Number(castPayrollTotal).toLocaleString()}</p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">ÂÆ¢Âçò‰æ°Ôºà‰∫∫Ôºâ</p>
                            <p class="text-2xl font-bold text-blue-300">
                                ¬•${Number(avgSpendPerPerson).toLocaleString()}
                            </p>
                            <p class="text-xs text-gray-500">Êù•ÂÆ¢Êï∞: ${totalGuestCount}Âêç</p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">Êù•Â∫óÁµÑÊï∞</p>
                            <p class="text-2xl font-bold text-gray-200">
                                ${totalCustomers}ÁµÑ
                            </p>
                        </div>
                    </div>
                    
                    <!-- „Ç≠„É£„Çπ„Éà„Éê„ÉÉ„ÇØÂÜÖË®≥ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                        <div class="bg-amber-900/30 rounded-xl p-4 border border-amber-700/30">
                            <p class="text-sm text-amber-400 mb-1">üí∞ Âêå‰º¥„Éê„ÉÉ„ÇØ</p>
                            <p class="text-xl font-bold text-amber-300">
                                ¬•${Number(companionBackTotal).toLocaleString()}
                            </p>
                        </div>
                        <div class="bg-purple-900/30 rounded-xl p-4 border border-purple-700/30">
                            <p class="text-sm text-purple-400 mb-1">üíé ÊåáÂêç„Éê„ÉÉ„ÇØ</p>
                            <p class="text-xl font-bold text-purple-300">
                                ¬•${Number(nominationBackTotal).toLocaleString()}
                            </p>
                        </div>
                        <div class="bg-blue-900/30 rounded-xl p-4 border border-blue-700/30">
                            <p class="text-sm text-blue-400 mb-1">üç∏ „Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØ</p>
                            <p class="text-xl font-bold text-blue-300">
                                ¬•${Number(drinkBackTotal).toLocaleString()}
                            </p>
                        </div>
                        <div class="bg-green-900/30 rounded-xl p-4 border border-green-700/30">
                            <p class="text-sm text-green-400 mb-1">üìà Â£≤‰∏ä„Éê„ÉÉ„ÇØ</p>
                            <p class="text-xl font-bold text-green-300">
                                ¬•${Number(salesBackTotal).toLocaleString()}
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">ÊåáÂêçÁ∑èÊï∞</p>
                            <p class="text-xl font-bold text-purple-300">
                                ${totalNominations}Êú¨
                            </p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">Êú¨ÊåáÂêç</p>
                            <p class="text-xl font-bold text-purple-400">
                                ${mainNominationCount}Êú¨
                            </p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">Â†¥ÂÜÖÊåáÂêç</p>
                            <p class="text-xl font-bold text-purple-300">
                                ${inHouseNominationCount}Êú¨
                            </p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">Âêå‰º¥</p>
                            <p class="text-xl font-bold text-pink-400">
                                ${companionCount}ÁµÑ
                            </p>
                        </div>
                    </div>

                    <div class="mt-4 bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">Âª∂Èï∑Á∑èÊï∞</p>
                        <p class="text-xl font-bold text-yellow-400">
                            ${totalExtensions}Êú¨
                        </p>
                    </div>
                </div>

                <!-- „Ç≠„É£„Çπ„ÉàÂà•Â£≤‰∏ä„É©„É≥„Ç≠„É≥„Ç∞ -->
                <div class="luxury-card rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-6 gold-accent">
                        „Ç≠„É£„Çπ„ÉàÂà•Â£≤‰∏ä„É©„É≥„Ç≠„É≥„Ç∞
                    </h2>
                    <div class="space-y-4">
                        ${castDataArray.map((cast, index) => `
                            <div class="bg-gray-800/50 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">
                                            ${
                                                index === 0 ? 'ü•á'
                                                : index === 1 ? 'ü•à'
                                                : index === 2 ? 'ü•â'
                                                : `${index + 1}‰Ωç`
                                            }
                                        </span>
                                        <span class="text-xl font-bold text-gray-200">
                                            ${cast.name}
                                        </span>
                                    </div>
                                    <span class="text-2xl font-bold gold-accent">
                                        ¬•${Number(cast.totalSales).toLocaleString()}
                                    </span>
                                </div>
                                <div class="text-xs text-gray-400">
                                    ÂÄã‰∫∫„Éê„ÉÉ„ÇØ: ¬•${Number(cast.personalBack).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = content;
        console.log('[renderDailyReport] finished');
    } catch (e) {
        console.error('[renderDailyReport] error', e);
        container.innerHTML = `
            <div style="color:#fff; padding:16px;">
                Êó•Â†±„ÅÆÁîüÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„ÅüÔºö${e.message}
            </div>
        `;
    }
}

// ===== ÊúàÂ†±Ê©üËÉΩ =====
let currentReportMode = 'daily';

function switchReportMode(mode) {
    currentReportMode = mode;
    const btnDaily = document.getElementById('btnDailyReport');
    const btnMonthly = document.getElementById('btnMonthlyReport');
    const monthSelector = document.getElementById('monthSelector');
    const dailyContent = document.getElementById('dailyReportContent');
    const monthlyContent = document.getElementById('monthlyReportContent');
    
    if (mode === 'daily') {
        btnDaily.classList.add('bg-amber-500', 'text-black');
        btnDaily.classList.remove('text-gray-400');
        btnMonthly.classList.remove('bg-amber-500', 'text-black');
        btnMonthly.classList.add('text-gray-400');
        monthSelector.classList.add('hidden');
        dailyContent.classList.remove('hidden');
        monthlyContent.classList.add('hidden');
        renderDailyReport();
    } else {
        btnMonthly.classList.add('bg-amber-500', 'text-black');
        btnMonthly.classList.remove('text-gray-400');
        btnDaily.classList.remove('bg-amber-500', 'text-black');
        btnDaily.classList.add('text-gray-400');
        monthSelector.classList.remove('hidden');
        dailyContent.classList.add('hidden');
        monthlyContent.classList.remove('hidden');
        initMonthSelector();
        loadMonthlyReport();
    }
}

function initMonthSelector() {
    const yearSelect = document.getElementById('reportYear');
    const monthSelect = document.getElementById('reportMonth');
    const now = new Date();
    
    // Âπ¥ÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºàÁèæÂú®Âπ¥„Åã„ÇâÈÅéÂéª3Âπ¥Ôºâ
    if (yearSelect.options.length === 0) {
        for (let y = now.getFullYear(); y >= now.getFullYear() - 3; y--) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = `${y}Âπ¥`;
            yearSelect.appendChild(opt);
        }
    }
    
    // ÁèæÂú®„ÅÆÊúà„ÇíÈÅ∏Êäû
    monthSelect.value = now.getMonth() + 1;
}

async function loadMonthlyReport() {
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;
    const container = document.getElementById('monthlyReportContent');
    
    container.innerHTML = '<div class="text-center py-8 text-gray-400">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
    
    try {
        let data;
        if (appState.apiConnected) {
            data = await apiRequest(`/monthly-report?year=${year}&month=${month}`);
        } else {
            // „Éá„É¢„Éá„Éº„Çø
            data = generateDemoMonthlyReport(parseInt(year), parseInt(month));
        }
        renderMonthlyReport(data);
    } catch (e) {
        console.error('ÊúàÂ†±Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
        container.innerHTML = `<div class="text-red-400 py-8">ÊúàÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${e.message}</div>`;
    }
}

function generateDemoMonthlyReport(year, month) {
    const daysInMonth = new Date(year, month, 0).getDate();
    const dailySales = [];
    let totalSales = 0;
    
    for (let d = 1; d <= daysInMonth; d++) {
        const sales = Math.floor(Math.random() * 200000) + 50000;
        totalSales += sales;
        dailySales.push({
            date: `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`,
            sales: sales
        });
    }
    
    return {
        year, month,
        period: `${year}Âπ¥${month}Êúà`,
        session_count: Math.floor(Math.random() * 100) + 50,
        total_guests: Math.floor(Math.random() * 300) + 100,
        total_sales: totalSales,
        total_cost: Math.floor(totalSales * 0.25),
        companion_count: Math.floor(Math.random() * 30) + 10,
        nomination_count: Math.floor(Math.random() * 50) + 20,
        extension_count: Math.floor(Math.random() * 40) + 15,
        cast_payroll: {
            companion_back: Math.floor(Math.random() * 100000) + 30000,
            nomination_back: Math.floor(Math.random() * 80000) + 20000,
            drink_back: Math.floor(Math.random() * 150000) + 50000,
            sales_back: Math.floor(Math.random() * 50000) + 10000,
            total: 0
        },
        staff_cost: Math.floor(Math.random() * 200000) + 100000,
        gross_profit: 0,
        gross_profit_rate: 0,
        avg_per_group: Math.floor(totalSales / 80),
        avg_per_person: Math.floor(totalSales / 200),
        daily_sales: dailySales,
        cast_ranking: [
            { name: '„Çä„Åä', sales: 850000, nominations: 25, companions: 12, drink_count: 45 },
            { name: '„Çå„Å™', sales: 720000, nominations: 20, companions: 8, drink_count: 38 },
            { name: '„Åã„Å™', sales: 650000, nominations: 18, companions: 10, drink_count: 32 },
            { name: '„ÅÇ„ÅÑ„Çä', sales: 480000, nominations: 12, companions: 5, drink_count: 28 },
            { name: '„Åø„ÇÜ', sales: 420000, nominations: 10, companions: 4, drink_count: 22 }
        ]
    };
}

function renderMonthlyReport(data) {
    const container = document.getElementById('monthlyReportContent');
    
    // Á≤óÂà©Ë®àÁÆóÔºàAPI„Åã„ÇâÊù•„Å™„ÅÑÂ†¥ÂêàÔºâ
    const castPayrollTotal = data.cast_payroll?.total || 
        (data.cast_payroll?.companion_back || 0) + 
        (data.cast_payroll?.nomination_back || 0) + 
        (data.cast_payroll?.drink_back || 0) + 
        (data.cast_payroll?.sales_back || 0);
    
    const grossProfit = data.gross_profit || 
        (data.total_sales - (data.total_cost || 0) - castPayrollTotal - (data.staff_cost || 0));
    
    const grossProfitRate = data.total_sales > 0 ? 
        Math.round(grossProfit / data.total_sales * 100) : 0;
    
    // Êó•Âà•Â£≤‰∏ä„ÅÆÊúÄÂ§ßÂÄ§Ôºà„Ç∞„É©„ÉïÁî®Ôºâ
    const maxDailySales = Math.max(...(data.daily_sales || []).map(d => d.sales), 1);
    
    const content = `
        <div class="space-y-6">
            <!-- ÊúàÊ¨°„Çµ„Éû„É™„Éº -->
            <div class="luxury-card rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-6 gold-accent">${data.period} ÊúàÊ¨°„Çµ„Éû„É™„Éº</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">ÊúàÈñìÂ£≤‰∏ä</p>
                        <p class="text-2xl font-bold gold-accent">
                            ¬•${Number(data.total_sales).toLocaleString()}
                        </p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">Á≤óÂà©</p>
                        <p class="text-2xl font-bold text-green-400">
                            ¬•${Number(grossProfit).toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">Á≤óÂà©Áéá ${grossProfitRate}%</p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">Êù•ÂÆ¢Êï∞</p>
                        <p class="text-2xl font-bold text-blue-300">
                            ${data.session_count}ÁµÑ / ${data.total_guests}Âêç
                        </p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">ÂÆ¢Âçò‰æ°</p>
                        <p class="text-2xl font-bold text-gray-200">
                            ¬•${Number(data.avg_per_person || 0).toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">ÁµÑÂçò‰æ°: ¬•${Number(data.avg_per_group || 0).toLocaleString()}</p>
                    </div>
                </div>
                
                <!-- „Ç≠„É£„Çπ„Éà„Éê„ÉÉ„ÇØÂÜÖË®≥ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <div class="bg-amber-900/30 rounded-xl p-4 border border-amber-700/30">
                        <p class="text-sm text-amber-400 mb-1">üí∞ Âêå‰º¥„Éê„ÉÉ„ÇØ</p>
                        <p class="text-xl font-bold text-amber-300">
                            ¬•${Number(data.cast_payroll?.companion_back || 0).toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">${data.companion_count}Âõû</p>
                    </div>
                    <div class="bg-purple-900/30 rounded-xl p-4 border border-purple-700/30">
                        <p class="text-sm text-purple-400 mb-1">üíé ÊåáÂêç„Éê„ÉÉ„ÇØ</p>
                        <p class="text-xl font-bold text-purple-300">
                            ¬•${Number(data.cast_payroll?.nomination_back || 0).toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">${data.nomination_count}Âõû</p>
                    </div>
                    <div class="bg-blue-900/30 rounded-xl p-4 border border-blue-700/30">
                        <p class="text-sm text-blue-400 mb-1">üç∏ „Éâ„É™„É≥„ÇØ„Éê„ÉÉ„ÇØ</p>
                        <p class="text-xl font-bold text-blue-300">
                            ¬•${Number(data.cast_payroll?.drink_back || 0).toLocaleString()}
                        </p>
                    </div>
                    <div class="bg-green-900/30 rounded-xl p-4 border border-green-700/30">
                        <p class="text-sm text-green-400 mb-1">üìà Â£≤‰∏ä„Éê„ÉÉ„ÇØ</p>
                        <p class="text-xl font-bold text-green-300">
                            ¬•${Number(data.cast_payroll?.sales_back || 0).toLocaleString()}
                        </p>
                    </div>
                </div>
                
                <!-- „Ç≥„Çπ„ÉàÂÜÖË®≥ -->
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">Âéü‰æ°</p>
                        <p class="text-xl font-bold text-red-400">
                            ¬•${Number(data.total_cost || 0).toLocaleString()}
                        </p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">„Ç≠„É£„Çπ„Éà„Éê„ÉÉ„ÇØË®à</p>
                        <p class="text-xl font-bold text-orange-400">
                            ¬•${Number(castPayrollTotal).toLocaleString()}
                        </p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">„Çπ„Çø„ÉÉ„Éï‰∫∫‰ª∂Ë≤ª</p>
                        <p class="text-xl font-bold text-yellow-400">
                            ¬•${Number(data.staff_cost || 0).toLocaleString()}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Êó•Âà•Â£≤‰∏ä„Ç∞„É©„Éï -->
            <div class="luxury-card rounded-xl p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-200">üìä Êó•Âà•Â£≤‰∏äÊé®Áßª</h3>
                <div class="overflow-x-auto">
                    <div class="flex items-end gap-1 h-48 min-w-max">
                        ${(data.daily_sales || []).map(d => {
                            const height = Math.max((d.sales / maxDailySales) * 100, 2);
                            const day = new Date(d.date).getDate();
                            return `
                                <div class="flex flex-col items-center">
                                    <div class="w-6 bg-gradient-to-t from-amber-600 to-amber-400 rounded-t transition-all hover:from-amber-500 hover:to-amber-300" 
                                         style="height: ${height}%" 
                                         title="${d.date}: ¬•${Number(d.sales).toLocaleString()}">
                                    </div>
                                    <span class="text-xs text-gray-500 mt-1">${day}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
            
            <!-- „Ç≠„É£„Çπ„Éà„É©„É≥„Ç≠„É≥„Ç∞ -->
            <div class="luxury-card rounded-xl p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-200">üèÜ „Ç≠„É£„Çπ„ÉàÊúàÈñì„É©„É≥„Ç≠„É≥„Ç∞</h3>
                <div class="space-y-4">
                    ${(data.cast_ranking || []).map((cast, index) => `
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">
                                        ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}‰Ωç`}
                                    </span>
                                    <span class="text-xl font-bold text-gray-200">${cast.name}</span>
                                </div>
                                <span class="text-2xl font-bold gold-accent">
                                    ¬•${Number(cast.sales).toLocaleString()}
                                </span>
                            </div>
                            <div class="flex gap-4 text-sm text-gray-400">
                                <span>üíé ÊåáÂêç ${cast.nominations}Âõû</span>
                                <span>üí∞ Âêå‰º¥ ${cast.companions}Âõû</span>
                                <span>üç∏ DB ${cast.drink_count}ÊùØ</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = content;
}


        function printFullDailyReport() {
            window.print();
        }

        // „É¨„Éù„Éº„Éà
        let salesTrendChart = null;
        let categorySalesChart = null;
        let hourlyChart = null;
        
        function renderReports() {
            const period = document.getElementById('reportPeriod')?.value || 'month';
            
            // „Éá„Éº„ÇøÈõÜË®à
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            const totalSales = allSessions.reduce((sum, s) => {
                const total = s.currentTotal || s.current_total || s.totalAmount || s.total_amount || 0;
                return sum + Number(total);
            }, 0);
            const totalCustomers = allSessions.length;
            const avgSpend = totalCustomers > 0 ? Math.floor(totalSales / totalCustomers) : 0;
            const grossProfit = Math.floor(totalSales * 0.6); // Á≤óÂà©Áéá60%
            
            // „Çµ„Éû„É™„ÉºÊõ¥Êñ∞
            document.getElementById('reportTotalSales').textContent = `¬•${totalSales.toLocaleString()}`;
            document.getElementById('reportTotalCustomers').textContent = `${totalCustomers}ÁµÑ`;
            document.getElementById('reportAvgSpend').textContent = `¬•${avgSpend.toLocaleString()}`;
            document.getElementById('reportGrossProfit').textContent = `¬•${grossProfit.toLocaleString()}`;
            
            // ÂâçÊúàÊØîÔºà„Éá„É¢Ôºâ
            document.getElementById('reportSalesChange').textContent = 'ÂâçÊúàÊØî +15.3%';
            document.getElementById('reportCustomersChange').textContent = 'ÂâçÊúàÊØî +8.5%';
            document.getElementById('reportAvgChange').textContent = 'ÂâçÊúàÊØî +6.2%';
            document.getElementById('reportProfitRate').textContent = 'Á≤óÂà©Áéá 60%';
            
            // „Ç∞„É©„ÉïÊèèÁîª
            renderSalesTrendChart(period);
            renderCategorySalesChart(allSessions);
            renderHourlyChart();
            renderCostRateList();
            renderCatchStaffTable(allSessions);
            renderTopProducts(allSessions);
        }
        
        function renderSalesTrendChart(period) {
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;
            
            // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„ÇíÁ†¥Ê£Ñ
            if (salesTrendChart) {
                salesTrendChart.destroy();
            }
            
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            let labels, data;
            
            if (period === 'today') {
                // ÊôÇÈñìÂ∏ØÂà•„ÅÆÂ£≤‰∏ä„ÇíË®àÁÆóÔºà20ÊôÇ„ÄúÁøå2ÊôÇÔºâ
                const hourlyData = {};
                const hours = ['20:00', '21:00', '22:00', '23:00', '24:00', '1:00', '2:00'];
                hours.forEach(h => hourlyData[h] = 0);
                
                allSessions.forEach(session => {
                    const checkoutTime = session.checkoutTime || session.checkout_time || session.startTime || session.start_time;
                    if (checkoutTime) {
                        const date = new Date(checkoutTime);
                        let hour = date.getHours();
                        // ÊôÇÈñìÂ∏Ø„ÇíÁâπÂÆö
                        let key = null;
                        if (hour >= 20) key = `${hour}:00`;
                        else if (hour === 0) key = '24:00';
                        else if (hour <= 2) key = `${hour}:00`;
                        
                        if (key && hourlyData.hasOwnProperty(key)) {
                            const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                            hourlyData[key] += Number(total);
                        }
                    }
                });
                
                // Á¥ØË®à„Å´Â§âÊèõ
                labels = hours;
                let cumulative = 0;
                data = hours.map(h => {
                    cumulative += hourlyData[h];
                    return cumulative;
                });
            } else if (period === 'week') {
                // ÊõúÊó•Âà•ÔºàÂÆü„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞0Ôºâ
                labels = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü', 'Êó•'];
                const dayData = [0, 0, 0, 0, 0, 0, 0];
                
                allSessions.forEach(session => {
                    const checkoutTime = session.checkoutTime || session.checkout_time;
                    if (checkoutTime) {
                        const date = new Date(checkoutTime);
                        const dayIndex = (date.getDay() + 6) % 7; // ÊúàÊõú=0
                        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                        dayData[dayIndex] += Number(total);
                    }
                });
                data = dayData;
            } else if (period === 'month') {
                labels = ['1ÈÄ±', '2ÈÄ±', '3ÈÄ±', '4ÈÄ±'];
                const weekData = [0, 0, 0, 0];
                
                allSessions.forEach(session => {
                    const checkoutTime = session.checkoutTime || session.checkout_time;
                    if (checkoutTime) {
                        const date = new Date(checkoutTime);
                        const weekIndex = Math.min(Math.floor((date.getDate() - 1) / 7), 3);
                        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                        weekData[weekIndex] += Number(total);
                    }
                });
                data = weekData;
            } else {
                labels = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
                const monthData = new Array(12).fill(0);
                
                allSessions.forEach(session => {
                    const checkoutTime = session.checkoutTime || session.checkout_time;
                    if (checkoutTime) {
                        const date = new Date(checkoutTime);
                        const monthIndex = date.getMonth();
                        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                        monthData[monthIndex] += Number(total);
                    }
                });
                data = monthData;
            }
            
            salesTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Â£≤‰∏ä',
                        data: data,
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#d4af37',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: 'rgba(212, 175, 55, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return '¬•' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return '¬•' + (value / 1000) + 'K';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        function renderCategorySalesChart(sessions) {
            const ctx = document.getElementById('categorySalesChart');
            if (!ctx) return;
            
            if (categorySalesChart) {
                categorySalesChart.destroy();
            }
            
            // 6„Ç´„ÉÜ„Ç¥„É™ÂØæÂøú
            const categoryTotals = {
                set: 0,
                bottle: 0,
                champagne: 0,
                wine: 0,
                drink: 0,
                food: 0
            };
            
            sessions.forEach(session => {
                if (session.orders) {
                    session.orders.forEach(order => {
                        const itemName = order.item_name || order.itemName || '';
                        const cat = normalizeCategory(order.category, itemName);
                        if (categoryTotals.hasOwnProperty(cat)) {
                            categoryTotals[cat] += (order.price || 0) * (order.quantity || 1);
                        }
                    });
                }
            });
            
            categorySalesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['„Çª„ÉÉ„Éà', '„Éú„Éà„É´', '„Ç∑„É£„É≥„Éë„É≥', '„ÉØ„Ç§„É≥', '„Éâ„É™„É≥„ÇØ', '„Éï„Éº„Éâ'],
                    datasets: [{
                        data: [
                            categoryTotals.set,
                            categoryTotals.bottle,
                            categoryTotals.champagne,
                            categoryTotals.wine,
                            categoryTotals.drink,
                            categoryTotals.food
                        ],
                        backgroundColor: [
                            'rgba(234, 179, 8, 0.8)',   // „Çª„ÉÉ„Éà - ÈªÑËâ≤
                            'rgba(147, 51, 234, 0.8)', // „Éú„Éà„É´ - Á¥´
                            'rgba(251, 191, 36, 0.8)', // „Ç∑„É£„É≥„Éë„É≥ - „Ç¥„Éº„É´„Éâ
                            'rgba(239, 68, 68, 0.8)',  // „ÉØ„Ç§„É≥ - Ëµ§
                            'rgba(59, 130, 246, 0.8)', // „Éâ„É™„É≥„ÇØ - Èùí
                            'rgba(34, 197, 94, 0.8)'   // „Éï„Éº„Éâ - Á∑ë
                        ],
                        borderColor: [
                            'rgba(234, 179, 8, 1)',
                            'rgba(147, 51, 234, 1)',
                            'rgba(251, 191, 36, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(34, 197, 94, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#9ca3af',
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: 'rgba(212, 175, 55, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return context.label + ': ¬•' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderHourlyChart() {
            const ctx = document.getElementById('hourlyChart');
            if (!ctx) return;
            
            if (hourlyChart) {
                hourlyChart.destroy();
            }
            
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            
            // ÊôÇÈñìÂ∏ØÂà•Â£≤‰∏ä„ÇíÈõÜË®àÔºà20ÊôÇ„ÄúÁøå5ÊôÇÔºâ
            const hours = ['20:00', '21:00', '22:00', '23:00', '24:00', '1:00', '2:00', '3:00', '4:00', '5:00'];
            const hourlyData = {};
            hours.forEach(h => hourlyData[h] = 0);
            
            allSessions.forEach(session => {
                const checkoutTime = session.checkoutTime || session.checkout_time || session.startTime || session.start_time;
                if (checkoutTime) {
                    const date = new Date(checkoutTime);
                    let hour = date.getHours();
                    let key = null;
                    
                    if (hour >= 20 && hour <= 23) {
                        key = `${hour}:00`;
                    } else if (hour === 0) {
                        key = '24:00';
                    } else if (hour >= 1 && hour <= 5) {
                        key = `${hour}:00`;
                    }
                    
                    if (key && hourlyData.hasOwnProperty(key)) {
                        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                        hourlyData[key] += Number(total);
                    }
                }
            });
            
            const salesData = hours.map(h => hourlyData[h]);
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Â£≤‰∏ä',
                        data: salesData,
                        backgroundColor: 'rgba(212, 175, 55, 0.8)',
                        borderColor: 'rgba(212, 175, 55, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: 'rgba(212, 175, 55, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return '¬•' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return '¬•' + (value / 1000) + 'K';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function renderCostRateList() {
            const container = document.getElementById('costRateList');
            if (!container) return;
            
            // 6„Ç´„ÉÜ„Ç¥„É™ÂØæÂøúÔºàÂéü‰æ°Áéá„ÅØ‰ªÆ„ÅÆÂÄ§Ôºâ
            const categories = [
                { name: '„Çª„ÉÉ„Éà', costRate: 20, color: 'bg-yellow-500' },
                { name: '„Éú„Éà„É´', costRate: 30, color: 'bg-purple-500' },
                { name: '„Ç∑„É£„É≥„Éë„É≥', costRate: 25, color: 'bg-amber-400' },
                { name: '„ÉØ„Ç§„É≥', costRate: 35, color: 'bg-red-500' },
                { name: '„Éâ„É™„É≥„ÇØ', costRate: 35, color: 'bg-blue-500' },
                { name: '„Éï„Éº„Éâ', costRate: 45, color: 'bg-green-500' }
            ];
            
            container.innerHTML = categories.map(cat => `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">${cat.name}</span>
                        <span class="font-semibold text-gray-200">${cat.costRate}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="${cat.color} h-2 rounded-full" style="width: ${cat.costRate}%"></div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderCatchStaffTable(sessions) {
            const tbody = document.getElementById('catchStaffTableBody');
            
            // „Ç≠„É£„ÉÉ„ÉÅ„Çπ„Çø„ÉÉ„ÉïÂà•ÈõÜË®à
            const staffMap = {};
            sessions.forEach(session => {
                const staff = session.catchStaff || 'Êú™Ë®≠ÂÆö';
                if (!staffMap[staff]) {
                    staffMap[staff] = {
                        name: staff,
                        count: 0,
                        totalSales: 0
                    };
                }
                staffMap[staff].count++;
                staffMap[staff].totalSales += session.currentTotal || session.totalAmount || 0;
            });
            
            const staffList = Object.values(staffMap).sort((a, b) => b.totalSales - a.totalSales);
            const totalSales = staffList.reduce((sum, s) => sum + s.totalSales, 0);
            
            if (staffList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-500">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
                return;
            }
            
            tbody.innerHTML = staffList.map((staff, index) => {
                const avgSpend = Math.floor(staff.totalSales / staff.count);
                const contribution = ((staff.totalSales / totalSales) * 100).toFixed(1);
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                return `
                    <tr class="border-b border-gray-800">
                        <td class="py-3 px-4 text-gray-300">${medal} ${staff.name}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${staff.count}ÁµÑ</td>
                        <td class="py-3 px-4 text-right font-bold gold-accent">¬•${staff.totalSales.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right text-gray-300">¬•${avgSpend.toLocaleString()}</td>
                        <td class="py-3 px-4 text-center text-blue-300">${contribution}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderTopProducts(sessions) {
            // ÂïÜÂìÅÂà•ÈõÜË®à
            const productMap = {};
            
            sessions.forEach(session => {
                if (session.orders) {
                    session.orders.forEach(order => {
                        const key = order.itemName;
                        const category = normalizeCategory(order.category) || 'drink';
                        
                        if (!productMap[key]) {
                            productMap[key] = {
                                name: order.itemName,
                                category: category,
                                quantity: 0,
                                totalSales: 0
                            };
                        }
                        productMap[key].quantity += order.quantity || 1;
                        productMap[key].totalSales += (order.price || 0) * (order.quantity || 1);
                    });
                }
            });
            
            const products = Object.values(productMap);
            
            // „Éú„Éà„É´„Éª„Ç∑„É£„É≥„Éë„É≥„Éª„ÉØ„Ç§„É≥„Çí„Åæ„Å®„ÇÅ„Å¶„Äå„Éú„Éà„É´Á≥ªTOP5„Äç
            const bottles = products
                .filter(p => ['bottle', 'champagne', 'wine'].includes(p.category))
                .sort((a, b) => b.totalSales - a.totalSales)
                .slice(0, 5);
            
            const drinks = products
                .filter(p => p.category === 'drink')
                .sort((a, b) => b.totalSales - a.totalSales)
                .slice(0, 5);
            
            const foods = products
                .filter(p => p.category === 'food')
                .sort((a, b) => b.totalSales - a.totalSales)
                .slice(0, 5);
            
            // „Éú„Éà„É´Á≥ªTOP5
            document.getElementById('topBottles').innerHTML = bottles.length > 0 
                ? bottles.map((p, i) => renderProductRank(p, i)).join('')
                : '<p class="text-gray-500 text-sm">„Éá„Éº„Çø„Å™„Åó</p>';
            
            // „Éâ„É™„É≥„ÇØTOP5
            document.getElementById('topDrinks').innerHTML = drinks.length > 0
                ? drinks.map((p, i) => renderProductRank(p, i)).join('')
                : '<p class="text-gray-500 text-sm">„Éá„Éº„Çø„Å™„Åó</p>';
            
            // „Éï„Éº„ÉâTOP5
            document.getElementById('topFoods').innerHTML = foods.length > 0
                ? foods.map((p, i) => renderProductRank(p, i)).join('')
                : '<p class="text-gray-500 text-sm">„Éá„Éº„Çø„Å™„Åó</p>';
        }
        
        function renderProductRank(product, index) {
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const rank = medals[index] || `${index + 1}‰Ωç`;
            
            return `
                <div class="flex justify-between items-center p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                    <div>
                        <p class="text-sm font-semibold text-gray-200">${rank} ${product.name}</p>
                        <p class="text-xs text-gray-400">${product.quantity}ÂÄã</p>
                    </div>
                    <p class="font-bold text-pink-300">¬•${product.totalSales.toLocaleString()}</p>
                </div>
            `;
        }
        
        function exportReportCSV() {
            showNotification('Â£≤‰∏ä„É¨„Éù„Éº„ÉàCSV„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü', 'success');
        }

        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊõ¥Êñ∞
        
        function updateDashboard() {
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            const totalSales = allSessions.reduce((sum, s) => {
                const total = s.currentTotal || s.current_total || s.totalAmount || s.total_amount || 0;
                return sum + Number(total);
            }, 0);
            const totalCustomers = allSessions.length;
            const workingCasts = (appState.attendances || []).filter(a => a.status === 'working').length;
            const averageSpend = totalCustomers > 0 ? Math.floor(totalSales / totalCustomers) : 0;
            
            document.getElementById('totalSales').textContent = `¬•${totalSales.toLocaleString()}`;
            document.getElementById('totalCustomers').textContent = `${totalCustomers}ÁµÑ`;
            document.getElementById('workingCasts').textContent = `${workingCasts}Âêç`;
            document.getElementById('averageSpend').textContent = `¬•${averageSpend.toLocaleString()}`;
            
            const activities = document.getElementById('recentActivities');
            activities.innerHTML = '<p class="text-sm text-gray-400">ÊúÄÊñ∞„ÅÆÊ¥ªÂãï„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</p>';
        }
let salesChartInstance = null;
// ‰ªñ„Å´„ÇÇ xxxChartInstance „ÅåÂá∫„Å¶„Åè„Çã„Å™„ÇâÂêå„Åò„Çà„ÅÜ„Å´Áî®ÊÑè
// ‰æã:
// let visitsChartInstance = null;
// let ordersChartInstance = null;

// „ÉÅ„É£„Éº„Éà„ÅØ‰∏ÄÊó¶„Ç™„Éï„Å´„Åó„Å¶„Åä„ÅèÔºàÂæå„ÅßÂæ©Ê¥ª„Åï„Åõ„ÇãÁî®Ôºâ
function setupCharts() {
    // TODO: „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÅÆ„ÉÅ„É£„Éº„Éà„ÇíÂæ©Ê¥ª„Åï„Åõ„Çã
}


        function printDailyReport() {
            showTab('daily-report');
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function exportCSV() {
            showNotification('CSV„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü', 'success');
        }

        // UIÈñ¢Êï∞
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            const navBtns = document.querySelectorAll(`.nav-btn, .bottom-nav-btn`);
            navBtns.forEach(btn => {
                if (btn.getAttribute('onclick')?.includes(tabName)) {
                    btn.classList.add('active');
                }
            });
            
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth < 768) {
                sidebar.classList.remove('active');
            }
            
            if (tabName === 'daily-report') {
                renderDailyReport();
            }
            
            // ‰ºöË®àÂ±•Ê≠¥„Çø„Éñ„ÇíÈñã„ÅÑ„Åü„ÇâÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„ÇÄ
            if (tabName === 'checkout-history') {
                renderCheckoutHistory();
            }
            
            // „Ç™„Éº„ÉÄ„ÉºÁÆ°ÁêÜ„Çø„Éñ„ÇíÈñã„ÅÑ„Åü„Çâ„Ç™„Éº„ÉÄ„Éº„ÇíË™≠„ÅøËæº„ÇÄ
            if (tabName === 'orders') {
                loadOrdersFromApi();
            }
            
            // Â∫óËàóË®≠ÂÆö„Çø„Éñ„ÇíÈñã„ÅÑ„Åü„Çâ„Çπ„Çø„ÉÉ„Éï„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„ÇÄ
            if (tabName === 'store-settings') {
                loadStaffList();
                loadStaffAttendances();
            }
        }

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-50 no-print`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ÂàùÊúüÂåñ
        window.addEventListener('DOMContentLoaded', () => {
            // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const isLoggedIn = sessionStorage.getItem('cabax_logged_in');
            if (isLoggedIn === 'true') {
                showMainApp();
                initializeApp();
            }
        });
    </script>

    <!-- ‰ºùÁ•®„É¢„Éº„ÉÄ„É´ -->
    <div id="receiptModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-auto">
            <div id="receiptContent" class="p-6 text-black">
                <!-- ‰ºùÁ•®ÂÜÖÂÆπ„Åå„Åì„Åì„Å´ÂÖ•„Çã -->
            </div>
            <div class="flex gap-2 p-4 border-t bg-gray-100 no-print">
                <button onclick="printReceipt()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">
                    üñ®Ô∏è Âç∞Âà∑
                </button>
                <button onclick="closeReceiptModal()" class="flex-1 bg-gray-600 text-white py-3 rounded-xl font-bold">
                    Èñâ„Åò„Çã
                </button>
            </div>
        </div>
    </div>

    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #receiptModal, #receiptModal * {
                visibility: visible;
            }
            #receiptModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
            }
            #receiptModal .no-print {
                display: none !important;
            }
            #receiptContent {
                padding: 10mm;
            }
        }
    </style>
</body>
</html>