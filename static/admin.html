<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cabax Admin Pro - Complete Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&display=swap');
        
        * { 
            font-family: 'Noto Serif JP', serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(214, 179, 106, 0.4);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(214, 179, 106, 0.6);
        }
        
        :root {
            --cabax-navy: #0b1628;
            --cabax-navy-light: #122040;
            --cabax-navy-dark: #070d18;
            --cabax-gold: #d6b36a;
            --cabax-gold-light: #e8d4a8;
            --cabax-text: #f0f4f8;
            --cabax-text-muted: #8896a8;
        }
        
        body { 
            background: linear-gradient(135deg, var(--cabax-navy-dark) 0%, var(--cabax-navy) 100%);
            color: var(--cabax-text);
            overflow-x: hidden;
        }
        
        .glass-effect {
            background: rgba(11, 22, 40, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(214, 179, 106, 0.15);
        }
        
        .gold-accent {
            background: linear-gradient(135deg, var(--cabax-gold) 0%, var(--cabax-gold-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .luxury-card {
            background: rgba(18, 32, 64, 0.6);
            border: 1px solid rgba(214, 179, 106, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .luxury-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.12);
            transform: translateY(-2px);
        }
        
        .luxury-btn {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .luxury-btn:active {
            transform: scale(0.98);
        }
        
        .luxury-btn:hover {
            box-shadow: 0 8px 24px rgba(214, 179, 106, 0.35);
            transform: translateY(-1px);
        }
        
        .sidebar-luxury {
            background: linear-gradient(180deg, rgba(7, 13, 24, 0.98) 0%, rgba(11, 22, 40, 0.98) 100%);
            border-right: 1px solid rgba(214, 179, 106, 0.15);
            backdrop-filter: blur(10px);
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(7, 13, 24, 0.98) 0%, rgba(11, 22, 40, 0.98) 100%);
            border-top: 1px solid rgba(214, 179, 106, 0.15);
            backdrop-filter: blur(20px);
            z-index: 50;
            padding: 8px 0;
            display: none;
        }
        
        @media (max-width: 768px) {
            .bottom-nav {
                display: block;
            }
            
            .sidebar-luxury {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar-luxury.active {
                transform: translateX(0);
            }
            
            .main-content {
                padding-bottom: 80px;
            }
        }
        
        .bottom-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            color: #9ca3af;
            border-radius: 12px;
            transition: all 0.2s;
        }
        
        .bottom-nav-btn.active {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }
        
        .nav-btn {
            transition: all 0.2s;
        }
        
        .nav-btn.active {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }
        
        .modal {
            display: none;
        }
        
        .modal.active {
            display: flex;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        input, select, textarea {
            background: rgba(42, 42, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f5f5f5;
        }
        
        /* selectã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ­£ã—ãè¡¨ç¤º */
        select {
            appearance: auto;
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            cursor: pointer;
        }
        
        select option {
            background: #1a1a1a;
            color: #f5f5f5;
            padding: 10px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
        }
        
        .table-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .table-card:hover {
            transform: scale(1.05);
        }
        
        .table-available {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .table-occupied {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .table-reserved {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
        }
        
        .cast-subtab-btn {
            background: rgba(42, 42, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #9ca3af;
        }
        
        .cast-subtab-btn.active {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.3);
            color: #d4af37;
        }
        
        .cast-subtab-content {
            display: none;
        }
        
        .cast-subtab-content.active {
            display: block;
        }
        
        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .image-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            background: rgba(42, 42, 42, 0.4);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .image-upload-area:hover {
            border-color: rgba(212, 175, 55, 0.5);
            background: rgba(42, 42, 42, 0.6);
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 1rem;
            border-radius: 12px;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: rgba(42, 42, 42, 0.4);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.3);
            border-radius: 4px;
        }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        @media (max-width: 640px) {
            .calendar-grid {
                gap: 4px;
            }
        }
        
        .calendar-cell {
            min-height: 80px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        @media (max-width: 640px) {
            .calendar-cell {
                min-height: 60px;
                padding: 4px;
            }
        }
        
        .calendar-cell:hover {
            background: rgba(212, 175, 55, 0.05);
        }
        
        .shift-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 6px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
        }
        
        @media (max-width: 640px) {
            .shift-badge {
                font-size: 0.6rem;
                padding: 2px 4px;
            }
        }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³ */
        .cast-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: #0a0a0a;
            text-transform: uppercase;
        }
        
        .cast-avatar-small {
            width: 48px;
            height: 48px;
            font-size: 18px;
        }
        
        .table-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            margin: 0 auto 1rem;
            background: rgba(42, 42, 42, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .table-icon.vip {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(244, 208, 63, 0.2) 100%);
            border: 2px solid rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        
        .table-icon.occupied {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }
        
        .table-icon.available {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.2) 100%);
            border: 2px solid rgba(34, 197, 94, 0.5);
        }
        
        .table-icon.reserved {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2) 0%, rgba(202, 138, 4, 0.2) 100%);
            border: 2px solid rgba(234, 179, 8, 0.5);
        }
        
        .icon-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .login-screen.hidden {
            display: none;
        }
        
        .login-box {
            width: 100%;
            max-width: 420px;
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 24px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        .login-logo h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .login-logo p {
            color: #9ca3af;
            font-size: 0.875rem;
        }
        
        .login-input {
            width: 100%;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            background: rgba(42, 42, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #f5f5f5;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .login-input:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
            background: rgba(42, 42, 42, 0.8);
        }
        
        .login-input::placeholder {
            color: #6b7280;
        }
        
        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.35);
            transform: translateY(-2px);
        }
        
        .login-btn:active {
            transform: scale(0.98);
        }
        
        .login-error {
            display: none;
            padding: 0.75rem;
            margin-bottom: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #ef4444;
            font-size: 0.875rem;
            text-align: center;
        }
        
        .login-error.active {
            display: block;
        }
        
        .demo-credentials {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(212, 175, 55, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 12px;
        }
        
        .demo-credentials p {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .demo-credentials code {
            color: #d4af37;
            font-size: 0.875rem;
            font-family: 'Courier New', monospace;
        }
        
        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ¶å¾¡ */
            .tab-content {
                display: none !important;
            }
            
            /* æ—¥å ±ã‚¿ãƒ–ã‚’å°åˆ·æ™‚ã«å¼·åˆ¶è¡¨ç¤º */
            #daily-report-tab {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            #dailyReportContent:not(.hidden),
            #monthlyReportContent:not(.hidden) {
                display: block !important;
                color: black !important;
            }
            
            #dailyReportContent.hidden,
            #monthlyReportContent.hidden {
                display: none !important;
            }
            
            #dailyReportContent *,
            #monthlyReportContent * {
                color: black !important;
                background: white !important;
                border-color: #ccc !important;
            }
            
            /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒŠãƒ“ã‚’éè¡¨ç¤º */
            #sidebar, .bottom-nav, nav, #loginScreen {
                display: none !important;
            }
            
            /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…¨å¹…ã« */
            .main-content {
                margin-left: 0 !important;
                padding: 20px !important;
                display: block !important;
            }
            
            .luxury-card {
                border: 1px solid #ccc !important;
                background: white !important;
                box-shadow: none !important;
            }
            
            .print-page-break {
                page-break-after: always;
            }
            
            /* ã‚°ãƒ©ãƒ•ãƒãƒ¼ã®è‰²ã‚’ç¶­æŒ */
            .bg-gradient-to-t {
                background: #f59e0b !important;
            }
            
            /* gold-accentã‚’é»’ã« */
            .gold-accent {
                color: black !important;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <h1>Cabax</h1>
                <p>Admin Pro - Complete Edition</p>
            </div>
            
            <div id="loginError" class="login-error">
                ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        class="login-input" 
                        placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
                        autocomplete="username"
                        required
                    >
                </div>
                <div>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="login-input" 
                        placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                        autocomplete="current-password"
                        required
                    >
                </div>
                <button type="submit" class="login-btn">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </form>
            
            <div class="demo-credentials">
                <p class="font-semibold mb-2 text-gray-300">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±</p>
                <p class="text-sm text-gray-400">åº—èˆ—ã«ç™ºè¡Œã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="min-h-screen" style="display: none;">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 sidebar-luxury no-print">
            <div class="flex h-full flex-col">
                <div class="flex h-24 items-center justify-between px-6 border-b border-gray-800">
                    <h1 class="text-3xl font-bold gold-accent tracking-tight">Cabax</h1>
                    <button onclick="toggleMobileSidebar()" class="md:hidden text-gray-400 text-2xl">âœ•</button>
                </div>
                
                <div class="border-b border-gray-800 p-6">
                    <p class="text-xs text-gray-500 uppercase tracking-widest mb-2">å–¶æ¥­æ—¥</p>
                    <p class="text-sm font-medium text-gray-300" id="businessDate"></p>
                </div>
                
                <nav class="flex-1 overflow-y-auto px-4 py-6 space-y-1">
                    <button onclick="showTab('dashboard')" class="nav-btn active w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸ“Š</span>
                        <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
                    </button>
                    <button onclick="showTab('tables')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸª‘</span>
                        <span>ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†</span>
                    </button>
                    <button onclick="showTab('orders')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸ½ï¸</span>
                        <span>ã‚ªãƒ¼ãƒ€ãƒ¼ç®¡ç†</span>
                    </button>
                    <button onclick="showTab('attendance')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">â°</span>
                        <span>å‹¤æ€ ç®¡ç†</span>
                    </button>
                    <button onclick="showTab('shifts')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸ“…</span>
                        <span>ã‚·ãƒ•ãƒˆç®¡ç†</span>
                    </button>
                    <button onclick="showTab('menu')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸ“œ</span>
                        <span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</span>
                    </button>
                    <button onclick="showTab('casts')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸ‘¥</span>
                        <span>ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</span>
                    </button>
                    <button onclick="showTab('checkout-history')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸ§¾</span>
                        <span>ä¼šè¨ˆå±¥æ­´</span>
                    </button>
                    <button onclick="showTab('daily-report')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸ“‹</span>
                        <span>æ—¥å ±</span>
                    </button>
                    <button onclick="showTab('store-settings')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">âš™ï¸</span>
                        <span>åº—èˆ—è¨­å®š</span>
                    </button>
                    <button onclick="showTab('reports')" class="nav-btn w-full flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm text-gray-300 hover:bg-gray-800/50 transition">
                        <span class="text-lg">ğŸ“ˆ</span>
                        <span>å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ</span>
                    </button>
                </nav>
                
                <div class="border-t border-gray-800 p-4 space-y-2">
                    <button id="soundToggleBtn" onclick="orderNotification.toggleSound()" class="w-full px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 text-sm">
                        ğŸ”” é€šçŸ¥éŸ³ON
                    </button>
                    <button onclick="logout()" class="w-full bg-red-900/20 text-red-400 border border-red-800/30 py-3.5 rounded-xl hover:bg-red-900/30 transition text-sm font-medium">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
        <button onclick="toggleMobileSidebar()" class="md:hidden fixed top-4 left-4 z-50 bg-gray-800/80 backdrop-blur-sm text-gray-300 p-3 rounded-xl no-print">
            â˜°
        </button>

        <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="bottom-nav no-print">
            <div class="grid grid-cols-4 gap-1 px-2">
                <button onclick="showTab('dashboard')" class="bottom-nav-btn active" data-tab="dashboard">
                    <span class="text-xl">ğŸ“Š</span>
                    <span class="text-xs">ãƒ€ãƒƒã‚·ãƒ¥</span>
                </button>
                <button onclick="showTab('tables')" class="bottom-nav-btn" data-tab="tables">
                    <span class="text-xl">ğŸª‘</span>
                    <span class="text-xs">ãƒ†ãƒ¼ãƒ–ãƒ«</span>
                </button>
                <button onclick="showTab('orders')" class="bottom-nav-btn" data-tab="orders">
                    <span class="text-xl">ğŸ½ï¸</span>
                    <span class="text-xs">ã‚ªãƒ¼ãƒ€ãƒ¼</span>
                </button>
                <button onclick="showTab('daily-report')" class="bottom-nav-btn" data-tab="daily-report">
                    <span class="text-xl">ğŸ“‹</span>
                    <span class="text-xs">æ—¥å ±</span>
                </button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="md:pl-72 min-h-screen main-content">
            <main class="p-4 md:p-10">
                
                <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
                <div id="dashboard-tab" class="tab-content active">
                    <div class="mb-8 md:mb-10">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-3 md:mb-4">Dashboard</h1>
                        <p class="text-gray-400 text-base md:text-lg mb-6 md:mb-8">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–¶æ¥­çŠ¶æ³</p>
                        <div class="flex flex-wrap gap-2 md:gap-3">
                            <button onclick="syncWithBackend()" class="luxury-btn px-6 md:px-8 py-3 md:py-3.5 rounded-xl text-sm">
                                ğŸ”„ APIåŒæœŸ
                            </button>
                            <button onclick="printDailyReport()" class="bg-gray-800 text-gray-300 px-6 md:px-8 py-3 md:py-3.5 rounded-xl hover:bg-gray-700 transition text-sm">
                                ğŸ–¨ï¸ æ—¥å ±å°åˆ·
                            </button>
                            <button onclick="exportCSV()" class="bg-gray-800 text-gray-300 px-6 md:px-8 py-3 md:py-3.5 rounded-xl hover:bg-gray-700 transition text-sm">
                                ğŸ“¥ CSVå‡ºåŠ›
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-8 md:mb-10">
                        <div class="luxury-card rounded-2xl p-4 md:p-8 shadow-xl">
                            <p class="text-xs md:text-sm text-gray-400 mb-2 md:mb-3 uppercase tracking-wide">æœ¬æ—¥ã®å£²ä¸Š</p>
                            <p class="text-2xl md:text-4xl font-bold gold-accent" id="totalSales">Â¥0</p>
                        </div>
                        <div class="luxury-card rounded-2xl p-4 md:p-8 shadow-xl">
                            <p class="text-xs md:text-sm text-gray-400 mb-2 md:mb-3 uppercase tracking-wide">æ¥åº—çµ„æ•°</p>
                            <p class="text-2xl md:text-4xl font-bold text-gray-200" id="totalCustomers">0çµ„</p>
                        </div>
                        <div class="luxury-card rounded-2xl p-4 md:p-8 shadow-xl">
                            <p class="text-xs md:text-sm text-gray-400 mb-2 md:mb-3 uppercase tracking-wide">å‡ºå‹¤ä¸­</p>
                            <p class="text-2xl md:text-4xl font-bold text-gray-200" id="workingCasts">0å</p>
                        </div>
                        <div class="luxury-card rounded-2xl p-4 md:p-8 shadow-xl">
                            <p class="text-xs md:text-sm text-gray-400 mb-2 md:mb-3 uppercase tracking-wide">å®¢å˜ä¾¡</p>
                            <p class="text-2xl md:text-4xl font-bold text-gray-200" id="averageSpend">Â¥0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                        <div class="luxury-card rounded-2xl p-6 md:p-8 shadow-xl">
                            <h3 class="text-lg md:text-xl font-semibold mb-4 md:mb-6 text-gray-200">æ™‚é–“å¸¯åˆ¥å£²ä¸Š</h3>
                            <canvas id="salesChart"></canvas>
                        </div>
                        <div class="luxury-card rounded-2xl p-6 md:p-8 shadow-xl">
                            <h3 class="text-lg md:text-xl font-semibold mb-4 md:mb-6 text-gray-200">æœ€è¿‘ã®æ´»å‹•</h3>
                            <div id="recentActivities" class="space-y-3 md:space-y-4"></div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div id="tables-tab" class="tab-content">
                    <div class="flex items-center justify-between mb-8 md:mb-10">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent">ãƒ†ãƒ¼ãƒ–ãƒ«</h1>
                        <button onclick="openTableSettingsModal()" class="luxury-btn px-4 py-2 rounded-xl text-sm flex items-center gap-2">
                            âš™ï¸ è¨­å®š
                        </button>
                    </div>

                    <div id="tablesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 md:gap-4">
                    </div>

                    <!-- â˜… ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ãƒ‘ãƒãƒ«ï¼ˆopenTableDetailãŒæ›¸ãæ›ãˆã‚‹ï¼‰ -->
                    <div id="tableDetailPanel" class="mt-6 hidden"></div>
                </div>

                <!-- ã‚ªãƒ¼ãƒ€ãƒ¼ç®¡ç†ã‚¿ãƒ– -->
                <div id="orders-tab" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent">ã‚ªãƒ¼ãƒ€ãƒ¼ç®¡ç†</h1>
                        <div class="flex gap-2">
                            <button onclick="filterOrders('all')" id="orderFilterAll" class="order-filter-btn active px-4 py-2 rounded-xl text-sm font-semibold bg-amber-600 text-white">
                                ã™ã¹ã¦
                            </button>
                            <button onclick="filterOrders('pending')" id="orderFilterPending" class="order-filter-btn px-4 py-2 rounded-xl text-sm font-semibold bg-gray-700 text-gray-300 hover:bg-gray-600">
                                â³ æœªæä¾›
                            </button>
                            <button onclick="filterOrders('served')" id="orderFilterServed" class="order-filter-btn px-4 py-2 rounded-xl text-sm font-semibold bg-gray-700 text-gray-300 hover:bg-gray-600">
                                âœ“ æä¾›æ¸ˆ
                            </button>
                            <button onclick="loadOrdersFromApi()" class="px-4 py-2 rounded-xl text-sm font-semibold bg-blue-600 text-white hover:bg-blue-500">
                                ğŸ”„ æ›´æ–°
                            </button>
                        </div>
                    </div>

                    <!-- æœªæä¾›ã‚ªãƒ¼ãƒ€ãƒ¼ã‚µãƒãƒªãƒ¼ -->
                    <div id="pendingOrdersSummary" class="mb-6 p-4 rounded-xl bg-red-900/20 border border-red-800/30 hidden">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âš ï¸</span>
                            <div>
                                <div class="text-lg font-bold text-red-400">æœªæä¾›ã‚ªãƒ¼ãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã™</div>
                                <div id="pendingOrdersCount" class="text-sm text-red-300"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚ªãƒ¼ãƒ€ãƒ¼ä¸€è¦§ -->
                    <div id="ordersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- ã‚ªãƒ¼ãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å…¥ã‚‹ -->
                    </div>

                    <div id="noOrdersMessage" class="hidden text-center py-12 text-gray-500">
                        <span class="text-5xl mb-4 block">ğŸ“­</span>
                        <p>ã‚ªãƒ¼ãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>


                <!-- å‹¤æ€ ç®¡ç†ã‚¿ãƒ– -->
                <div id="attendance-tab" class="tab-content">
                    <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-8 md:mb-10">å‹¤æ€ ç®¡ç†</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="luxury-card rounded-xl p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">å‡ºå‹¤æ‰“åˆ»</h3>
                            <select id="clockInCast" class="w-full px-4 py-3 rounded-xl mb-4 text-sm"></select>
                            <button onclick="clockIn()" class="w-full luxury-btn py-3 rounded-xl text-sm">å‡ºå‹¤</button>
                        </div>
                        <div class="luxury-card rounded-xl p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">é€€å‹¤æ‰“åˆ»</h3>
                            <select id="clockOutCast" class="w-full px-4 py-3 rounded-xl mb-4 text-sm"></select>
                            <button onclick="clockOut()" class="w-full bg-red-900/20 text-red-400 border border-red-800/30 py-3 rounded-xl hover:bg-red-900/30 transition text-sm">é€€å‹¤</button>
                        </div>
                    </div>

                    <div class="luxury-card rounded-xl p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-200">å‹¤æ€ å±¥æ­´</h3>
                            <button onclick="exportAttendanceCSV()" class="luxury-btn px-6 py-2 rounded-xl text-sm">CSVå‡ºåŠ›</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-700">
                                        <th class="text-left py-3 px-4 text-gray-400">æ—¥ä»˜</th>
                                        <th class="text-left py-3 px-4 text-gray-400">ã‚­ãƒ£ã‚¹ãƒˆ</th>
                                        <th class="text-center py-3 px-4 text-gray-400">å‡ºå‹¤</th>
                                        <th class="text-center py-3 px-4 text-gray-400">é€€å‹¤</th>
                                        <th class="text-center py-3 px-4 text-gray-400">å‹¤å‹™æ™‚é–“</th>
                                        <th class="text-center py-3 px-4 text-gray-400">çŠ¶æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ã‚·ãƒ•ãƒˆç®¡ç† -->
                <div id="shifts-tab" class="tab-content">
                    <div class="mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-4">ã‚·ãƒ•ãƒˆç®¡ç†</h1>
                        <button onclick="openAddShiftModal()" class="luxury-btn px-6 py-3 rounded-xl text-sm">ã‚·ãƒ•ãƒˆç™»éŒ²</button>
                    </div>

                    <div class="luxury-card rounded-xl p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="previousMonth()" class="bg-gray-800 text-gray-300 px-4 py-2 rounded-xl hover:bg-gray-700 transition text-sm">å‰æœˆ</button>
                            <h3 class="text-xl font-semibold text-gray-200" id="currentMonth">2024å¹´11æœˆ</h3>
                            <button onclick="nextMonth()" class="bg-gray-800 text-gray-300 px-4 py-2 rounded-xl hover:bg-gray-700 transition text-sm">æ¬¡æœˆ</button>
                        </div>
                        <div class="calendar-grid" id="shiftCalendar"></div>
                    </div>

                    <div class="luxury-card rounded-xl p-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-200">ä»Šé€±ã®ã‚·ãƒ•ãƒˆ</h3>
                        <div id="weeklyShifts"></div>
                    </div>
                </div>

                <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç† -->
                <div id="menu-tab" class="tab-content">
                    <div class="mb-6">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-4">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</h1>
                        <button onclick="openAddMenuModal()" class="luxury-btn px-6 py-3 rounded-xl text-sm">ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ </button>
                    </div>
                    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ã‚¿ãƒ– -->
                    <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                        <button onclick="filterMenuCategory('all')" class="menu-filter-btn active px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-amber-500/20 text-amber-300 border border-amber-500/30" data-category="all">
                            ã™ã¹ã¦
                        </button>
                        <button onclick="filterMenuCategory('drink')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="drink">
                            ãƒ‰ãƒªãƒ³ã‚¯
                        </button>
                        <button onclick="filterMenuCategory('castdrink')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="castdrink">
                            ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•
                        </button>
                        <button onclick="filterMenuCategory('tableset')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="tableset">
                            å“ã‚»ãƒƒãƒˆ
                        </button>
                        <button onclick="filterMenuCategory('shochu')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="shochu">
                            ç„¼é…
                        </button>
                        <button onclick="filterMenuCategory('whisky')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="whisky">
                            ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼
                        </button>
                        <button onclick="filterMenuCategory('champagne')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="champagne">
                            ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³
                        </button>
                        <button onclick="filterMenuCategory('wine')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="wine">
                            ãƒ¯ã‚¤ãƒ³
                        </button>
                        <button onclick="filterMenuCategory('food')" class="menu-filter-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap transition bg-gray-800 text-gray-300 border border-gray-700" data-category="food">
                            ãƒ•ãƒ¼ãƒ‰
                        </button>
                    </div>
                    <div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6"></div>
                </div>

                <!-- ã‚­ãƒ£ã‚¹ãƒˆç®¡ç† -->
                <div id="casts-tab" class="tab-content">
                    <div class="mb-6 md:mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-4">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</h1>
                        
                        <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                        <div class="flex gap-2 overflow-x-auto pb-2">
                            <button onclick="showCastSubTab('cast-list')" class="cast-subtab-btn active px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                ğŸ‘¥ ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§
                            </button>
                            <button onclick="showCastSubTab('staff-list')" class="cast-subtab-btn px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                ğŸ§‘â€ğŸ’¼ ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§
                            </button>
                            <button onclick="showCastSubTab('drink-back')" class="cast-subtab-btn px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                ğŸ’ DBç²å¾—ä¸€è¦§
                            </button>
                            <button onclick="showCastSubTab('salary')" class="cast-subtab-btn px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                ğŸ’° çµ¦ä¸è¨ˆç®—
                            </button>
                            <button onclick="showCastSubTab('ranking')" class="cast-subtab-btn px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm font-semibold whitespace-nowrap transition">
                                ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                            </button>
                        </div>
                    </div>
                    
                    <!-- ã‚µãƒ–ã‚¿ãƒ–1: ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ -->
                    <div id="cast-list-subtab" class="cast-subtab-content active">
                        <div class="mb-6 flex justify-end">
                            <button onclick="openAddCastModal()" class="luxury-btn px-6 md:px-8 py-3 rounded-xl text-sm">
                                â• ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ 
                            </button>
                        </div>
                        <div id="castsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                    </div>
                    
                    <!-- ã‚µãƒ–ã‚¿ãƒ–: ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ -->
                    <div id="staff-list-subtab" class="cast-subtab-content">
                        <div class="mb-6 flex justify-end">
                            <button onclick="openAddStaffModal()" class="luxury-btn px-6 md:px-8 py-3 rounded-xl text-sm">
                                â• ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
                            </button>
                        </div>
                        <div id="staffGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                    </div>
                    
                    <!-- ã‚µãƒ–ã‚¿ãƒ–2: DBç²å¾—ä¸€è¦§ -->
                    <div id="drink-back-subtab" class="cast-subtab-content">
                        <div class="mb-6 flex flex-col md:flex-row gap-3">
                            <select id="dbFilterPeriod" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderDrinkBackList()">
                                <option value="today">æœ¬æ—¥</option>
                                <option value="week">ä»Šé€±</option>
                                <option value="month">ä»Šæœˆ</option>
                            </select>
                            <button onclick="exportDrinkBackCSV()" class="luxury-btn px-6 py-3 rounded-xl text-sm">
                                ğŸ“¥ CSVå‡ºåŠ›
                            </button>
                        </div>
                        
                        <!-- DBé›†è¨ˆã‚µãƒãƒªãƒ¼ -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="luxury-card rounded-xl p-4 text-center">
                                <p class="text-sm text-gray-400 mb-1">ç·DBé¡</p>
                                <p class="text-2xl font-bold gold-accent" id="totalDbAmount">Â¥0</p>
                            </div>
                            <div class="luxury-card rounded-xl p-4 text-center">
                                <p class="text-sm text-gray-400 mb-1">DBæ³¨æ–‡æ•°</p>
                                <p class="text-2xl font-bold text-gray-200" id="totalDbCount">0ä»¶</p>
                            </div>
                            <div class="luxury-card rounded-xl p-4 text-center">
                                <p class="text-sm text-gray-400 mb-1">TOP ã‚­ãƒ£ã‚¹ãƒˆ</p>
                                <p class="text-lg font-bold text-purple-300" id="topDbCast">-</p>
                            </div>
                            <div class="luxury-card rounded-xl p-4 text-center">
                                <p class="text-sm text-gray-400 mb-1">å¹³å‡DB/äºº</p>
                                <p class="text-2xl font-bold text-gray-200" id="avgDbAmount">Â¥0</p>
                            </div>
                        </div>
                        
                        <!-- ã‚­ãƒ£ã‚¹ãƒˆåˆ¥DBä¸€è¦§ -->
                        <div class="luxury-card rounded-xl p-6 mb-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">ã‚­ãƒ£ã‚¹ãƒˆåˆ¥DBé›†è¨ˆ</h3>
                            <div id="castDbList" class="space-y-3"></div>
                        </div>
                        
                        <!-- DBè©³ç´°ä¸€è¦§ -->
                        <div class="luxury-card rounded-xl p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">DBè©³ç´°</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th class="text-left py-3 px-4 text-gray-400 font-medium">æ™‚åˆ»</th>
                                            <th class="text-left py-3 px-4 text-gray-400 font-medium">ã‚­ãƒ£ã‚¹ãƒˆ</th>
                                            <th class="text-left py-3 px-4 text-gray-400 font-medium">å•†å“</th>
                                            <th class="text-center py-3 px-4 text-gray-400 font-medium">æ•°é‡</th>
                                            <th class="text-right py-3 px-4 text-gray-400 font-medium">DBé¡</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dbDetailTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ã‚µãƒ–ã‚¿ãƒ–3: çµ¦ä¸è¨ˆç®— -->
                    <div id="salary-subtab" class="cast-subtab-content">
                        <div class="mb-6 flex flex-col md:flex-row gap-3 items-start md:items-center">
                            <div class="flex gap-2">
                                <select id="salaryYear" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderSalaryCalculation()">
                                </select>
                                <select id="salaryMonth" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderSalaryCalculation()">
                                    <option value="1">1æœˆ</option>
                                    <option value="2">2æœˆ</option>
                                    <option value="3">3æœˆ</option>
                                    <option value="4">4æœˆ</option>
                                    <option value="5">5æœˆ</option>
                                    <option value="6">6æœˆ</option>
                                    <option value="7">7æœˆ</option>
                                    <option value="8">8æœˆ</option>
                                    <option value="9">9æœˆ</option>
                                    <option value="10">10æœˆ</option>
                                    <option value="11">11æœˆ</option>
                                    <option value="12">12æœˆ</option>
                                </select>
                            </div>
                            <button onclick="exportSalaryCSV()" class="luxury-btn px-6 py-3 rounded-xl text-sm">
                                ğŸ“¥ çµ¦ä¸æ˜ç´°CSV
                            </button>
                        </div>
                        
                        <div id="salaryList" class="space-y-4"></div>
                    </div>
                    
                    <!-- ã‚µãƒ–ã‚¿ãƒ–4: ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                    <div id="ranking-subtab" class="cast-subtab-content">
                        <div class="mb-6">
                            <select id="rankingPeriod" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderRankings()">
                                <option value="month">ä»Šæœˆ</option>
                                <option value="week">ä»Šé€±</option>
                                <option value="today">æœ¬æ—¥</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                    <span>ğŸ’°</span>
                                    <span>å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                                </h3>
                                <div id="salesRanking" class="space-y-3"></div>
                            </div>
                            
                            <!-- DBãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                    <span>ğŸ’</span>
                                    <span>DBç²å¾—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                                </h3>
                                <div id="dbRanking" class="space-y-3"></div>
                            </div>
                            
                            <!-- æŒ‡åæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                    <span>â­</span>
                                    <span>æŒ‡åæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                                </h3>
                                <div id="nominationRanking" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¼šè¨ˆå±¥æ­´ã‚¿ãƒ– -->
                <div id="checkout-history-tab" class="tab-content">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-3">ä¼šè¨ˆå±¥æ­´</h1>
                            <p class="text-gray-400">æœ¬æ—¥ã®ä¼šè¨ˆå±¥æ­´ã‚’ç¢ºèªãƒ»ä¿®æ­£ã§ãã¾ã™</p>
                        </div>
                        <button onclick="exportCheckoutHistoryCSV()" class="bg-gray-800 text-gray-300 px-6 py-3 rounded-xl text-sm hover:bg-gray-700 transition">
                            ğŸ“¥ CSVå‡ºåŠ›
                        </button>
                    </div>
                    
                    <div id="checkoutHistoryContent" class="space-y-4">
                        <!-- ã“ã“ã«ä¼šè¨ˆå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>

                <!-- æ—¥å ±ã‚¿ãƒ– -->
                <div id="daily-report-tab" class="tab-content">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 no-print">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent">ãƒ¬ãƒãƒ¼ãƒˆ</h1>
                        <div class="flex items-center gap-3">
                            <!-- æ—¥å ±/æœˆå ±åˆ‡ã‚Šæ›¿ãˆ -->
                            <div class="flex bg-gray-800 rounded-xl p-1">
                                <button id="btnDailyReport" onclick="switchReportMode('daily')" class="px-4 py-2 rounded-lg text-sm font-semibold transition bg-amber-500 text-black">æ—¥å ±</button>
                                <button id="btnMonthlyReport" onclick="switchReportMode('monthly')" class="px-4 py-2 rounded-lg text-sm font-semibold transition text-gray-400 hover:text-white">æœˆå ±</button>
                            </div>
                            <!-- æœˆé¸æŠï¼ˆæœˆå ±æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                            <div id="monthSelector" class="hidden flex items-center gap-2">
                                <select id="reportYear" class="px-3 py-2 rounded-lg bg-gray-800 text-white text-sm" onchange="loadMonthlyReport()">
                                </select>
                                <select id="reportMonth" class="px-3 py-2 rounded-lg bg-gray-800 text-white text-sm" onchange="loadMonthlyReport()">
                                    <option value="1">1æœˆ</option>
                                    <option value="2">2æœˆ</option>
                                    <option value="3">3æœˆ</option>
                                    <option value="4">4æœˆ</option>
                                    <option value="5">5æœˆ</option>
                                    <option value="6">6æœˆ</option>
                                    <option value="7">7æœˆ</option>
                                    <option value="8">8æœˆ</option>
                                    <option value="9">9æœˆ</option>
                                    <option value="10">10æœˆ</option>
                                    <option value="11">11æœˆ</option>
                                    <option value="12">12æœˆ</option>
                                </select>
                            </div>
                            <button onclick="exportReportCSV()" class="bg-gray-800 text-gray-300 px-6 py-3 rounded-xl text-sm hover:bg-gray-700 transition">
                                ğŸ“¥ CSV
                            </button>
                            <button onclick="printFullDailyReport()" class="luxury-btn px-6 py-3 rounded-xl text-sm">
                                ğŸ–¨ï¸ å°åˆ·
                            </button>
                        </div>
                    </div>
                    
                    <div id="dailyReportContent"></div>
                    <div id="monthlyReportContent" class="hidden"></div>
                </div>

                <!-- åº—èˆ—è¨­å®š -->
                <div id="store-settings-tab" class="tab-content">
                    <div class="mb-6 md:mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent mb-4">åº—èˆ—è¨­å®š</h1>
                        <p class="text-gray-400">ãƒãƒƒã‚¯ç‡ãªã©åº—èˆ—å›ºæœ‰ã®è¨­å®šã‚’ç®¡ç†ã—ã¾ã™</p>
                    </div>
                    
                    <!-- ãƒãƒƒã‚¯è¨­å®š -->
                    <div class="glass-effect rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold text-white mb-4">ãƒãƒƒã‚¯è¨­å®š</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ï¼ˆDBï¼‰</span>
                                    <span class="text-amber-400 font-bold" id="displayDbRate">60%</span>
                                </div>
                                <input type="range" id="settingDbRate" min="0" max="100" value="60" 
                                       onchange="updateBackSetting('db', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒªãƒ³ã‚¯ã®ãƒãƒƒã‚¯ç‡</p>
                            </div>
                            
                            <!-- æŒ‡åæ–™ãƒãƒƒã‚¯ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">æŒ‡åæ–™ãƒãƒƒã‚¯</span>
                                    <span class="text-amber-400 font-bold" id="displayNominationRate">60%</span>
                                </div>
                                <input type="range" id="settingNominationRate" min="0" max="100" value="60" 
                                       onchange="updateBackSetting('nomination', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">æŒ‡åæ–™ã®ãƒãƒƒã‚¯ç‡ï¼ˆè¤‡æ•°æŒ‡åæ™‚ã¯ç­‰åˆ†å¾Œã«é©ç”¨ï¼‰</p>
                            </div>
                            
                            <!-- å£²ä¸Šãƒãƒƒã‚¯ï¼ˆæŒ‡åæ™‚ï¼‰ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">å£²ä¸Šãƒãƒƒã‚¯ï¼ˆæŒ‡åæ™‚ï¼‰</span>
                                    <span class="text-amber-400 font-bold" id="displaySalesRate">10%</span>
                                </div>
                                <input type="range" id="settingSalesRate" min="0" max="50" value="10" 
                                       onchange="updateBackSetting('sales', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">æŒ‡åå®¢ã®ä¼šè¨ˆã«å¯¾ã™ã‚‹ãƒãƒƒã‚¯ç‡</p>
                            </div>
                            
                            <!-- åŒä¼´ãƒãƒƒã‚¯ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">åŒä¼´ãƒãƒƒã‚¯</span>
                                    <span class="text-amber-400 font-bold" id="displayCompanionRate">100%</span>
                                </div>
                                <input type="range" id="settingCompanionRate" min="0" max="100" value="100" 
                                       onchange="updateBackSetting('companion', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">åŒä¼´æ–™ã®ãƒãƒƒã‚¯ç‡</p>
                            </div>
                            
                            <!-- ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒãƒƒã‚¯ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒãƒƒã‚¯</span>
                                    <span class="text-amber-400 font-bold" id="displayChampagneRate">10%</span>
                                </div>
                                <input type="range" id="settingChampagneRate" min="0" max="50" value="10" 
                                       onchange="updateBackSetting('champagne', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³å£²ä¸Šã«å¯¾ã™ã‚‹ãƒãƒƒã‚¯ç‡</p>
                            </div>
                            
                            <!-- ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ -->
                            <div class="p-4 bg-black/20 rounded-xl border border-white/10">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-white font-semibold">ãƒœãƒˆãƒ«ãƒãƒƒã‚¯</span>
                                    <span class="text-amber-400 font-bold" id="displayBottleRate">10%</span>
                                </div>
                                <input type="range" id="settingBottleRate" min="0" max="50" value="10" 
                                       onchange="updateBackSetting('bottle', this.value)"
                                       class="w-full accent-amber-500">
                                <p class="text-xs text-gray-500 mt-1">ãƒœãƒˆãƒ«å£²ä¸Šã«å¯¾ã™ã‚‹ãƒãƒƒã‚¯ç‡</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button onclick="saveStoreSettings()" class="luxury-btn px-6 py-3 rounded-xl">
                                è¨­å®šã‚’ä¿å­˜
                            </button>
                        </div>
                    </div>
                    
                    <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† -->
                    <div class="glass-effect rounded-2xl p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h2>
                            <button onclick="openAddStaffModal()" class="luxury-btn px-4 py-2 rounded-xl text-sm">
                                ï¼‹ ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
                            </button>
                        </div>
                        
                        <div id="staffList" class="space-y-3">
                            <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    
                    <!-- æœ¬æ—¥ã®ã‚¹ã‚¿ãƒƒãƒ•å‹¤æ€  -->
                    <div class="glass-effect rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold text-white mb-4">æœ¬æ—¥ã®ã‚¹ã‚¿ãƒƒãƒ•å‹¤æ€ </h2>
                        
                        <div id="staffAttendanceList" class="space-y-3">
                            <!-- å‹¤æ€ ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                        
                        <div class="mt-4 p-4 bg-amber-900/20 rounded-xl border border-amber-800/30">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">æœ¬æ—¥ã®ã‚¹ã‚¿ãƒƒãƒ•äººä»¶è²»</span>
                                <span id="todayStaffCost" class="text-2xl font-bold gold-accent">Â¥0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ -->
                <div id="reports-tab" class="tab-content">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h1 class="text-4xl md:text-5xl font-bold gold-accent">å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ</h1>
                        <div class="flex gap-3">
                            <select id="reportPeriod" class="px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200" onchange="renderReports()">
                                <option value="today">æœ¬æ—¥</option>
                                <option value="week">ä»Šé€±</option>
                                <option value="month" selected>ä»Šæœˆ</option>
                                <option value="year">ä»Šå¹´</option>
                            </select>
                            <button onclick="exportReportCSV()" class="luxury-btn px-6 py-3 rounded-xl text-sm">
                                ğŸ“¥ CSVå‡ºåŠ›
                            </button>
                        </div>
                    </div>
                    
                    <div id="reportsContent">
                        <!-- å£²ä¸Šã‚µãƒãƒªãƒ¼ -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div class="luxury-card rounded-xl p-6">
                                <p class="text-sm text-gray-400 mb-2">ç·å£²ä¸Š</p>
                                <p class="text-3xl font-bold gold-accent" id="reportTotalSales">Â¥0</p>
                                <p class="text-xs text-green-400 mt-1" id="reportSalesChange">å‰æœˆæ¯” +0%</p>
                            </div>
                            <div class="luxury-card rounded-xl p-6">
                                <p class="text-sm text-gray-400 mb-2">æ¥åº—çµ„æ•°</p>
                                <p class="text-3xl font-bold text-gray-200" id="reportTotalCustomers">0çµ„</p>
                                <p class="text-xs text-green-400 mt-1" id="reportCustomersChange">å‰æœˆæ¯” +0%</p>
                            </div>
                            <div class="luxury-card rounded-xl p-6">
                                <p class="text-sm text-gray-400 mb-2">å®¢å˜ä¾¡</p>
                                <p class="text-3xl font-bold text-blue-300" id="reportAvgSpend">Â¥0</p>
                                <p class="text-xs text-green-400 mt-1" id="reportAvgChange">å‰æœˆæ¯” +0%</p>
                            </div>
                            <div class="luxury-card rounded-xl p-6">
                                <p class="text-sm text-gray-400 mb-2">ç²—åˆ©</p>
                                <p class="text-3xl font-bold text-green-400" id="reportGrossProfit">Â¥0</p>
                                <p class="text-xs text-gray-400 mt-1" id="reportProfitRate">ç²—åˆ©ç‡ 60%</p>
                            </div>
                        </div>
                        
                        <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- å£²ä¸Šæ¨ç§»ã‚°ãƒ©ãƒ• -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-200">å£²ä¸Šæ¨ç§»</h3>
                                <canvas id="salesTrendChart"></canvas>
                            </div>
                            
                            <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥å£²ä¸Š -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-200">ã‚«ãƒ†ã‚´ãƒªåˆ¥å£²ä¸Š</h3>
                                <canvas id="categorySalesChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- æ™‚é–“å¸¯åˆ¥å£²ä¸Š -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-200">æ™‚é–“å¸¯åˆ¥å£²ä¸Š</h3>
                                <canvas id="hourlyChart"></canvas>
                            </div>
                            
                            <!-- åŸä¾¡ç‡åˆ†æ -->
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-200">ã‚«ãƒ†ã‚´ãƒªåˆ¥åŸä¾¡ç‡</h3>
                                <div class="space-y-3" id="costRateList"></div>
                            </div>
                        </div>
                        
                        <!-- ã‚­ãƒ£ãƒƒãƒã‚¹ã‚¿ãƒƒãƒ•æˆç¸¾ -->
                        <div class="luxury-card rounded-xl p-6 mb-8">
                            <h3 class="text-xl font-semibold mb-4 text-gray-200">ã‚­ãƒ£ãƒƒãƒã‚¹ã‚¿ãƒƒãƒ•æˆç¸¾</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-700">
                                            <th class="text-left py-3 px-4 text-gray-400">ã‚¹ã‚¿ãƒƒãƒ•å</th>
                                            <th class="text-center py-3 px-4 text-gray-400">æ¥åº—çµ„æ•°</th>
                                            <th class="text-right py-3 px-4 text-gray-400">ç·å£²ä¸Š</th>
                                            <th class="text-right py-3 px-4 text-gray-400">å¹³å‡å®¢å˜ä¾¡</th>
                                            <th class="text-center py-3 px-4 text-gray-400">è²¢çŒ®åº¦</th>
                                        </tr>
                                    </thead>
                                    <tbody id="catchStaffTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- TOPå•†å“ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <span>ğŸ¾</span>
                                    <span>ãƒœãƒˆãƒ«TOP5</span>
                                </h3>
                                <div id="topBottles" class="space-y-3"></div>
                            </div>
                            
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <span>ğŸ¥ƒ</span>
                                    <span>ãƒ‰ãƒªãƒ³ã‚¯TOP5</span>
                                </h3>
                                <div id="topDrinks" class="space-y-3"></div>
                            </div>
                            
                            <div class="luxury-card rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <span>ğŸ½</span>
                                    <span>ãƒ•ãƒ¼ãƒ‰TOP5</span>
                                </h3>
                                <div id="topFoods" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ  -->
    <div id="addStaffModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-lg modal-content glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 py-5 flex items-center justify-between">
                <h2 class="text-xl font-bold gold-accent">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </h2>
                <button onclick="closeModal('addStaffModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6">
                <form onsubmit="addStaff(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">åå‰</label>
                        <input type="text" id="staffName" placeholder="åå‰" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">å½¹å‰²</label>
                        <select id="staffRole" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white">
                            <option value="waiter">ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼</option>
                            <option value="kitchen">ã‚­ãƒƒãƒãƒ³</option>
                            <option value="manager">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</option>
                            <option value="catch">ã‚­ãƒ£ãƒƒãƒ</option>
                            <option value="driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">çµ¦ä¸ã‚¿ã‚¤ãƒ—</label>
                        <select id="staffSalaryType" onchange="updateSalaryLabel()" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white">
                            <option value="hourly">æ™‚çµ¦</option>
                            <option value="daily">æ—¥çµ¦</option>
                            <option value="monthly">æœˆçµ¦</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2" id="salaryAmountLabel">æ™‚çµ¦</label>
                        <input type="number" id="staffSalaryAmount" placeholder="1000" value="1000" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
                        <input type="tel" id="staffPhone" placeholder="090-1234-5678" class="w-full px-4 py-3 rounded-xl text-sm bg-gray-800 border border-gray-700 text-white">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 rounded-xl font-semibold text-sm">è¿½åŠ </button>
                        <button type="button" onclick="closeModal('addStaffModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ  -->
    <div id="addMenuModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-lg modal-content glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ </h2>
                <button onclick="closeModal('addMenuModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="addMenuItem(event)" class="space-y-4 md:space-y-5">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">å•†å“ç”»åƒ</label>
                        <div class="image-upload-area rounded-xl p-6 text-center" onclick="document.getElementById('menuImageInput').click()">
                            <input type="file" id="menuImageInput" accept="image/*" class="hidden" onchange="previewMenuImage(event, 'add')">
                            <p class="text-gray-400 mb-2 text-sm">ğŸ“¸ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                            <p class="text-xs text-gray-500">JPG, PNG, GIF (æœ€å¤§5MB)</p>
                        </div>
                        <img id="menuImagePreview" class="image-preview hidden" />
                    </div>
                    <input type="text" id="menuName" placeholder="å•†å“å" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ã‚«ãƒ†ã‚´ãƒª</label>
                        <select id="menuCategory" style="width:100%; padding:12px 16px; border-radius:12px; background:#2a2a2a; color:#f5f5f5; border:1px solid #444; font-size:14px; cursor:pointer;">
                            <option value="drink">ãƒ‰ãƒªãƒ³ã‚¯</option>
                            <option value="castdrink">ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯</option>
                            <option value="tableset">å“ã‚»ãƒƒãƒˆ</option>
                            <option value="bottle" selected>ãƒœãƒˆãƒ«</option>
                            <option value="champagne">ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³</option>
                            <option value="wine">ãƒ¯ã‚¤ãƒ³</option>
                            <option value="food">ãƒ•ãƒ¼ãƒ‰</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">å£²ä¾¡</label>
                            <input type="number" id="menuPrice" placeholder="å£²ä¾¡" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">åŸä¾¡</label>
                            <input type="number" id="menuCost" placeholder="åŸä¾¡ï¼ˆä»»æ„ï¼‰" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        </div>
                    </div>
                    <textarea id="menuDescription" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰" rows="3" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm"></textarea>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">è¿½åŠ </button>
                        <button type="button" onclick="closeModal('addMenuModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç·¨é›† -->
    <div id="editMenuModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-lg modal-content glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç·¨é›†</h2>
                <button onclick="closeModal('editMenuModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="updateMenuItem(event)" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="editMenuId">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">å•†å“ç”»åƒ</label>
                        <div class="image-upload-area rounded-xl p-6 text-center" onclick="document.getElementById('editMenuImageInput').click()">
                            <input type="file" id="editMenuImageInput" accept="image/*" class="hidden" onchange="previewMenuImage(event, 'edit')">
                            <p class="text-gray-400 mb-2 text-sm">ğŸ“¸ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’å¤‰æ›´</p>
                            <p class="text-xs text-gray-500">JPG, PNG, GIF (æœ€å¤§5MB)</p>
                        </div>
                        <img id="editMenuImagePreview" class="image-preview hidden" />
                    </div>
                    <input type="text" id="editMenuName" placeholder="å•†å“å" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ã‚«ãƒ†ã‚´ãƒª</label>
                        <select id="editMenuCategory" style="width:100%; padding:12px 16px; border-radius:12px; background:#2a2a2a; color:#f5f5f5; border:1px solid #444; font-size:14px; cursor:pointer;">
                            <option value="drink">ãƒ‰ãƒªãƒ³ã‚¯</option>
                            <option value="castdrink">ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯</option>
                            <option value="tableset">å“ã‚»ãƒƒãƒˆ</option>
                            <option value="bottle">ãƒœãƒˆãƒ«</option>
                            <option value="champagne">ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³</option>
                            <option value="wine">ãƒ¯ã‚¤ãƒ³</option>
                            <option value="food">ãƒ•ãƒ¼ãƒ‰</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">å£²ä¾¡</label>
                            <input type="number" id="editMenuPrice" placeholder="å£²ä¾¡" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">åŸä¾¡</label>
                            <input type="number" id="editMenuCost" placeholder="åŸä¾¡ï¼ˆä»»æ„ï¼‰" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        </div>
                    </div>
                    <textarea id="editMenuDescription" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰" rows="3" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm"></textarea>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">æ›´æ–°</button>
                        <button type="button" onclick="closeModal('editMenuModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šï¼ˆä¸€è¦§ï¼‰ -->
    <div id="tableSettingsModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-2xl glass-effect rounded-2xl shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š</h2>
                <button onclick="closeModal('tableSettingsModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8 overflow-y-auto flex-1">
                <div class="mb-4 flex justify-end">
                    <button onclick="closeModal('tableSettingsModal'); openAddTableModal();" class="luxury-btn px-4 py-2 rounded-xl text-sm">
                        â• ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
                    </button>
                </div>
                <div id="tableSettingsList" class="space-y-3">
                    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ãŒã“ã“ã«å…¥ã‚‹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ  -->
    <div id="addTableModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ </h2>
                <button onclick="closeModal('addTableModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="addTable(event)" class="space-y-4 md:space-y-5">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ãƒ†ãƒ¼ãƒ–ãƒ«å</label>
                        <input type="text" id="tableName" placeholder="ä¾‹: 1, 2, VIP1, ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">VIPãƒ†ãƒ¼ãƒ–ãƒ«</label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="tableIsVip" class="w-5 h-5 rounded">
                            <span class="text-gray-300">VIPãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦è¨­å®š</span>
                        </label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">è¿½åŠ </button>
                        <button type="button" onclick="closeModal('addTableModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›† -->
    <div id="editTableModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†</h2>
                <button onclick="closeModal('editTableModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="updateTable(event)" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="editTableId">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ãƒ†ãƒ¼ãƒ–ãƒ«å</label>
                        <input type="text" id="editTableName" placeholder="ä¾‹: 1, 2, VIP1, ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">VIPãƒ†ãƒ¼ãƒ–ãƒ«</label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="editTableIsVip" class="w-5 h-5 rounded">
                            <span class="text-gray-300">VIPãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦è¨­å®š</span>
                        </label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">æ›´æ–°</button>
                        <button type="button" onclick="closeModal('editTableModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <button onclick="deleteTable()" class="w-full bg-red-900/20 text-red-400 border border-red-800/30 py-3 rounded-xl hover:bg-red-900/30 transition text-sm">
                        ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ãƒ»è¿½åŠ æ³¨æ–‡ -->
    <div id="tableDetailModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-4xl modal-content glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent" id="tableDetailTitle">ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°</h2>
                <button onclick="closeModal('tableDetailModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <div id="tableDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ  -->
    <div id="addCastModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between sticky top-0 bg-gray-900/95 backdrop-blur">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ </h2>
                <button onclick="closeModal('addCastModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="addCast(event)" class="space-y-4 md:space-y-5">
                    <input type="text" id="castName" placeholder="åå‰" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <select id="castRank" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        <option value="regular">ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼</option>
                        <option value="chief">ãƒãƒ¼ãƒ•</option>
                        <option value="manager">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</option>
                    </select>
                    
                    <!-- çµ¦ä¸ä½“ç³» -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">ğŸ’µ çµ¦ä¸ä½“ç³»</p>
                        <div class="flex gap-3 mb-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="castSalaryType" value="hourly" checked onchange="toggleSalaryType('add', 'hourly')" class="accent-amber-500">
                                <span class="text-sm text-gray-300">æ™‚çµ¦åˆ¶</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="castSalaryType" value="monthly" onchange="toggleSalaryType('add', 'monthly')" class="accent-amber-500">
                                <span class="text-sm text-gray-300">æœˆçµ¦åˆ¶</span>
                            </label>
                        </div>
                        <div id="addHourlyInput">
                            <label class="block text-xs text-gray-500 mb-1">æ™‚çµ¦ï¼ˆå††ï¼‰</label>
                            <input type="number" id="castHourlyRate" placeholder="3000" class="w-full px-4 py-3 rounded-xl text-sm">
                        </div>
                        <div id="addMonthlyInput" class="hidden">
                            <label class="block text-xs text-gray-500 mb-1">æœˆçµ¦ï¼ˆå††ï¼‰</label>
                            <input type="number" id="castMonthlySalary" placeholder="300000" class="w-full px-4 py-3 rounded-xl text-sm">
                        </div>
                    </div>
                    
                    <!-- ãƒãƒƒã‚¯è¨­å®š -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">ğŸ’° ãƒãƒƒã‚¯è¨­å®š</p>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">åŒä¼´ãƒãƒƒã‚¯ï¼ˆå††ï¼‰</label>
                                <input type="number" id="castCompanionBack" value="3000" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">æŒ‡åãƒãƒƒã‚¯ï¼ˆå††ï¼‰</label>
                                <input type="number" id="castNominationBack" value="1000" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ç‡ï¼ˆ%ï¼‰</label>
                                <input type="number" id="castDrinkBackRate" value="10" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">å£²ä¸Šãƒãƒƒã‚¯ç‡ï¼ˆ%ï¼‰</label>
                                <input type="number" id="castSalesBackRate" value="0" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">è¿½åŠ </button>
                        <button type="button" onclick="closeModal('addCastModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚­ãƒ£ã‚¹ãƒˆç·¨é›† -->
    <div id="editCastModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between sticky top-0 bg-gray-900/95 backdrop-blur">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ã‚­ãƒ£ã‚¹ãƒˆç·¨é›†</h2>
                <button onclick="closeModal('editCastModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="updateCast(event)" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="editCastId">
                    <input type="text" id="editCastName" placeholder="åå‰" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <select id="editCastRank" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        <option value="regular">ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼</option>
                        <option value="chief">ãƒãƒ¼ãƒ•</option>
                        <option value="manager">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</option>
                    </select>
                    
                    <!-- çµ¦ä¸ä½“ç³» -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">ğŸ’µ çµ¦ä¸ä½“ç³»</p>
                        <div class="flex gap-3 mb-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="editCastSalaryType" id="editSalaryTypeHourly" value="hourly" checked onchange="toggleSalaryType('edit', 'hourly')" class="accent-amber-500">
                                <span class="text-sm text-gray-300">æ™‚çµ¦åˆ¶</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="editCastSalaryType" id="editSalaryTypeMonthly" value="monthly" onchange="toggleSalaryType('edit', 'monthly')" class="accent-amber-500">
                                <span class="text-sm text-gray-300">æœˆçµ¦åˆ¶</span>
                            </label>
                        </div>
                        <div id="editHourlyInput">
                            <label class="block text-xs text-gray-500 mb-1">æ™‚çµ¦ï¼ˆå††ï¼‰</label>
                            <input type="number" id="editCastHourlyRate" placeholder="3000" class="w-full px-4 py-3 rounded-xl text-sm">
                        </div>
                        <div id="editMonthlyInput" class="hidden">
                            <label class="block text-xs text-gray-500 mb-1">æœˆçµ¦ï¼ˆå††ï¼‰</label>
                            <input type="number" id="editCastMonthlySalary" placeholder="300000" class="w-full px-4 py-3 rounded-xl text-sm">
                        </div>
                    </div>
                    
                    <!-- ãƒãƒƒã‚¯è¨­å®š -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">ğŸ’° ãƒãƒƒã‚¯è¨­å®š</p>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">åŒä¼´ãƒãƒƒã‚¯ï¼ˆå††ï¼‰</label>
                                <input type="number" id="editCastCompanionBack" placeholder="3000" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">æŒ‡åãƒãƒƒã‚¯ï¼ˆå††ï¼‰</label>
                                <input type="number" id="editCastNominationBack" placeholder="1000" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ç‡ï¼ˆ%ï¼‰</label>
                                <input type="number" id="editCastDrinkBackRate" placeholder="10" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">å£²ä¸Šãƒãƒƒã‚¯ç‡ï¼ˆ%ï¼‰</label>
                                <input type="number" id="editCastSalesBackRate" placeholder="0" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">æ›´æ–°</button>
                        <button type="button" onclick="closeModal('editCastModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ  -->
    <div id="addStaffModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </h2>
                <button onclick="closeModal('addStaffModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="addStaff(event)" class="space-y-4 md:space-y-5">
                    <input type="text" id="staffName" placeholder="åå‰" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <select id="staffRole" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        <option value="waiter">ãƒœãƒ¼ã‚¤</option>
                        <option value="kitchen">ã‚­ãƒƒãƒãƒ³</option>
                        <option value="manager">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</option>
                        <option value="catch">ã‚­ãƒ£ãƒƒãƒ</option>
                        <option value="driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                    <input type="number" id="staffHourlyRate" placeholder="æ™‚çµ¦" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <input type="tel" id="staffPhone" placeholder="é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">è¿½åŠ </button>
                        <button type="button" onclick="closeModal('addStaffModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›† -->
    <div id="editStaffModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†</h2>
                <button onclick="closeModal('editStaffModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="updateStaff(event)" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="editStaffId">
                    <input type="text" id="editStaffName" placeholder="åå‰" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <select id="editStaffRole" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                        <option value="waiter">ãƒœãƒ¼ã‚¤</option>
                        <option value="kitchen">ã‚­ãƒƒãƒãƒ³</option>
                        <option value="manager">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</option>
                        <option value="catch">ã‚­ãƒ£ãƒƒãƒ</option>
                        <option value="driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                    <input type="number" id="editStaffHourlyRate" placeholder="æ™‚çµ¦" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <input type="tel" id="editStaffPhone" placeholder="é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm">
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">æ›´æ–°</button>
                        <button type="button" onclick="closeModal('editStaffModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚·ãƒ•ãƒˆè¿½åŠ  -->
    <div id="addShiftModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-6 md:px-8 py-5 md:py-6 flex items-center justify-between">
                <h2 class="text-xl md:text-2xl font-bold gold-accent">ã‚·ãƒ•ãƒˆç™»éŒ²</h2>
                <button onclick="closeModal('addShiftModal')" class="text-gray-400 hover:text-gray-200 text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8">
                <form onsubmit="saveShift(event)" class="space-y-4 md:space-y-5">
                    <select id="shiftCast" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm"></select>
                    <input type="date" id="shiftDate" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <input type="time" id="shiftStart" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <input type="time" id="shiftEnd" class="w-full px-4 md:px-5 py-3 md:py-4 rounded-xl text-sm" required>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 luxury-btn py-3 md:py-4 rounded-xl font-semibold text-sm">ç™»éŒ²</button>
                        <button type="button" onclick="closeModal('addShiftModal')" class="flex-1 bg-gray-800 text-gray-300 py-3 md:py-4 rounded-xl hover:bg-gray-700 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
const appState = {
  currentUser: null,
  currentMonth: new Date(),
  tables: [],
  sessions: [],
  menuItems: [],
  casts: [],
  orders: [],
  shifts: [],
  attendances: [],
  sales: 0,
  apiConnected: false,
  currentMenuImage: null,

  activeSessions: [],
  checkoutHistory: [],

  // â˜… ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ç”¨ï¼ˆã“ã‚Œã ã‘ã§OKï¼‰
  currentTableId: null,
  isTableDetailOpen: false,
  currentTableDetail: null,
  currentTableSession: null,

  currentEditingMenuId: null,
};

// ãƒ‡ãƒãƒƒã‚°ç”¨ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
window.appState = appState;

// åº—èˆ—æƒ…å ±ï¼ˆå¿…è¦ã«å¿œã˜ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰
const SHOP_INFO = {
    name: 'Cabax Sample åº—',                // åº—å
    address: 'æ±äº¬éƒ½ã€‡ã€‡åŒºã€‡ã€‡ 1-2-3',      // ä½æ‰€
    tel: '03-1234-5678'                    // é›»è©±ç•ªå·
};        
// â˜… ç®¡ç†ç”»é¢ç”¨ API è¨­å®šï¼ˆæ³¨æ–‡ã‚¢ãƒ—ãƒªã¨æƒãˆã‚‹ï¼‰
// APIãƒ™ãƒ¼ã‚¹URLã‚’å‹•çš„ã«è¨­å®š
const API_BASE_URL = (() => {
    // æœ¬ç•ªç’°å¢ƒ: åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®APIã‚’ä½¿ç”¨
    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        return `${window.location.origin}/api`;
    }
    // é–‹ç™ºç’°å¢ƒ
    return 'http://localhost:8000/api';
})();

console.log('[Cabax Admin] API_BASE_URL:', API_BASE_URL);

const API_ENDPOINTS = {
    menu: '/menu',
    tables: '/tables',
    casts: '/casts',
    sessions: '/sessions',
    sessionsActive: '/sessions/active',
    orders: '/orders',
};

// â˜… æ³¨æ–‡é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
const orderNotification = {
    lastOrderIds: new Set(),
    initialized: false,
    soundEnabled: true,
    
    // é€šçŸ¥éŸ³ã‚’é³´ã‚‰ã™
    playSound() {
        if (!this.soundEnabled) return;
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // 2å›ãƒ”ãƒ³ãƒãƒ³éŸ³
            oscillator.frequency.value = 880; // A5
            oscillator.type = 'sine';
            gainNode.gain.value = 0.3;
            
            oscillator.start();
            
            // éŸ³ç¨‹ã‚’å¤‰ãˆã‚‹ï¼ˆãƒ”ãƒ³ãƒãƒ³ï¼‰
            setTimeout(() => { oscillator.frequency.value = 1100; }, 150);
            setTimeout(() => { oscillator.frequency.value = 880; }, 300);
            setTimeout(() => { oscillator.frequency.value = 1100; }, 450);
            
            setTimeout(() => {
                oscillator.stop();
                audioContext.close();
            }, 600);
        } catch (e) {
            console.log('é€šçŸ¥éŸ³ã®å†ç”Ÿã«å¤±æ•—:', e);
        }
    },
    
    // æ–°ã—ã„æ³¨æ–‡ã‚’ãƒã‚§ãƒƒã‚¯
    async checkNewOrders() {
        try {
            const sessions = await apiRequest(API_ENDPOINTS.sessionsActive);
            if (!Array.isArray(sessions)) return;
            
            let hasNewOrder = false;
            
            for (const session of sessions) {
                const orders = await apiRequest(`/sessions/${session.id}/orders`);
                if (!Array.isArray(orders)) continue;
                
                for (const order of orders) {
                    const orderId = `${session.id}-${order.id}`;
                    if (!this.lastOrderIds.has(orderId)) {
                        if (this.initialized) {
                            hasNewOrder = true;
                            console.log('[é€šçŸ¥] æ–°ã—ã„æ³¨æ–‡:', order);
                        }
                        this.lastOrderIds.add(orderId);
                    }
                }
            }
            
            if (hasNewOrder) {
                this.playSound();
                showNotification('ğŸ”” æ–°ã—ã„æ³¨æ–‡ãŒå…¥ã‚Šã¾ã—ãŸï¼', 'info');
            }
            
            this.initialized = true;
        } catch (e) {
            console.error('æ³¨æ–‡ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', e);
        }
    },
    
    // é€šçŸ¥éŸ³ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ
    toggleSound() {
        this.soundEnabled = !this.soundEnabled;
        const btn = document.getElementById('soundToggleBtn');
        if (btn) {
            btn.textContent = this.soundEnabled ? 'ğŸ”” é€šçŸ¥éŸ³ON' : 'ğŸ”• é€šçŸ¥éŸ³OFF';
            btn.className = this.soundEnabled 
                ? 'px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 text-sm'
                : 'px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 text-sm';
        }
        showNotification(this.soundEnabled ? 'é€šçŸ¥éŸ³ã‚’ONã«ã—ã¾ã—ãŸ' : 'é€šçŸ¥éŸ³ã‚’OFFã«ã—ã¾ã—ãŸ', 'info');
    }
};


// å…±é€šAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢æ•°
async function apiRequest(endpointOrPath, options = {}) {
  // 'menu' ã¿ãŸã„ãªã‚­ãƒ¼ã§ã‚‚ '/menu' ã¿ãŸã„ãªãƒ‘ã‚¹ã§ã‚‚OK
  const path =
    (typeof API_ENDPOINTS === 'object' && API_ENDPOINTS && API_ENDPOINTS[endpointOrPath])
      ? API_ENDPOINTS[endpointOrPath]
      : endpointOrPath;

  const url = path.startsWith('http')
    ? path
    : `${API_BASE_URL}${String(path).startsWith('/') ? '' : '/'}${path}`;

  const headers = { ...(options.headers || {}) };
  if (!headers['Content-Type'] && options.body !== undefined) {
    headers['Content-Type'] = 'application/json';
  }
  
  // åº—èˆ—IDã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ 
  const storeId = sessionStorage.getItem('cabax_store_id');
  if (storeId) {
    headers['X-Store-Id'] = storeId;
  }

  const res = await fetch(url, { ...options, headers });
  const text = await res.text();

  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

  if (!res.ok) {
    const msg = data?.detail
      ? (typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail))
      : (text || 'API error');
    const err = new Error(`API ${res.status}: ${msg}`);
    err.status = res.status;
    err.data = data;
    throw err;
  }
  return data;
}

// â˜… loadActiveSessionsFromApiã¯å¾Œæ–¹ã§å®šç¾©ï¼ˆé‡è¤‡å‰Šé™¤ï¼‰

async function fetchOrdersForSession(sessionId) {
    try {
        const data = await apiRequest(`/sessions/${sessionId}/orders`);
        return Array.isArray(data) ? data : [];
    } catch (e) {
        console.error('[admin] fetchOrdersForSession error', e);
        return [];
    }
}

// ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã®æç”»ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçœŸå®Ÿï¼‰
function renderTables() {
    const grid = document.getElementById('tablesGrid');
    if (!grid) return;

    const WARN_MINUTES = 10; // ãƒã‚§ãƒƒã‚¯10åˆ†å‰ã§è­¦å‘Šè¡¨ç¤º

    // â˜… APIã®æ—¥ä»˜ã‚’UTCã¨ã—ã¦è§£é‡ˆï¼ˆZã‚„+09:00ãŒç„¡ã„å ´åˆã ã‘Zã‚’è¶³ã™ï¼‰
    const parseApiDate = (iso) => {
        if (!iso || typeof iso !== 'string') return null;
        const s = iso.trim();
        const hasTZ = /Z$|[+\-]\d{2}:\d{2}$/.test(s);
        return new Date(hasTZ ? s : (s + 'Z'));
    };

    // casts ã‹ã‚‰æ‹…å½“åå¼•ã
    const casts = Array.isArray(appState.casts) ? appState.casts : [];
    const getCastName = (castId) => {
        const c = casts.find(x => Number(x.id) === Number(castId));
        return c ? (c.name || c.display_name || c.nickname || `#${c.id}`) : '';
    };

    const now = Date.now();
    const active = Array.isArray(appState.activeSessions) ? appState.activeSessions : [];
    const tables = Array.isArray(appState.tables) ? appState.tables : [];

    grid.innerHTML = tables.map(table => {
        const tId = Number(table.id);

        const session = active.find(s => Number(s.tableId ?? s.table_id) === tId) || null;

        const effectiveStatus = session ? 'occupied' : 'available';

        const statusClass =
            effectiveStatus === 'available' ? 'table-available'
          : effectiveStatus === 'occupied' ? 'table-occupied'
          : 'table-reserved';

        const statusText =
            effectiveStatus === 'available' ? 'ç©ºå¸­'
          : effectiveStatus === 'occupied' ? 'ä½¿ç”¨ä¸­'
          : 'äºˆç´„';

        const iconClass = `table-icon ${effectiveStatus}${table.isVip ? ' vip' : ''}`;

        // ---- è¡¨ç¤ºç”¨ï¼ˆsessionãŒã‚ã‚‹æ™‚ã ã‘ï¼‰ ----
        let castName = '';
        let guests = 0;
        let total = 0;

        // â˜… ãƒã‚§ãƒƒã‚¯é–¢é€£
        let checkTimeText = '-';
        let checkRemainText = '-';
        let checkBadgeClass = 'text-gray-300';
        let cardBorderClass = '';

        if (session) {
            const castId = session.castId ?? session.cast_id ?? null;
            castName = session.castName || getCastName(castId) || 'æœªè¨­å®š';

            guests = Number(session.guests ?? 0);
            total = Number(session.currentTotal ?? session.current_total ?? 0);

            const startStr = session.startTime ?? session.start_time ?? null;
            const startTime = parseApiDate(startStr);

            // â˜… ã‚»ãƒƒãƒˆåˆ†æ•°/å»¶é•·åˆ†æ•°ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ï¼‰
            const setMin = Number(session.setMinutes ?? session.set_minutes ?? 60);
            const extraMin = Number(session.extraMinutes ?? session.extra_minutes ?? 0);
            const totalMin = Math.max(0, setMin + extraMin);

            if (startTime) {
                const checkAt = new Date(startTime.getTime() + totalMin * 60 * 1000);
                const remainingMin = Math.ceil((checkAt.getTime() - now) / (60 * 1000));

                const hh = String(checkAt.getHours()).padStart(2, '0');
                const mm = String(checkAt.getMinutes()).padStart(2, '0');
                checkTimeText = `${hh}:${mm}`;

                if (remainingMin >= 0) {
                    checkRemainText = `ã‚ã¨${remainingMin}åˆ†`;
                } else {
                    checkRemainText = `è¶…é${Math.abs(remainingMin)}åˆ†`;
                }

                // è‰²åˆ†ã‘ï¼ˆæ®‹ã‚Šå°‘ãªã„/è¶…éï¼‰
                if (remainingMin < 0) {
                    checkBadgeClass = 'text-red-300';
                    cardBorderClass = 'ring-2 ring-red-500/40';
                } else if (remainingMin <= WARN_MINUTES) {
                    checkBadgeClass = 'text-amber-300';
                    cardBorderClass = 'ring-2 ring-amber-500/30';
                } else {
                    checkBadgeClass = 'text-emerald-300';
                }
            }
        }

        // â˜… æœªæä¾›æ³¨æ–‡æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        let pendingOrderCount = 0;
        if (session && session.orders) {
            pendingOrderCount = session.orders.filter(o => 
                o.status !== 'served' && !o.is_served
            ).length;
        }

        return `
            <div class="table-card luxury-card rounded-2xl p-6 text-center ${statusClass} ${cardBorderClass}"
                 onclick="openTableDetail(${tId})">

                <div class="${iconClass}">
                    ${table.isVip ? 'â˜…' : (table.name ?? table.id)}
                </div>

                <h3 class="text-2xl font-bold mb-2 text-gray-200">
                    ãƒ†ãƒ¼ãƒ–ãƒ« ${table.name ?? table.id}
                </h3>

                <p class="text-sm font-semibold mb-3 ${
                    effectiveStatus === 'available' ? 'text-green-400'
                  : effectiveStatus === 'occupied' ? 'text-red-400'
                  : 'text-yellow-400'
                }">${statusText}</p>

                ${session ? `
                    <div class="text-xs text-gray-300 space-y-1 text-left bg-gray-900/40 border border-gray-800 rounded-xl p-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">æ‹…å½“</span>
                            <span class="font-semibold text-gray-200">${castName}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">äººæ•°</span>
                            <span class="font-semibold text-gray-200">${guests}å</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">ãƒã‚§ãƒƒã‚¯</span>
                            <span class="font-semibold ${checkBadgeClass}">
                                ${checkTimeText}ï¼ˆ${checkRemainText}ï¼‰
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">å°è¨ˆ</span>
                            <span class="font-bold text-amber-300">Â¥${total.toLocaleString()}</span>
                        </div>
                        ${pendingOrderCount > 0 ? `
                        <div class="flex justify-between mt-1 pt-1 border-t border-gray-700">
                            <span class="text-gray-400">æœªæä¾›</span>
                            <span class="font-bold text-red-400 animate-pulse">âš  ${pendingOrderCount}ä»¶</span>
                        </div>
                        ` : ''}
                    </div>
                ` : `
                    <p class="text-xs text-gray-500">æœªå…¥åº—</p>
                `}
            </div>
        `;
    }).join('');
}

async function handleTableCardClick(tableId) {
    // ã¾ãšæœ€æ–°çŠ¶æ…‹ã«åŒæœŸ
    if (typeof syncWithBackend === 'function') {
        await syncWithBackend();
    }

    // åŒæœŸå¾Œã® tables / activeSessions ã‹ã‚‰æ‹¾ã„ç›´ã™
    const table = appState.tables.find(t => Number(t.id) === Number(tableId)) || null;
    const session = Array.isArray(appState.activeSessions)
        ? appState.activeSessions.find(
            s => Number(s.tableId ?? s.table_id) === Number(tableId)
        )
        : null;

    appState.currentTableDetail = table;
    appState.currentTableSession = session;

    // è©³ç´°ãƒ‘ãƒãƒ«é–‹ã
    if (typeof openTableDetailPanel === 'function') {
        openTableDetailPanel();
    }

    // ä¸­èº«ã‚’æç”»
    if (typeof renderTableDetailPanel === 'function') {
        renderTableDetailPanel();
    }
}

function renderTableDetailPanel(session) {
  const panel = document.getElementById('tableDetailPanel');
  if (!panel) return;
  panel.classList.remove('hidden');

  const s = session || {};
  const hasSession = !!s?.id && s.id !== '-' && s.id !== null && s.id !== undefined;

  const menu = Array.isArray(s._menu) ? s._menu : [];
  const orders = Array.isArray(s._orders) ? s._orders : [];
  const casts = Array.isArray(s._casts) ? s._casts : [];

  const fmtDT = (iso) => {
    if (!iso) return 'â€”';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return String(iso);
    return d.toLocaleString('ja-JP', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  };

  const yen = (n) => (Number(n || 0)).toLocaleString('ja-JP');

  const setMinutes = Number(s.set_minutes ?? 60);
  const extraMinutes = Number(s.extra_minutes ?? 0);

  const optSet = (v) => `<option value="${v}" ${setMinutes === v ? 'selected' : ''}>${v}åˆ†</option>`;

  // ===== Cabax: Dark + Navy + Gold accent =====
  const gold = "text-[#d6b36a]";
  const borderGold = "border-[#3a2a0a]";
  const card = "bg-[#0f141b]/80 border border-white/10";
  const shadowLux = "shadow-[0_20px_60px_rgba(0,0,0,0.55)]";

  const btnBase = "px-4 py-2 rounded-xl font-semibold transition active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed";
  const btnPri = `${btnBase} bg-[#0b1b3a] text-white hover:bg-[#0e234a] border border-white/10`;
  const btnSec = `${btnBase} bg-white/5 text-white hover:bg-white/10 border border-white/10`;
  const btnDis = `${btnBase} bg-white/5 text-white/30 border border-white/10`;

  // ãƒ‰ãƒªãƒ³ã‚¯ä¾¡æ ¼è¡¨ç¤º
  const customerDrinkNames = ['ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼', 'ã‚³ãƒ¼ã‚¯ãƒã‚¤', 'ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ãƒã‚¤', 'ãƒ“ãƒ¼ãƒ«', 'ã‚«ã‚¯ãƒ†ãƒ«', 'ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯'];
  const castDrinkNames = ['éº¦ç„¼é…', 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼'];
  const paidDrinkNames = ['ã‚·ãƒ§ãƒƒãƒˆ', 'ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³'];
  const tableSetNames = ['ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆ', 'ã‚¢ã‚¤ã‚¹ï¼ˆè¿½åŠ ï¼‰', 'ã‚°ãƒ©ã‚¹ï¼ˆè¿½åŠ ï¼‰', 'ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'ç·‘èŒ¶ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'ç‚­é…¸æ°´', 'ç´…èŒ¶ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'ã‚¸ãƒ£ã‚¹ãƒŸãƒ³èŒ¶ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'ãƒŸãƒãƒ©ãƒ«ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼'];
  
  const menuOptions = menu.length
    ? menu.map(m => {
        let priceLabel = `Â¥${yen(m.price)}`;
        if (customerDrinkNames.includes(m.name)) {
          priceLabel = 'ã‚»ãƒƒãƒˆè¾¼';
        } else if (castDrinkNames.includes(m.name)) {
          priceLabel = 'ã‚µã‚¤ã‚ºåˆ¥';
        } else if (tableSetNames.includes(m.name)) {
          priceLabel = 'ã‚»ãƒƒãƒˆè¾¼';
        } else if (paidDrinkNames.includes(m.name)) {
          priceLabel = `Â¥${yen(m.price)}`;
        }
        return `<option value="${m.id}">${m.name}ï¼ˆ${priceLabel}ï¼‰</option>`;
      }).join('')
    : `<option value="">ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼æœªå–å¾—ï¼‰</option>`;

  const castOptions = (() => {
  const freeOpt = `<option value="free">ãƒ•ãƒªãƒ¼</option>`;
  if (!casts.length) return `${freeOpt}<option value="">ï¼ˆã‚­ãƒ£ã‚¹ãƒˆæœªå–å¾—ï¼‰</option>`;
  const list = casts
    .map(c => `<option value="${c.id}">${c.stage_name ?? c.name ?? `Cast#${c.id}`}</option>`)
    .join('');
  return `${freeOpt}${list}`;
})();

  // è¤‡æ•°æŒ‡åã‚­ãƒ£ã‚¹ãƒˆç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
  const castCheckboxes = (() => {
    if (!casts.length) return '<div class="text-white/50 text-sm">ã‚­ãƒ£ã‚¹ãƒˆæœªå–å¾—</div>';
    return casts.map(c => `
      <label class="flex items-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30 hover:border-amber-500/30">
        <input type="checkbox" class="shimei-cast-checkbox w-4 h-4 accent-[#d6b36a]" value="${c.id}" data-name="${c.stage_name ?? c.name ?? `Cast#${c.id}`}">
        <span class="text-sm text-white/90">${c.stage_name ?? c.name ?? `Cast#${c.id}`}</span>
      </label>
    `).join('');
  })();

  const ordersHtml = orders.length
    ? orders.map((o, idx) => {
        const line = (Number(o.price || 0) * Number(o.quantity || 0));
        const isServed = o.status === 'served' || o.is_served;
        const statusClass = isServed 
          ? 'bg-green-500/20 text-green-400 border-green-500/30' 
          : 'bg-amber-500/20 text-amber-400 border-amber-500/30';
        const statusText = isServed ? 'âœ“ æä¾›æ¸ˆ' : 'â³ æœªæä¾›';
        const statusBtnClass = isServed
          ? 'bg-gray-600/50 text-gray-400 hover:bg-red-500/30 hover:text-red-400'
          : 'bg-green-600/30 text-green-400 hover:bg-green-500/50';
        const statusBtnText = isServed ? 'æœªæä¾›ã«æˆ»ã™' : 'æä¾›æ¸ˆã¿ã«ã™ã‚‹';
        
        return `
          <div class="flex items-center justify-between gap-3 py-3 border-b border-white/10" data-order-id="${o.id}" data-order-idx="${idx}">
            <div class="min-w-0 flex-1">
              <div class="flex items-center gap-2">
                <span class="text-white/90 font-semibold truncate">${o.item_name ?? `#${o.menu_item_id}`}</span>
                <span class="px-2 py-0.5 text-[10px] font-bold rounded-full border ${statusClass}">${statusText}</span>
              </div>
              <div class="text-xs text-white/45 mt-1">${fmtDT(o.created_at)} / æ•°é‡ ${o.quantity}</div>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <div class="text-white/90 font-bold">Â¥${yen(line)}</div>
                <div class="text-xs text-white/45">å˜ä¾¡ Â¥${yen(o.price)}</div>
              </div>
              <button 
                onclick="toggleOrderStatus(${s.id}, ${o.id}, ${isServed ? 'false' : 'true'})"
                class="px-2 py-1 text-xs rounded-lg transition ${statusBtnClass}"
              >${statusBtnText}</button>
            </div>
          </div>
        `;
      }).join('')
    : `<div class="text-white/50 text-sm">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;

  panel.innerHTML = `
  <div id="tableDetailOverlay" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-3">
    <div id="tableDetailModal" class="w-full max-w-2xl max-h-[92vh] flex flex-col rounded-2xl overflow-hidden ${shadowLux} border ${borderGold} bg-gradient-to-b from-[#0b0f14] to-[#070a0d]">

      <div class="sticky top-0 z-10 p-4 border-b border-white/10 bg-[#070a0d]/90 backdrop-blur">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-[11px] tracking-widest uppercase text-white/50">Table Detail</div>
            <div class="text-2xl font-extrabold text-white">
              ãƒ†ãƒ¼ãƒ–ãƒ« <span class="${gold}">${s.table_id ?? 'â€”'}</span>
            </div>
            <div class="text-xs text-white/50 mt-1">
              Session: <span class="text-white/80">${hasSession ? s.id : 'ãªã—'}</span>
            </div>
          </div>
          <button id="btnCloseTableDetail" class="${btnSec}">é–‰ã˜ã‚‹</button>
        </div>
        <div id="tableDetailMsg" class="text-sm text-white/70 mt-3"></div>
      </div>

      <div class="p-4 space-y-4 overflow-y-auto">

        ${
          !hasSession ? `
          <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆç®¡ç†ã‹ã‚‰é–‹å§‹ã§ãã‚‹ã‚ˆã†ã«å¾©æ´»ï¼‰ -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆç®¡ç†ï¼‰</div>
            
            <!-- åŸºæœ¬æƒ…å ± -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">å®¢äººæ•°</div>
                <input id="inpStartGuests" type="number" min="1" value="1"
                       onchange="updateStartCharges()"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
              </label>
              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">ã‚­ãƒ£ãƒƒãƒï¼ˆä»»æ„ï¼‰</div>
                <input id="inpStartCatch" type="text" placeholder="ä¾‹ï¼‰å±±ç”°"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
              </label>
            </div>
            
            <!-- æŒ‡åã‚­ãƒ£ã‚¹ãƒˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰ -->
            <div class="border-t border-white/10 pt-4 mt-4">
              <div class="font-bold text-white mb-3 flex items-center gap-2">
                ğŸ‘‘ æŒ‡å
                <span class="text-xs text-white/40">ï¼ˆè¤‡æ•°å¯ãƒ»ãƒãƒƒã‚¯ã¯äººæ•°ã§ç­‰åˆ†ï¼‰</span>
              </div>
              <div class="text-xs text-white/50 mb-2">â€» æŒ‡åãªã—ã®å ´åˆã¯ã€Œãƒ•ãƒªãƒ¼ã€æ‰±ã„</div>
              <div id="shimeiCastList" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto pr-2 scrollbar-thin">
                ${castCheckboxes}
              </div>
              <div id="shimeiCastPreview" class="mt-2 text-sm text-amber-400"></div>
            </div>
            
            <!-- æ–™é‡‘è¨­å®š -->
            <div class="border-t border-white/10 pt-4 mt-4">
              <div class="font-bold text-white mb-3 flex items-center gap-2">
                ğŸ’° æ–™é‡‘è¨­å®š
                <span class="text-xs text-white/40">ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«è‡ªå‹•è¨ˆä¸Šï¼‰</span>
              </div>
              
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                <!-- ã‚»ãƒƒãƒˆæ–™é‡‘ -->
                <label class="block">
                  <div class="text-[11px] text-white/50 mb-1">ã‚»ãƒƒãƒˆæ–™é‡‘ï¼ˆ1åã‚ãŸã‚Šï¼‰</div>
                  <input id="inpSetPrice" type="number" min="0" step="100" value="5000"
                         onchange="updateStartCharges()"
                         class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                </label>
                
                <!-- TAX/ã‚µãƒ¼ãƒ“ã‚¹æ–™ -->
                <label class="block">
                  <div class="text-[11px] text-white/50 mb-1">TAX/ã‚µãƒ¼ãƒ“ã‚¹æ–™ï¼ˆ%ï¼‰</div>
                  <select id="selTaxRate" onchange="updateStartCharges()"
                          class="rounded-xl px-3 py-2 w-full bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                    <option value="0">0%ï¼ˆã‚«ãƒƒãƒˆï¼‰</option>
                    <option value="10">10%</option>
                    <option value="15">15%</option>
                    <option value="20" selected>20%</option>
                    <option value="25">25%</option>
                    <option value="30">30%</option>
                  </select>
                </label>
              </div>
              
              <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ–™é‡‘ -->
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-3">
                <label class="flex items-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                  <input id="chkDouhan" type="checkbox" onchange="updateStartCharges()" class="w-4 h-4 accent-[#d6b36a]">
                  <span class="text-sm text-white/90">åŒä¼´ <span class="text-amber-400">Â¥3,000</span></span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                  <input id="chkSingle" type="checkbox" onchange="updateStartCharges()" class="w-4 h-4 accent-[#d6b36a]">
                  <span class="text-sm text-white/90">ã‚·ãƒ³ã‚°ãƒ« <span class="text-amber-400">Â¥2,000</span></span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                  <input id="chkFree" type="checkbox" onchange="updateStartCharges()" class="w-4 h-4 accent-[#d6b36a]">
                  <span class="text-sm text-white/90">ãƒ•ãƒªãƒ¼ <span class="text-gray-400">å‰²å¼•</span></span>
                </label>
              </div>
              
              <!-- æ–™é‡‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
              <div id="startChargesPreview" class="p-3 rounded-xl bg-gradient-to-r from-amber-900/20 to-transparent border border-amber-500/20">
                <div class="text-xs text-white/50 mb-2">é–‹å§‹æ™‚ã®è‡ªå‹•è¨ˆä¸Šé¡ï¼ˆç¨ã‚µè¾¼ï¼‰</div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div class="text-white/70">ã‚»ãƒƒãƒˆæ–™é‡‘:</div>
                  <div id="previewSetTotal" class="text-right text-white font-semibold">Â¥5,000</div>
                  <div class="text-white/70">ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸:</div>
                  <div id="previewSingle" class="text-right text-white font-semibold">Â¥2,000</div>
                  <div class="text-white/70">åŒä¼´æ–™:</div>
                  <div id="previewDouhan" class="text-right text-white font-semibold">Â¥0</div>
                  <div class="text-white/70">æŒ‡åæ–™:</div>
                  <div id="previewShimei" class="text-right text-white font-semibold">Â¥0</div>
                  <div class="text-white/70">TAX/ã‚µãƒ¼ãƒ“ã‚¹:</div>
                  <div id="previewTax" class="text-right text-white font-semibold">Â¥0</div>
                  <div class="border-t border-white/20 pt-2 text-white font-bold">åˆè¨ˆ:</div>
                  <div id="previewTotal" class="border-t border-white/20 pt-2 text-right text-amber-400 font-bold text-lg">Â¥0</div>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end mt-4">
              <button id="btnStartSession" class="${btnPri}">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§é–‹å§‹</button>
            </div>
            <div class="text-xs text-white/45 mt-2">
              â€»é–‹å§‹ã™ã‚‹ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€Œä½¿ç”¨ä¸­ã€æ‰±ã„ã«ãªã‚Šã€ä»¥å¾Œã¯å»¶é•·/æ³¨æ–‡/ç²¾ç®—ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚
            </div>
          </div>
          ` : `
          <!-- KPI -->
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">é–‹å§‹</div>
              <div class="font-semibold text-white/90">${fmtDT(s.start_time)}</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">ãƒã‚§ãƒƒã‚¯äºˆå®š</div>
              <div class="font-semibold ${gold}">${fmtDT(s.check_due_at)}</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">å°è¨ˆï¼ˆDBï¼‰</div>
              <div class="font-extrabold text-lg text-white">Â¥${yen(s.current_total)}</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">ã‚»ãƒƒãƒˆåˆ†æ•°</div>
              <div class="font-semibold text-white/90">${setMinutes}åˆ†</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">å»¶é•·åˆ†</div>
              <div class="font-semibold text-white/90">+${extraMinutes}åˆ†</div>
            </div>
            <div class="p-3 rounded-2xl ${card}">
              <div class="text-[11px] text-white/50">å»¶é•·å›æ•°</div>
              <div class="font-semibold text-white/90">${Number(s.extension_count ?? 0)}å›</div>
            </div>
          </div>

          <!-- ä¼šè¨ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
          ${(() => {
            const taxRate = Number(s.tax_rate ?? 20);
            const currentSubtotal = Number(s.current_total ?? 0);
            const guests = Number(s.guests ?? 1);
            
            // æŒ‡åã‚­ãƒ£ã‚¹ãƒˆæ•°ã‚’å–å¾—
            const shimeiCastsStr = s.shimei_casts || '';
            const shimeiCount = shimeiCastsStr ? shimeiCastsStr.split(',').filter(n => n.trim()).length : 0;
            
            // ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ï¼ˆ1åã®å ´åˆã®ã¿ï¼‰
            const singleCharge = guests === 1 ? 2000 : 0;
            
            // 30åˆ†å»¶é•·æ–™é‡‘ï¼ˆãƒãƒ¼ãƒ•ï¼‰= äººæ•°Ã—3000 + æŒ‡åæ•°Ã—2000 + ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸
            const halfExtension = (guests * 3000) + (shimeiCount * 2000) + singleCharge;
            // 60åˆ†å»¶é•·æ–™é‡‘ï¼ˆ1ã‚»ãƒƒãƒˆï¼‰= äººæ•°Ã—5000 + æŒ‡åæ•°Ã—2000 + ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸
            const fullExtension = (guests * 5000) + (shimeiCount * 2000) + singleCharge;
            
            // ç¾åœ¨ã®ä¼šè¨ˆ
            const currentTax = Math.floor(currentSubtotal * (taxRate / 100));
            const currentTotal = currentSubtotal + currentTax;
            
            // 30åˆ†å»¶é•·æ™‚
            const subtotal30 = currentSubtotal + halfExtension;
            const tax30 = Math.floor(subtotal30 * (taxRate / 100));
            const total30 = subtotal30 + tax30;
            
            // 60åˆ†å»¶é•·æ™‚
            const subtotal60 = currentSubtotal + fullExtension;
            const tax60 = Math.floor(subtotal60 * (taxRate / 100));
            const total60 = subtotal60 + tax60;
            
            // å»¶é•·å†…è¨³ã®èª¬æ˜æ–‡
            const ext30Desc = `${guests}åÃ—3000${singleCharge > 0 ? ' + SC' : ''}${shimeiCount > 0 ? ` + æŒ‡å${shimeiCount}Ã—2000` : ''}`;
            const ext60Desc = `${guests}åÃ—5000${singleCharge > 0 ? ' + SC' : ''}${shimeiCount > 0 ? ` + æŒ‡å${shimeiCount}Ã—2000` : ''}`;
            
            return `
          <div class="p-4 rounded-2xl border border-amber-500/30 bg-amber-500/5">
            <div class="font-bold text-white mb-3">ğŸ’° ä¼šè¨ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ <span class="text-white/40 text-xs">ï¼ˆTAX ${taxRate}%è¾¼ï¼‰</span></div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div class="p-3 rounded-xl bg-black/30 border border-white/10">
                <div class="text-[11px] text-white/50 mb-1">ä»Šã™ãä¼šè¨ˆ</div>
                <div class="text-xs text-white/60">å°è¨ˆ: Â¥${yen(currentSubtotal)}</div>
                <div class="text-xs text-white/60">TAX: Â¥${yen(currentTax)}</div>
                <div class="font-extrabold text-xl ${gold}">Â¥${yen(currentTotal)}</div>
              </div>
              <div class="p-3 rounded-xl bg-black/30 border border-blue-500/30">
                <div class="text-[11px] text-blue-400 mb-1">+30åˆ†å»¶é•·å¾Œ</div>
                <div class="text-xs text-white/60">+Â¥${yen(halfExtension)}ï¼ˆ${ext30Desc}ï¼‰</div>
                <div class="text-xs text-white/60">å°è¨ˆ: Â¥${yen(subtotal30)} / TAX: Â¥${yen(tax30)}</div>
                <div class="font-extrabold text-xl text-blue-300">Â¥${yen(total30)}</div>
                <div class="text-[10px] text-white/40 mt-1">ï¼ˆ+Â¥${yen(total30 - currentTotal)}ï¼‰</div>
              </div>
              <div class="p-3 rounded-xl bg-black/30 border border-purple-500/30">
                <div class="text-[11px] text-purple-400 mb-1">+60åˆ†å»¶é•·å¾Œ</div>
                <div class="text-xs text-white/60">+Â¥${yen(fullExtension)}ï¼ˆ${ext60Desc}ï¼‰</div>
                <div class="text-xs text-white/60">å°è¨ˆ: Â¥${yen(subtotal60)} / TAX: Â¥${yen(tax60)}</div>
                <div class="font-extrabold text-xl text-purple-300">Â¥${yen(total60)}</div>
                <div class="text-[10px] text-white/40 mt-1">ï¼ˆ+Â¥${yen(total60 - currentTotal)}ï¼‰</div>
              </div>
            </div>
          </div>
            `;
          })()}

          <!-- å»¶é•·è¨ˆç®—å…¥åŠ› -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">å»¶é•·è¨ˆç®—ã®å…¥åŠ› <span class="text-white/40 text-xs">ï¼ˆæ¬¡å›å»¶é•·ã‹ã‚‰åæ˜ ï¼‰</span></div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">å®¢äººæ•°</div>
                <input id="inpGuests" type="number" min="0"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60"
                       value="${Number(s.guests ?? 0)}">
              </label>

              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">å ´å†…æŒ‡åäººæ•°</div>
                <input id="inpInhouse" type="number" min="0"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60"
                       value="${Number(s.inhouse_nomination_count ?? 0)}">
              </label>

              <label class="flex items-center gap-2 mt-2 sm:mt-7">
                <input id="chkHon" type="checkbox" class="w-4 h-4 accent-[#d6b36a]"
                       ${s.has_hon_nomination ? 'checked' : ''}>
                <span class="font-semibold text-white/90">æœ¬æŒ‡å <span class="${gold}">ï¼ˆ+3000ï¼‰</span></span>
              </label>
            </div>
            <div class="flex justify-end mt-4">
              <button id="btnSaveAttrs" class="${btnSec}">ä¿å­˜</button>
            </div>
          </div>

          <!-- ã‚»ãƒƒãƒˆåˆ†æ•° -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">ã‚»ãƒƒãƒˆåˆ†æ•°ã®å¤‰æ›´</div>
            <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
              <select id="selSetMinutes"
                      class="rounded-xl px-3 py-2 w-full sm:w-48 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                ${optSet(30)}${optSet(45)}${optSet(60)}${optSet(90)}${optSet(120)}${optSet(150)}${optSet(180)}
              </select>
              <button id="btnUpdateTiming" class="${btnSec}">
                ã‚»ãƒƒãƒˆåˆ†æ•°ã‚’æ›´æ–°
              </button>
            </div>
            <div class="text-xs text-white/45 mt-2">
              â€»ãƒã‚§ãƒƒã‚¯äºˆå®šæ™‚åˆ»ã¯ã€Œé–‹å§‹ + ã‚»ãƒƒãƒˆåˆ†æ•° + å»¶é•·åˆ†ã€ã€‚
            </div>
          </div>

          <!-- å»¶é•· -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">å»¶é•· <span class="${gold}">ï¼ˆè‡ªå‹•æ³¨æ–‡ãŒå…¥ã‚Šã¾ã™ï¼‰</span></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <button id="btnExtend30" class="${btnPri}">
                ãƒãƒ¼ãƒ•å»¶é•· 30åˆ†ï¼ˆè‡ªå‹•æ³¨æ–‡ï¼‰
              </button>
              <button id="btnExtend60" class="${btnPri}">
                1ã‚»ãƒƒãƒˆå»¶é•· 60åˆ†ï¼ˆè‡ªå‹•æ³¨æ–‡ï¼‰
              </button>
            </div>
          </div>

          <!-- è¿½åŠ æ³¨æ–‡ -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">è¿½åŠ æ³¨æ–‡</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="block sm:col-span-2">
                <div class="text-[11px] text-white/50 mb-1">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
                <select id="selAddOrderItem" onchange="onOrderMenuChange()"
                        class="rounded-xl px-3 py-2 w-full bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                  ${menuOptions}
                </select>
              </label>
              
              <!-- ãƒ‰ãƒªãƒ³ã‚¯ã‚µã‚¤ã‚ºé¸æŠï¼ˆãƒ‰ãƒªãƒ³ã‚¯ã‚«ãƒ†ã‚´ãƒªæ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
              <div id="drinkSizeSection" class="sm:col-span-2 hidden">
                <div class="text-[11px] text-white/50 mb-1">ãƒ‰ãƒªãƒ³ã‚¯ã‚µã‚¤ã‚º</div>
                <div class="grid grid-cols-3 gap-2">
                  <label class="drink-size-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border-2 border-amber-500 bg-amber-500/20 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkSize" value="single" checked onchange="updateDrinkSizeStyle()" class="hidden">
                    <span class="text-sm text-white/90 text-center">ã‚·ãƒ³ã‚°ãƒ«<br><span class="text-amber-400 font-bold">Â¥1,000</span></span>
                  </label>
                  <label class="drink-size-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkSize" value="double" onchange="updateDrinkSizeStyle()" class="hidden">
                    <span class="text-sm text-white/90 text-center">ãƒ€ãƒ–ãƒ«<br><span class="text-amber-400 font-bold">Â¥2,000</span></span>
                  </label>
                  <label class="drink-size-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkSize" value="triple" onchange="updateDrinkSizeStyle()" class="hidden">
                    <span class="text-sm text-white/90 text-center">ãƒˆãƒªãƒ—ãƒ«<br><span class="text-amber-400 font-bold">Â¥3,000</span></span>
                  </label>
                </div>
              </div>
              
              <!-- å‰²ã‚Šæ–¹ãƒ»ç¨®é¡é¸æŠï¼ˆéº¦ç„¼é…ã€ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ã€ãƒ“ãƒ¼ãƒ«ã€ã‚«ã‚¯ãƒ†ãƒ«ã€ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯ã€ã‚·ãƒ§ãƒƒãƒˆã€ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
              <div id="mixStyleSection" class="sm:col-span-2 hidden">
                <div class="text-[11px] text-white/50 mb-1">ç¨®é¡ã‚’é¸æŠ</div>
                <div id="mixStyleOptions" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                  <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
              </div>
              
              <!-- èª°ãŒé£²ã‚€ã‹é¸æŠï¼ˆãƒ‰ãƒªãƒ³ã‚¯/ãƒœãƒˆãƒ«/ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
              <div id="drinkForSection" class="sm:col-span-2 hidden">
                <div class="text-[11px] text-white/50 mb-1">èª°ãŒé£²ã‚€ï¼Ÿ</div>
                <div class="grid grid-cols-3 gap-2 mb-2">
                  <label class="drink-for-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border-2 border-blue-500 bg-blue-500/20 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkFor" value="customer" checked onchange="onDrinkForChange(); updateDrinkForStyle()" class="hidden">
                    <span class="text-sm text-white/90">ğŸ‘¤ ãŠå®¢æ§˜</span>
                  </label>
                  <label class="drink-for-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkFor" value="staff" onchange="onDrinkForChange(); updateDrinkForStyle()" class="hidden">
                    <span class="text-sm text-white/90">ğŸ§‘â€ğŸ’¼ ã‚¹ã‚¿ãƒƒãƒ•</span>
                  </label>
                  <label class="drink-for-label flex items-center justify-center gap-2 p-2 rounded-xl bg-black/20 border border-white/10 cursor-pointer hover:bg-black/30">
                    <input type="radio" name="drinkFor" value="cast" onchange="onDrinkForChange(); updateDrinkForStyle()" class="hidden">
                    <span class="text-sm text-white/90">ã‚­ãƒ£ã‚¹ãƒˆ</span>
                  </label>
                </div>
                
                <!-- ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•é¸æŠï¼ˆã‚­ãƒ£ã‚¹ãƒˆorã‚¹ã‚¿ãƒƒãƒ•é¸æŠæ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="personSelectSection" class="hidden">
                  <select id="selDrinkPerson"
                          class="rounded-xl px-3 py-2 w-full bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                  </select>
                  <div id="drinkBackInfo" class="mt-2 text-xs text-purple-400 hidden">
                    
                  </div>
                </div>
              </div>
              
              <label class="block">
                <div class="text-[11px] text-white/50 mb-1">æ•°é‡</div>
                <input id="inpAddOrderQty" type="number" min="1" value="1"
                       class="w-full rounded-xl px-3 py-2 bg-black/40 border border-white/10 text-white outline-none focus:border-[#d6b36a]/60">
              </label>
            </div>
            <div class="flex justify-end mt-4">
              <button id="btnAddOrder" class="${btnPri}">
                æ³¨æ–‡ã‚’è¿½åŠ 
              </button>
            </div>
          </div>

          <!-- æ³¨æ–‡å±¥æ­´ -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="font-bold text-white mb-3">æ³¨æ–‡å±¥æ­´ï¼ˆDBï¼‰</div>
            <div class="max-h-64 overflow-y-auto pr-1">
              ${ordersHtml}
            </div>
          </div>

          <!-- ç²¾ç®— -->
          <div class="p-4 rounded-2xl border border-white/10 bg-white/3">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="font-bold text-white">ç²¾ç®—</div>
                <div class="text-xs text-white/45">â€»DBæ³¨æ–‡åˆè¨ˆã‹ã‚‰å†è¨ˆç®—ï¼ˆcheckoutï¼‰</div>
              </div>
              <button id="btnCheckout" class="${btnPri}">
                ç²¾ç®—ã™ã‚‹
              </button>
            </div>
          </div>
          `
        }

        <div class="h-2"></div>
      </div>
    </div>
  </div>
  `;
}


function showTableDetailPanel({ tableId, session, orders }) {
    const panel = document.getElementById('tableDetailPanel');
    if (!panel) {
        console.error('[admin] tableDetailPanel ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // â˜… ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡ã„ï¼ˆï¼ç©ºå¸­ãƒ»ã¾ã å…¥åº—ã—ã¦ã„ãªã„ï¼‰
    if (!session) {
        panel.innerHTML = `
            <div class="p-4 space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-100">
                        ãƒ†ãƒ¼ãƒ–ãƒ« ${tableId}
                    </h2>
                    <button class="text-sm text-gray-400" onclick="closeTableDetailPanel()">âœ•</button>
                </div>
                <p class="text-sm text-gray-400">ã¾ã å…¥åº—å‡¦ç†ãŒã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
            </div>
        `;
        panel.classList.remove('hidden');
        return;
    }

    const total = (
        session.currentTotal ?? session.current_total ?? 0
    );

    panel.innerHTML = `
        <div class="p-4 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-100">
                    ãƒ†ãƒ¼ãƒ–ãƒ« ${tableId}ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${session.id}ï¼‰
                </h2>
                <button class="text-sm text-gray-400" onclick="closeTableDetailPanel()">âœ•</button>
            </div>

            <div class="space-y-1 text-sm text-gray-300">
                <p>äººæ•°ï¼š${session.guests}å</p>
                <p>ã‚­ãƒ£ãƒƒãƒï¼š${session.catchStaff || 'ãªã—'}</p>
                <p class="font-semibold text-amber-300">
                    ç¾åœ¨åˆè¨ˆï¼šÂ¥${total.toLocaleString()}
                </p>
            </div>

            <div class="pt-2 border-t border-gray-700">
                <h3 class="text-sm font-semibold text-gray-200 mb-2">æ³¨æ–‡å±¥æ­´</h3>
                <p class="text-sm text-gray-500">
                    â€» ä»Šã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® current_total ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ï¼ˆå±¥æ­´ã¯å¾Œã§è¿½åŠ ï¼‰
                </p>
            </div>

            <div class="flex gap-2 pt-4 border-t border-gray-700">
                <button class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg text-sm"
                        onclick="checkoutSession(${session.id})">
                    æ¸…ç®—ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼‰
                </button>
            </div>
        </div>
    `;

    panel.classList.remove('hidden');
}

// â˜… æ¸…ç®—ãƒœã‚¿ãƒ³ï¼šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§æ¸…ç®— â†’ APIã‹ã‚‰æœ€æ–°çŠ¶æ…‹ã‚’å–ã‚Šç›´ã—ã¦åæ˜ 
async function checkoutSession(sessionId) {
    
    
    
    if (!confirm('ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¸…ç®—ã—ã¦ç©ºå¸­ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }

    try {
        // â˜… ç²¾ç®—å‰ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜ï¼ˆAPIã‹ã‚‰æ¶ˆãˆã‚‹å‰ã«ï¼‰
        // å‹ã‚’ä¸¡æ–¹è©¦ã™ï¼ˆæ•°å€¤ã¨æ–‡å­—åˆ—ï¼‰
        const numId = Number(sessionId);
        const sessionToCheckout = appState.activeSessions.find(s => 
            Number(s.id) === numId
        );
        
        // â˜… ä¼ç¥¨ç”¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã¨æ³¨æ–‡ã‚’å–å¾—
        let ordersForReceipt = [];
        try {
            const ordersData = await apiRequest(`/sessions/${sessionId}/orders`);
            ordersForReceipt = Array.isArray(ordersData) ? ordersData : [];
        } catch (e) {
            console.warn('[checkout] orders fetch failed:', e);
            ordersForReceipt = sessionToCheckout?.orders || [];
        }
        
        // â˜… ä¼šè¨ˆæ™‚ã«TAXã‚’è¨ˆç®—
        const taxRate = sessionToCheckout?.taxRate || sessionToCheckout?.tax_rate || 20;
        const subtotalAmount = ordersForReceipt.reduce((sum, o) => sum + (o.price * o.quantity), 0);
        const taxAmount = Math.floor(subtotalAmount * (taxRate / 100));
        const totalWithTax = subtotalAmount + taxAmount;
        
        // TAXã‚’æ³¨æ–‡ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºç”¨ï¼‰
        if (taxAmount > 0) {
            ordersForReceipt.push({
                item_name: `TAX/ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ${taxRate}%ï¼‰`,
                quantity: 1,
                price: taxAmount
            });
        }
        
        // 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§æ¸…ç®—
        const result = await apiRequest(`${API_ENDPOINTS.sessions}/${sessionId}/checkout`, {
            method: 'PUT',
        });
        

        // â˜… checkoutHistoryã«è¿½åŠ ï¼ˆç²¾ç®—æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿æŒï¼‰
        if (sessionToCheckout) {
            const checkoutRecord = {
                ...sessionToCheckout,
                checkoutTime: new Date().toISOString(),
                totalAmount: totalWithTax,
                orders: ordersForReceipt, // æ³¨æ–‡å±¥æ­´ã‚’ä¿å­˜
                status: 'completed'
            };
            appState.checkoutHistory.push(checkoutRecord);
            
            
            
            // localStorageã«ã‚‚ä¿å­˜
            try {
                localStorage.setItem('cabax_checkoutHistory', JSON.stringify(appState.checkoutHistory));
                
            } catch (e) {
                console.warn('localStorageä¿å­˜ã«å¤±æ•—:', e);
            }
            
            // â˜… ä¼ç¥¨ã‚’è¡¨ç¤º
            console.log('[checkout] showReceiptå‘¼ã³å‡ºã—', sessionToCheckout, ordersForReceipt);
            showReceipt(sessionToCheckout, ordersForReceipt);
        } else {
            console.warn('[checkout] sessionToCheckout not found!');
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªãã¦ã‚‚æœ€ä½é™ã®ä¼ç¥¨ã‚’è¡¨ç¤º
            showReceipt({ 
                guests: 0, 
                castName: 'ä¸æ˜', 
                tableName: 'ä¸æ˜', 
                currentTotal: 0 
            }, ordersForReceipt);
        }

        // 2. ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ API ã‹ã‚‰å–ã‚Šç›´ã™
        if (typeof loadTablesFromApi === 'function') {
            await loadTablesFromApi();
        }
        if (typeof loadActiveSessionsFromApi === 'function') {
            await loadActiveSessionsFromApi();
        }

        // 3. å†æç”» & è©³ç´°ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        if (typeof renderTables === 'function') {
            renderTables();
        }
        if (typeof closeTableDetailPanel === 'function') {
            closeTableDetailPanel();
        }
        
        // â˜… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»æ—¥å ±ãƒ»ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°
        if (typeof updateDashboard === 'function') updateDashboard();
        if (typeof renderDailyReport === 'function') renderDailyReport();
        if (typeof renderReports === 'function') renderReports();
        

    } catch (e) {
        console.error('[admin] checkoutSession error', e);
        alert('æ¸…ç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

// â˜… ä¼ç¥¨ã‚’è¡¨ç¤º
function showReceipt(session, orders) {
    console.log('[showReceipt] é–‹å§‹', session, orders);
    
    const guests = session.guests || 0;
    // ã‚­ãƒ£ã‚¹ãƒˆåã‚’ç›´æ¥å–å¾—ï¼ˆgetCastNameãŒä½¿ãˆãªã„å ´åˆã«å‚™ãˆã‚‹ï¼‰
    let castName = session.castName || session.cast_name || '';
    if (!castName && (session.castId || session.cast_id)) {
        const castId = session.castId || session.cast_id;
        const cast = (appState.casts || []).find(c => Number(c.id) === Number(castId));
        castName = cast ? (cast.stage_name || cast.name) : '';
    }
    castName = castName || 'æœªè¨­å®š';
    
    const tableName = session.tableName || session.table_name || session.tableId || '?';
    const now = new Date();
    
    // æ³¨æ–‡ã‚’æ•´å½¢
    const orderItems = orders.map(o => {
        const itemName = o.item_name || o.itemName || 'å•†å“';
        const qty = o.quantity || 1;
        const price = o.price || 0;
        const subtotal = price * qty;
        return { name: itemName, qty, price, subtotal };
    });
    
    // TAX/ã‚µãƒ¼ãƒ“ã‚¹æ–™ã‚’åˆ†é›¢ã—ã¦è¨ˆç®—
    const taxItem = orderItems.find(item => item.name.includes('TAX') || item.name.includes('ã‚µãƒ¼ãƒ“ã‚¹'));
    const itemsWithoutTax = orderItems.filter(item => !item.name.includes('TAX') && !item.name.includes('ã‚µãƒ¼ãƒ“ã‚¹'));
    
    // ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ã‚’ã¾ã¨ã‚ã‚‹
    const singleChargeItems = itemsWithoutTax.filter(item => item.name.includes('ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸'));
    const otherItems = itemsWithoutTax.filter(item => !item.name.includes('ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸'));
    
    // ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ã‚’1è¡Œã«ã¾ã¨ã‚ã‚‹
    let consolidatedItems = [...otherItems];
    if (singleChargeItems.length > 0) {
        const totalSingleQty = singleChargeItems.reduce((sum, item) => sum + item.qty, 0);
        const totalSingleAmount = singleChargeItems.reduce((sum, item) => sum + item.subtotal, 0);
        consolidatedItems.push({
            name: 'ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸',
            qty: totalSingleQty,
            price: 2000,
            subtotal: totalSingleAmount
        });
    }
    
    // ä¸¦ã³é †: ã‚»ãƒƒãƒˆæ–™é‡‘ â†’ æŒ‡åæ–™ â†’ åŒä¼´æ–™ â†’ å»¶é•·æ–™é‡‘ â†’ ãƒ‰ãƒªãƒ³ã‚¯ç­‰ â†’ ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸
    const sortOrder = (name) => {
        if (name.includes('ã‚»ãƒƒãƒˆæ–™é‡‘')) return 1;
        if (name.includes('æŒ‡åæ–™') && !name.includes('å»¶é•·')) return 2;
        if (name.includes('åŒä¼´')) return 3;
        if (name.includes('å»¶é•·')) return 4;
        if (name.includes('ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸')) return 99; // æœ€å¾Œ
        return 50; // ãã®ä»–ï¼ˆãƒ‰ãƒªãƒ³ã‚¯ç­‰ï¼‰
    };
    
    consolidatedItems.sort((a, b) => sortOrder(a.name) - sortOrder(b.name));
    
    const subtotalAmount = consolidatedItems.reduce((sum, item) => sum + item.subtotal, 0);
    const taxAmount = taxItem ? taxItem.subtotal : 0;
    
    // åˆè¨ˆã¯TAXè¾¼ã¿ã§è¨ˆç®—
    const total = subtotalAmount + taxAmount;
    
    // ä¼ç¥¨HTMLç”Ÿæˆ
    const receiptHtml = `
        <div class="text-center border-b-2 border-dashed border-gray-400 pb-4 mb-4">
            <h1 class="text-2xl font-bold">Cabax</h1>
            <p class="text-sm text-gray-600">${now.toLocaleDateString('ja-JP')} ${now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</p>
        </div>
        
        <div class="mb-4 text-sm">
            <div class="flex justify-between py-1">
                <span>ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†</span>
                <span class="font-bold">${tableName}</span>
            </div>
            <div class="flex justify-between py-1">
                <span>æ¥åº—äººæ•°</span>
                <span class="font-bold">${guests}å</span>
            </div>
            <div class="flex justify-between py-1">
                <span>æ‹…å½“</span>
                <span class="font-bold">${castName}</span>
            </div>
        </div>
        
        <div class="border-t-2 border-dashed border-gray-400 pt-4 mb-4">
            <h2 class="font-bold mb-2">ã”æ³¨æ–‡æ˜ç´°</h2>
            <div class="text-sm space-y-1">
                ${consolidatedItems.length > 0 ? consolidatedItems.map(item => `
                    <div class="flex justify-between">
                        <span>${item.name} Ã— ${item.qty}</span>
                        <span>Â¥${item.subtotal.toLocaleString()}</span>
                    </div>
                `).join('') : '<p class="text-gray-500">æ³¨æ–‡ãªã—</p>'}
            </div>
        </div>
        
        <div class="border-t-2 border-dashed border-gray-400 pt-4 mb-2">
            <div class="flex justify-between text-sm">
                <span>å°è¨ˆ</span>
                <span>Â¥${subtotalAmount.toLocaleString()}</span>
            </div>
            ${taxAmount > 0 ? `
            <div class="flex justify-between text-sm">
                <span>TAX/ã‚µãƒ¼ãƒ“ã‚¹æ–™</span>
                <span>Â¥${taxAmount.toLocaleString()}</span>
            </div>
            ` : ''}
        </div>
        
        <div class="border-t-2 border-gray-800 pt-4">
            <div class="flex justify-between text-xl font-bold">
                <span>åˆè¨ˆ</span>
                <span>Â¥${total.toLocaleString()}</span>
            </div>
        </div>
        
        <div class="text-center mt-6 text-sm text-gray-500">
            <p>ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</p>
            <p>ã¾ãŸã®ã”æ¥åº—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™</p>
        </div>
    `;
    
    document.getElementById('receiptContent').innerHTML = receiptHtml;
    document.getElementById('receiptModal').classList.remove('hidden');
    document.getElementById('receiptModal').classList.add('flex');
}

function closeReceiptModal() {
    document.getElementById('receiptModal').classList.add('hidden');
    document.getElementById('receiptModal').classList.remove('flex');
}

function printReceipt() {
    window.print();
}

async function createSessionForTable(tableId) {
    try {
        const castId = Number(document.getElementById('entryCastSelect')?.value || 1);
        const guests = Number(document.getElementById('entryGuests')?.value || 1);
        const catchStaff = (document.getElementById('entryCatchStaff')?.value || '').trim();
        
        // store_idã‚’å–å¾—
        const storeId = sessionStorage.getItem('cabax_store_id');

        const payload = {
            table_id: Number(tableId),
            cast_id: castId,
            guests: guests,
            store_id: storeId ? Number(storeId) : null
        };
        if (catchStaff) payload.catch_staff = catchStaff;

        // POST /api/sessions
        await apiRequest(API_ENDPOINTS.sessions, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });

        showNotification('å…¥åº—ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‰ã—ã¾ã—ãŸ', 'success');

        // æœ€æ–°åŒ–ã—ã¦è©³ç´°ã‚’æ›´æ–°
        if (typeof syncWithBackend === 'function') await syncWithBackend();
        if (typeof openTableDetail === 'function') await openTableDetail(tableId);

    } catch (e) {
        console.error('[admin] createSessionForTable error', e);
        showNotification('å…¥åº—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆAPI/Consoleç¢ºèªï¼‰', 'error');
    }
}

// â˜… ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’ API ã‹ã‚‰å–å¾—ã—ã¦ state ã«åæ˜ ï¼ˆç®¡ç†ç”»é¢ç”¨ï¼‰

async function loadTablesFromApi() {
    try {
        const data = await apiRequest(API_ENDPOINTS.tables);

        if (!Array.isArray(data)) {
            console.error("ãƒ†ãƒ¼ãƒ–ãƒ«APIã®æˆ»ã‚Šå€¤ãŒé…åˆ—ã˜ã‚ƒãªã„:", data);
            return;
        }

        appState.tables = data.map((t) => {
            const name =
                t.name ??
                t.table_name ??
                (t.number !== undefined ? String(t.number) : String(t.id));

            return {
                id: t.id,
                name: name,
                status: t.status ?? "available",
                // FastAPIå´ã¯ is_vip ãªã®ã§ã“ã“ã§ã‚­ãƒ£ãƒ¡ãƒ«ã«æƒãˆã‚‹
                isVip: t.isVip ?? t.is_vip ?? false,
            };
        });

        renderTables();
    } catch (error) {
        console.error("ãƒ†ãƒ¼ãƒ–ãƒ«å–å¾—ã«å¤±æ•—:", error);
        alert("ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ï¼ˆç®¡ç†ç”»é¢ï¼‰");
    }
}

// â˜… loadActiveSessionsFromApiã¯å¾Œæ–¹ã§å®šç¾©ï¼ˆé‡è¤‡å‰Šé™¤ï¼‰

// â˜… ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆç®¡ç†ç”»é¢ï¼‰

async function startSessionForTable(tableId, options = {}) {
    // options ã«ã¯ UI ã‹ã‚‰æ‹¾ã£ãŸå€¤ã‚’æ¸¡ã™ã‚¤ãƒ¡ãƒ¼ã‚¸
    const {
        castId,
        guests,
        catchStaff = "",
        hasCompanion = false,
        companionName = "",
        nominationType = null,
        nominationFee = 0,
        shimeiCasts = "",
    } = options;

    const payload = {
        table_id: tableId,
        cast_id: castId,
        guests: guests,
        catch_staff: catchStaff || null,
        has_companion: hasCompanion,
        companion_name: companionName || null,
        nomination_type: nominationType,
        nomination_fee: nominationFee,
        shimei_casts: shimeiCasts || null,
        store_id: sessionStorage.getItem('cabax_store_id') ? Number(sessionStorage.getItem('cabax_store_id')) : null,
    };

    try {
        // FastAPI ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const session = await apiRequest(API_ENDPOINTS.sessions, {
            method: "POST",
            body: JSON.stringify(payload),
        });

        // appState å´ã«åæ˜ ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’æŒã£ã¦ã„ã‚‹å‰æï¼‰
        if (!Array.isArray(appState.sessions)) {
            appState.sessions = [];
        }
        appState.sessions.push(session);

        // è©²å½“ãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ…‹ã‚‚ã€Œä½¿ç”¨ä¸­ã€ã«æ›´æ–°
        const table = appState.tables.find(t => t.id === tableId);
        if (table) {
            table.status = "occupied";
        }

        // â˜… ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å†å–å¾—
        await loadActiveSessionsFromApi();

        // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
        renderTables();  // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–¢æ•°

        console.log("ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æˆåŠŸ:", session);
        return session;
    } catch (error) {
        console.error("ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã«å¤±æ•—:", error);
        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ or API ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        throw error;
    }
}

// â˜… ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦æ³¨æ–‡ã‚’ä½œæˆã—ã¦ API ã«é€ã‚‹

async function createOrderForTable(tableId, menuItemId, quantity, options = {}) {
    const {
        isDrinkBack = false,
        castName = null,   // ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ã®å¯¾è±¡ã‚­ãƒ£ã‚¹ãƒˆåãªã©
    } = options;

    // 1. ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¢ã™
    const session = appState.activeSessions.find(s => s.tableId === tableId);

    if (!session) {
        alert("ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«å…¥åº—å‡¦ç†ã‚’ã—ã¦ãã ã•ã„ã€‚");
        throw new Error("No active session for table " + tableId);
    }

    const payload = {
        session_id: session.id,
        menu_item_id: menuItemId,
        quantity: quantity,
        is_drink_back: isDrinkBack,
        cast_name: castName,
    };

    try {
        const order = await apiRequest(API_ENDPOINTS.orders, {
            method: "POST",
            body: JSON.stringify(payload),
        });

        console.log("æ³¨æ–‡ä½œæˆæˆåŠŸ:", order);

        // â˜… é‡‘é¡ãªã©ã‚’æœ€æ–°åŒ–ã—ãŸã„ã®ã§ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–ã‚Šç›´ã™
        await loadActiveSessionsFromApi();

        // å¿…è¦ãªã‚‰ã€ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚„æ³¨æ–‡ä¸€è¦§ã®å†æç”»ã‚‚ã“ã“ã§å‘¼ã¶
        renderTables();
        // renderTableDetail(tableId); â† ãã†ã„ã†é–¢æ•°ãŒã‚ã‚‹ãªã‚‰

        return order;
    } catch (e) {
        console.error("æ³¨æ–‡ä½œæˆã«å¤±æ•—:", e);
        alert("æ³¨æ–‡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚API ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        throw e;
    }
}

// â˜… æ³¨æ–‡è¿½åŠ ãƒœã‚¿ãƒ³ç”¨ã®ãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
async function handleAddOrder() {
    const tableId = currentTableId;          // ä»Šè¡¨ç¤ºä¸­ã®ãƒ†ãƒ¼ãƒ–ãƒ«ID
    const menuItemId = selectedMenuItemId;  // é¸æŠä¸­ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    const quantity = selectedQuantity || 1;  // æœªæŒ‡å®šãªã‚‰1

    // å¿…è¦ãªã‚‰ UI ã‹ã‚‰ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯æƒ…å ±ã‚„ã‚­ãƒ£ã‚¹ãƒˆåã‚‚å–ã£ã¦ãã‚‹
    const isDrinkBack = false;              // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰æ‹¾ã†ãªã©
    const castName = null;                  // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ãªã©ã‹ã‚‰

    try {
        await createOrderForTable(tableId, menuItemId, quantity, {
            isDrinkBack,
            castName,
        });
        alert("æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
    } catch (e) {
        // createOrderForTable å†…ã§ alert æ¸ˆã¿ãªã®ã§ã“ã“ã¯ãƒ­ã‚°ã ã‘ã§ã‚‚OK
        console.error(e);
    }
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã‚’APIã‹ã‚‰å–å¾—ï¼ˆã“ã‚Œã¯æ—¢ã«ã‚ã‚‹ã¯ãšï¼‰
async function loadMenuFromApi() {
  try {
    const data = await apiRequest('menu', { method: 'GET' });
    const items = Array.isArray(data) ? data : (data?.items || data?.menu || []);
    
    // image_url ã‚’ image ã«ã‚‚ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆè¡¨ç¤ºç”¨ï¼‰
    appState.menuItems = items.map(item => ({
        ...item,
        image: item.image || item.image_url
    }));

    // æ—¢å­˜UIã«åˆã‚ã›ã¦ã€Œå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ã€å‘¼ã¶
    if (typeof renderMenu === 'function') renderMenu();
    if (typeof renderMenuItems === 'function') renderMenuItems();
    if (typeof renderMenuManagement === 'function') renderMenuManagement();
    if (typeof populateMenuSelects === 'function') populateMenuSelects();

    console.log('âœ… loadMenuFromApi OK:', items.length);
    return items;
  } catch (e) {
    console.error('âŒ loadMenuFromApi failed:', e);
    return [];
  }
}

// â˜… ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’APIã‹ã‚‰å–å¾—ã—ã¦ state ã«åæ˜ 
async function loadCastsFromApi() {
  try {
    const data = await apiRequest('casts', { method: 'GET' });
    const casts = Array.isArray(data) ? data : (data?.casts || data?.items || []);
    appState.casts = casts;

    // ã‚»ãƒ¬ã‚¯ãƒˆå¾©æ´»ã¯ã“ã‚ŒãŒå¿…é ˆ
    if (typeof populateCastSelects === 'function') populateCastSelects();
    if (typeof renderCasts === 'function') renderCasts();
    if (typeof renderCastManagement === 'function') renderCastManagement();

    console.log('âœ… loadCastsFromApi OK:', casts.length);
    return casts;
  } catch (e) {
    console.error('âŒ loadCastsFromApi failed:', e);
    return [];
  }
}

async function loadActiveSessionsFromApi() {
    try {
        
        const data = await apiRequest(API_ENDPOINTS.sessionsActive);
        

        // â˜… data ãŒ [] ã§ã‚‚ã€Œç©ºå¸­ã€ãŒçœŸå®Ÿãªã®ã§å¿…ãšä¸Šæ›¸ãã™ã‚‹
        if (!Array.isArray(data)) {
            console.warn('[admin] Invalid active sessions payload', data);
            appState.activeSessions = [];
            if (typeof renderTables === 'function') renderTables();
            return;
        }

        appState.activeSessions = data.map(raw => {
            const tableId = raw.tableId ?? raw.table_id ?? null;

            const tableName =
                raw.tableName ??
                raw.table_name ??
                (tableId != null ? String(tableId) : '');

            const guests = raw.guests ?? raw.guest_count ?? 0;

            const castName = raw.castName ?? raw.cast_name ?? '';

            const catchStaff = raw.catchStaff ?? raw.catch_staff ?? '';

            const startTime = raw.startTime ?? raw.start_time ?? new Date().toISOString();

            const currentTotal =
                raw.currentTotal ??
                raw.current_total ??
                raw.totalAmount ??
                raw.total_amount ??
                0;

            const hasCompanion = raw.hasCompanion ?? raw.has_companion ?? false;

            const companionName = raw.companionName ?? raw.companion_name ?? '';

            const extensionCount = raw.extensionCount ?? raw.extension_count ?? 0;

            let orders = [];
            if (Array.isArray(raw.orders)) {
                orders = raw.orders.map(o => {
                    const menuItemId = o.menuItemId ?? o.menu_item_id ?? null;
                    const menuItem =
                        (Array.isArray(appState.menuItems) ? appState.menuItems : [])
                            .find(m => Number(m.id) === Number(menuItemId)) || null;

                    const price = o.price ?? (menuItem ? menuItem.price : 0);
                    const itemName = o.itemName ?? o.item_name ?? (menuItem ? menuItem.name : '');
                    const category = o.category ?? (menuItem ? menuItem.category : 'other');

                    return {
                        id: o.id ?? null, // order_idä¿æŒ
                        itemName,
                        category,
                        price,
                        quantity: o.quantity ?? 1,
                        isDrinkBack: o.isDrinkBack ?? o.is_drink_back ?? false,
                        castName: o.castName ?? o.cast_name ?? null
                    };
                });
            }

            return {
                id: raw.id,
                tableId,
                tableName,
                guests,
                castName,
                catchStaff,
                startTime,
                currentTotal,
                hasCompanion,
                companionName,
                extensionCount,
                orders
            };
        });

        
        if (typeof renderTables === 'function') renderTables();

    } catch (e) {
        console.error('[admin] loadActiveSessionsFromApi error', e);

        // é€šä¿¡ã‚¨ãƒ©ãƒ¼æ™‚ã®æŒ™å‹•ï¼šå¹½éœŠã‚’æ®‹ã—ãŸããªã„ãªã‚‰ç©ºã«ã™ã‚‹
        appState.activeSessions = [];
        if (typeof renderTables === 'function') renderTables();
    }
}

function applyCastsToAllSelects() {
  const casts = Array.isArray(appState.casts) ? appState.casts : [];

  // ã‚­ãƒ£ã‚¹ãƒˆé¸æŠã£ã½ã„ select ã‚’ç·å½“ãŸã‚Šã§åŸ‹ã‚ã‚‹ï¼ˆæ—¢å­˜UIãŒå£Šã‚Œã¦ã¦ã‚‚å¾©æ´»ã™ã‚‹ï¼‰
  const selects = Array.from(document.querySelectorAll('select'))
    .filter(sel => /cast/i.test(sel.id || '') || /cast/i.test(sel.name || ''));

  if (!selects.length) return;

  const optionsHtml = [
    `<option value="free">ãƒ•ãƒªãƒ¼</option>`,
    ...casts.map(c => `<option value="${c.id}">${c.stage_name ?? c.name ?? `Cast#${c.id}`}</option>`)
  ].join('');

  selects.forEach(sel => {
    // ç¾åœ¨é¸æŠã‚’ä¿æŒ
    const current = sel.value;
    sel.innerHTML = optionsHtml;
    if (current) sel.value = current;
  });
}

function applyMenuToAllSelects() {
  const items = Array.isArray(appState.menuItems) ? appState.menuItems : [];

  const selects = Array.from(document.querySelectorAll('select'))
    .filter(sel => /menu/i.test(sel.id || '') || /item/i.test(sel.id || ''));

  if (!selects.length) return;

  const optionsHtml = items.map(it => {
    const label = `${it.name}ï¼ˆÂ¥${Number(it.price||0).toLocaleString('ja-JP')}ï¼‰`;
    return `<option value="${it.id}">${label}</option>`;
  }).join('');

  selects.forEach(sel => {
    const current = sel.value;
    sel.innerHTML = optionsHtml;
    if (current) sel.value = current;
  });
}

function initializeApp() {
    // â˜… localStorageã‹ã‚‰checkoutHistoryã‚’å¾©å…ƒ
    try {
        const saved = localStorage.getItem('cabax_checkoutHistory');
        if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
                // ä»Šæ—¥ã®åˆ†ã ã‘å¾©å…ƒï¼ˆæ—¥ä»˜ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
                const today = new Date().toISOString().split('T')[0];
                appState.checkoutHistory = parsed.filter(s => {
                    const checkoutDate = s.checkoutTime || s.end_time || s.startTime || s.start_time;
                    return checkoutDate && checkoutDate.startsWith(today);
                });
                console.log('âœ… checkoutHistoryå¾©å…ƒ:', appState.checkoutHistory.length, 'ä»¶');
            }
        }
    } catch (e) {
        console.warn('checkoutHistoryå¾©å…ƒã«å¤±æ•—:', e);
    }
    
    setupBusinessDate();
    // loadDemoData();  // â˜… ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ€ãƒŸãƒ¼åˆæœŸåŒ–ã¯ã‚‚ã†ä½¿ã‚ãªã„

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç³»ã¯ãã®ã¾ã¾
    setupCharts();
    updateDashboard();
    initializeShiftCalendar();
    renderAttendance();
    populateCastSelects();
    renderDailyReport();
    renderReports();
    applyCastsToAllSelects();
    applyMenuToAllSelects();



    // â˜… ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ç‰ˆã‚’1å›ã ã‘é…ç·šï¼ˆå¾Œã‹ã‚‰DOMãŒç”Ÿæˆã•ã‚Œã¦ã‚‚æ‹¾ã†ï¼‰
    if (typeof wireDelegatedCheckout === 'function') {
        wireDelegatedCheckout();
    }

    // â˜… APIåŒæœŸï¼ˆæœ€åˆã«1å›ï¼‰
    if (typeof syncWithBackend === 'function') {
        syncWithBackend();
    }

    // â˜… ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ã‚­ãƒ£ã‚¹ãƒˆå¾©æ´»ï¼ˆã“ã“ã§1å›ï¼‰
    if (typeof loadMenuFromApi === 'function') {
        loadMenuFromApi().catch(err => console.error('loadMenuFromApi failed:', err));
    }
    if (typeof loadCastsFromApi === 'function') {
        loadCastsFromApi().catch(err => console.error('loadCastsFromApi failed:', err));
    }

    // â˜… å®šæœŸåŒæœŸï¼ˆäºŒé‡èµ·å‹•é˜²æ­¢ï¼‰
    if (!window.__cabaxSyncInterval) {
        window.__cabaxSyncInterval = setInterval(() => {
            if (document.visibilityState === 'visible' &&
                typeof syncWithBackend === 'function') {
                syncWithBackend();
            }
        }, 15000);
    }
    
    // â˜… æ³¨æ–‡é€šçŸ¥ãƒã‚§ãƒƒã‚¯ï¼ˆ5ç§’é–“éš”ï¼‰
    if (!window.__cabaxOrderCheckInterval) {
        // åˆå›ãƒã‚§ãƒƒã‚¯
        orderNotification.checkNewOrders();
        
        window.__cabaxOrderCheckInterval = setInterval(() => {
            if (document.visibilityState === 'visible') {
                orderNotification.checkNewOrders();
            }
        }, 5000);
    }

    // â˜… ã‚¿ãƒ–å¾©å¸°æ™‚ã«åŒæœŸï¼ˆäºŒé‡ç™»éŒ²é˜²æ­¢ï¼‰
    if (!window.__cabaxVisibilityHandlerAdded) {
        window.__cabaxVisibilityHandlerAdded = true;
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {

                // â‘  ã¾ãšã‚»ãƒƒã‚·ãƒ§ãƒ³/ãƒ†ãƒ¼ãƒ–ãƒ«åŒæœŸ
                if (typeof syncWithBackend === 'function') {
                    syncWithBackend();
                }

                // â‘¡ ãã®æ¬¡ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ã‚­ãƒ£ã‚¹ãƒˆã‚‚æ›´æ–°ï¼ˆå¤±æ•—ã—ã¦ã‚‚æ­¢ã‚ãªã„ï¼‰
                if (typeof loadMenuFromApi === 'function') {
                    loadMenuFromApi().catch(err => console.error('loadMenuFromApi failed:', err));
                }
                if (typeof loadCastsFromApi === 'function') {
                    loadCastsFromApi().catch(err => console.error('loadCastsFromApi failed:', err));
                }
            }
        });
    }
}

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            console.log('ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:', { username });
            
            try {
                // APIèªè¨¼
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼', data);
                    
                    // JWTã‹ã‚‰store_idã¨store_nameã‚’å–å¾—
                    let storeId = data.store_id;
                    let storeName = data.store_name;
                    
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ãªã„å ´åˆã¯JWTã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                    if (!storeId && data.access_token) {
                        try {
                            const payload = JSON.parse(atob(data.access_token.split('.')[1]));
                            storeId = payload.store_id;
                            storeName = payload.store_name;
                            console.log('JWT decoded:', payload);
                        } catch (e) {
                            console.log('JWT decode failed:', e);
                        }
                    }
                    
                    sessionStorage.setItem('cabax_logged_in', 'true');
                    sessionStorage.setItem('cabax_user', username);
                    sessionStorage.setItem('cabax_token', data.access_token);
                    sessionStorage.setItem('cabax_store_id', storeId || '');
                    sessionStorage.setItem('cabax_store_name', storeName || '');
                    
                    console.log('Store ID saved:', storeId);
                    
                    errorDiv.classList.remove('active');
                    showMainApp();
                    initializeApp();
                    
                    const displayName = storeName || 'Cabax';
                    showNotification(`${displayName} ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ`, 'success');
                } else {
                    const err = await response.json().catch(() => ({}));
                    console.log('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:', err.detail);
                    errorDiv.textContent = err.detail || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                    errorDiv.classList.add('active');
                    document.getElementById('loginPassword').value = '';
                }
            } catch (e) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', e);
                errorDiv.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                errorDiv.classList.add('active');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').style.display = 'block';
        }

        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                sessionStorage.removeItem('cabax_logged_in');
                sessionStorage.removeItem('cabax_user');
                
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').style.display = 'none';
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').classList.remove('active');
                
                showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
            }
        }

        function setupBusinessDate() {
            const now = new Date();
            const businessDate = now.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('businessDate').textContent = businessDate;
        }

        function loadDemoData() {
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’1ã€œ6ã®ç•ªå·ã«å¤‰æ›´
            appState.tables = [
                { id: 1, name: '1', status: 'available' },
                { id: 2, name: '2', status: 'occupied' },
                { id: 3, name: '3', status: 'occupied', isVip: true },
                { id: 4, name: '4', status: 'available' },
                { id: 5, name: '5', status: 'reserved' },
                { id: 6, name: '6', status: 'available' }
            ];

            appState.menuItems = [
                { 
                    id: 1, 
                    name: 'ãƒ‰ãƒ³ãƒšãƒªãƒ‹ãƒ¨ãƒ³ ãƒ­ã‚¼', 
                    category: 'bottle', 
                    price: 150000, 
                    stock: 5,
                    description: 'ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ¥ ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³',
                    image: null
                },
                { 
                    id: 2, 
                    name: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', 
                    category: 'drink', 
                    price: 800, 
                    stock: 100,
                    description: 'ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒã‚¤ãƒœãƒ¼ãƒ«',
                    image: null
                },
                { 
                    id: 3, 
                    name: 'ã‚«ã‚·ã‚¹ã‚ªãƒ¬ãƒ³ã‚¸', 
                    category: 'drink', 
                    price: 800, 
                    stock: 100,
                    description: 'ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ã‚«ã‚¯ãƒ†ãƒ«',
                    image: null
                },
                { 
                    id: 4, 
                    name: '90åˆ†ã‚»ãƒƒãƒˆ', 
                    category: 'set', 
                    price: 5000, 
                    stock: null,
                    description: 'é£²ã¿æ”¾é¡Œä»˜ã',
                    image: null
                },
                { 
                    id: 5, 
                    name: 'ãƒ•ãƒ«ãƒ¼ãƒ„ç››ã‚Šåˆã‚ã›', 
                    category: 'food', 
                    price: 8000, 
                    stock: 20,
                    description: 'å­£ç¯€ã®ãƒ•ãƒ«ãƒ¼ãƒ„',
                    image: null
                }
            ];

            appState.casts = [
                { id: 1, name: 'ã•ãã‚‰', rank: 'chief', hourlyRate: 3500, sales: 285000 },
                { id: 2, name: 'ã‚†ã', rank: 'regular', hourlyRate: 2500, sales: 168000 },
                { id: 3, name: 'ã¿ã‹', rank: 'manager', hourlyRate: 4000, sales: 342000 }
            ];

            appState.sessions = [
                { id: 1, tableId: 2, startTime: '21:30', guests: 4, total: 26400 },
                { id: 2, tableId: 3, startTime: '20:00', guests: 6, total: 160000 }
            ];

            appState.attendances = [
                { id: 1, castId: 1, castName: 'ã•ãã‚‰', date: new Date().toISOString().split('T')[0], clockIn: '20:00', clockOut: null, status: 'working' },
                { id: 2, castId: 3, castName: 'ã¿ã‹', date: new Date().toISOString().split('T')[0], clockIn: '19:30', clockOut: null, status: 'working' }
            ];

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆæ‹¡å¼µæ©Ÿèƒ½ç”¨ï¼‰
            appState.activeSessions = [
                {
                    id: 1,
                    tableId: 2,
                    tableName: '2',
                    guests: 3,
                    castName: 'ã•ãã‚‰',
                    catchStaff: 'å±±ç”°',
                    startTime: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                    currentTotal: 45000,
                    hasCompanion: true,
                    companionName: 'ç”°ä¸­æ§˜',
                    extensionCount: 2,
                    orders: [
                        { itemName: 'ãƒ‰ãƒ³ãƒšãƒªãƒ‹ãƒ¨ãƒ³ ãƒ­ã‚¼', category: 'bottle', price: 30000, quantity: 1 },
                        { itemName: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', category: 'drink', price: 800, quantity: 3, castName: 'ã•ãã‚‰', isDrinkBack: true },
                        { itemName: 'ã‚«ã‚·ã‚¹ã‚ªãƒ¬ãƒ³ã‚¸', category: 'drink', price: 800, quantity: 2, castName: 'ã•ãã‚‰', isDrinkBack: true },
                        { itemName: 'ãƒ•ãƒ«ãƒ¼ãƒ„ç››ã‚Šåˆã‚ã›', category: 'food', price: 8000, quantity: 1 }
                    ],
                    nomination: {
                        type: 'in-house',
                        castName: 'ã•ãã‚‰',
                        fee: 2000
                    }
                },
                {
                    id: 2,
                    tableId: 3,
                    tableName: '3',
                    guests: 4,
                    castName: 'ã¿ã‹',
                    catchStaff: 'ä½è—¤',
                    startTime: new Date(Date.now() - 1.5 * 60 * 60 * 1000).toISOString(),
                    currentTotal: 160000,
                    hasCompanion: false,
                    companionName: null,
                    extensionCount: 1,
                    orders: [
                        { itemName: 'ãƒ‰ãƒ³ãƒšãƒªãƒ‹ãƒ¨ãƒ³ ãƒ­ã‚¼', category: 'bottle', price: 150000, quantity: 1 },
                        { itemName: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', category: 'drink', price: 800, quantity: 5, castName: 'ã¿ã‹', isDrinkBack: true },
                        { itemName: '90åˆ†ã‚»ãƒƒãƒˆ', category: 'set', price: 5000, quantity: 1 }
                    ],
                    nomination: {
                        type: 'main',
                        castName: 'ã¿ã‹',
                        fee: 5000
                    }
                }
            ];

            // ç²¾ç®—æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆæ—¥å ±ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
            appState.checkoutHistory = [
                {
                    id: 101,
                    tableId: 4,
                    tableName: '4',
                    guests: 2,
                    castName: 'ã‚†ã',
                    catchStaff: 'é«˜æ©‹',
                    startTime: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                    checkoutTime: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(),
                    totalAmount: 28000,
                    hasCompanion: true,
                    companionName: 'ä½ã€…æœ¨æ§˜',
                    extensionCount: 1,
                    orders: [
                        { itemName: '90åˆ†ã‚»ãƒƒãƒˆ', category: 'set', price: 5000, quantity: 2 },
                        { itemName: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', category: 'drink', price: 800, quantity: 4, castName: 'ã‚†ã', isDrinkBack: true },
                        { itemName: 'ãƒ•ãƒ«ãƒ¼ãƒ„ç››ã‚Šåˆã‚ã›', category: 'food', price: 8000, quantity: 1 }
                    ],
                    nomination: {
                        type: 'main',
                        castName: 'ã‚†ã',
                        fee: 5000
                    }
                }
            ];

            renderTables();
            renderMenu();
            renderCasts();
            renderReports();
        }

async function syncWithBackend() {
    // showNotification('APIåŒæœŸã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info'); // é€šçŸ¥ä¸è¦

    try {
        await Promise.all([
            (typeof loadMenuFromApi === 'function') ? loadMenuFromApi() : Promise.resolve(),
            (typeof loadCastsFromApi === 'function') ? loadCastsFromApi() : Promise.resolve(),
            (typeof loadTablesFromApi === 'function') ? loadTablesFromApi() : Promise.resolve(),
            (typeof loadActiveSessionsFromApi === 'function') ? loadActiveSessionsFromApi() : Promise.resolve(),
            (typeof loadStaffFromApi === 'function') ? loadStaffFromApi() : Promise.resolve()
        ]);

        appState.apiConnected = true;
        // showNotification('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚­ãƒ£ã‚¹ãƒˆãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’APIã¨åŒæœŸã—ã¾ã—ãŸ', 'success'); // é€šçŸ¥ä¸è¦

        // åº—èˆ—è¨­å®šã‚’èª­ã¿è¾¼ã¿
        if (typeof loadStoreSettings === 'function') loadStoreSettings();

        // â˜… åŒæœŸå¾Œã®å†æç”»
        if (typeof renderTables === 'function') renderTables();
        if (typeof renderMenu === 'function') renderMenu();
        if (typeof renderCasts === 'function') renderCasts();
        if (typeof renderStaff === 'function') renderStaff();
        if (typeof populateCastSelects === 'function') populateCastSelects();
        if (typeof updateDashboard === 'function') updateDashboard();
        if (typeof renderDailyReport === 'function') renderDailyReport();
        if (typeof renderReports === 'function') renderReports();

        // â˜… æ³¨æ„ï¼šè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«æ›´æ–°ã¯ openTableDetail ã®è²¬å‹™ï¼ˆã“ã“ã§ã¯çµ¶å¯¾ã‚„ã‚‰ãªã„ï¼‰
        return true;

    } catch (error) {
        console.error(error);
        appState.apiConnected = false;
        showNotification('APIåŒæœŸã«å¤±æ•—ã—ãŸãŸã‚ã€ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™', 'error');

        if (typeof renderMenu === 'function') renderMenu();
        if (typeof renderCasts === 'function') renderCasts();
        if (typeof renderStaff === 'function') renderStaff();
        if (typeof renderTables === 'function') renderTables();
        if (typeof populateCastSelects === 'function') populateCastSelects();

        return false;
    }
}


        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†
        function previewMenuImage(event, mode) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (mode === 'add') {
                        appState.currentMenuImage = e.target.result;
                        const preview = document.getElementById('menuImagePreview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                    } else if (mode === 'edit') {
                        appState.currentMenuImage = e.target.result;
                        const preview = document.getElementById('editMenuImagePreview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // ã‚«ãƒ†ã‚´ãƒªæ­£è¦åŒ–ï¼ˆAPIå€¤ â†’ çµ±ä¸€ã‚­ãƒ¼ï¼‰
        function normalizeCategory(category, itemName = '') {
            // item_nameã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’æ¨å®š
            if (itemName) {
                const name = String(itemName).toLowerCase();
                if (name.includes('ã‚»ãƒƒãƒˆæ–™é‡‘') || name.includes('æŒ‡åæ–™') || name.includes('ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸') || name.includes('åŒä¼´æ–™') || name.includes('å»¶é•·')) {
                    return 'tableset';
                }
                if (name.includes('tax') || name.includes('ã‚µãƒ¼ãƒ“ã‚¹')) {
                    return 'tableset';
                }
            }
            
            if (!category) return 'other';
            const c = String(category).toLowerCase().trim();
            const map = {
                'set': 'tableset',
                'ã‚»ãƒƒãƒˆ': 'tableset',
                'tableset': 'tableset',
                'fee_set': 'tableset',
                'fee_inhouse': 'tableset',
                'fee_hon': 'tableset',
                'shochu': 'shochu',
                'ç„¼é…': 'shochu',
                'whisky': 'whisky',
                'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼': 'whisky',
                'bottle': 'shochu',
                'ãƒœãƒˆãƒ«': 'shochu',
                'champagne': 'champagne',
                'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³': 'champagne',
                'wine': 'wine',
                'ãƒ¯ã‚¤ãƒ³': 'wine',
                'drink': 'drink',
                'ãƒ‰ãƒªãƒ³ã‚¯': 'drink',
                'castdrink': 'castdrink',
                'ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒªãƒ³ã‚¯': 'castdrink',
                'food': 'food',
                'ãƒ•ãƒ¼ãƒ‰': 'food'
            };
            return map[c] || 'other';
        }

        // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹
        let currentMenuFilter = 'all';

        function filterMenuCategory(category) {
            currentMenuFilter = category;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.menu-filter-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.remove('bg-gray-800', 'text-gray-300', 'border-gray-700');
                    btn.classList.add('bg-amber-500/20', 'text-amber-300', 'border-amber-500/30', 'active');
                } else {
                    btn.classList.remove('bg-amber-500/20', 'text-amber-300', 'border-amber-500/30', 'active');
                    btn.classList.add('bg-gray-800', 'text-gray-300', 'border-gray-700');
                }
            });
            
            renderMenu();
        }

        // ========== åº—èˆ—è¨­å®š ==========
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒƒã‚¯è¨­å®š
        const defaultBackSettings = {
            db: 60,           // ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯
            nomination: 60,   // æŒ‡åæ–™ãƒãƒƒã‚¯
            sales: 10,        // å£²ä¸Šãƒãƒƒã‚¯ï¼ˆæŒ‡åæ™‚ï¼‰
            companion: 100,   // åŒä¼´ãƒãƒƒã‚¯
            champagne: 10,    // ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒãƒƒã‚¯
            bottle: 10        // ãƒœãƒˆãƒ«ãƒãƒƒã‚¯
        };
        
        // åº—èˆ—è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadStoreSettings() {
            const saved = localStorage.getItem('cabax_store_settings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    Object.assign(appState.backSettings, settings);
                } catch (e) {
                    console.error('Failed to load store settings:', e);
                }
            }
            
            // UIã«åæ˜ 
            updateBackSettingsUI();
        }
        
        // UIã«è¨­å®šã‚’åæ˜ 
        function updateBackSettingsUI() {
            const settings = appState.backSettings || defaultBackSettings;
            
            const fields = ['db', 'nomination', 'sales', 'companion', 'champagne', 'bottle'];
            fields.forEach(field => {
                const input = document.getElementById(`setting${field.charAt(0).toUpperCase() + field.slice(1)}Rate`);
                const display = document.getElementById(`display${field.charAt(0).toUpperCase() + field.slice(1)}Rate`);
                if (input) input.value = settings[field] ?? defaultBackSettings[field];
                if (display) display.textContent = `${settings[field] ?? defaultBackSettings[field]}%`;
            });
        }
        
        // ãƒãƒƒã‚¯è¨­å®šã‚’æ›´æ–°
        function updateBackSetting(type, value) {
            if (!appState.backSettings) appState.backSettings = { ...defaultBackSettings };
            appState.backSettings[type] = Number(value);
            
            const display = document.getElementById(`display${type.charAt(0).toUpperCase() + type.slice(1)}Rate`);
            if (display) display.textContent = `${value}%`;
        }
        
        // åº—èˆ—è¨­å®šã‚’ä¿å­˜
        function saveStoreSettings() {
            localStorage.setItem('cabax_store_settings', JSON.stringify(appState.backSettings));
            showNotification('åº—èˆ—è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }
        
        // appStateã«ãƒãƒƒã‚¯è¨­å®šã‚’è¿½åŠ 
        if (!appState.backSettings) {
            appState.backSettings = { ...defaultBackSettings };
        }
        
        // ========== ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† ==========
        
        appState.staffList = [];
        appState.staffAttendances = [];
        
        async function loadStaffList() {
            try {
                const staff = await apiRequest('/api/staff');
                appState.staffList = staff || [];
                renderStaffList();
            } catch (e) {
                console.error('ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§å–å¾—å¤±æ•—:', e);
            }
        }
        
        async function loadStaffAttendances() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const attendances = await apiRequest(`/api/staff-attendance?date=${today}`);
                appState.staffAttendances = attendances || [];
                renderStaffAttendanceList();
                updateTodayStaffCost();
            } catch (e) {
                console.error('ã‚¹ã‚¿ãƒƒãƒ•å‹¤æ€ å–å¾—å¤±æ•—:', e);
            }
        }
        
        function renderStaffList() {
            const container = document.getElementById('staffList');
            if (!container) return;
            
            if (appState.staffList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            const roleLabels = {
                waiter: 'ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼',
                kitchen: 'ã‚­ãƒƒãƒãƒ³',
                manager: 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼',
                catch: 'ã‚­ãƒ£ãƒƒãƒ',
                driver: 'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼',
                other: 'ãã®ä»–'
            };
            
            const salaryTypeLabels = {
                hourly: 'æ™‚çµ¦',
                daily: 'æ—¥çµ¦',
                monthly: 'æœˆçµ¦'
            };
            
            container.innerHTML = appState.staffList.map(staff => `
                <div class="p-4 bg-black/20 rounded-xl border border-white/10 flex items-center justify-between">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="text-white font-semibold">${staff.name}</span>
                            <span class="text-xs px-2 py-1 bg-gray-700 rounded">${roleLabels[staff.role] || staff.role}</span>
                        </div>
                        <div class="text-sm text-gray-400 mt-1">
                            ${salaryTypeLabels[staff.salary_type] || 'æ™‚çµ¦'}: Â¥${(staff.salary_amount || 0).toLocaleString()}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="staffClockIn(${staff.id})" class="px-3 py-1 bg-green-900/30 text-green-400 border border-green-800/30 rounded-lg text-sm hover:bg-green-900/50">
                            å‡ºå‹¤
                        </button>
                        <button onclick="deleteStaff(${staff.id})" class="px-3 py-1 bg-red-900/30 text-red-400 border border-red-800/30 rounded-lg text-sm hover:bg-red-900/50">
                            å‰Šé™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderStaffAttendanceList() {
            const container = document.getElementById('staffAttendanceList');
            if (!container) return;
            
            if (appState.staffAttendances.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">æœ¬æ—¥ã®å‡ºå‹¤è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            container.innerHTML = appState.staffAttendances.map(att => `
                <div class="p-4 bg-black/20 rounded-xl border border-white/10 flex items-center justify-between">
                    <div>
                        <div class="text-white font-semibold">${att.staff_name}</div>
                        <div class="text-sm text-gray-400">
                            ${att.clock_in} ${att.clock_out ? 'ã€œ ' + att.clock_out : 'ã€œ å‹¤å‹™ä¸­'}
                            ${att.hours_worked > 0 ? `ï¼ˆ${att.hours_worked.toFixed(1)}hï¼‰` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        ${att.daily_wage > 0 ? `<span class="text-amber-400 font-bold">Â¥${att.daily_wage.toLocaleString()}</span>` : ''}
                        ${!att.clock_out ? `
                            <button onclick="staffClockOut(${att.id})" class="px-3 py-1 bg-amber-900/30 text-amber-400 border border-amber-800/30 rounded-lg text-sm hover:bg-amber-900/50">
                                é€€å‹¤
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function updateTodayStaffCost() {
            const total = appState.staffAttendances.reduce((sum, att) => sum + (att.daily_wage || 0), 0);
            const el = document.getElementById('todayStaffCost');
            if (el) el.textContent = `Â¥${total.toLocaleString()}`;
        }
        
        function openAddStaffModal() {
            document.getElementById('staffName').value = '';
            document.getElementById('staffRole').value = 'waiter';
            document.getElementById('staffSalaryType').value = 'hourly';
            document.getElementById('staffSalaryAmount').value = '1000';
            document.getElementById('staffPhone').value = '';
            updateSalaryLabel();
            document.getElementById('addStaffModal').classList.add('active');
        }
        
        function updateSalaryLabel() {
            const type = document.getElementById('staffSalaryType').value;
            const label = document.getElementById('salaryAmountLabel');
            const labels = { hourly: 'æ™‚çµ¦', daily: 'æ—¥çµ¦', monthly: 'æœˆçµ¦' };
            if (label) label.textContent = labels[type] || 'é‡‘é¡';
        }
        
        async function addStaff(event) {
            event.preventDefault();
            
            const payload = {
                name: document.getElementById('staffName').value,
                role: document.getElementById('staffRole').value,
                salary_type: document.getElementById('staffSalaryType').value,
                salary_amount: parseInt(document.getElementById('staffSalaryAmount').value) || 1000,
                phone: document.getElementById('staffPhone').value || null
            };
            
            try {
                await apiRequest('/api/staff', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                closeModal('addStaffModal');
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                await loadStaffList();
            } catch (e) {
                console.error(e);
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        async function deleteStaff(staffId) {
            if (!confirm('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                await apiRequest(`/api/staff/${staffId}`, { method: 'DELETE' });
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                await loadStaffList();
            } catch (e) {
                console.error(e);
                showNotification('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        async function staffClockIn(staffId) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const clockIn = now.toTimeString().slice(0, 5);
            
            try {
                await apiRequest('/api/staff-attendance', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: staffId,
                        date: today,
                        clock_in: clockIn
                    })
                });
                showNotification('å‡ºå‹¤ã—ã¾ã—ãŸ', 'success');
                await loadStaffAttendances();
            } catch (e) {
                console.error(e);
                if (e.message.includes('400')) {
                    showNotification('æ—¢ã«å‡ºå‹¤ã—ã¦ã„ã¾ã™', 'error');
                } else {
                    showNotification('å‡ºå‹¤å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }
        
        async function staffClockOut(attendanceId) {
            const now = new Date();
            const clockOut = now.toTimeString().slice(0, 5);
            
            try {
                await apiRequest(`/api/staff-attendance/${attendanceId}/clock-out`, {
                    method: 'PUT',
                    body: JSON.stringify({ clock_out: clockOut })
                });
                showNotification('é€€å‹¤ã—ã¾ã—ãŸ', 'success');
                await loadStaffAttendances();
            } catch (e) {
                console.error(e);
                showNotification('é€€å‹¤å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ========== ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š ==========
        
        function openTableSettingsModal() {
            renderTableSettingsList();
            document.getElementById('tableSettingsModal').classList.add('active');
        }
        
        function renderTableSettingsList() {
            const list = document.getElementById('tableSettingsList');
            if (!list) return;
            
            if (appState.tables.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            list.innerHTML = appState.tables.map(table => `
                <div class="glass-effect rounded-xl p-4 border border-white/10 hover:border-amber-500/30 transition flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold text-white">${table.name}</span>
                        ${table.is_vip ? '<span class="px-2 py-1 bg-amber-500/20 text-amber-300 text-xs rounded-full">VIP</span>' : ''}
                        <span class="text-sm ${table.status === 'available' ? 'text-green-400' : 'text-amber-400'}">${table.status === 'available' ? 'ç©ºå¸­' : 'ä½¿ç”¨ä¸­'}</span>
                    </div>
                    <button onclick="closeModal('tableSettingsModal'); openEditTableModal(${table.id});" class="px-3 py-1 bg-gray-700 text-gray-300 rounded-lg text-sm hover:bg-gray-600">
                        ç·¨é›†
                    </button>
                </div>
            `).join('');
        }
        
        function openAddTableModal() {
            document.getElementById('tableName').value = '';
            document.getElementById('tableIsVip').checked = false;
            document.getElementById('addTableModal').classList.add('active');
        }
        
        async function addTable(event) {
            event.preventDefault();
            
            const name = document.getElementById('tableName').value.trim();
            const isVip = document.getElementById('tableIsVip').checked;
            
            if (!name) {
                showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE_URL}/tables`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, is_vip: isVip })
                });
                
                if (res.ok) {
                    const newTable = await res.json();
                    appState.tables.push(newTable);
                    renderTableSettingsList();
                    renderTables();
                    closeModal('addTableModal');
                    showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                } else {
                    const err = await res.json();
                    showNotification(err.detail || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                console.error('ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e);
                showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        function openEditTableModal(tableId) {
            const table = appState.tables.find(t => t.id === tableId);
            if (!table) return;
            
            document.getElementById('editTableId').value = tableId;
            document.getElementById('editTableName').value = table.name;
            document.getElementById('editTableIsVip').checked = table.is_vip || false;
            document.getElementById('editTableModal').classList.add('active');
        }
        
        async function updateTable(event) {
            event.preventDefault();
            
            const tableId = document.getElementById('editTableId').value;
            const name = document.getElementById('editTableName').value.trim();
            const isVip = document.getElementById('editTableIsVip').checked;
            
            if (!name) {
                showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE_URL}/tables/${tableId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, is_vip: isVip })
                });
                
                if (res.ok) {
                    const updated = await res.json();
                    const idx = appState.tables.findIndex(t => t.id == tableId);
                    if (idx !== -1) {
                        appState.tables[idx] = updated;
                    }
                    renderTableSettingsList();
                    renderTables();
                    closeModal('editTableModal');
                    showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                } else {
                    const err = await res.json();
                    showNotification(err.detail || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
                showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        async function deleteTable() {
            const tableId = document.getElementById('editTableId').value;
            const table = appState.tables.find(t => t.id == tableId);
            
            if (!confirm(`ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${table?.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ä½¿ç”¨ä¸­ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE_URL}/tables/${tableId}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    appState.tables = appState.tables.filter(t => t.id != tableId);
                    renderTableSettingsList();
                    renderTables();
                    closeModal('editTableModal');
                    showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } else {
                    const err = await res.json();
                    showNotification(err.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                console.error('ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
                showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function renderMenu() {
            const menuGrid = document.getElementById('menuGrid');
            
            // APIã‹ã‚‰å–å¾—ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            if (appState.menuItems.length > 0) {
                const categories = [...new Set(appState.menuItems.map(i => i.category))];
                console.log('ğŸ“¦ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªä¸€è¦§:', categories);
            }
            
            if (appState.menuItems.length === 0) {
                menuGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
            const filtered = appState.menuItems.filter(item => {
                if (currentMenuFilter === 'all') return true;
                return normalizeCategory(item.category) === currentMenuFilter;
            });

            if (filtered.length === 0) {
                menuGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">è©²å½“ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            menuGrid.innerHTML = filtered.map(item => {
                const normCat = normalizeCategory(item.category);
                return `
                <div class="luxury-card rounded-2xl overflow-hidden">
                    ${item.image ? 
                        `<img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover">` :
                        `<div class="w-full h-48 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center text-6xl">
                            ${getCategoryEmoji(normCat)}
                        </div>`
                    }
                    <div class="p-6">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getCategoryColor(normCat)}">
                                ${getCategoryLabel(normCat)}
                            </span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-200 mb-2">${item.name}</h3>
                        <p class="text-gray-400 text-sm mb-4">${item.description || ''}</p>
                        <div class="flex items-center justify-between">
                            <p class="text-2xl font-bold gold-accent">Â¥${item.price.toLocaleString()}</p>
                            ${item.stock !== null ? 
                                `<p class="text-sm text-gray-400">åœ¨åº«: ${item.stock}</p>` : 
                                ''}
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="editMenuItem(${item.id})" class="flex-1 bg-blue-900/20 text-blue-400 border border-blue-800/30 py-2 rounded-xl hover:bg-blue-900/30 transition text-sm">
                                ç·¨é›†
                            </button>
                            <button onclick="deleteMenuItem(${item.id})" class="flex-1 bg-red-900/20 text-red-400 border border-red-800/30 py-2 rounded-xl hover:bg-red-900/30 transition text-sm">
                                å‰Šé™¤
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function getCategoryEmoji(category) {
            const icons = {
                'bottle': 'ğŸ¾',
                'drink': 'ğŸ¥ƒ',
                'food': 'ğŸ½',
                'set': 'ğŸ«',
                'champagne': 'ğŸ¥‚',
                'wine': 'ğŸ·',
                'other': 'ğŸ“¦'
            };
            return icons[category] || 'ğŸ“¦';
        }

        function getCategoryColor(category) {
            const colors = {
                'bottle': 'bg-purple-900/30 text-purple-300 border border-purple-800/30',
                'drink': 'bg-blue-900/30 text-blue-300 border border-blue-800/30',
                'food': 'bg-green-900/30 text-green-300 border border-green-800/30',
                'set': 'bg-yellow-900/30 text-yellow-300 border border-yellow-800/30',
                'champagne': 'bg-amber-900/30 text-amber-300 border border-amber-800/30',
                'wine': 'bg-rose-900/30 text-rose-300 border border-rose-800/30',
                'other': 'bg-gray-900/30 text-gray-300 border border-gray-800/30'
            };
            return colors[category] || 'bg-gray-900/30 text-gray-300 border border-gray-800/30';
        }

        function getCategoryLabel(category) {
            const labels = {
                'bottle': 'ãƒœãƒˆãƒ«',
                'drink': 'ãƒ‰ãƒªãƒ³ã‚¯',
                'food': 'ãƒ•ãƒ¼ãƒ‰',
                'set': 'ã‚»ãƒƒãƒˆ',
                'champagne': 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³',
                'wine': 'ãƒ¯ã‚¤ãƒ³',
                'other': 'ãã®ä»–'
            };
            return labels[category] || 'ãã®ä»–';
        }

        function openAddMenuModal() {
            document.getElementById('addMenuModal').classList.add('active');
            appState.currentMenuImage = null;
            document.getElementById('menuImagePreview').classList.add('hidden');
            
            // selectã®optionsã‚’å‹•çš„ã«è¨­å®šï¼ˆHTMLãƒ‘ãƒ¼ã‚¹ã®å•é¡Œå›é¿ï¼‰
            const sel = document.getElementById('menuCategory');
            if (sel && sel.options.length === 0) {
                const categories = [
                    { value: 'tableset', label: 'å“ã‚»ãƒƒãƒˆ' },
                    { value: 'drink', label: 'ãƒ‰ãƒªãƒ³ã‚¯' },
                    { value: 'castdrink', label: 'ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒªãƒ³ã‚¯' },
                    { value: 'shochu', label: 'ç„¼é…' },
                    { value: 'whisky', label: 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼' },
                    { value: 'champagne', label: 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³' },
                    { value: 'wine', label: 'ãƒ¯ã‚¤ãƒ³' },
                    { value: 'food', label: 'ãƒ•ãƒ¼ãƒ‰' }
                ];
                categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.value;
                    opt.textContent = cat.label;
                    sel.appendChild(opt);
                });
                sel.value = 'drink'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            }
        }

async function addMenuItem(event) {
    event.preventDefault();
    
    // å…ˆã«ã€ŒAPIã«æŠ•ã’ã‚‹ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã€ã‚’ä½œã‚‹ï¼ˆidã¯ä»˜ã‘ãªã„ï¼‰
    const payload = {
        name: document.getElementById('menuName').value,
        category: document.getElementById('menuCategory').value,
        price: parseInt(document.getElementById('menuPrice').value),
        cost: parseInt(document.getElementById('menuCost').value) || 0,
        description: document.getElementById('menuDescription').value,
        image_url: appState.currentMenuImage,  // APIã¯image_urlã‚’æœŸå¾…
        stock: ['bottle', 'drink', 'food'].includes(document.getElementById('menuCategory').value) ? 100 : null
    };

    try {
        let createdItem;

        if (appState.apiConnected) {
            // â˜… APIãŒç”Ÿãã¦ã„ã‚‹ã¨ã â†’ APIçµŒç”±ã§ç™»éŒ²
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã¯ã€ä½œæˆã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆidä»˜ãï¼‰ã‚’è¿”ã™æƒ³å®š
            createdItem = await apiRequest(API_ENDPOINTS.menu, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«imageãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚è¿½åŠ ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆè¡¨ç¤ºç”¨ï¼‰
            createdItem.image = createdItem.image_url;
        } else {
            // â˜… APIãŒã‚ªãƒ•ã®ã¨ã â†’ ã“ã‚Œã¾ã§é€šã‚Šãƒ•ãƒ­ãƒ³ãƒˆã®ã¿ã§å®Œçµ
            createdItem = {
                ...payload,
                id: appState.menuItems.length + 1,
                image: payload.image_url
            };
        }

        appState.menuItems.push(createdItem);
        renderMenu();
        closeModal('addMenuModal');
        showNotification('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('menuName').value = '';
        document.getElementById('menuPrice').value = '';
        document.getElementById('menuCost').value = '';
        document.getElementById('menuDescription').value = '';
    } catch (error) {
        console.error(error);
        showNotification('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

        function editMenuItem(id) {
            const item = appState.menuItems.find(m => m.id === id);
            if (!item) return;

            appState.currentEditingMenuId = id;
            appState.currentMenuImage = item.image;
            
            // selectã®optionsã‚’å‹•çš„ã«è¨­å®šï¼ˆHTMLãƒ‘ãƒ¼ã‚¹ã®å•é¡Œå›é¿ï¼‰
            const sel = document.getElementById('editMenuCategory');
            if (sel && sel.options.length === 0) {
                const categories = [
                    { value: 'tableset', label: 'å“ã‚»ãƒƒãƒˆ' },
                    { value: 'drink', label: 'ãƒ‰ãƒªãƒ³ã‚¯' },
                    { value: 'castdrink', label: 'ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒªãƒ³ã‚¯' },
                    { value: 'shochu', label: 'ç„¼é…' },
                    { value: 'whisky', label: 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼' },
                    { value: 'champagne', label: 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³' },
                    { value: 'wine', label: 'ãƒ¯ã‚¤ãƒ³' },
                    { value: 'food', label: 'ãƒ•ãƒ¼ãƒ‰' }
                ];
                categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.value;
                    opt.textContent = cat.label;
                    sel.appendChild(opt);
                });
            }
            
            document.getElementById('editMenuId').value = item.id;
            document.getElementById('editMenuName').value = item.name;
            document.getElementById('editMenuCategory').value = normalizeCategory(item.category);
            document.getElementById('editMenuPrice').value = item.price;
            document.getElementById('editMenuCost').value = item.cost || 0;
            document.getElementById('editMenuDescription').value = item.description || '';
            
            if (item.image) {
                const preview = document.getElementById('editMenuImagePreview');
                preview.src = item.image;
                preview.classList.remove('hidden');
            } else {
                document.getElementById('editMenuImagePreview').classList.add('hidden');
            }
            
            document.getElementById('editMenuModal').classList.add('active');
        }

async function updateMenuItem(event) {
    event.preventDefault();
    
    const id = parseInt(document.getElementById('editMenuId').value);
    const itemIndex = appState.menuItems.findIndex(m => m.id === id);
    
    if (itemIndex === -1) return;

    const updatedItem = {
        ...appState.menuItems[itemIndex],
        name: document.getElementById('editMenuName').value,
        category: document.getElementById('editMenuCategory').value,
        price: parseInt(document.getElementById('editMenuPrice').value),
        cost: parseInt(document.getElementById('editMenuCost').value) || 0,
        description: document.getElementById('editMenuDescription').value,
        image_url: appState.currentMenuImage,  // APIã¯image_urlã‚’æœŸå¾…
        image: appState.currentMenuImage       // ãƒ•ãƒ­ãƒ³ãƒˆè¡¨ç¤ºç”¨
    };

    try {
        if (appState.apiConnected) {
            // â˜… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ›´æ–°ã‚’åæ˜ 
            await apiRequest(`${API_ENDPOINTS.menu}/${id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    name: updatedItem.name,
                    category: updatedItem.category,
                    price: updatedItem.price,
                    cost: updatedItem.cost,
                    description: updatedItem.description,
                    image_url: updatedItem.image_url
                })
            });
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã¯å¿…ãšæ›´æ–°
        appState.menuItems[itemIndex] = updatedItem;
        renderMenu();
        closeModal('editMenuModal');
        showNotification('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
    } catch (error) {
        console.error(error);
        showNotification('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

async function deleteMenuItem(id) {
    if (!confirm('ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
        if (appState.apiConnected) {
            // â˜… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«å‰Šé™¤ã‚’åæ˜ 
            await apiRequest(`${API_ENDPOINTS.menu}/${id}`, {
                method: 'DELETE'
            });
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‹ã‚‰å‰Šé™¤
        appState.menuItems = appState.menuItems.filter(item => item.id !== id);
        renderMenu();
        showNotification('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    } catch (error) {
        console.error(error);
        showNotification('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}


function closeTableDetailPanel() {
    appState.isTableDetailOpen = false;
    appState.currentTableId = null;
    appState.currentTableDetail = null;
    appState.currentTableSession = null;

    const panel = document.getElementById('tableDetailPanel');
    if (panel) panel.classList.add('hidden');
}
function getActiveSessionByTableId(tableId) {
    const list = Array.isArray(appState.activeSessions) ? appState.activeSessions : [];
    return list.find(s => Number(s.tableId ?? s.table_id) === Number(tableId)) || null;
}

function getCastNameById(castId) {
    const casts = Array.isArray(appState.casts) ? appState.casts : [];
    const c = casts.find(x => Number(x.id) === Number(castId));
    return c ? (c.name || c.display_name || c.nickname || `#${c.id}`) : '';
}

// ã‚ªãƒ¼ãƒ€ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆæœªæä¾›â‡”æä¾›æ¸ˆã¿ï¼‰
async function toggleOrderStatus(sessionId, orderId, setServed) {
    try {
        // APIã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        await apiRequest(`/sessions/${sessionId}/orders/${orderId}/status`, {
            method: 'PUT',
            body: JSON.stringify({ is_served: setServed })
        });
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
        const tableId = appState.currentTableId;
        if (tableId && typeof openTableDetail === 'function') {
            await openTableDetail(tableId);
        }
        
        showNotification(setServed ? 'æä¾›æ¸ˆã¿ã«ã—ã¾ã—ãŸ' : 'æœªæä¾›ã«æˆ»ã—ã¾ã—ãŸ', 'success');
    } catch (e) {
        console.error('[toggleOrderStatus] error:', e);
        
        // APIãŒãªãã¦ã‚‚ãƒ•ãƒ­ãƒ³ãƒˆã§çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
        const session = appState.activeSessions.find(s => Number(s.id) === Number(sessionId));
        if (session && session.orders) {
            const order = session.orders.find(o => Number(o.id) === Number(orderId));
            if (order) {
                order.is_served = setServed;
                order.status = setServed ? 'served' : 'pending';
            }
        }
        
        // è©³ç´°ãƒ‘ãƒãƒ«ã‚’å†æç”»
        const tableId = appState.currentTableId;
        if (tableId && typeof openTableDetail === 'function') {
            await openTableDetail(tableId);
        }
        
        showNotification(setServed ? 'æä¾›æ¸ˆã¿ã«ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰' : 'æœªæä¾›ã«æˆ»ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰', 'info');
    }
}

// ========== ã‚ªãƒ¼ãƒ€ãƒ¼ç®¡ç† ==========
let currentOrderFilter = 'all';
let allOrders = [];

async function loadOrdersFromApi() {
    try {
        const data = await apiRequest('/orders');
        allOrders = Array.isArray(data) ? data : [];
        renderOrders();
    } catch (e) {
        console.error('[loadOrdersFromApi] error:', e);
        // APIãŒãªã„å ´åˆã¯activeSessionsã‹ã‚‰å–å¾—
        allOrders = [];
        (appState.activeSessions || []).forEach(session => {
            if (session.orders) {
                session.orders.forEach(order => {
                    allOrders.push({
                        ...order,
                        session_id: session.id,
                        table_id: session.tableId || session.table_id,
                        table_name: session.tableName || session.table_name || '?',
                        item_name: order.itemName || order.item_name || '?',
                        is_served: order.is_served || order.status === 'served'
                    });
                });
            }
        });
        renderOrders();
    }
}

function filterOrders(filter) {
    currentOrderFilter = filter;
    
    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.order-filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-amber-600', 'text-white');
        btn.classList.add('bg-gray-700', 'text-gray-300');
    });
    
    const activeBtn = document.getElementById(`orderFilter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
    if (activeBtn) {
        activeBtn.classList.add('active', 'bg-amber-600', 'text-white');
        activeBtn.classList.remove('bg-gray-700', 'text-gray-300');
    }
    
    renderOrders();
}

function renderOrders() {
    const grid = document.getElementById('ordersGrid');
    const noOrdersMsg = document.getElementById('noOrdersMessage');
    const pendingSummary = document.getElementById('pendingOrdersSummary');
    const pendingCount = document.getElementById('pendingOrdersCount');
    
    if (!grid) return;
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    let filteredOrders = allOrders;
    if (currentOrderFilter === 'pending') {
        filteredOrders = allOrders.filter(o => !o.is_served);
    } else if (currentOrderFilter === 'served') {
        filteredOrders = allOrders.filter(o => o.is_served);
    }
    
    // æœªæä¾›ã‚µãƒãƒªãƒ¼
    const pendingOrders = allOrders.filter(o => !o.is_served);
    if (pendingOrders.length > 0) {
        pendingSummary.classList.remove('hidden');
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const byTable = {};
        pendingOrders.forEach(o => {
            const tName = o.table_name || '?';
            if (!byTable[tName]) byTable[tName] = [];
            byTable[tName].push(o);
        });
        
        const tableInfo = Object.entries(byTable)
            .map(([table, orders]) => `ãƒ†ãƒ¼ãƒ–ãƒ«${table}: ${orders.length}ä»¶`)
            .join('ã€');
        
        pendingCount.textContent = `${pendingOrders.length}ä»¶ã®æœªæä¾›ã‚ªãƒ¼ãƒ€ãƒ¼ï¼ˆ${tableInfo}ï¼‰`;
    } else {
        pendingSummary.classList.add('hidden');
    }
    
    if (filteredOrders.length === 0) {
        grid.innerHTML = '';
        noOrdersMsg.classList.remove('hidden');
        return;
    }
    
    noOrdersMsg.classList.add('hidden');
    
    // æ™‚é–“ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
    filteredOrders.sort((a, b) => {
        const dateA = new Date(a.created_at || 0);
        const dateB = new Date(b.created_at || 0);
        return dateB - dateA;
    });
    
    grid.innerHTML = filteredOrders.map(order => {
        const isServed = order.is_served;
        const statusClass = isServed 
            ? 'border-green-500/30 bg-green-900/10' 
            : 'border-amber-500/30 bg-amber-900/10';
        const statusBadge = isServed 
            ? '<span class="px-2 py-1 text-xs font-bold rounded-full bg-green-500/20 text-green-400 border border-green-500/30">âœ“ æä¾›æ¸ˆ</span>'
            : '<span class="px-2 py-1 text-xs font-bold rounded-full bg-amber-500/20 text-amber-400 border border-amber-500/30 animate-pulse">â³ æœªæä¾›</span>';
        
        // created_atã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆUTCã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹ã®ã§JSTã«å¤‰æ›ï¼‰
        let createdAt = null;
        if (order.created_at) {
            // ISOæ–‡å­—åˆ—ã«ZãŒãªã‘ã‚Œã°UTCã¨ã—ã¦æ‰±ã†
            const isoStr = order.created_at.includes('Z') || order.created_at.includes('+') 
                ? order.created_at 
                : order.created_at + 'Z';
            createdAt = new Date(isoStr);
        }
        
        const timeStr = createdAt 
            ? createdAt.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
            : '--:--';
        
        // çµŒéæ™‚é–“
        let elapsedStr = '';
        if (createdAt && !isServed) {
            const now = new Date();
            // åˆ†å˜ä½ã®å·®åˆ†ã‚’è¨ˆç®—
            const elapsed = Math.floor((now.getTime() - createdAt.getTime()) / 60000);
            // è² ã®å€¤ã‚„ç•°å¸¸ãªå€¤ã¯è¡¨ç¤ºã—ãªã„
            if (elapsed >= 0 && elapsed < 1440) { // 24æ™‚é–“ä»¥å†…
                if (elapsed >= 10) {
                    elapsedStr = `<span class="text-red-400 font-bold">${elapsed}åˆ†çµŒé</span>`;
                } else if (elapsed >= 5) {
                    elapsedStr = `<span class="text-amber-400">${elapsed}åˆ†çµŒé</span>`;
                } else {
                    elapsedStr = `<span class="text-gray-400">${elapsed}åˆ†çµŒé</span>`;
                }
            }
        }
        
        const categoryEmoji = {
            'set': 'ğŸ«', 'bottle': 'ğŸ¾', 'champagne': 'ğŸ¥‚', 
            'wine': 'ğŸ·', 'drink': 'ğŸ¥ƒ', 'food': 'ğŸ½ï¸'
        };
        const emoji = categoryEmoji[order.category] || 'ğŸ“¦';
        
        return `
            <div class="luxury-card rounded-xl p-4 border ${statusClass}">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-bold text-amber-400">T${order.table_name}</span>
                        ${statusBadge}
                    </div>
                    <span class="text-xs text-gray-500">${timeStr}</span>
                </div>
                
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-2xl">${emoji}</span>
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-semibold truncate">${order.item_name || '?'}</div>
                        <div class="text-sm text-gray-400">Ã—${order.quantity} / Â¥${(order.price * order.quantity).toLocaleString()}</div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="text-xs text-gray-500">${elapsedStr}</div>
                    <button 
                        onclick="toggleOrderStatusFromList(${order.session_id}, ${order.id}, ${isServed ? 'false' : 'true'})"
                        class="px-3 py-1.5 text-sm rounded-lg font-semibold transition ${isServed 
                            ? 'bg-gray-600/50 text-gray-400 hover:bg-red-500/30 hover:text-red-400' 
                            : 'bg-green-600/30 text-green-400 hover:bg-green-500/50'}"
                    >${isServed ? 'æœªæä¾›ã«æˆ»ã™' : 'æä¾›æ¸ˆã¿ã«ã™ã‚‹'}</button>
                </div>
            </div>
        `;
    }).join('');
}

async function toggleOrderStatusFromList(sessionId, orderId, setServed) {
    try {
        await apiRequest(`/sessions/${sessionId}/orders/${orderId}/status`, {
            method: 'PUT',
            body: JSON.stringify({ is_served: setServed })
        });
        
        // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        await loadOrdersFromApi();
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚‚æ›´æ–°
        if (typeof loadActiveSessionsFromApi === 'function') {
            await loadActiveSessionsFromApi();
        }
        
        showNotification(setServed ? 'æä¾›æ¸ˆã¿ã«ã—ã¾ã—ãŸ' : 'æœªæä¾›ã«æˆ»ã—ã¾ã—ãŸ', 'success');
    } catch (e) {
        console.error('[toggleOrderStatusFromList] error:', e);
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã§æ›´æ–°
        const order = allOrders.find(o => o.id === orderId);
        if (order) {
            order.is_served = setServed;
        }
        renderOrders();
        
        showNotification(setServed ? 'æä¾›æ¸ˆã¿ã«ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰' : 'æœªæä¾›ã«æˆ»ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰', 'info');
    }
}

// ========== ãƒ‰ãƒªãƒ³ã‚¯æ³¨æ–‡é–¢é€£ ==========

// å‰²ã‚Šæ–¹ãƒ»ç¨®é¡ã®å®šç¾©ï¼ˆãŠå®¢æ§˜ç”¨ãƒ‰ãƒªãƒ³ã‚¯ï¼‰
const mixStylesAdmin = {
    'ãƒ“ãƒ¼ãƒ«': ['ç”Ÿãƒ“ãƒ¼ãƒ«', 'ã‚¢ã‚¤ã‚¹ãƒ“ãƒ¼ãƒ«', 'ã‚·ãƒ£ãƒ³ãƒ‡ã‚£ã‚¬ãƒ•', 'ãƒ¬ãƒƒãƒ‰ã‚¢ã‚¤'],
    'ã‚«ã‚¯ãƒ†ãƒ«': ['ã‚«ã‚·ã‚¹ã‚ªãƒ¬ãƒ³ã‚¸', 'ã‚«ã‚·ã‚¹ã‚½ãƒ¼ãƒ€', 'ã‚«ã‚·ã‚¹ã‚¦ãƒ¼ãƒ­ãƒ³', 'ãƒ”ãƒ¼ãƒã‚ªãƒ¬ãƒ³ã‚¸', 'ãƒ”ãƒ¼ãƒã‚¦ãƒ¼ãƒ­ãƒ³', 'ãƒ•ã‚¡ã‚¸ãƒ¼ãƒãƒ¼ãƒ–ãƒ«', 'ã‚«ãƒ«ãƒ¼ã‚¢ãƒŸãƒ«ã‚¯'],
    'ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯': ['ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶', 'ç·‘èŒ¶', 'ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹', 'ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¸ãƒ¥ãƒ¼ã‚¹', 'ã‚³ãƒ¼ãƒ©', 'ã‚¸ãƒ³ã‚¸ãƒ£ã‚¨ãƒ¼ãƒ«', 'ç‚­é…¸æ°´', 'ã‚«ãƒ«ãƒ”ã‚¹', 'ã‚«ãƒ«ãƒ”ã‚¹ã‚½ãƒ¼ãƒ€'],
    'ã‚·ãƒ§ãƒƒãƒˆ': ['ãƒ†ã‚­ãƒ¼ãƒ©', 'ã‚¤ã‚§ãƒ¼ã‚¬ãƒ¼', 'ã‚³ã‚«ãƒ¬ãƒ­', 'ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼'],
    'ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³': ['ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼ˆèµ¤ï¼‰', 'ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼ˆç™½ï¼‰', 'ã‚­ãƒ†ã‚£', 'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼']
};

// ã‚­ãƒ£ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ç”¨ã®å‰²ã‚Šæ–¹
const castDrinkMixStylesAdmin = {
    'éº¦ç„¼é…': ['ãƒ­ãƒƒã‚¯', 'æ°´å‰²ã‚Š', 'ã‚½ãƒ¼ãƒ€å‰²ã‚Š', 'ç·‘èŒ¶å‰²ã‚Š', 'ç´…èŒ¶å‰²ã‚Š', 'ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶å‰²ã‚Š', 'ã‚¸ãƒ£ã‚¹ãƒŸãƒ³å‰²ã‚Š', 'ã‚³ãƒ¼ãƒ’ãƒ¼å‰²ã‚Š', 'ãŠæ¹¯å‰²ã‚Š', 'ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼'],
    'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼': ['ãƒ­ãƒƒã‚¯', 'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ', 'æ°´å‰²ã‚Š', 'ãƒã‚¤ãƒœãƒ¼ãƒ«', 'ã‚³ãƒ¼ã‚¯å‰²ã‚Š', 'ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼å‰²ã‚Š']
};

// æœ‰æ–™ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆãŠå®¢æ§˜ã‚‚ã‚»ãƒƒãƒˆè¾¼ã¿ã§ã¯ãªãèª²é‡‘ï¼‰
const paidDrinksAdmin = ['ã‚·ãƒ§ãƒƒãƒˆ', 'ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³'];

// ã‚­ãƒ£ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•å°‚ç”¨ãƒ‰ãƒªãƒ³ã‚¯
const castOnlyDrinksAdmin = ['éº¦ç„¼é…', 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼'];

// ç¾åœ¨é¸æŠä¸­ã®å‰²ã‚Šæ–¹
let selectedMixStyleAdmin = null;

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠãŒå¤‰ã‚ã£ãŸæ™‚
function onOrderMenuChange() {
    const select = document.getElementById('selAddOrderItem');
    if (!select) return;
    
    const itemId = Number(select.value);
    const menuItem = (appState.menuItems || []).find(m => m.id === itemId);
    const category = (menuItem?.category || '').toLowerCase();
    const itemName = menuItem?.name || '';
    
    const drinkSizeSection = document.getElementById('drinkSizeSection');
    const drinkForSection = document.getElementById('drinkForSection');
    const mixStyleSection = document.getElementById('mixStyleSection');
    const mixStyleOptions = document.getElementById('mixStyleOptions');
    
    // ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š
    const isCastDrink = category === 'castdrink';
    const isTableSet = category === 'tableset';
    const isDrinkCategory = ['drink', 'castdrink', 'bottle', 'champagne', 'wine'].includes(category);
    const isDrinkOnly = ['drink', 'castdrink'].includes(category);
    const isPaidDrink = paidDrinksAdmin.includes(itemName);
    const isCastOnlyDrink = castOnlyDrinksAdmin.includes(itemName);
    
    // å‰²ã‚Šæ–¹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å–å¾—
    const hasMixStyle = isCastDrink 
        ? castDrinkMixStylesAdmin[itemName] !== undefined 
        : mixStylesAdmin[itemName] !== undefined;
    const currentMixStyles = isCastDrink ? castDrinkMixStylesAdmin : mixStylesAdmin;
    
    // å‰²ã‚Šæ–¹é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³
    if (mixStyleSection && mixStyleOptions) {
        if (hasMixStyle) {
            mixStyleSection.classList.remove('hidden');
            const styles = currentMixStyles[itemName];
            mixStyleOptions.innerHTML = styles.map((style, index) => `
                <label class="mix-style-admin-label flex items-center justify-center p-2 rounded-xl bg-black/20 ${index === 0 ? 'border-2 border-amber-500 bg-amber-500/20' : 'border border-white/10'} cursor-pointer hover:bg-black/30">
                    <input type="radio" name="mixStyleAdmin" value="${style}" ${index === 0 ? 'checked' : ''} onchange="updateMixStyleAdminStyle()" class="hidden">
                    <span class="text-sm text-white/90">${style}</span>
                </label>
            `).join('');
            selectedMixStyleAdmin = styles[0];
        } else {
            mixStyleSection.classList.add('hidden');
            mixStyleOptions.innerHTML = '';
            selectedMixStyleAdmin = null;
        }
    }
    
    // èª°ãŒé£²ã‚€ã‹é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const customerLabel = document.querySelector('.drink-for-label input[value="customer"]')?.parentElement;
    
    if (isCastDrink) {
        // ã‚­ãƒ£ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ã¯ãŠå®¢æ§˜é¸æŠãªã—
        if (customerLabel) customerLabel.classList.add('hidden');
        if (drinkForSection) drinkForSection.classList.remove('hidden');
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ
        const castRadio = document.querySelector('input[name="drinkFor"][value="cast"]');
        if (castRadio) castRadio.checked = true;
        updateDrinkForStyle();
        // ã‚µã‚¤ã‚ºé¸æŠã‚’è¡¨ç¤º
        if (drinkSizeSection) drinkSizeSection.classList.remove('hidden');
        // äººç‰©é¸æŠã‚’è¡¨ç¤º
        onDrinkForChange();
    } else if (isTableSet) {
        // å“ã‚»ãƒƒãƒˆã¯èª°ãŒé£²ã‚€ã‹ä¸è¦
        if (drinkForSection) drinkForSection.classList.add('hidden');
        if (drinkSizeSection) drinkSizeSection.classList.add('hidden');
    } else {
        // é€šå¸¸ãƒ‰ãƒªãƒ³ã‚¯ã¯ãŠå®¢æ§˜é¸æŠã‚ã‚Š
        if (customerLabel) customerLabel.classList.remove('hidden');
        if (drinkForSection) drinkForSection.classList.toggle('hidden', !isDrinkCategory);
        // åˆæœŸè¡¨ç¤ºã¯ãŠå®¢æ§˜ãªã®ã§ã‚µã‚¤ã‚ºé¸æŠã¯éè¡¨ç¤º
        if (drinkSizeSection) drinkSizeSection.classList.add('hidden');
        // ãƒªã‚»ãƒƒãƒˆ
        const customerRadio = document.querySelector('input[name="drinkFor"][value="customer"]');
        if (customerRadio) customerRadio.checked = true;
        updateDrinkForStyle();
    }
    
    // äººç‰©é¸æŠãƒªã‚»ãƒƒãƒˆ
    const personSection = document.getElementById('personSelectSection');
    if (personSection && !isCastDrink) personSection.classList.add('hidden');
}

// å‰²ã‚Šæ–¹é¸æŠã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
function updateMixStyleAdminStyle() {
    document.querySelectorAll('.mix-style-admin-label').forEach(label => {
        const input = label.querySelector('input');
        if (input?.checked) {
            label.classList.remove('border', 'border-white/10');
            label.classList.add('border-2', 'border-amber-500', 'bg-amber-500/20');
            selectedMixStyleAdmin = input.value;
        } else {
            label.classList.remove('border-2', 'border-amber-500', 'bg-amber-500/20');
            label.classList.add('border', 'border-white/10');
        }
    });
}

// èª°ãŒé£²ã‚€ã‹é¸æŠãŒå¤‰ã‚ã£ãŸæ™‚
function onDrinkForChange() {
    const drinkFor = document.querySelector('input[name="drinkFor"]:checked')?.value || 'customer';
    const personSection = document.getElementById('personSelectSection');
    const personSelect = document.getElementById('selDrinkPerson');
    const drinkBackInfo = document.getElementById('drinkBackInfo');
    const drinkSizeSection = document.getElementById('drinkSizeSection');
    
    // ç¾åœ¨é¸æŠä¸­ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å–å¾—
    const select = document.getElementById('selAddOrderItem');
    const itemId = Number(select?.value);
    const menuItem = (appState.menuItems || []).find(m => m.id === itemId);
    const itemName = menuItem?.name || '';
    const category = (menuItem?.category || '').toLowerCase();
    const isPaidDrink = paidDrinksAdmin.includes(itemName);
    const isDrinkOnly = category === 'drink';
    
    if (drinkFor === 'customer') {
        // ãŠå®¢æ§˜ã®å ´åˆã¯é¸æŠä¸è¦
        personSection?.classList.add('hidden');
        drinkBackInfo?.classList.add('hidden');
        // ãŠå®¢æ§˜ã¯ã‚µã‚¤ã‚ºé¸æŠä¸è¦ï¼ˆã‚»ãƒƒãƒˆæ–™é‡‘è¾¼ã¿ or æœ‰æ–™ãƒ‰ãƒªãƒ³ã‚¯çµ±ä¸€ä¾¡æ ¼ï¼‰
        drinkSizeSection?.classList.add('hidden');
    } else {
        // ã‚­ãƒ£ã‚¹ãƒˆã¾ãŸã¯ã‚¹ã‚¿ãƒƒãƒ•ã®å ´åˆ
        personSection?.classList.remove('hidden');
        
        // ã‚µã‚¤ã‚ºé¸æŠè¡¨ç¤ºï¼ˆæœ‰æ–™ãƒ‰ãƒªãƒ³ã‚¯ä»¥å¤–ã®ãƒ‰ãƒªãƒ³ã‚¯ã‚«ãƒ†ã‚´ãƒªï¼‰
        if (drinkSizeSection && isDrinkOnly && !isPaidDrink) {
            drinkSizeSection.classList.remove('hidden');
        }
        
        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        if (personSelect) {
            let options = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            
            if (drinkFor === 'cast') {
                (appState.casts || []).forEach(c => {
                    const name = c.stage_name || c.name || `Cast#${c.id}`;
                    options += `<option value="${name}">${name}</option>`;
                });
                drinkBackInfo?.classList.remove('hidden');
            } else if (drinkFor === 'staff') {
                (appState.staff || []).forEach(s => {
                    options += `<option value="${s.name}">${s.name}ï¼ˆ${getStaffRoleLabel(s.role)}ï¼‰</option>`;
                });
                drinkBackInfo?.classList.add('hidden');
            }
            
            personSelect.innerHTML = options;
        }
    }
}

// ãƒ‰ãƒªãƒ³ã‚¯ã‚µã‚¤ã‚ºé¸æŠã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
function updateDrinkSizeStyle() {
    document.querySelectorAll('.drink-size-label').forEach(label => {
        const input = label.querySelector('input');
        if (input?.checked) {
            label.classList.remove('border', 'border-white/10');
            label.classList.add('border-2', 'border-amber-500', 'bg-amber-500/20');
        } else {
            label.classList.remove('border-2', 'border-amber-500', 'bg-amber-500/20');
            label.classList.add('border', 'border-white/10');
        }
    });
}

// èª°ãŒé£²ã‚€ã‹é¸æŠã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
function updateDrinkForStyle() {
    const colors = {
        'customer': { border: 'border-blue-500', bg: 'bg-blue-500/20' },
        'staff': { border: 'border-green-500', bg: 'bg-green-500/20' },
        'cast': { border: 'border-purple-500', bg: 'bg-purple-500/20' }
    };
    
    document.querySelectorAll('.drink-for-label').forEach(label => {
        const input = label.querySelector('input');
        const value = input?.value;
        const color = colors[value] || colors['customer'];
        
        // ãƒªã‚»ãƒƒãƒˆ
        label.classList.remove('border-2', 'border-blue-500', 'border-green-500', 'border-purple-500', 
                               'bg-blue-500/20', 'bg-green-500/20', 'bg-purple-500/20');
        
        if (input?.checked) {
            label.classList.remove('border', 'border-white/10');
            label.classList.add('border-2', color.border, color.bg);
        } else {
            label.classList.add('border', 'border-white/10');
        }
    });
}

// ========== ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã®æ–™é‡‘è¨ˆç®— ==========

// æ–™é‡‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
function updateStartCharges() {
    const charges = calculateStartCharges();
    
    document.getElementById('previewSetTotal').textContent = `Â¥${charges.setTotal.toLocaleString()}`;
    document.getElementById('previewSingle').textContent = `Â¥${charges.single.toLocaleString()}`;
    document.getElementById('previewDouhan').textContent = `Â¥${charges.douhan.toLocaleString()}`;
    document.getElementById('previewShimei').textContent = `Â¥${charges.shimei.toLocaleString()}`;
    document.getElementById('previewTax').textContent = `Â¥${charges.tax.toLocaleString()}`;
    document.getElementById('previewTotal').textContent = `Â¥${charges.total.toLocaleString()}`;
    
    // æŒ‡åã‚­ãƒ£ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    const shimeiPreview = document.getElementById('shimeiCastPreview');
    if (shimeiPreview) {
        const checkedCasts = document.querySelectorAll('.shimei-cast-checkbox:checked');
        if (checkedCasts.length > 0) {
            const names = Array.from(checkedCasts).map(c => c.dataset.name).join(', ');
            shimeiPreview.textContent = `é¸æŠä¸­: ${names}ï¼ˆæŒ‡åæ–™ Â¥${(checkedCasts.length * 2000).toLocaleString()}ï¼‰`;
        } else {
            shimeiPreview.textContent = '';
        }
    }
    
    // ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆ1åã®å ´åˆï¼‰
    const guests = Number(document.getElementById('inpStartGuests')?.value ?? 1);
    const chkSingle = document.getElementById('chkSingle');
    if (chkSingle && guests === 1) {
        chkSingle.checked = true;
    } else if (chkSingle && guests > 1) {
        chkSingle.checked = false;
    }
}

// æ–™é‡‘ã‚’è¨ˆç®—
function calculateStartCharges() {
    const guests = Number(document.getElementById('inpStartGuests')?.value ?? 1);
    const setPrice = Number(document.getElementById('inpSetPrice')?.value ?? 5000);
    const taxRate = Number(document.getElementById('selTaxRate')?.value ?? 20);
    const hasDouhan = document.getElementById('chkDouhan')?.checked ?? false;
    const hasSingle = document.getElementById('chkSingle')?.checked ?? false;
    const isFree = document.getElementById('chkFree')?.checked ?? false;
    
    // æŒ‡åã‚­ãƒ£ã‚¹ãƒˆã®æ•°ã‚’å–å¾—
    const shimeiCastCount = document.querySelectorAll('.shimei-cast-checkbox:checked').length;
    
    // ãƒ•ãƒªãƒ¼å®¢ã®å ´åˆã¯å‰²å¼•é©ç”¨
    const discount = isFree ? 0.8 : 1; // 20%OFF
    
    // ã‚»ãƒƒãƒˆæ–™é‡‘ï¼ˆ1åã‚ãŸã‚Š Ã— äººæ•°ï¼‰
    const setTotal = Math.floor(setPrice * guests * discount);
    
    // ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ï¼ˆ1åã®ã¿ã®å ´åˆï¼‰
    const single = (hasSingle && guests === 1) ? 2000 : 0;
    
    // åŒä¼´æ–™
    const douhan = hasDouhan ? 3000 : 0;
    
    // æŒ‡åæ–™ï¼ˆ1äººã‚ãŸã‚Š2000å†† Ã— æŒ‡åã‚­ãƒ£ã‚¹ãƒˆæ•°ï¼‰
    const shimei = shimeiCastCount * 2000;
    
    // å°è¨ˆ
    const subtotal = setTotal + single + douhan + shimei;
    
    // TAX/ã‚µãƒ¼ãƒ“ã‚¹æ–™
    const tax = Math.floor(subtotal * (taxRate / 100));
    
    // åˆè¨ˆ
    const total = subtotal + tax;
    
    return { setTotal, single, douhan, shimei, tax, total, subtotal, taxRate, shimeiCastCount };
}

// åˆæœŸæ–™é‡‘ã‚’æ³¨æ–‡ã¨ã—ã¦è¿½åŠ 
async function addInitialCharge(sessionId, itemName, price, quantity) {
    try {
        // ã¾ãšãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã€Œã‚»ãƒƒãƒˆæ–™é‡‘ã€ç­‰ãŒã‚ã‚‹ã‹ç¢ºèªã€ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆè¨ˆã«ç›´æ¥è¿½åŠ 
        // ç°¡æ˜“å®Ÿè£…ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ã® current_total ã‚’ç›´æ¥æ›´æ–°
        await apiRequest(`/sessions/${sessionId}/add-charge`, {
            method: 'POST',
            body: JSON.stringify({
                item_name: itemName,
                price: price,
                quantity: quantity
            })
        });
    } catch (e) {
        console.warn(`[addInitialCharge] ${itemName} ã®è¿½åŠ ã«å¤±æ•—ï¼ˆAPIæœªå¯¾å¿œã®å¯èƒ½æ€§ï¼‰:`, e);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
        const session = appState.activeSessions.find(s => Number(s.id) === Number(sessionId));
        if (session) {
            if (!session.orders) session.orders = [];
            session.orders.push({
                id: Date.now(),
                item_name: itemName,
                price: price,
                quantity: quantity,
                is_served: true,
                created_at: new Date().toISOString()
            });
            session.currentTotal = (session.currentTotal || 0) + (price * quantity);
        }
    }
}

async function openTableDetail(tableId) {
  const tId = Number(tableId);

  appState.currentTableId = tId;
  appState.isTableDetailOpen = true;

  const panel = document.getElementById('tableDetailPanel');
  if (panel) {
    panel.dataset.tableId = String(tId);
    panel.classList.remove('hidden');
  }

  const API = API_BASE_URL;

  const msg = (s, isErr = false) => {
    const el = document.getElementById('tableDetailMsg');
    if (el) el.innerHTML = `<div class="${isErr ? 'text-rose-300' : 'text-white/70'}">${s}</div>`;
  };

  const fetchJson = async (path, options = {}) => {
    const res = await fetch(`${API}${path}`, {
      headers: { 'Content-Type': 'application/json' },
      ...options,
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
    if (!res.ok) throw new Error(`HTTP ${res.status} ${text}`);
    return data;
  };

  const closePanel = () => {
    appState.isTableDetailOpen = false;
    const p = document.getElementById('tableDetailPanel');
    if (p) {
      p.innerHTML = '';
      p.classList.add('hidden');
    }
  };

  const fetchActiveForTable = async () => {
    const active = await fetchJson('/sessions/active', { method: 'GET' });
    const list = Array.isArray(active) ? active : (active.sessions || []);
    return list.find(s => Number(s.table_id) === tId) || null;
  };

  const fetchBundle = async (sessionId) => {
    const [menu, orders, casts] = await Promise.all([
      fetchJson('/menu', { method: 'GET' }).catch(() => []),
      fetchJson(`/sessions/${sessionId}/orders`, { method: 'GET' }).catch(() => []),
      fetchJson('/casts', { method: 'GET' }).catch(() => []),
    ]);
    return { menu, orders, casts };
  };

  const fetchCastsOnly = async () => {
    return await fetchJson('/casts', { method: 'GET' }).catch(() => []);
  };

  try {
    const session = await fetchActiveForTable();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡ã— â†’ â€œç®¡ç†ã‹ã‚‰é–‹å§‹â€UIã‚’å‡ºã™
    if (!session) {
      const casts = await fetchCastsOnly();
      renderTableDetailPanel({
        id: '-',
        table_id: tId,
        guests: 0,
        inhouse_nomination_count: 0,
        has_hon_nomination: false,
        set_minutes: 60,
        extra_minutes: 0,
        current_total: 0,
        start_time: null,
        check_due_at: null,
        extension_count: 0,
        _menu: [],
        _orders: [],
        _casts: casts,
      });
      msg('ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æœªé–‹å§‹ã§ã™ã€‚ç®¡ç†ã‹ã‚‰é–‹å§‹ã§ãã¾ã™ã€‚');
      wireTableDetailEvents(null);
      return;
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ã‚Š â†’ è©³ç´°ä¸€å¼è¡¨ç¤º
    const b = await fetchBundle(session.id);
    renderTableDetailPanel({ ...session, _menu: b.menu, _orders: b.orders, _casts: b.casts });
    msg('èª­ã¿è¾¼ã¿OK');
    wireTableDetailEvents(session.id);

    async function refreshPanel() {
      const s2 = await fetchActiveForTable();
      if (!s2) {
        // é€”ä¸­ã§ç²¾ç®—ãªã©ã§æ¶ˆãˆãŸ
        const casts = await fetchCastsOnly();
        renderTableDetailPanel({ id:'-', table_id:tId, _casts:casts, _menu:[], _orders:[] });
        msg('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', true);
        wireTableDetailEvents(null);
        return;
      }
      const b2 = await fetchBundle(s2.id);
      renderTableDetailPanel({ ...s2, _menu: b2.menu, _orders: b2.orders, _casts: b2.casts });
      wireTableDetailEvents(s2.id);

      if (typeof syncWithBackend === 'function') await syncWithBackend();
    }

    function wireTableDetailEvents(sessionId) {
      // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ + ä¸­èº«ã‚¯ãƒªãƒƒã‚¯ã¯é–‰ã˜ãªã„
      const overlay = document.getElementById('tableDetailOverlay');
      const modal = document.getElementById('tableDetailModal');
      if (overlay) overlay.onclick = closePanel;
      if (modal) modal.onclick = (e) => e.stopPropagation();

      const btnClose = document.getElementById('btnCloseTableDetail');
      if (btnClose) btnClose.onclick = closePanel;

      // âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡ã—ã§ã‚‚ã€Œé–‹å§‹ã€ã‚’é…ç·š
      const btnStart = document.getElementById('btnStartSession');
      if (!sessionId) {
        if (btnStart) {
          btnStart.onclick = async () => {
            try {
              msg('ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ä¸­...');
              const guests = Number(document.getElementById('inpStartGuests')?.value ?? 1);
              const catchStaff = (document.getElementById('inpStartCatch')?.value ?? '').trim();
              
              // æ–™é‡‘ã‚ªãƒ—ã‚·ãƒ§ãƒ³
              const hasDouhan = document.getElementById('chkDouhan')?.checked ?? false;
              
              // æŒ‡åã‚­ãƒ£ã‚¹ãƒˆã‚’å–å¾—ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
              const shimeiCasts = Array.from(document.querySelectorAll('.shimei-cast-checkbox:checked')).map(c => ({
                id: Number(c.value),
                name: c.dataset.name
              }));
              const hasShimei = shimeiCasts.length > 0;
              
              // æœ€åˆã®æŒ‡åã‚­ãƒ£ã‚¹ãƒˆã‚’cast_idã¨ã—ã¦ä½¿ç”¨ï¼ˆæŒ‡åãªã—ãªã‚‰0=ãƒ•ãƒªãƒ¼ï¼‰
              const castId = hasShimei ? shimeiCasts[0].id : 0;
              
              // TAXç‡ã‚’å–å¾—
              const taxRate = Number(document.getElementById('selTaxRate')?.value ?? 20);

              if (!guests || guests <= 0) throw new Error('å®¢äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

              // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
              const sessionRes = await fetchJson('/sessions', {
                method: 'POST',
                body: JSON.stringify({
                  table_id: tId,
                  cast_id: castId,
                  guests: guests,
                  catch_staff: catchStaff || null,
                  has_companion: hasDouhan,
                  companion_name: null,
                  nomination_type: hasShimei ? 'shimei' : (hasDouhan ? 'douhan' : null),
                  nomination_fee: shimeiCasts.length * 2000,
                  shimei_casts: shimeiCasts.map(c => c.name).join(', '),
                  tax_rate: taxRate,
                  store_id: sessionStorage.getItem('cabax_store_id') ? Number(sessionStorage.getItem('cabax_store_id')) : null
                })
              });
              
              // åˆæœŸæ–™é‡‘ã‚’è¿½åŠ 
              const newSessionId = sessionRes?.id;
              if (newSessionId && typeof calculateStartCharges === 'function') {
                const charges = calculateStartCharges();
                if (charges.setTotal > 0) await addInitialCharge(newSessionId, 'ã‚»ãƒƒãƒˆæ–™é‡‘', charges.setTotal, 1);
                if (charges.single > 0) await addInitialCharge(newSessionId, 'ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸', charges.single, 1);
                if (charges.douhan > 0) await addInitialCharge(newSessionId, 'åŒä¼´æ–™', charges.douhan, 1);
                // æŒ‡åæ–™ã¯å„ã‚­ãƒ£ã‚¹ãƒˆã”ã¨ã«è¨˜éŒ²
                if (shimeiCasts.length > 0) {
                  for (const cast of shimeiCasts) {
                    await addInitialCharge(newSessionId, `æŒ‡åæ–™ï¼ˆ${cast.name}ï¼‰`, 2000, 1);
                  }
                }
                // TAXã¯ä¼šè¨ˆæ™‚ã«å…¨ä½“ã®å°è¨ˆã«å¯¾ã—ã¦è¨ˆç®—ï¼ˆç¨ç‡ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜æ¸ˆã¿ï¼‰
              }

              msg('é–‹å§‹ã—ã¾ã—ãŸ');
              await openTableDetail(tId);
              if (typeof syncWithBackend === 'function') await syncWithBackend();
            } catch (e) {
              console.error(e);
              msg(`é–‹å§‹å¤±æ•—: ${e.message}`, true);
            }
          };
        }
        // æ–™é‡‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆæœŸåŒ–
        if (typeof updateStartCharges === 'function') setTimeout(() => updateStartCharges(), 100);
        
        // æŒ‡åã‚­ãƒ£ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        document.querySelectorAll('.shimei-cast-checkbox').forEach(cb => {
          cb.addEventListener('change', updateStartCharges);
        });
        return;
      }

      // ---- ã“ã“ã‹ã‚‰æ—¢å­˜ï¼ˆå»¶é•·/æ³¨æ–‡/ç²¾ç®—ï¼‰ ----
      const btnSaveAttrs = document.getElementById('btnSaveAttrs');
      const btnUpdateTiming = document.getElementById('btnUpdateTiming');
      const btnExtend30 = document.getElementById('btnExtend30');
      const btnExtend60 = document.getElementById('btnExtend60');
      const btnAddOrder = document.getElementById('btnAddOrder');
      const btnCheckout = document.getElementById('btnCheckout');
      
      // â˜… è¿½åŠ æ³¨æ–‡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠåˆæœŸåŒ–ï¼ˆå‰²ã‚Šæ–¹é¸æŠã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
      if (typeof onOrderMenuChange === 'function') {
        onOrderMenuChange();
      }

      if (btnSaveAttrs) {
        btnSaveAttrs.onclick = async () => {
          try {
            msg('ä¿å­˜ä¸­...');
            const guests = Number(document.getElementById('inpGuests')?.value ?? 0);
            const inhouse = Number(document.getElementById('inpInhouse')?.value ?? 0);
            const hon = !!document.getElementById('chkHon')?.checked;

            await fetchJson(`/sessions/${sessionId}/attributes`, {
              method: 'PUT',
              body: JSON.stringify({
                guests,
                inhouse_nomination_count: inhouse,
                has_hon_nomination: hon
              })
            });

            msg('ä¿å­˜ã—ã¾ã—ãŸï¼ˆæ¬¡å›å»¶é•·ã‹ã‚‰åæ˜ ï¼‰');
            await refreshPanel();
          } catch (e) {
            console.error(e);
            msg(`ä¿å­˜å¤±æ•—: ${e.message}`, true);
          }
        };
      }

      if (btnUpdateTiming) {
        btnUpdateTiming.onclick = async () => {
          try {
            msg('ã‚»ãƒƒãƒˆåˆ†æ•°ã‚’æ›´æ–°ä¸­...');
            const setMinutes = Number(document.getElementById('selSetMinutes')?.value ?? 60);

            await fetchJson(`/sessions/${sessionId}/timing`, {
              method: 'PUT',
              body: JSON.stringify({ set_minutes: setMinutes })
            });

            msg('ã‚»ãƒƒãƒˆåˆ†æ•°ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            await refreshPanel();
          } catch (e) {
            console.error(e);
            msg(`æ›´æ–°å¤±æ•—: ${e.message}`, true);
          }
        };
      }

      if (btnExtend30) {
        btnExtend30.onclick = async () => {
          try {
            msg('30åˆ†å»¶é•·ï¼ˆè‡ªå‹•æ³¨æ–‡è¿½åŠ ï¼‰ä¸­...');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
            const sessionData = appState.activeSessions.find(s => Number(s.id) === Number(sessionId));
            const guests = Number(sessionData?.guests ?? 1);
            const shimeiCastsStr = sessionData?.shimei_casts || '';
            const shimeiCount = shimeiCastsStr ? shimeiCastsStr.split(',').filter(n => n.trim()).length : 0;
            
            // å»¶é•·æ–™é‡‘è¨ˆç®—: äººæ•°Ã—3000 + æŒ‡åæ•°Ã—2000 + ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ï¼ˆ1åã®ã¿ï¼‰
            const setExtension = guests * 3000;
            const shimeiExtension = shimeiCount * 2000;
            const singleCharge = guests === 1 ? 2000 : 0;
            
            // å»¶é•·APIã‚’å‘¼ã¶
            await fetchJson(`/sessions/${sessionId}/extend`, {
              method: 'POST'
            });
            
            // å»¶é•·ã‚»ãƒƒãƒˆæ–™é‡‘ã‚’æ³¨æ–‡ã«è¿½åŠ 
            if (setExtension > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: `å»¶é•·30åˆ†ï¼ˆ${guests}åÃ—3000ï¼‰`,
                  price: setExtension,
                  quantity: 1
                })
              });
            }
            
            // ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ã‚’æ³¨æ–‡ã«è¿½åŠ ï¼ˆ1åã®å ´åˆã®ã¿ï¼‰
            if (singleCharge > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: 'ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ï¼ˆå»¶é•·ï¼‰',
                  price: singleCharge,
                  quantity: 1
                })
              });
            }
            
            // å»¶é•·æŒ‡åæ–™ã‚’æ³¨æ–‡ã«è¿½åŠ 
            if (shimeiExtension > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: `å»¶é•·æŒ‡åæ–™ï¼ˆ${shimeiCount}åÃ—2000ï¼‰`,
                  price: shimeiExtension,
                  quantity: 1
                })
              });
            }
            
            msg('30åˆ†å»¶é•·ã—ã¾ã—ãŸ');
            await refreshPanel();
            if (typeof syncWithBackend === 'function') await syncWithBackend();
          } catch (e) {
            console.error(e);
            msg(`å»¶é•·å¤±æ•—: ${e.message}`, true);
          }
        };
      }

      if (btnExtend60) {
        btnExtend60.onclick = async () => {
          try {
            msg('60åˆ†å»¶é•·ï¼ˆè‡ªå‹•æ³¨æ–‡è¿½åŠ ï¼‰ä¸­...');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
            const sessionData = appState.activeSessions.find(s => Number(s.id) === Number(sessionId));
            const guests = Number(sessionData?.guests ?? 1);
            const shimeiCastsStr = sessionData?.shimei_casts || '';
            const shimeiCount = shimeiCastsStr ? shimeiCastsStr.split(',').filter(n => n.trim()).length : 0;
            
            // å»¶é•·æ–™é‡‘è¨ˆç®—: äººæ•°Ã—5000 + æŒ‡åæ•°Ã—2000 + ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ï¼ˆ1åã®ã¿ï¼‰
            const setExtension = guests * 5000;
            const shimeiExtension = shimeiCount * 2000;
            const singleCharge = guests === 1 ? 2000 : 0;
            
            // å»¶é•·APIã‚’å‘¼ã¶
            await fetchJson(`/sessions/${sessionId}/extend`, {
              method: 'POST'
            });
            
            // å»¶é•·ã‚»ãƒƒãƒˆæ–™é‡‘ã‚’æ³¨æ–‡ã«è¿½åŠ 
            if (setExtension > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: `å»¶é•·60åˆ†ï¼ˆ${guests}åÃ—5000ï¼‰`,
                  price: setExtension,
                  quantity: 1
                })
              });
            }
            
            // ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ã‚’æ³¨æ–‡ã«è¿½åŠ ï¼ˆ1åã®å ´åˆã®ã¿ï¼‰
            if (singleCharge > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: 'ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ£ãƒ¼ã‚¸ï¼ˆå»¶é•·ï¼‰',
                  price: singleCharge,
                  quantity: 1
                })
              });
            }
            
            // å»¶é•·æŒ‡åæ–™ã‚’æ³¨æ–‡ã«è¿½åŠ 
            if (shimeiExtension > 0) {
              await fetchJson(`/sessions/${sessionId}/add-charge`, {
                method: 'POST',
                body: JSON.stringify({
                  item_name: `å»¶é•·æŒ‡åæ–™ï¼ˆ${shimeiCount}åÃ—2000ï¼‰`,
                  price: shimeiExtension,
                  quantity: 1
                })
              });
            }
            
            msg('60åˆ†å»¶é•·ã—ã¾ã—ãŸ');
            await refreshPanel();
            if (typeof syncWithBackend === 'function') await syncWithBackend();
          } catch (e) {
            console.error(e);
            msg(`å»¶é•·å¤±æ•—: ${e.message}`, true);
          }
        };
      }

      if (btnAddOrder) {
        btnAddOrder.onclick = async () => {
          try {
            msg('æ³¨æ–‡è¿½åŠ ä¸­...');
            const itemId = Number(document.getElementById('selAddOrderItem')?.value);
            let qty = Number(document.getElementById('inpAddOrderQty')?.value ?? 1);
            if (!itemId || qty <= 0) throw new Error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼/æ•°é‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆAPIã‹ã‚‰ï¼‰
            const menuData = await fetchJson('/menu', { method: 'GET' }).catch(() => []);
            const menuItem = menuData.find(m => m.id === itemId);
            const category = menuItem?.category?.toLowerCase() || '';
            const itemName = menuItem?.name || '';
            const isDrinkCategory = ['drink', 'bottle', 'champagne', 'wine'].includes(category);
            
            // æœ‰æ–™ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼‰
            const isPaidDrink = paidDrinksAdmin.includes(itemName);
            
            // å‰²ã‚Šæ–¹ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const hasMixStyle = mixStylesAdmin[itemName] !== undefined;
            
            // ãƒ‰ãƒªãƒ³ã‚¯ã‚µã‚¤ã‚ºã«ã‚ˆã‚‹ä¾¡æ ¼èª¿æ•´
            let finalPrice = menuItem?.price || 0;
            let itemNameSuffix = '';
            
            // å‰²ã‚Šæ–¹ãŒã‚ã‚‹å ´åˆã¯åå‰ã«è¿½åŠ 
            if (hasMixStyle && selectedMixStyleAdmin) {
              itemNameSuffix = 'ï¼ˆ' + selectedMixStyleAdmin + 'ï¼‰';
            }
            
            if (isPaidDrink) {
              // ã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ã¯çµ±ä¸€ä¾¡æ ¼ã€ã‚µã‚¤ã‚ºãªã—
              finalPrice = menuItem?.price || 2000;
            } else if (category === 'drink') {
              const drinkFor = document.querySelector('input[name="drinkFor"]:checked')?.value || 'customer';
              if (drinkFor === 'customer') {
                // ãŠå®¢æ§˜ã®ã‚»ãƒƒãƒˆãƒ‰ãƒªãƒ³ã‚¯ã¯0å††
                finalPrice = 0;
              } else {
                // ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•ã¯ã‚µã‚¤ã‚ºã§ä¾¡æ ¼æ±ºå®š
                const drinkSize = document.querySelector('input[name="drinkSize"]:checked')?.value || 'single';
                const drinkPrices = { single: 1000, double: 2000, triple: 3000 };
                finalPrice = drinkPrices[drinkSize];
                const sizeLabel = drinkSize === 'single' ? 'ã‚·ãƒ³ã‚°ãƒ«' : drinkSize === 'double' ? 'ãƒ€ãƒ–ãƒ«' : 'ãƒˆãƒªãƒ—ãƒ«';
                // å‰²ã‚Šæ–¹ãŒã‚ã‚‹å ´åˆã¯ã€Œéº¦ç„¼é…ï¼ˆãƒ­ãƒƒã‚¯ãƒ»ã‚·ãƒ³ã‚°ãƒ«ï¼‰ã€ã®ã‚ˆã†ã«è¡¨ç¤º
                if (hasMixStyle && selectedMixStyleAdmin) {
                  itemNameSuffix = 'ï¼ˆ' + selectedMixStyleAdmin + 'ãƒ»' + sizeLabel + 'ï¼‰';
                } else {
                  itemNameSuffix = 'ï¼ˆ' + sizeLabel + 'ï¼‰';
                }
              }
            }
            
            // èª°ãŒé£²ã‚€ã‹
            let drinkFor = 'customer';
            let personName = null;
            let isDrinkBack = false;
            
            if (isDrinkCategory) {
              drinkFor = document.querySelector('input[name="drinkFor"]:checked')?.value || 'customer';
              
              if (drinkFor === 'cast' || drinkFor === 'staff') {
                personName = document.getElementById('selDrinkPerson')?.value || null;
                if (!personName) throw new Error('ã‚­ãƒ£ã‚¹ãƒˆã¾ãŸã¯ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„');
                isDrinkBack = (drinkFor === 'cast'); // ã‚­ãƒ£ã‚¹ãƒˆã®å ´åˆã®ã¿ãƒãƒƒã‚¯ç™ºç”Ÿ
              }
            }

            await fetchJson('/orders', {
              method: 'POST',
              body: JSON.stringify({
                session_id: sessionId,
                menu_item_id: itemId,
                quantity: qty,
                is_drink_back: isDrinkBack,
                cast_name: personName,
                drink_for: drinkFor,
                custom_price: finalPrice,
                item_suffix: itemNameSuffix
              })
            });

            msg('æ³¨æ–‡ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆDBåæ˜ ï¼‰');
            await refreshPanel();
          } catch (e) {
            console.error(e);
            msg(`æ³¨æ–‡è¿½åŠ å¤±æ•—: ${e.message}`, true);
          }
        };
      }

      if (btnCheckout) {
        btnCheckout.onclick = async () => {
          try {
            if (!confirm('ç²¾ç®—ã—ã¾ã™ã‹ï¼Ÿï¼ˆDBæ³¨æ–‡åˆè¨ˆã‹ã‚‰å†è¨ˆç®—ã—ã¦ç¢ºå®šï¼‰')) return;
            
            // â˜… ç²¾ç®—å‰ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
            const sessionToCheckout = appState.activeSessions.find(s => 
              Number(s.id) === Number(sessionId)
            );
            
            // â˜… ä¼ç¥¨ç”¨ã«æ³¨æ–‡ã‚’å–å¾—
            let ordersForReceipt = [];
            try {
              const ordersData = await fetchJson(`/sessions/${sessionId}/orders`);
              ordersForReceipt = Array.isArray(ordersData) ? ordersData : [];
            } catch (e) {
              console.warn('[checkout] orders fetch failed:', e);
            }
            
            // â˜… ä¼šè¨ˆæ™‚ã«TAXã‚’è¨ˆç®—
            const taxRate = sessionToCheckout?.taxRate || sessionToCheckout?.tax_rate || 20;
            const subtotalAmount = ordersForReceipt.reduce((sum, o) => sum + (o.price * o.quantity), 0);
            const taxAmount = Math.floor(subtotalAmount * (taxRate / 100));
            const totalWithTax = subtotalAmount + taxAmount;
            
            // TAXã‚’æ³¨æ–‡ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºç”¨ï¼‰
            if (taxAmount > 0) {
              ordersForReceipt.push({
                item_name: `TAX/ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ${taxRate}%ï¼‰`,
                quantity: 1,
                price: taxAmount
              });
            }
            
            msg('ç²¾ç®—ä¸­...');
            const result = await fetchJson(`/sessions/${sessionId}/checkout`, { method: 'PUT' });
            
            
            // â˜… checkoutHistoryã«è¿½åŠ 
            if (sessionToCheckout) {
              const checkoutRecord = {
                ...sessionToCheckout,
                checkoutTime: new Date().toISOString(),
                totalAmount: totalWithTax,
                orders: ordersForReceipt, // æ³¨æ–‡å±¥æ­´ã‚’ä¿å­˜
                status: 'completed'
              };
              appState.checkoutHistory.push(checkoutRecord);
              
              
              // localStorageã«ã‚‚ä¿å­˜
              try {
                localStorage.setItem('cabax_checkoutHistory', JSON.stringify(appState.checkoutHistory));
              } catch (e) {
                console.warn('localStorageä¿å­˜ã«å¤±æ•—:', e);
              }
              
              // â˜… ä¼ç¥¨ã‚’è¡¨ç¤º
              console.log('[checkout] showReceiptå‘¼ã³å‡ºã—', sessionToCheckout, ordersForReceipt);
              showReceipt(sessionToCheckout, ordersForReceipt);
            } else {
              // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªãã¦ã‚‚ä¼ç¥¨ã‚’è¡¨ç¤º
              showReceipt({ guests: 0, castName: 'ä¸æ˜', tableName: 'ä¸æ˜', currentTotal: result?.final_total || 0 }, ordersForReceipt);
            }
            
            msg('ç²¾ç®—ã—ã¾ã—ãŸ');
            closePanel();
            if (typeof syncWithBackend === 'function') await syncWithBackend();
            
            // â˜… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»æ—¥å ±ãƒ»ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°
            if (typeof updateDashboard === 'function') updateDashboard();
            if (typeof renderDailyReport === 'function') renderDailyReport();
            if (typeof renderReports === 'function') renderReports();
            
          } catch (e) {
            console.error(e);
            msg(`ç²¾ç®—å¤±æ•—: ${e.message}`, true);
          }
        };
      }
    }

  } catch (e) {
    console.error(e);
    // å¤±æ•—ã—ã¦ã‚‚â€œé–‰ã˜ã‚‹â€ã ã‘ã¯æŠ¼ã›ã‚‹çŠ¶æ…‹ã«ã™ã‚‹
    renderTableDetailPanel({ id:'-', table_id:tId, _casts:[], _menu:[], _orders:[] });
    msg(`ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã®å–å¾—ã«å¤±æ•—: ${e.message}`, true);

    const btnClose = document.getElementById('btnCloseTableDetail');
    if (btnClose) btnClose.onclick = closePanel;
    const overlay = document.getElementById('tableDetailOverlay');
    const modal = document.getElementById('tableDetailModal');
    if (overlay) overlay.onclick = closePanel;
    if (modal) modal.onclick = (ev) => ev.stopPropagation();
  }
}



// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆè¨ˆé‡‘é¡ã‚’ã¾ã¨ã‚ã¦å†è¨ˆç®—ï¼ˆå°è¨ˆï¼‹èª¿æ•´ï¼‰
function recalcSessionTotal(session) {
    const orders = session.orders || [];
    const adjustments = session.adjustments || [];

    // æ³¨æ–‡å°è¨ˆ
    const ordersTotal = orders.reduce((sum, o) => {
        const q = o.quantity || 1;
        const p = o.price || 0;
        return sum + p * q;
    }, 0);

    // èª¿æ•´åˆè¨ˆï¼ˆå‰²å¼•ã¯ãƒã‚¤ãƒŠã‚¹ã€ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒ—ãƒ©ã‚¹ï¼‰
    const adjustmentsTotal = adjustments.reduce((sum, adj) => {
        return sum + (adj.amount || 0);
    }, 0);

    // å‚ç…§ã—ã‚„ã™ã„ã‚ˆã†ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æŒã£ã¦ãŠã
    session.ordersTotal = ordersTotal;
    session.adjustmentsTotal = adjustmentsTotal;
    session.currentTotal = ordersTotal + adjustmentsTotal;
}


// æ•°é‡ã‚’ +1 / -1 ã™ã‚‹
function changeOrderQuantity(tableId, orderIndex, delta) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    const orders = session.orders || [];
    const order = orders[orderIndex];
    if (!order) return;

    const currentQty = order.quantity || 1;
    const newQty = currentQty + delta;

    if (newQty <= 0) {
        // 0ä»¥ä¸‹ã«ãªã£ãŸã‚‰å‰Šé™¤æ‰±ã„
        if (!confirm(`${order.itemName} ã‚’æ³¨æ–‡ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }
        orders.splice(orderIndex, 1);
        showNotification(`${order.itemName} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
    } else {
        order.quantity = newQty;
        showNotification(`${order.itemName} ã®æ•°é‡ã‚’ ${newQty} ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
    }

    recalcSessionTotal(session);
    renderTables();
    openTableDetail(tableId);
}

// å®Œå…¨ã«å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
function deleteOrder(tableId, orderIndex) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    const orders = session.orders || [];
    const order = orders[orderIndex];
    if (!order) return;

    if (!confirm(`${order.itemName} ã‚’æ³¨æ–‡ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    orders.splice(orderIndex, 1);
    recalcSessionTotal(session);

    renderTables();
    openTableDetail(tableId);
    showNotification(`${order.itemName} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
}
// èª¿æ•´è¡Œã®è¿½åŠ ï¼ˆå‰²å¼•ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ãƒ»ãã®ä»–ï¼‰
function addAdjustment(tableId, type) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    if (!session.adjustments) {
        session.adjustments = [];
    }

    let defaultLabel = '';
    let sign = 1;

    if (type === 'discount') {
        defaultLabel = 'å‰²å¼•';
        sign = -1; // å‰²å¼•ã¯ãƒã‚¤ãƒŠã‚¹
    } else if (type === 'service') {
        defaultLabel = 'ã‚µãƒ¼ãƒ“ã‚¹';
        sign = 1;  // ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒ—ãƒ©ã‚¹
    } else {
        defaultLabel = 'èª¿æ•´';
        sign = 1;
    }

    const label = prompt('å†…å®¹ï¼ˆä¾‹ï¼šãƒœãƒˆãƒ«ã‚µãƒ¼ãƒ“ã‚¹ã€VIPå‰²å¼•ãªã©ï¼‰', defaultLabel);
    if (label === null) return;

    const raw = prompt('é‡‘é¡ï¼ˆå††ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š1000ï¼‰', '1000');
    if (raw === null) return;

    const amountValue = parseInt(raw, 10);
    if (isNaN(amountValue)) {
        showNotification('é‡‘é¡ã¯æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }

    const amount = sign * Math.abs(amountValue);

    session.adjustments.push({
        type,           // 'discount' | 'service' | 'other'
        label,
        amount          // å‰²å¼•ãªã‚‰ãƒã‚¤ãƒŠã‚¹ã€ã‚µãƒ¼ãƒ“ã‚¹ãªã‚‰ãƒ—ãƒ©ã‚¹
    });

    recalcSessionTotal(session);
    renderTables();
    openTableDetail(tableId);
    showNotification(`${label} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
}

// èª¿æ•´è¡Œã®å‰Šé™¤
function removeAdjustment(tableId, index) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session || !session.adjustments) return;

    const adj = session.adjustments[index];
    if (!adj) return;

    if (!confirm(`${adj.label}ï¼ˆ${adj.amount}å††ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    session.adjustments.splice(index, 1);
    recalcSessionTotal(session);
    renderTables();
    openTableDetail(tableId);
    showNotification(`${adj.label} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
}

function addOrderToTable(menuItemId) {
    const tableId = appState.currentTableId;
    if (!tableId) {
        showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
    }

    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) {
        showNotification('ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ç¾åœ¨ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
    }

    const menuItem = appState.menuItems.find(m => m.id === menuItemId);
    if (!menuItem) return;

    // DBæ³¨æ–‡ã‹ã©ã†ã‹ï¼ˆãƒ‰ãƒªãƒ³ã‚¯ã ã‘ç¢ºèªï¼‰
    let isDrinkBack = false;
    let castName = null;

    if (menuItem.category === 'drink') {
        const confirmDb = confirm(
            `${menuItem.name} ã‚’DBæ³¨æ–‡ã«ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
            `OK = DBæ³¨æ–‡ï¼ˆ${session.castName || ''}ï¼‰\nã‚­ãƒ£ãƒ³ã‚»ãƒ« = é€šå¸¸æ³¨æ–‡`
        );
        if (confirmDb) {
            isDrinkBack = true;
            castName = session.castName;
        }
    }

    // â˜… ã™ã§ã«åŒã˜æ¡ä»¶ã®æ³¨æ–‡ãŒã‚ã‚‹ã‹æ¢ã™
    const existingOrder = (session.orders || []).find(o =>
        o.itemName === menuItem.name &&
        (o.price || 0) === menuItem.price &&
        (o.category || 'other') === (menuItem.category || 'other') &&
        !!o.isDrinkBack === isDrinkBack &&
        (o.castName || '') === (castName || '')
    );

    if (existingOrder) {
        // æ—¢å­˜è¡Œã®æ•°é‡ã ã‘ +1
        existingOrder.quantity = (existingOrder.quantity || 1) + 1;
    } else {
        // ãªã‘ã‚Œã°æ–°è¦è¡Œã‚’è¿½åŠ 
        session.orders.push({
            itemName: menuItem.name,
            category: menuItem.category,
            price: menuItem.price,
            quantity: 1,
            isDrinkBack,
            castName
        });
    }

    // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—ï¼ˆã•ã£ãä½œã£ãŸã‚„ã¤ã‚’åˆ©ç”¨ï¼‰
    recalcSessionTotal(session);

    renderTables();
    openTableDetail(tableId);
    showNotification(`${menuItem.name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
}


function checkoutTable(tableId) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    // å¿µã®ãŸã‚æœ€æ–°ã®é‡‘é¡ã‚’å†è¨ˆç®—ï¼ˆrecalcSessionTotal ã‚’ä½¿ã£ã¦ã„ã‚‹å‰æï¼‰
    if (typeof recalcSessionTotal === 'function') {
        recalcSessionTotal(session);
    }

    const confirmMsg =
        'ãƒ†ãƒ¼ãƒ–ãƒ« ' + (session.tableName || '') + ' ã®ç²¾ç®—ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ\n\n' +
        'åˆè¨ˆ: Â¥' + (session.currentTotal || 0).toLocaleString();

    if (!confirm(confirmMsg)) {
        return;
    }

    // ä¼ç¥¨ã‚’è¡¨ç¤ºã™ã‚‹ã‹ç¢ºèª
    const wantReceipt = confirm(
        'ã“ã®å†…å®¹ã§ä¼ç¥¨ï¼ˆå°åˆ·ç”¨ï¼‰ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ\n\n' +
        'OK = ä¼ç¥¨ç”»é¢ã‚’é–‹ã\nã‚­ãƒ£ãƒ³ã‚»ãƒ« = é–‹ã‹ãªã„'
    );

    if (wantReceipt) {
        // ã‚³ãƒ”ãƒ¼ã‚’ä½œã£ã¦æ¸¡ã™ï¼ˆã‚ã¨ã§æ›¸ãæ›ãˆã‚‰ã‚Œã¦ã‚‚ã„ã„ã‚ˆã†ã«ï¼‰
        const sessionCopy = JSON.parse(JSON.stringify(session));
        if (typeof recalcSessionTotal === 'function') {
            recalcSessionTotal(sessionCopy);
        }
        openReceiptWindow(tableId, sessionCopy);
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç²¾ç®—æ¸ˆã¿ã«ç§»å‹•
    session.checkoutTime = new Date().toISOString();
    session.totalAmount = session.currentTotal;

    appState.checkoutHistory.push({ ...session });
    appState.activeSessions = appState.activeSessions.filter(s => s.id !== session.id);
    
    // â˜… checkoutHistoryã‚’localStorageã«ä¿å­˜ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚ä¿æŒï¼‰
    try {
        localStorage.setItem('cabax_checkoutHistory', JSON.stringify(appState.checkoutHistory));
    } catch (e) {
        console.warn('localStorageä¿å­˜ã«å¤±æ•—:', e);
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç©ºå¸­ã«
    const table = appState.tables.find(t => t.id === tableId);
    if (table) table.status = 'available';

    renderTables();
    updateDashboard();
    renderDailyReport();
    closeModal('tableDetailModal');
    showNotification('ç²¾ç®—ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
}
function openReceiptWindow(tableId, session) {
    const table = appState.tables.find(t => t.id === tableId);
    if (!table) return;

    const orders = session.orders || [];
    const adjustments = session.adjustments || [];
    const ordersTotal = session.ordersTotal || 0;
    const adjustmentsTotal = session.adjustmentsTotal || 0;
    const finalTotal = session.currentTotal || 0;

    const checkoutDate = session.checkoutTime ? new Date(session.checkoutTime) : new Date();
    const dateStr =
        checkoutDate.getFullYear() + '-' +
        String(checkoutDate.getMonth() + 1).padStart(2, '0') + '-' +
        String(checkoutDate.getDate()).padStart(2, '0') + ' ' +
        String(checkoutDate.getHours()).padStart(2, '0') + ':' +
        String(checkoutDate.getMinutes()).padStart(2, '0');

    const shopName = (SHOP_INFO && SHOP_INFO.name) || 'Cabax';
    const shopAddress = (SHOP_INFO && SHOP_INFO.address) || '';
    const shopTel = (SHOP_INFO && SHOP_INFO.tel) || '';

    // æ³¨æ–‡è¡Œ
    let rowsHtml = '';
    orders.forEach(function(order) {
        const name = order.itemName || '';
        const qty = order.quantity || 1;
        const price = order.price || 0;
        const lineTotal = price * qty;
        rowsHtml +=
            '<tr>' +
                '<td>' + name + '</td>' +
                '<td class="num">' + qty + '</td>' +
                '<td class="num">Â¥' + price.toLocaleString() + '</td>' +
                '<td class="num">Â¥' + lineTotal.toLocaleString() + '</td>' +
            '</tr>';
    });

    // å‰²å¼•ãƒ»ã‚µãƒ¼ãƒ“ã‚¹è¡Œ
    if (adjustments.length > 0) {
        rowsHtml +=
            '<tr><td colspan="4" class="section-title">å‰²å¼•ãƒ»ã‚µãƒ¼ãƒ“ã‚¹</td></tr>';
        adjustments.forEach(function(adj) {
            const label = adj.label || '';
            const amount = adj.amount || 0;
            rowsHtml +=
                '<tr>' +
                    '<td>' + label + '</td>' +
                    '<td></td>' +
                    '<td></td>' +
                    '<td class="num ' + (amount < 0 ? 'minus' : 'plus') + '">' +
                        (amount < 0 ? 'âˆ’' : '+') + 'Â¥' + Math.abs(amount).toLocaleString() +
                    '</td>' +
                '</tr>';
        });
    }

    // å°åˆ·ç”¨HTMLå…¨ä½“
    const html =
        '<!DOCTYPE html>' +
        '<html lang="ja">' +
        '<head>' +
            '<meta charset="UTF-8">' +
            '<title>ä¼ç¥¨ - ' + table.name + '</title>' +
            '<style>' +
                'body{font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;margin:16px;font-size:12px;}' +
                'h1{font-size:18px;margin:0 0 4px;}' +
                'h2{font-size:13px;margin:12px 0 4px;}' +
                'table{width:100%;border-collapse:collapse;margin-top:8px;}' +
                'th,td{border-bottom:1px solid #ccc;padding:4px 2px;}' +
                'th{background:#f3f4f6;font-weight:600;text-align:left;}' +
                'td.num{text-align:right;white-space:nowrap;}' +
                '.section-title{padding-top:8px;font-weight:600;}' +
                '.total-box{margin-top:12px;border-top:1px solid #000;padding-top:8px;}' +
                '.total-box table{width:auto;margin-left:auto;}' +
                '.label{padding-right:12px;}' +
                '.value{text-align:right;}' +
                '.minus{color:#b91c1c;}' +
                '.plus{color:#15803d;}' +
                '.meta{font-size:11px;color:#555;margin-bottom:2px;}' +
                '.header{margin-bottom:12px;border-bottom:1px solid #ddd;padding-bottom:8px;}' +
                '.header-line{font-size:11px;color:#444;}' +
                '.receipt-title{font-size:14px;font-weight:600;margin-top:6px;}' +
                '.header-top{display:flex;justify-content:space-between;align-items:flex-start;}' +
                '.stamp-box{width:90px;height:70px;border:1px solid #000;margin-left:12px;display:flex;align-items:center;justify-content:center;font-size:11px;}' +
                '.stamp-text{writing-mode:vertical-rl;}' +
            '</style>' +
        '</head>' +
        '<body>' +

            // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåº—åãƒ»ä½æ‰€ãƒ»é›»è©±ãƒ»é ˜åå°æ¬„ï¼‰
            '<div class="header">' +
                '<div class="header-top">' +
                    '<div>' +
                        '<h1>' + shopName + '</h1>' +
                        (shopAddress ? '<div class="header-line">ä½æ‰€: ' + shopAddress + '</div>' : '') +
                        (shopTel ? '<div class="header-line">TEL: ' + shopTel + '</div>' : '') +
                        '<div class="receipt-title">é ˜åæ›¸ / ä¼ç¥¨</div>' +
                    '</div>' +
                    '<div class="stamp-box">' +
                        '<div class="stamp-text">é ˜åå°</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +

            '<div class="meta">ãƒ†ãƒ¼ãƒ–ãƒ«: ' + table.name + '</div>' +
            '<div class="meta">æ‹…å½“: ' + (session.castName || '') + '</div>' +
            '<div class="meta">äººæ•°: ' + (session.guests || 0) + 'å</div>' +
            '<div class="meta">ä¼šè¨ˆæ™‚åˆ»: ' + dateStr + '</div>' +

            '<h2>ã”æ³¨æ–‡å†…å®¹</h2>' +
            '<table>' +
                '<thead>' +
                    '<tr>' +
                        '<th>å•†å“</th>' +
                        '<th class="num">æ•°</th>' +
                        '<th class="num">å˜ä¾¡</th>' +
                        '<th class="num">é‡‘é¡</th>' +
                    '</tr>' +
                '</thead>' +
                '<tbody>' +
                    rowsHtml +
                '</tbody>' +
            '</table>' +
            '<div class="total-box">' +
                '<table>' +
                    '<tr><td class="label">å°è¨ˆ</td><td class="value">Â¥' + ordersTotal.toLocaleString() + '</td></tr>' +
                    '<tr><td class="label">èª¿æ•´</td><td class="value">' +
                        (adjustmentsTotal >= 0 ? '+' : 'âˆ’') + 'Â¥' + Math.abs(adjustmentsTotal).toLocaleString() +
                    '</td></tr>' +
                    '<tr><td class="label"><strong>åˆè¨ˆ</strong></td><td class="value"><strong>Â¥' + finalTotal.toLocaleString() + '</strong></td></tr>' +
                '</table>' +
            '</div>' +
        '</body>' +
        '</html>';

    const win = window.open('', 'cabaxReceipt', 'width=480,height=640');
    if (!win) {
        alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
    try {
        win.print();
    } catch (e) {
        console.warn('å°åˆ·ã‚’è‡ªå‹•ã§é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ:', e);
    }
}

function cancelOneFromGroup(tableId, groupIndex) {
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) return;

    const grouped = getGroupedOrders(session);
    const group = grouped[groupIndex];
    if (!group) return;

    const idx = session.orders.findIndex(order =>
        order.itemName === group.itemName &&
        (order.price || 0) === group.price &&
        (order.category || 'other') === group.category &&
        !!order.isDrinkBack === !!group.isDrinkBack &&
        (order.castName || '') === (group.castName || '')
    );

    if (idx === -1) return;

    const target = session.orders[idx];

    // â˜… APIã«ã‚‚å–æ¶ˆã‚’åæ˜ ï¼ˆorder.id ãŒã‚ã£ã¦æ¥ç¶šä¸­ã®ã¨ãã ã‘ï¼‰
    if (appState.apiConnected && target.id) {
        apiRequest(`${API_ENDPOINTS.orders}/${target.id}`, {
            method: 'DELETE'
        }).catch(err => {
            console.warn('Order delete API failed (one):', err);
        });
    }

    const q = target.quantity || 1;
    const diff = (target.price || 0) * q;

    session.currentTotal = Math.max(0, (session.currentTotal || 0) - diff);
    session.orders.splice(idx, 1);

    renderTables();
    openTableDetail(tableId);
    showNotification(`${group.itemName} ã‚’1ä»¶å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`, 'success');
}

 // ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†
 function renderCasts() {
            const grid = document.getElementById('castsGrid');
            if (!grid) return;
            
            // ã‚­ãƒ£ã‚¹ãƒˆãŒãªã„å ´åˆ
            if (!appState.casts || appState.casts.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">ã‚­ãƒ£ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            grid.innerHTML = appState.casts.map(cast => {
                // undefined/nullå¯¾ç­–: stage_name â†’ name â†’ 'Cast#id' ã®é †ã§å–å¾—
                const displayName = cast.stage_name || cast.name || `Cast#${cast.id || '?'}`;
                const initial = displayName.charAt(0) || '?';
                const hourlyRate = Number(cast.hourly_rate || cast.hourlyRate || 0);
                const sales = Number(cast.sales || 0);
                
                return `
                <div class="luxury-card rounded-2xl p-6">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="cast-avatar">
                            ${initial}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-200">${displayName}</h3>
                            <p class="text-sm ${getRankColor(cast.rank)}">${getRankLabel(cast.rank)}</p>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">æ™‚çµ¦</span>
                            <span class="font-semibold text-gray-200">Â¥${hourlyRate.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">æœ¬æ—¥å£²ä¸Š</span>
                            <span class="font-bold gold-accent">Â¥${sales.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCast(${cast.id})" class="flex-1 bg-blue-900/20 text-blue-400 border border-blue-800/30 py-2 rounded-xl hover:bg-blue-900/30 transition text-sm">
                            ç·¨é›†
                        </button>
                        <button onclick="deleteCast(${cast.id})" class="flex-1 bg-red-900/20 text-red-400 border border-red-800/30 py-2 rounded-xl hover:bg-red-900/30 transition text-sm">
                            å‰Šé™¤
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function getRankColor(rank) {
            const colors = {
                'regular': 'text-gray-400',
                'chief': 'text-blue-400',
                'manager': 'text-purple-400'
            };
            return colors[rank] || 'text-gray-400';
        }

        function getRankLabel(rank) {
            const labels = {
                'regular': 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼',
                'chief': 'ãƒãƒ¼ãƒ•',
                'manager': 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼'
            };
            return labels[rank] || rank;
        }

        // ========== ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† ==========
        
        // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰å–å¾—
        async function loadStaffFromApi() {
            try {
                const data = await apiRequest('/staff');
                appState.staff = Array.isArray(data) ? data : [];
                renderStaff();
            } catch (e) {
                console.error('[loadStaffFromApi] error:', e);
                appState.staff = [];
            }
        }
        
        function renderStaff() {
            const grid = document.getElementById('staffGrid');
            if (!grid) return;
            
            if (!appState.staff || appState.staff.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            grid.innerHTML = appState.staff.map(staff => {
                const displayName = staff.name || `Staff#${staff.id || '?'}`;
                const initial = displayName.charAt(0) || '?';
                const hourlyRate = Number(staff.hourly_rate || staff.hourlyRate || 0);
                
                return `
                <div class="luxury-card rounded-2xl p-6">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="cast-avatar" style="background: linear-gradient(135deg, #4a5568, #2d3748);">
                            ${initial}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-200">${displayName}</h3>
                            <p class="text-sm ${getStaffRoleColor(staff.role)}">${getStaffRoleLabel(staff.role)}</p>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">æ™‚çµ¦</span>
                            <span class="font-semibold text-gray-200">Â¥${hourlyRate.toLocaleString()}</span>
                        </div>
                        ${staff.phone ? `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">é›»è©±ç•ªå·</span>
                            <span class="text-gray-200">${staff.phone}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editStaff(${staff.id})" class="flex-1 bg-blue-900/20 text-blue-400 border border-blue-800/30 py-2 rounded-xl hover:bg-blue-900/30 transition text-sm">
                            ç·¨é›†
                        </button>
                        <button onclick="deleteStaff(${staff.id})" class="flex-1 bg-red-900/20 text-red-400 border border-red-800/30 py-2 rounded-xl hover:bg-red-900/30 transition text-sm">
                            å‰Šé™¤
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function getStaffRoleColor(role) {
            const colors = {
                'waiter': 'text-blue-400',
                'kitchen': 'text-orange-400',
                'manager': 'text-purple-400',
                'catch': 'text-green-400',
                'driver': 'text-cyan-400',
                'other': 'text-gray-400'
            };
            return colors[role] || 'text-gray-400';
        }
        
        function getStaffRoleLabel(role) {
            const labels = {
                'waiter': 'ãƒœãƒ¼ã‚¤',
                'kitchen': 'ã‚­ãƒƒãƒãƒ³',
                'manager': 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼',
                'catch': 'ã‚­ãƒ£ãƒƒãƒ',
                'driver': 'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼',
                'other': 'ãã®ä»–'
            };
            return labels[role] || role;
        }
        
        function openAddStaffModal() {
            document.getElementById('addStaffModal').classList.add('active');
        }
        
        async function addStaff(event) {
            event.preventDefault();
            
            const name = document.getElementById('staffName').value;
            const role = document.getElementById('staffRole').value;
            const hourlyRate = parseInt(document.getElementById('staffHourlyRate').value);
            const phone = document.getElementById('staffPhone').value;
            
            try {
                await apiRequest('/staff', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: name,
                        role: role,
                        hourly_rate: hourlyRate,
                        phone: phone || null
                    })
                });
                
                closeModal('addStaffModal');
                await loadStaffFromApi();
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('staffName').value = '';
                document.getElementById('staffRole').value = 'waiter';
                document.getElementById('staffHourlyRate').value = '';
                document.getElementById('staffPhone').value = '';
            } catch (e) {
                console.error('[addStaff] error:', e);
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        function editStaff(staffId) {
            const staff = appState.staff.find(s => s.id === staffId);
            if (!staff) return;
            
            document.getElementById('editStaffId').value = staff.id;
            document.getElementById('editStaffName').value = staff.name;
            document.getElementById('editStaffRole').value = staff.role;
            document.getElementById('editStaffHourlyRate').value = staff.hourly_rate || staff.hourlyRate || 0;
            document.getElementById('editStaffPhone').value = staff.phone || '';
            
            document.getElementById('editStaffModal').classList.add('active');
        }
        
        async function updateStaff(event) {
            event.preventDefault();
            
            const staffId = parseInt(document.getElementById('editStaffId').value);
            
            try {
                await apiRequest(`/staff/${staffId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('editStaffName').value,
                        role: document.getElementById('editStaffRole').value,
                        hourly_rate: parseInt(document.getElementById('editStaffHourlyRate').value),
                        phone: document.getElementById('editStaffPhone').value || null
                    })
                });
                
                closeModal('editStaffModal');
                await loadStaffFromApi();
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                console.error('[updateStaff] error:', e);
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        async function deleteStaff(staffId) {
            if (!confirm('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                await apiRequest(`/staff/${staffId}`, {
                    method: 'DELETE'
                });
                
                await loadStaffFromApi();
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                console.error('[deleteStaff] error:', e);
                showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function openAddCastModal() {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            toggleSalaryType('add', 'hourly');
            document.querySelector('input[name="castSalaryType"][value="hourly"]').checked = true;
            document.getElementById('addCastModal').classList.add('active');
        }
        
        function toggleSalaryType(mode, type) {
            const prefix = mode === 'add' ? '' : 'edit';
            const hourlyInput = document.getElementById(`${prefix}${mode === 'add' ? 'add' : 'edit'}HourlyInput`);
            const monthlyInput = document.getElementById(`${prefix}${mode === 'add' ? 'add' : 'edit'}MonthlyInput`);
            
            // IDã®ä¿®æ­£
            const hourlyEl = document.getElementById(mode === 'add' ? 'addHourlyInput' : 'editHourlyInput');
            const monthlyEl = document.getElementById(mode === 'add' ? 'addMonthlyInput' : 'editMonthlyInput');
            
            if (type === 'hourly') {
                hourlyEl?.classList.remove('hidden');
                monthlyEl?.classList.add('hidden');
            } else {
                hourlyEl?.classList.add('hidden');
                monthlyEl?.classList.remove('hidden');
            }
        }

async function addCast(event) {
    event.preventDefault();

    const name = document.getElementById('castName').value;
    const rank = document.getElementById('castRank').value;
    const salaryType = document.querySelector('input[name="castSalaryType"]:checked').value;
    const hourlyRate = parseInt(document.getElementById('castHourlyRate').value) || 0;
    const monthlySalary = parseInt(document.getElementById('castMonthlySalary').value) || 0;
    const companionBack = parseInt(document.getElementById('castCompanionBack').value) || 3000;
    const nominationBack = parseInt(document.getElementById('castNominationBack').value) || 1000;
    const drinkBackRate = parseInt(document.getElementById('castDrinkBackRate').value) || 10;
    const salesBackRate = parseInt(document.getElementById('castSalesBackRate').value) || 0;

    // â˜… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆstage_name å¿…é ˆï¼‰
    const payload = {
        name: name,
        stage_name: name,
        rank: rank,
        salary_type: salaryType,
        hourly_rate: hourlyRate,
        monthly_salary: monthlySalary,
        companion_back: companionBack,
        nomination_back: nominationBack,
        drink_back_rate: drinkBackRate,
        sales_back_rate: salesBackRate
    };

    console.log('addCast payload:', payload);

    try {
        let createdCast;

        if (appState.apiConnected) {
            // APIçµŒç”±ã§ä½œæˆ
            createdCast = await apiRequest(API_ENDPOINTS.casts, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
        } else {
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘
            createdCast = {
                id: appState.casts.length + 1,
                sales: 0,
                ...payload
            };
        }

        const hourlyRateFromApi =
            createdCast.hourlyRate ??
            createdCast.hourly_rate ??
            hourlyRate;

        appState.casts.push({
            id: createdCast.id,
            name: createdCast.name ?? createdCast.stage_name ?? name,
            rank: createdCast.rank ?? rank,
            hourlyRate: hourlyRateFromApi,
            companionBack: createdCast.companion_back ?? companionBack,
            nominationBack: createdCast.nomination_back ?? nominationBack,
            drinkBackRate: createdCast.drink_back_rate ?? drinkBackRate,
            salesBackRate: createdCast.sales_back_rate ?? salesBackRate,
            sales: createdCast.sales ?? 0
        });

        renderCasts();
        populateCastSelects();
        closeModal('addCastModal');
        showNotification('ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');

        document.getElementById('castName').value = '';
        document.getElementById('castHourlyRate').value = '';
        document.getElementById('castCompanionBack').value = '3000';
        document.getElementById('castNominationBack').value = '1000';
        document.getElementById('castDrinkBackRate').value = '10';
        document.getElementById('castSalesBackRate').value = '0';
    } catch (error) {
        console.error(error);
        showNotification('ã‚­ãƒ£ã‚¹ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}


        function editCast(id) {
            const cast = appState.casts.find(c => c.id === id);
            if (!cast) return;

            document.getElementById('editCastId').value = cast.id;
            document.getElementById('editCastName').value = cast.name || cast.stage_name || '';
            document.getElementById('editCastRank').value = cast.rank;
            
            // çµ¦ä¸ä½“ç³»
            const salaryType = cast.salaryType ?? cast.salary_type ?? 'hourly';
            if (salaryType === 'monthly') {
                document.getElementById('editSalaryTypeMonthly').checked = true;
                toggleSalaryType('edit', 'monthly');
            } else {
                document.getElementById('editSalaryTypeHourly').checked = true;
                toggleSalaryType('edit', 'hourly');
            }
            document.getElementById('editCastHourlyRate').value = cast.hourlyRate ?? cast.hourly_rate ?? 0;
            document.getElementById('editCastMonthlySalary').value = cast.monthlySalary ?? cast.monthly_salary ?? 0;
            
            document.getElementById('editCastCompanionBack').value = cast.companionBack ?? cast.companion_back ?? 3000;
            document.getElementById('editCastNominationBack').value = cast.nominationBack ?? cast.nomination_back ?? 1000;
            document.getElementById('editCastDrinkBackRate').value = cast.drinkBackRate ?? cast.drink_back_rate ?? 10;
            document.getElementById('editCastSalesBackRate').value = cast.salesBackRate ?? cast.sales_back_rate ?? 0;
            
            document.getElementById('editCastModal').classList.add('active');
        }

async function updateCast(event) {
    event.preventDefault();
    
    const id = parseInt(document.getElementById('editCastId').value);
    const castIndex = appState.casts.findIndex(c => c.id === id);
    if (castIndex === -1) return;

    const name = document.getElementById('editCastName').value;
    const rank = document.getElementById('editCastRank').value;
    const salaryType = document.querySelector('input[name="editCastSalaryType"]:checked').value;
    const hourlyRate = parseInt(document.getElementById('editCastHourlyRate').value) || 0;
    const monthlySalary = parseInt(document.getElementById('editCastMonthlySalary').value) || 0;
    const companionBack = parseInt(document.getElementById('editCastCompanionBack').value) || 3000;
    const nominationBack = parseInt(document.getElementById('editCastNominationBack').value) || 1000;
    const drinkBackRate = parseInt(document.getElementById('editCastDrinkBackRate').value) || 10;
    const salesBackRate = parseInt(document.getElementById('editCastSalesBackRate').value) || 0;

    // â˜… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆstage_name å¿…é ˆï¼‰
    const payload = {
        ...appState.casts[castIndex],
        name: name,
        stage_name: name,
        rank: rank,
        salary_type: salaryType,
        hourly_rate: hourlyRate,
        monthly_salary: monthlySalary,
        companion_back: companionBack,
        nomination_back: nominationBack,
        drink_back_rate: drinkBackRate,
        sales_back_rate: salesBackRate
    };

    try {
        if (appState.apiConnected) {
            // API ã«åæ˜ 
            await apiRequest(`${API_ENDPOINTS.casts}/${id}`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });
        }

        // ãƒ•ãƒ­ãƒ³ãƒˆå´ã® state ã‚‚æ›´æ–°
        appState.casts[castIndex] = {
            ...appState.casts[castIndex],
            name: name,
            rank: rank,
            salaryType: salaryType,
            hourlyRate: hourlyRate,
            monthlySalary: monthlySalary,
            companionBack: companionBack,
            nominationBack: nominationBack,
            drinkBackRate: drinkBackRate,
            salesBackRate: salesBackRate
        };

        renderCasts();
        populateCastSelects();
        closeModal('editCastModal');
        showNotification('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
    } catch (error) {
        console.error(error);
        showNotification('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

async function deleteCast(id) {
    if (!confirm('ã“ã®ã‚­ãƒ£ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
        if (appState.apiConnected) {
            // â˜… API ä¸Šã‹ã‚‰ã‚‚å‰Šé™¤
            await apiRequest(`${API_ENDPOINTS.casts}/${id}`, {
                method: 'DELETE'
            });
        }

        // ãƒ­ãƒ¼ã‚«ãƒ« state ã‹ã‚‰å‰Šé™¤
        appState.casts = appState.casts.filter(cast => cast.id !== id);
        renderCasts();
        populateCastSelects();
        showNotification('ã‚­ãƒ£ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    } catch (error) {
        console.error(error);
        showNotification('ã‚­ãƒ£ã‚¹ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

function populateCastSelects() {
    const selects = ['clockInCast', 'clockOutCast', 'shiftCast'];
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                appState.casts
                    .map(cast => {
                        const displayName = cast.stage_name || cast.name || `Cast#${cast.id}`;
                        return `<option value="${cast.id}">${displayName}</option>`;
                    })
                    .join('');
        }
    });
}
        // å‹¤æ€ ç®¡ç†
        function clockIn() {
            const castId = document.getElementById('clockInCast').value;
            if (!castId) {
                showNotification('ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const cast = appState.casts.find(c => c.id === parseInt(castId));
            const castName = cast.stage_name || cast.name || `Cast#${cast.id}`;
            const now = new Date();
            
            const attendance = {
                id: appState.attendances.length + 1,
                castId: cast.id,
                castName: castName,
                date: now.toISOString().split('T')[0],
                clockIn: now.toTimeString().slice(0, 5),
                clockOut: null,
                status: 'working'
            };

            appState.attendances.push(attendance);
            renderAttendance();
            updateDashboard();
            showNotification(`${castName}ãŒå‡ºå‹¤ã—ã¾ã—ãŸ`, 'success');
        }

        function clockOut() {
            const castId = document.getElementById('clockOutCast').value;
            if (!castId) {
                showNotification('ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const cast = appState.casts.find(c => c.id === parseInt(castId));
            const castName = cast.stage_name || cast.name || `Cast#${cast.id}`;
            const attendance = appState.attendances.find(a => 
                a.castId === cast.id && 
                a.status === 'working' &&
                a.date === new Date().toISOString().split('T')[0]
            );

            if (!attendance) {
                showNotification('å‡ºå‹¤è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const now = new Date();
            attendance.clockOut = now.toTimeString().slice(0, 5);
            attendance.status = 'completed';

            renderAttendance();
            updateDashboard();
            showNotification(`${castName}ãŒé€€å‹¤ã—ã¾ã—ãŸ`, 'success');
        }

        function renderAttendance() {
            const tbody = document.getElementById('attendanceTableBody');
            const today = new Date().toISOString().split('T')[0];
            const todayAttendances = appState.attendances.filter(a => a.date === today);

            if (todayAttendances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-gray-500">æœ¬æ—¥ã®å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = todayAttendances.map(attendance => {
                const hours = calculateHours(attendance.clockIn, attendance.clockOut);
                return `
                    <tr class="border-b border-gray-800">
                        <td class="py-3 px-4 text-gray-300">${attendance.date}</td>
                        <td class="py-3 px-4 text-gray-300">${attendance.castName}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${attendance.clockIn}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${attendance.clockOut || '-'}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${hours}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                attendance.status === 'working' ? 'bg-green-900/30 text-green-300' : 'bg-gray-800 text-gray-400'
                            }">
                                ${attendance.status === 'working' ? 'å‹¤å‹™ä¸­' : 'é€€å‹¤'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateHours(clockIn, clockOut) {
            if (!clockOut) return '-';
            const [inH, inM] = clockIn.split(':').map(Number);
            const [outH, outM] = clockOut.split(':').map(Number);
            const totalMinutes = (outH * 60 + outM) - (inH * 60 + inM);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours}æ™‚é–“${minutes}åˆ†`;
        }

        function exportAttendanceCSV() {
            showNotification('å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚·ãƒ•ãƒˆç®¡ç†
        function initializeShiftCalendar() {
            appState.shifts = [
                { id: 1, castId: 1, date: '2024-11-15', start: '20:00', end: '01:00' },
                { id: 2, castId: 2, date: '2024-11-15', start: '21:00', end: '02:00' },
                { id: 3, castId: 3, date: '2024-11-16', start: '19:30', end: '00:30' }
            ];
            renderShiftCalendar();
            renderWeeklyShifts();
        }

        function renderShiftCalendar() {
            const calendar = document.getElementById('shiftCalendar');
            if (!calendar) return;

            const year = appState.currentMonth.getFullYear();
            const month = appState.currentMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            document.getElementById('currentMonth').textContent = `${year}å¹´${month + 1}æœˆ`;

            let html = '';
            const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            weekDays.forEach(day => {
                html += `<div class="text-center font-semibold p-2 md:p-3 text-gray-400 text-xs md:text-sm">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += `<div class="p-2"></div>`;
            }

            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const shiftsForDate = appState.shifts.filter(s => s.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                
                html += `<div class="calendar-cell border border-gray-800 ${isToday ? 'bg-yellow-900/10 border-yellow-700/30' : ''}">
                    <div class="font-semibold text-xs md:text-sm mb-1 md:mb-2 ${isToday ? 'text-yellow-500' : 'text-gray-400'}">${date}</div>
                    <div class="space-y-1">
                        ${shiftsForDate.map(shift => {
                            const cast = appState.casts.find(c => c.id === shift.castId);
                            const castName = cast ? (cast.stage_name || cast.name || `Cast#${cast.id}`) : 'ä¸æ˜';
                            return `<div class="shift-badge">${castName}</div>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            calendar.innerHTML = html;
        }

        function renderWeeklyShifts() {
            const container = document.getElementById('weeklyShifts');
            if (!container) return;

            const today = new Date();
            const weekShifts = appState.shifts.filter(s => {
                const shiftDate = new Date(s.date);
                const diff = Math.floor((shiftDate - today) / (1000 * 60 * 60 * 24));
                return diff >= 0 && diff < 7;
            });

            container.innerHTML = weekShifts.length === 0 
                ? '<p class="text-gray-500 text-center py-6 text-sm">ä»Šé€±ã®ã‚·ãƒ•ãƒˆãªã—</p>'
                : weekShifts.map(shift => {
                    const cast = appState.casts.find(c => c.id === shift.castId);
                    const castName = cast ? (cast.stage_name || cast.name || `Cast#${cast.id}`) : 'ä¸æ˜';
                    return `
                        <div class="flex justify-between items-center p-4 md:p-5 bg-gray-800/30 rounded-xl hover:bg-gray-800/50 transition">
                            <div>
                                <p class="font-bold text-base md:text-lg text-gray-200">${castName}</p>
                                <p class="text-xs md:text-sm text-gray-400">${shift.date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs md:text-sm text-gray-300">${shift.start} - ${shift.end}</p>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function openAddShiftModal() {
            populateCastSelects();
            document.getElementById('addShiftModal').classList.add('active');
        }

        async function saveShift(event) {
            event.preventDefault();
            
            const castId = parseInt(document.getElementById('shiftCast').value);
            if (!castId) {
                showNotification('ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const shift = {
                id: appState.shifts.length + 1,
                castId: castId,
                date: document.getElementById('shiftDate').value,
                start: document.getElementById('shiftStart').value,
                end: document.getElementById('shiftEnd').value
            };

            appState.shifts.push(shift);
            
            renderShiftCalendar();
            renderWeeklyShifts();
            closeModal('addShiftModal');
            showNotification('ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('shiftDate').value = '';
            document.getElementById('shiftStart').value = '';
            document.getElementById('shiftEnd').value = '';
        }

        function previousMonth() {
            appState.currentMonth.setMonth(appState.currentMonth.getMonth() - 1);
            renderShiftCalendar();
        }

        function nextMonth() {
            appState.currentMonth.setMonth(appState.currentMonth.getMonth() + 1);
            renderShiftCalendar();
        }

        // ã‚­ãƒ£ã‚¹ãƒˆã‚µãƒ–ã‚¿ãƒ–
        function showCastSubTab(tabName) {
            document.querySelectorAll('.cast-subtab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.cast-subtab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-subtab`).classList.add('active');
            
            if (tabName === 'staff-list') {
                renderStaff();
            } else if (tabName === 'drink-back') {
                renderDrinkBackList();
            } else if (tabName === 'salary') {
                renderSalaryCalculation();
            } else if (tabName === 'ranking') {
                renderRankings();
            }
        }

        function renderDrinkBackList() {
            const period = document.getElementById('dbFilterPeriod')?.value || 'today';
            
            const dbOrders = [];
            const allSessions = [
                ...(appState.activeSessions || []),
                ...(appState.checkoutHistory || [])
            ];
            
            allSessions.forEach(session => {
                if (session.orders) {
                    session.orders.filter(o => o.isDrinkBack).forEach(order => {
                        const dbAmount = Math.floor(order.price * order.quantity * 0.6);
                        dbOrders.push({
                            castName: order.castName,
                            itemName: order.itemName,
                            quantity: order.quantity,
                            price: order.price,
                            dbAmount: dbAmount,
                            time: session.startTime
                        });
                    });
                }
            });
            
            const castDbMap = {};
            dbOrders.forEach(order => {
                if (!castDbMap[order.castName]) {
                    castDbMap[order.castName] = {
                        name: order.castName,
                        totalDb: 0,
                        count: 0,
                        orders: []
                    };
                }
                castDbMap[order.castName].totalDb += order.dbAmount;
                castDbMap[order.castName].count += order.quantity;
                castDbMap[order.castName].orders.push(order);
            });
            
            const castDbList = Object.values(castDbMap).sort((a, b) => b.totalDb - a.totalDb);
            
            const totalDb = dbOrders.reduce((sum, o) => sum + o.dbAmount, 0);
            const totalCount = dbOrders.length;
            const topCast = castDbList[0]?.name || '-';
            const avgDb = castDbList.length > 0 ? Math.floor(totalDb / castDbList.length) : 0;
            
            document.getElementById('totalDbAmount').textContent = `Â¥${totalDb.toLocaleString()}`;
            document.getElementById('totalDbCount').textContent = `${totalCount}ä»¶`;
            document.getElementById('topDbCast').textContent = topCast;
            document.getElementById('avgDbAmount').textContent = `Â¥${avgDb.toLocaleString()}`;
            
            const castDbListEl = document.getElementById('castDbList');
            if (castDbList.length === 0) {
                castDbListEl.innerHTML = '<p class="text-gray-500 text-center py-6">DBæ³¨æ–‡ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                castDbListEl.innerHTML = castDbList.map(cast => {
                    const initial = cast.name.charAt(0);
                    return `
                    <div class="flex items-center justify-between p-4 bg-gray-800/30 rounded-xl hover:bg-gray-800/50 transition">
                        <div class="flex items-center gap-4">
                            <div class="cast-avatar cast-avatar-small">
                                ${initial}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-200">${cast.name}</p>
                                <p class="text-sm text-gray-400">${cast.count}ä»¶ã®æ³¨æ–‡</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-pink-300">Â¥${cast.totalDb.toLocaleString()}</p>
                            <p class="text-xs text-gray-400">DBåˆè¨ˆ</p>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            const dbDetailTable = document.getElementById('dbDetailTableBody');
            if (dbOrders.length === 0) {
                dbDetailTable.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-500">DBæ³¨æ–‡ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</td></tr>';
            } else {
                dbDetailTable.innerHTML = dbOrders.map(order => `
                    <tr>
                        <td class="py-3 px-4 text-gray-300">${new Date(order.time).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</td>
                        <td class="py-3 px-4 text-purple-300 font-semibold">${order.castName}</td>
                        <td class="py-3 px-4 text-gray-300">${order.itemName}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${order.quantity}</td>
                        <td class="py-3 px-4 text-right font-semibold text-pink-300">Â¥${order.dbAmount.toLocaleString()}</td>
                    </tr>
                `).join('');
            }
        }

        async function renderSalaryCalculation() {
            // å¹´é¸æŠã®åˆæœŸåŒ–
            const yearSelect = document.getElementById('salaryYear');
            const monthSelect = document.getElementById('salaryMonth');
            const now = new Date();
            
            if (yearSelect && yearSelect.options.length === 0) {
                for (let y = now.getFullYear(); y >= now.getFullYear() - 3; y--) {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = `${y}å¹´`;
                    yearSelect.appendChild(opt);
                }
                monthSelect.value = now.getMonth() + 1;
            }
            
            const year = yearSelect?.value || now.getFullYear();
            const month = monthSelect?.value || (now.getMonth() + 1);
            
            const salaryListEl = document.getElementById('salaryList');
            salaryListEl.innerHTML = '<div class="text-center py-8 text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            try {
                let payrollData;
                if (appState.apiConnected) {
                    payrollData = await apiRequest(`/cast-payroll?year=${year}&month=${month}`);
                } else {
                    // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
                    payrollData = {
                        period: `${year}å¹´${month}æœˆ`,
                        payroll_list: appState.casts.map(cast => ({
                            cast_name: cast.name || cast.stage_name,
                            rank: cast.rank,
                            salary_type: cast.salaryType || cast.salary_type || 'hourly',
                            work_days: 20,
                            total_hours: 160,
                            hourly_rate: cast.hourlyRate || cast.hourly_rate || 0,
                            monthly_salary: cast.monthlySalary || cast.monthly_salary || 0,
                            base_salary: (cast.salaryType === 'monthly' || cast.salary_type === 'monthly') 
                                ? (cast.monthlySalary || cast.monthly_salary || 0) 
                                : ((cast.hourlyRate || cast.hourly_rate || 0) * 160),
                            companion_count: Math.floor(Math.random() * 10),
                            companion_back: Math.floor(Math.random() * 30000),
                            nomination_count: Math.floor(Math.random() * 20),
                            nomination_back: Math.floor(Math.random() * 20000),
                            drink_count: Math.floor(Math.random() * 50),
                            drink_sales: Math.floor(Math.random() * 50000),
                            drink_back: Math.floor(Math.random() * 5000),
                            total_sales: Math.floor(Math.random() * 500000),
                            sales_back: Math.floor(Math.random() * 25000),
                            total_payroll: 0
                        }))
                    };
                    payrollData.payroll_list.forEach(p => {
                        p.total_payroll = p.base_salary + p.companion_back + p.nomination_back + p.drink_back + p.sales_back;
                    });
                }
                
                renderPayrollList(payrollData);
            } catch (e) {
                console.error('çµ¦ä¸è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
                salaryListEl.innerHTML = `<div class="text-red-400 py-8">çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}</div>`;
            }
        }
        
        function renderPayrollList(data) {
            const salaryListEl = document.getElementById('salaryList');
            
            if (!data.payroll_list || data.payroll_list.length === 0) {
                salaryListEl.innerHTML = '<div class="text-center py-8 text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            salaryListEl.innerHTML = data.payroll_list.map(p => {
                const initial = (p.cast_name || 'ã‚­').charAt(0);
                const salaryTypeLabel = p.salary_type === 'monthly' ? 'æœˆçµ¦åˆ¶' : 'æ™‚çµ¦åˆ¶';
                const salaryTypeColor = p.salary_type === 'monthly' ? 'text-purple-400' : 'text-blue-400';
                
                return `
                <div class="luxury-card rounded-xl overflow-hidden">
                    <div class="bg-gray-800/50 p-4 border-b border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="cast-avatar cast-avatar-small">
                                    ${initial}
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-200">${p.cast_name}</h3>
                                    <p class="text-sm text-gray-400">${data.period} <span class="${salaryTypeColor}">(${salaryTypeLabel})</span></p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-400">ç·æ”¯çµ¦é¡</p>
                                <p class="text-3xl font-bold gold-accent">Â¥${Number(p.total_payroll).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1">å‡ºå‹¤æ—¥æ•°</p>
                            <p class="text-xl font-semibold text-gray-200">${p.work_days}æ—¥</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1">å‹¤å‹™æ™‚é–“</p>
                            <p class="text-xl font-semibold text-gray-200">${p.total_hours}h</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1">${p.salary_type === 'monthly' ? 'æœˆçµ¦' : 'æ™‚çµ¦'}</p>
                            <p class="text-xl font-semibold text-gray-200">Â¥${Number(p.salary_type === 'monthly' ? p.monthly_salary : p.hourly_rate).toLocaleString()}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1">åŸºæœ¬çµ¦</p>
                            <p class="text-xl font-semibold text-blue-300">Â¥${Number(p.base_salary).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-gray-700 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">ğŸ’° åŒä¼´ãƒãƒƒã‚¯ (${p.companion_count}å›)</span>
                            <span class="font-semibold text-amber-300">Â¥${Number(p.companion_back).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">ğŸ’ æŒ‡åãƒãƒƒã‚¯ (${p.nomination_count}å›)</span>
                            <span class="font-semibold text-purple-300">Â¥${Number(p.nomination_back).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">ğŸ¸ ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ (${p.drink_count}æ¯)</span>
                            <span class="font-semibold text-blue-300">Â¥${Number(p.drink_back).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">ğŸ“ˆ å£²ä¸Šãƒãƒƒã‚¯ (å£²ä¸Š: Â¥${Number(p.total_sales).toLocaleString()})</span>
                            <span class="font-semibold text-green-300">Â¥${Number(p.sales_back).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 border-t-2 border-yellow-700/50">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-gray-200">ç·æ”¯çµ¦é¡</span>
                            <span class="text-2xl font-bold gold-accent">Â¥${Number(p.total_payroll).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-900/50 border-t border-gray-700">
                        <button onclick="printPayrollSlip('${p.cast_name}', ${JSON.stringify(p).replace(/"/g, '&quot;')})" class="w-full text-sm text-gray-400 hover:text-white transition">
                            ğŸ–¨ï¸ çµ¦ä¸æ˜ç´°ã‚’å°åˆ·
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function printPayrollSlip(castName, data) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>çµ¦ä¸æ˜ç´° - ${castName}</title>
                    <style>
                        body { font-family: sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; }
                        h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .info { margin: 20px 0; }
                        .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
                        .total { font-size: 1.5em; font-weight: bold; border-top: 2px solid #000; margin-top: 20px; padding-top: 20px; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>çµ¦ä¸æ˜ç´°æ›¸</h1>
                    <div class="info">
                        <p><strong>æ°å:</strong> ${castName}</p>
                        <p><strong>æœŸé–“:</strong> ${data.period || ''}</p>
                        <p><strong>çµ¦ä¸ä½“ç³»:</strong> ${data.salary_type === 'monthly' ? 'æœˆçµ¦åˆ¶' : 'æ™‚çµ¦åˆ¶'}</p>
                    </div>
                    <div class="row"><span>å‡ºå‹¤æ—¥æ•°</span><span>${data.work_days}æ—¥</span></div>
                    <div class="row"><span>å‹¤å‹™æ™‚é–“</span><span>${data.total_hours}æ™‚é–“</span></div>
                    <div class="row"><span>åŸºæœ¬çµ¦</span><span>Â¥${Number(data.base_salary).toLocaleString()}</span></div>
                    <div class="row"><span>åŒä¼´ãƒãƒƒã‚¯ (${data.companion_count}å›)</span><span>Â¥${Number(data.companion_back).toLocaleString()}</span></div>
                    <div class="row"><span>æŒ‡åãƒãƒƒã‚¯ (${data.nomination_count}å›)</span><span>Â¥${Number(data.nomination_back).toLocaleString()}</span></div>
                    <div class="row"><span>ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ (${data.drink_count}æ¯)</span><span>Â¥${Number(data.drink_back).toLocaleString()}</span></div>
                    <div class="row"><span>å£²ä¸Šãƒãƒƒã‚¯</span><span>Â¥${Number(data.sales_back).toLocaleString()}</span></div>
                    <div class="row total"><span>ç·æ”¯çµ¦é¡</span><span>Â¥${Number(data.total_payroll).toLocaleString()}</span></div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function renderRankings() {
            const period = document.getElementById('rankingPeriod')?.value || 'month';
            
            const salesRanking = [...appState.casts].sort((a, b) => (b.sales || 0) - (a.sales || 0));
            
            const dbRanking = appState.casts.map(cast => {
                let totalDb = 0;
                const allSessions = [
                    ...(appState.activeSessions || []),
                    ...(appState.checkoutHistory || [])
                ];
                
                allSessions.forEach(session => {
                    if (session.castName === cast.name && session.orders) {
                        session.orders.filter(o => o.isDrinkBack && o.castName === cast.name).forEach(order => {
                            totalDb += Math.floor(order.price * order.quantity * 0.6);
                        });
                    }
                });
                
                return { cast: cast, totalDb: totalDb };
            }).sort((a, b) => b.totalDb - a.totalDb);
            
            const nominationRanking = appState.casts.map(cast => {
                let nominationCount = 0;
                const allSessions = [
                    ...(appState.activeSessions || []),
                    ...(appState.checkoutHistory || [])
                ];
                
                allSessions.forEach(session => {
                    if (session.nomination && session.nomination.castName === cast.name) {
                        nominationCount++;
                    }
                });
                
                return { cast: cast, nominationCount: nominationCount };
            }).sort((a, b) => b.nominationCount - a.nominationCount);
            
            document.getElementById('salesRanking').innerHTML = salesRanking.slice(0, 5).map((cast, index) => {
                const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                const medal = medals[index] || `${index + 1}ä½`;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${medal}</span>
                            <span class="font-semibold text-gray-200">${cast.name}</span>
                        </div>
                        <span class="font-bold gold-accent">Â¥${(cast.sales || 0).toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dbRanking').innerHTML = dbRanking.slice(0, 5).map((data, index) => {
                const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                const medal = medals[index] || `${index + 1}ä½`;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${medal}</span>
                            <span class="font-semibold text-gray-200">${data.cast.name}</span>
                        </div>
                        <span class="font-bold text-pink-300">Â¥${data.totalDb.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('nominationRanking').innerHTML = nominationRanking.slice(0, 5).map((data, index) => {
                const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                const medal = medals[index] || `${index + 1}ä½`;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${medal}</span>
                            <span class="font-semibold text-gray-200">${data.cast.name}</span>
                        </div>
                        <span class="font-bold text-purple-300">${data.nominationCount}å›</span>
                    </div>
                `;
            }).join('');
        }

        function exportDrinkBackCSV() {
            showNotification('DBä¸€è¦§CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ', 'success');
        }

        // ===== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ =====
        function downloadCSV(filename, csvContent) {
            const bom = '\uFEFF'; // Excelã§æ—¥æœ¬èªæ–‡å­—åŒ–ã‘é˜²æ­¢
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }
        
        async function exportSalaryCSV() {
            const year = document.getElementById('salaryYear')?.value || new Date().getFullYear();
            const month = document.getElementById('salaryMonth')?.value || (new Date().getMonth() + 1);
            
            try {
                let data;
                if (appState.apiConnected) {
                    data = await apiRequest(`/cast-payroll?year=${year}&month=${month}`);
                } else {
                    showNotification('APIæœªæ¥ç¶šã®ãŸã‚ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã™', 'info');
                    data = { payroll_list: appState.casts.map(c => ({
                        cast_name: c.name || c.stage_name,
                        salary_type: c.salaryType || 'hourly',
                        work_days: 20,
                        total_hours: 160,
                        base_salary: 0,
                        companion_back: 0,
                        nomination_back: 0,
                        drink_back: 0,
                        sales_back: 0,
                        total_payroll: 0
                    }))};
                }
                
                const headers = ['ã‚­ãƒ£ã‚¹ãƒˆå', 'çµ¦ä¸ä½“ç³»', 'å‡ºå‹¤æ—¥æ•°', 'å‹¤å‹™æ™‚é–“', 'åŸºæœ¬çµ¦', 'åŒä¼´ãƒãƒƒã‚¯', 'æŒ‡åãƒãƒƒã‚¯', 'ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯', 'å£²ä¸Šãƒãƒƒã‚¯', 'ç·æ”¯çµ¦é¡'];
                const rows = data.payroll_list.map(p => [
                    p.cast_name,
                    p.salary_type === 'monthly' ? 'æœˆçµ¦åˆ¶' : 'æ™‚çµ¦åˆ¶',
                    p.work_days,
                    p.total_hours,
                    p.base_salary,
                    p.companion_back,
                    p.nomination_back,
                    p.drink_back,
                    p.sales_back,
                    p.total_payroll
                ]);
                
                const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
                downloadCSV(`çµ¦ä¸æ˜ç´°_${year}å¹´${month}æœˆ.csv`, csvContent);
                showNotification('çµ¦ä¸æ˜ç´°CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
                showNotification('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        async function exportReportCSV() {
            const isDailyMode = currentReportMode === 'daily';
            
            if (isDailyMode) {
                // æ—¥å ±CSV
                const today = new Date().toISOString().split('T')[0];
                try {
                    let data;
                    if (appState.apiConnected) {
                        data = await apiRequest(`/daily-report?date=${today}`);
                    } else {
                        data = {
                            date: today,
                            total_sales: 0,
                            total_cost: 0,
                            gross_profit: 0,
                            session_count: 0,
                            total_guests: 0
                        };
                    }
                    
                    const csvContent = [
                        ['æ—¥å ±', data.date],
                        [''],
                        ['é …ç›®', 'é‡‘é¡'],
                        ['ç·å£²ä¸Š', data.total_sales],
                        ['åŸä¾¡', data.total_cost],
                        ['ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯åˆè¨ˆ', data.cast_payroll?.total || 0],
                        ['  åŒä¼´ãƒãƒƒã‚¯', data.cast_payroll?.companion_back || 0],
                        ['  æŒ‡åãƒãƒƒã‚¯', data.cast_payroll?.nomination_back || 0],
                        ['  ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯', data.cast_payroll?.drink_back || 0],
                        ['  å£²ä¸Šãƒãƒƒã‚¯', data.cast_payroll?.sales_back || 0],
                        ['ã‚¹ã‚¿ãƒƒãƒ•äººä»¶è²»', data.staff_cost || 0],
                        ['ç²—åˆ©', data.gross_profit],
                        [''],
                        ['æ¥åº—çµ„æ•°', data.session_count],
                        ['æ¥å®¢æ•°', data.total_guests],
                        ['å®¢å˜ä¾¡ï¼ˆçµ„ï¼‰', data.avg_per_group || 0],
                        ['å®¢å˜ä¾¡ï¼ˆäººï¼‰', data.avg_per_person || 0]
                    ].map(row => row.join(',')).join('\n');
                    
                    downloadCSV(`æ—¥å ±_${today}.csv`, csvContent);
                    showNotification('æ—¥å ±CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                } catch (e) {
                    console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
                    showNotification('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } else {
                // æœˆå ±CSV
                const year = document.getElementById('reportYear')?.value || new Date().getFullYear();
                const month = document.getElementById('reportMonth')?.value || (new Date().getMonth() + 1);
                
                try {
                    let data;
                    if (appState.apiConnected) {
                        data = await apiRequest(`/monthly-report?year=${year}&month=${month}`);
                    } else {
                        data = {
                            period: `${year}å¹´${month}æœˆ`,
                            total_sales: 0,
                            total_cost: 0,
                            gross_profit: 0,
                            session_count: 0,
                            total_guests: 0,
                            cast_payroll: {},
                            daily_sales: []
                        };
                    }
                    
                    // ã‚µãƒãƒªãƒ¼éƒ¨åˆ†
                    const summaryRows = [
                        ['æœˆå ±', data.period],
                        [''],
                        ['é …ç›®', 'é‡‘é¡'],
                        ['æœˆé–“å£²ä¸Š', data.total_sales],
                        ['åŸä¾¡', data.total_cost],
                        ['ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯åˆè¨ˆ', data.cast_payroll?.total || 0],
                        ['  åŒä¼´ãƒãƒƒã‚¯', data.cast_payroll?.companion_back || 0],
                        ['  æŒ‡åãƒãƒƒã‚¯', data.cast_payroll?.nomination_back || 0],
                        ['  ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯', data.cast_payroll?.drink_back || 0],
                        ['  å£²ä¸Šãƒãƒƒã‚¯', data.cast_payroll?.sales_back || 0],
                        ['ã‚¹ã‚¿ãƒƒãƒ•äººä»¶è²»', data.staff_cost || 0],
                        ['ç²—åˆ©', data.gross_profit],
                        ['ç²—åˆ©ç‡', `${data.gross_profit_rate || 0}%`],
                        [''],
                        ['æ¥åº—çµ„æ•°', data.session_count],
                        ['æ¥å®¢æ•°', data.total_guests],
                        ['åŒä¼´æ•°', data.companion_count || 0],
                        ['æŒ‡åæ•°', data.nomination_count || 0],
                        [''],
                        ['æ—¥åˆ¥å£²ä¸Š'],
                        ['æ—¥ä»˜', 'å£²ä¸Š']
                    ];
                    
                    // æ—¥åˆ¥å£²ä¸Š
                    const dailyRows = (data.daily_sales || []).map(d => [d.date, d.sales]);
                    
                    const csvContent = [...summaryRows, ...dailyRows].map(row => row.join(',')).join('\n');
                    downloadCSV(`æœˆå ±_${year}å¹´${month}æœˆ.csv`, csvContent);
                    showNotification('æœˆå ±CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                } catch (e) {
                    console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
                    showNotification('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }
        
        function exportCheckoutHistoryCSV() {
            const history = appState.checkoutHistory || [];
            
            if (history.length === 0) {
                showNotification('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                return;
            }
            
            const headers = ['ä¼šè¨ˆæ—¥æ™‚', 'ãƒ†ãƒ¼ãƒ–ãƒ«', 'æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆ', 'äººæ•°', 'æŒ‡åã‚¿ã‚¤ãƒ—', 'åŒä¼´', 'å°è¨ˆ', 'ç¨è¾¼åˆè¨ˆ'];
            const rows = history.map(s => [
                s.checkoutTime || '',
                s.tableName || `ãƒ†ãƒ¼ãƒ–ãƒ«${s.tableId}`,
                s.castName || s.cast_name || '',
                s.guests || 0,
                s.nomination_type || 'ãƒ•ãƒªãƒ¼',
                s.has_companion ? 'ã‚ã‚Š' : 'ãªã—',
                s.subtotal || s.current_total || 0,
                s.total || s.current_total || 0
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const today = new Date().toISOString().split('T')[0];
            downloadCSV(`ä¼šè¨ˆå±¥æ­´_${today}.csv`, csvContent);
            showNotification('ä¼šè¨ˆå±¥æ­´CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }
ã€€ã€€ã€€ã€€ã€€function getAllSessionsFromAppState(app) {
    if (!app) return [];

    const result = [];

    // ã¾ãšä»Šã¾ã§é€šã‚Šã®2ã¤
    if (Array.isArray(app.activeSessions)) {
        result.push(...app.activeSessions);
    }
    if (Array.isArray(app.checkoutHistory)) {
        result.push(...app.checkoutHistory);
    }

    // ä»–ã«ã‚‚ãã‚Œã£ã½ã„é…åˆ—ãŒã‚ã‚Œã°è¿½åŠ 
    for (const [key, value] of Object.entries(app)) {
        if (!Array.isArray(value)) continue;
        // castName ã‚„ orders ã‚’æŒã£ã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ··ã–ã£ã¦ã„ã‚‹é…åˆ—ã ã‘å€™è£œã«ã™ã‚‹
        if (value.some(v => v && (v.castName || v.orders || v.tableId))) {
            // æ—¢ã«è¿½åŠ æ¸ˆã¿ã® active/checkout ã§ãªã„ã‚­ãƒ¼ã ã‘è¶³ã™
            if (key !== 'activeSessions' && key !== 'checkoutHistory') {
                result.push(...value);
            }
        }
    }
    return result;
    }

// â˜… ä¼šè¨ˆå±¥æ­´æ©Ÿèƒ½
function renderCheckoutHistory() {
    const container = document.getElementById('checkoutHistoryContent');
    if (!container) return;
    
    // ä»Šæ—¥ã®æ—¥ä»˜
    const today = new Date();
    const todayStr = today.toLocaleDateString('ja-JP');
    
    // ä»Šæ—¥ã®ä¼šè¨ˆã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
    const todayHistory = (appState.checkoutHistory || []).filter(session => {
        const checkoutTime = new Date(session.checkoutTime);
        return checkoutTime.toLocaleDateString('ja-JP') === todayStr;
    }).sort((a, b) => new Date(b.checkoutTime) - new Date(a.checkoutTime));
    
    if (todayHistory.length === 0) {
        container.innerHTML = `
            <div class="luxury-card rounded-2xl p-8 text-center text-gray-500">
                <p class="text-lg">æœ¬æ—¥ã®ä¼šè¨ˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = todayHistory.map((session, index) => {
        const checkoutTime = new Date(session.checkoutTime);
        const timeStr = checkoutTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const tableName = session.tableName || session.table_name || session.tableId || '?';
        const guests = session.guests || 0;
        const castName = session.castName || session.cast_name || 'æœªè¨­å®š';
        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
        const historyIndex = appState.checkoutHistory.indexOf(session);
        
        return `
            <div class="luxury-card rounded-2xl p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-2xl font-bold text-gray-200">ãƒ†ãƒ¼ãƒ–ãƒ« ${tableName}</span>
                            <span class="text-sm text-gray-500">${timeStr}</span>
                        </div>
                        <div class="flex flex-wrap gap-4 text-sm text-gray-400">
                            <span>ğŸ‘¥ ${guests}å</span>
                            <span>ğŸ’ƒ ${castName}</span>
                            <span class="text-lg font-bold gold-accent">Â¥${total.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showReceiptFromHistory(${historyIndex})" 
                                class="bg-blue-900/20 text-blue-400 border border-blue-800/30 px-4 py-2 rounded-xl hover:bg-blue-900/30 transition text-sm">
                            ğŸ§¾ ä¼ç¥¨
                        </button>
                        <button onclick="openEditCheckoutModal(${historyIndex})" 
                                class="bg-amber-900/20 text-amber-400 border border-amber-800/30 px-4 py-2 rounded-xl hover:bg-amber-900/30 transition text-sm">
                            âœï¸ ä¿®æ­£
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// å±¥æ­´ã‹ã‚‰ä¼ç¥¨ã‚’å†è¡¨ç¤º
function showReceiptFromHistory(historyIndex) {
    const session = appState.checkoutHistory[historyIndex];
    if (!session) return;
    
    // æ³¨æ–‡ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã•ã‚Œã¦ã‚‹ã‚‚ã®ã‚’ä½¿ã†
    const orders = session.orders || [];
    showReceipt(session, orders);
}

// ä¼šè¨ˆä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openEditCheckoutModal(historyIndex) {
    const session = appState.checkoutHistory[historyIndex];
    if (!session) return;
    
    const total = session.totalAmount || session.currentTotal || session.current_total || 0;
    const guests = session.guests || 0;
    const tableName = session.tableName || session.table_name || session.tableId || '?';
    const castName = session.castName || session.cast_name || 'æœªè¨­å®š';
    const shimeiCasts = session.shimei_casts || '';
    const catchStaff = session.catchStaff || session.catch_staff || '';
    const taxRate = session.taxRate || session.tax_rate || 20;
    const orders = session.orders || [];
    
    // æ³¨æ–‡æ˜ç´°ã®HTMLç”Ÿæˆ
    const ordersHtml = orders.length > 0 ? orders.map((o, idx) => {
        const itemName = o.item_name || o.itemName || 'å•†å“';
        const price = o.price || 0;
        const qty = o.quantity || 1;
        return `
            <div class="flex items-center gap-2 py-2 border-b border-gray-700">
                <input type="text" id="editOrderName_${idx}" value="${itemName}" 
                       class="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm">
                <input type="number" id="editOrderQty_${idx}" value="${qty}" min="0"
                       class="w-16 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm text-center">
                <input type="number" id="editOrderPrice_${idx}" value="${price}" 
                       class="w-24 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm text-right">
            </div>
        `;
    }).join('') : '<p class="text-gray-500 text-sm">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
    
    // ä¿®æ­£ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modalHtml = `
        <div id="editCheckoutModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-y-auto">
            <div class="luxury-card rounded-2xl max-w-2xl w-full p-6 my-4">
                <h2 class="text-xl font-bold gold-accent mb-4">ä¼šè¨ˆä¿®æ­£ - ãƒ†ãƒ¼ãƒ–ãƒ«${tableName}</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm text-gray-400 block mb-1">æ¥åº—äººæ•°</label>
                        <input type="number" id="editGuests" value="${guests}" min="1" 
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 block mb-1">TAX/ã‚µãƒ¼ãƒ“ã‚¹ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="editTaxRate" value="${taxRate}" min="0" max="100"
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 block mb-1">æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆ</label>
                        <input type="text" id="editCastName" value="${castName}" 
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 block mb-1">æŒ‡åã‚­ãƒ£ã‚¹ãƒˆ</label>
                        <input type="text" id="editShimeiCasts" value="${shimeiCasts}" 
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white"
                               placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š">
                    </div>
                    <div class="col-span-2">
                        <label class="text-sm text-gray-400 block mb-1">ã‚­ãƒ£ãƒƒãƒæ‹…å½“</label>
                        <input type="text" id="editCatchStaff" value="${catchStaff}" 
                               class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="text-sm text-gray-400 block mb-2">æ³¨æ–‡æ˜ç´°ï¼ˆå“å / æ•°é‡ / å˜ä¾¡ï¼‰</label>
                    <div class="max-h-48 overflow-y-auto bg-gray-900/50 rounded-xl p-2" id="editOrdersList">
                        ${ordersHtml}
                    </div>
                    <button onclick="addEditOrderRow(${historyIndex})" 
                            class="mt-2 text-sm text-amber-400 hover:text-amber-300">
                        ï¼‹ è¡Œã‚’è¿½åŠ 
                    </button>
                </div>
                
                <div class="mb-4 p-3 bg-amber-900/20 rounded-xl border border-amber-800/30">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">åˆè¨ˆé‡‘é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</span>
                        <span id="editCalculatedTotal" class="text-xl font-bold gold-accent">Â¥${total.toLocaleString()}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ä¿å­˜æ™‚ã«æ³¨æ–‡æ˜ç´°ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="saveEditCheckout(${historyIndex})" 
                            class="flex-1 luxury-btn py-3 rounded-xl font-bold">
                        ä¿å­˜
                    </button>
                    <button onclick="closeEditCheckoutModal()" 
                            class="flex-1 bg-gray-700 text-white py-3 rounded-xl font-bold">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
    const existing = document.getElementById('editCheckoutModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// æ³¨æ–‡è¡Œã‚’è¿½åŠ 
function addEditOrderRow(historyIndex) {
    const container = document.getElementById('editOrdersList');
    if (!container) return;
    
    const idx = container.querySelectorAll('.flex.items-center').length;
    const newRow = document.createElement('div');
    newRow.className = 'flex items-center gap-2 py-2 border-b border-gray-700';
    newRow.innerHTML = `
        <input type="text" id="editOrderName_${idx}" value="" 
               class="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm"
               placeholder="å“å">
        <input type="number" id="editOrderQty_${idx}" value="1" min="0"
               class="w-16 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm text-center">
        <input type="number" id="editOrderPrice_${idx}" value="0" 
               class="w-24 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white text-sm text-right">
    `;
    container.appendChild(newRow);
}

function closeEditCheckoutModal() {
    const modal = document.getElementById('editCheckoutModal');
    if (modal) modal.remove();
}

function saveEditCheckout(historyIndex) {
    const session = appState.checkoutHistory[historyIndex];
    if (!session) return;
    
    const newGuests = parseInt(document.getElementById('editGuests').value) || 0;
    const newTaxRate = parseInt(document.getElementById('editTaxRate').value) || 20;
    const newCastName = document.getElementById('editCastName').value || '';
    const newShimeiCasts = document.getElementById('editShimeiCasts').value || '';
    const newCatchStaff = document.getElementById('editCatchStaff').value || '';
    
    // æ³¨æ–‡æ˜ç´°ã‚’åé›†
    const orderRows = document.querySelectorAll('#editOrdersList .flex.items-center');
    const newOrders = [];
    let subtotal = 0;
    
    orderRows.forEach((row, idx) => {
        const name = document.getElementById(`editOrderName_${idx}`)?.value || '';
        const qty = parseInt(document.getElementById(`editOrderQty_${idx}`)?.value) || 0;
        const price = parseInt(document.getElementById(`editOrderPrice_${idx}`)?.value) || 0;
        
        if (name && qty > 0) {
            newOrders.push({
                item_name: name,
                quantity: qty,
                price: price
            });
            subtotal += price * qty;
        }
    });
    
    // TAXã‚’è¨ˆç®—
    const taxAmount = Math.floor(subtotal * (newTaxRate / 100));
    const newTotal = subtotal + taxAmount;
    
    // æ›´æ–°
    session.guests = newGuests;
    session.taxRate = newTaxRate;
    session.tax_rate = newTaxRate;
    session.castName = newCastName;
    session.cast_name = newCastName;
    session.shimei_casts = newShimeiCasts;
    session.catchStaff = newCatchStaff;
    session.catch_staff = newCatchStaff;
    session.orders = newOrders;
    session.totalAmount = newTotal;
    session.currentTotal = newTotal;
    session.current_total = newTotal;
    
    // localStorageã«ä¿å­˜
    try {
        localStorage.setItem('cabax_checkoutHistory', JSON.stringify(appState.checkoutHistory));
    } catch (e) {
        console.warn('localStorageä¿å­˜å¤±æ•—:', e);
    }
    
    closeEditCheckoutModal();
    renderCheckoutHistory();
    
    // æ—¥å ±ã‚‚æ›´æ–°
    if (typeof renderDailyReport === 'function') renderDailyReport();
    
    showNotification('ä¼šè¨ˆæƒ…å ±ã‚’ä¿®æ­£ã—ã¾ã—ãŸ', 'success');
}

// æ—¥å ±æ©Ÿèƒ½
function renderDailyReport() {
    console.log('[renderDailyReport] start');

    const container = document.getElementById('dailyReportContent');
    console.log('[renderDailyReport] container =', container);
    if (!container) return;

    try {
        // â˜… ã“ã“ã‚’ä¿®æ­£
        // const app = window.appState || {};
        const app = (typeof appState !== 'undefined' && appState) ? appState : {};

        const activeSessions  = Array.isArray(app.activeSessions)  ? app.activeSessions  : [];
        const checkoutHistory = Array.isArray(app.checkoutHistory) ? app.checkoutHistory : [];
        const allSessions     = activeSessions.concat(checkoutHistory);

        console.log('[renderDailyReport] sessions', {
            active: activeSessions.length,
            history: checkoutHistory.length,
            all: allSessions.length
        });
        console.log('[renderDailyReport] sample session 0', allSessions[0]);
        console.log('[renderDailyReport] sample session 1', allSessions[1]);

        const casts        = Array.isArray(app.casts)        ? app.casts        : [];
        const attendances  = Array.isArray(app.attendances)  ? app.attendances  : [];
        const today        = new Date().toISOString().split('T')[0];

        // ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³1ä»¶ã‚ãŸã‚Šã®å£²ä¸Šã‚’å–ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ =====
        function getSessionTotal(session) {
            if (!session) return 0;

            const candidates = [
                session.currentTotal,
                session.totalAmount,
                session.total,
                session.subtotal,
                session.grandTotal,
                session.totalWithTax
            ];

            for (const v of candidates) {
                if (typeof v === 'number' && !isNaN(v)) return v;
                if (typeof v === 'string' && v.trim() !== '' && !isNaN(Number(v))) {
                    return Number(v);
                }
            }

            // ãã‚Œã§ã‚‚ç„¡ã‘ã‚Œã° orders ã‹ã‚‰åˆè¨ˆ
            if (Array.isArray(session.orders)) {
                return session.orders.reduce((sum, o) => {
                    const price = Number(o?.price) || 0;
                    const qty   = Number(o?.quantity) || 0;
                    return sum + price * qty;
                }, 0);
            }

            return 0;
        }

        // ===== æ—¥æ¬¡å£²ä¸Šé›†è¨ˆ =====
        const totalSales = allSessions.reduce((sum, s) => {
            return sum + getSessionTotal(s);
        }, 0);

        const totalCustomers = allSessions.length;
        const averageSpend   = totalCustomers > 0
            ? Math.floor(totalSales / totalCustomers)
            : 0;

        const totalOrdersAmount = allSessions.reduce((sum, s) => {
            if (!s || !Array.isArray(s.orders)) return sum;
            const orderTotal = s.orders.reduce((os, o) => {
                const price = Number(o?.price) || 0;
                const qty   = Number(o?.quantity) || 0;
                return os + price * qty;
            }, 0);
            return sum + orderTotal;
        }, 0);
        console.log('[renderDailyReport] totalOrdersAmount =', totalOrdersAmount);

        // ===== é…’é¡åŸä¾¡è¨ˆç®—ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åŸä¾¡ã‹ã‚‰è¨ˆç®—ï¼‰=====
        const menuItems = Array.isArray(app.menuItems) ? app.menuItems : [];
        let totalCost = 0;
        let totalGuestCount = 0;
        
        allSessions.forEach(session => {
            // æ¥å®¢æ•°ã‚’é›†è¨ˆ
            totalGuestCount += Number(session.guests) || 0;
            
            if (Array.isArray(session.orders)) {
                session.orders.forEach(order => {
                    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã™
                    const menuItem = menuItems.find(m => 
                        m.name === order.item_name || 
                        m.id === order.menu_item_id
                    );
                    
                    if (menuItem && menuItem.cost > 0) {
                        // åŸä¾¡ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
                        totalCost += (menuItem.cost || 0) * (order.quantity || 1);
                    }
                });
            }
        });
        
        // ã‚¹ã‚¿ãƒƒãƒ•äººä»¶è²»ã‚’å–å¾—
        const staffAttendances = Array.isArray(app.staffAttendances) ? app.staffAttendances : [];
        const todayStaffCost = staffAttendances.reduce((sum, att) => sum + (att.daily_wage || 0), 0);
        
        // ===== ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯è¨ˆç®— =====
        let companionBackTotal = 0;
        let nominationBackTotal = 0;
        let drinkBackTotal = 0;
        let salesBackTotal = 0;
        
        // ã‚­ãƒ£ã‚¹ãƒˆã”ã¨ã®å£²ä¸Šã‚’é›†è¨ˆ
        const castSales = {};
        allSessions.forEach(session => {
            if (!session) return;
            const castName = session.castName || session.cast_name;
            if (castName) {
                if (!castSales[castName]) castSales[castName] = 0;
                castSales[castName] += getSessionTotal(session);
            }
            
            // åŒä¼´ãƒãƒƒã‚¯
            if (session.hasCompanion && session.companionName) {
                const cast = casts.find(c => c.name === session.companionName || c.stage_name === session.companionName);
                if (cast) {
                    companionBackTotal += cast.companionBack ?? cast.companion_back ?? 3000;
                }
            }
            
            // æŒ‡åãƒãƒƒã‚¯
            if (session.nomination && session.nomination.type) {
                const castName = session.castName || session.cast_name;
                const cast = casts.find(c => c.name === castName || c.stage_name === castName);
                if (cast) {
                    nominationBackTotal += cast.nominationBack ?? cast.nomination_back ?? 1000;
                }
            }
            
            // ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯
            if (Array.isArray(session.orders)) {
                session.orders.forEach(order => {
                    if (order.isDrinkBack && order.castName) {
                        const cast = casts.find(c => c.name === order.castName || c.stage_name === order.castName);
                        if (cast) {
                            const rate = cast.drinkBackRate ?? cast.drink_back_rate ?? 10;
                            drinkBackTotal += Math.floor((order.price || 0) * (order.quantity || 1) * rate / 100);
                        }
                    }
                });
            }
        });
        
        // å£²ä¸Šãƒãƒƒã‚¯
        Object.entries(castSales).forEach(([castName, sales]) => {
            const cast = casts.find(c => c.name === castName || c.stage_name === castName);
            if (cast) {
                const rate = cast.salesBackRate ?? cast.sales_back_rate ?? 0;
                salesBackTotal += Math.floor(sales * rate / 100);
            }
        });
        
        const castPayrollTotal = companionBackTotal + nominationBackTotal + drinkBackTotal + salesBackTotal;
        
        // ç²—åˆ© = å£²ä¸Š - é…’é¡åŸä¾¡ - ã‚¹ã‚¿ãƒƒãƒ•äººä»¶è²» - ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯
        const grossProfit = totalSales - totalCost - todayStaffCost - castPayrollTotal;
        
        // å®¢å˜ä¾¡ = å£²ä¸Šåˆè¨ˆ Ã· æ¥å®¢æ•°ï¼ˆäººæ•°ã®åˆè¨ˆï¼‰
        const avgSpendPerPerson = totalGuestCount > 0 
            ? Math.floor(totalSales / totalGuestCount) 
            : 0;

        // ===== æŒ‡åãƒ»åŒä¼´ãƒ»å»¶é•·é›†è¨ˆ =====
        const companionCount = allSessions.filter(s => s && s.hasCompanion).length;
        const mainNominationCount = allSessions.filter(
            s => s && s.nomination && s.nomination.type === 'main'
        ).length;
        const inHouseNominationCount = allSessions.filter(
            s => s && s.nomination && s.nomination.type === 'in-house'
        ).length;
        const totalNominations = mainNominationCount + inHouseNominationCount;

        const totalExtensions = allSessions.reduce((sum, s) => {
            const v = s && s.extensionCount ? Number(s.extensionCount) : 0;
            return sum + (isNaN(v) ? 0 : v);
        }, 0);

        // ===== ã‚­ãƒ£ã‚¹ãƒˆåˆ¥é›†è¨ˆ =====
        const castData = {};

        allSessions.forEach(session => {
            if (!session) return;
            const castName = session.castName || 'æœªè¨­å®š';

            if (!castData[castName]) {
                const cast = casts.find(c => c && c.name === castName);
                const attendance = attendances.find(
                    a => a && a.castName === castName && a.date === today
                );

                const hourlyRate = cast && typeof cast.hourlyRate === 'number'
                    ? cast.hourlyRate
                    : 0;

                castData[castName] = {
                    name: castName,
                    hourlyRate,
                    clockIn:  attendance?.clockIn || '-',
                    clockOut: attendance?.clockOut || '-',
                    mainNominations: 0,
                    inHouseNominations: 0,
                    companions: 0,
                    companionNames: [],
                    extensions: 0,
                    drinkCount: 0,
                    bottles: [],
                    totalSales: 0,
                    personalBack: 0
                };
            }

            const cd = castData[castName];

            // æŒ‡å
            if (session.nomination) {
                if (session.nomination.type === 'main') {
                    cd.mainNominations++;
                } else if (session.nomination.type === 'in-house') {
                    cd.inHouseNominations++;
                }
            }

            // åŒä¼´
            if (session.hasCompanion) {
                cd.companions++;
                if (session.companionName) {
                    cd.companionNames.push(session.companionName);
                }
            }

            // å»¶é•·
            const ext = session.extensionCount ? Number(session.extensionCount) : 0;
            cd.extensions += isNaN(ext) ? 0 : ext;

            // æ³¨æ–‡
            if (Array.isArray(session.orders)) {
                session.orders.forEach(order => {
                    if (!order) return;
                    const price = Number(order.price) || 0;
                    const qty   = Number(order.quantity) || 0;

                    if (order.isDrinkBack && order.castName === castName) {
                        cd.drinkCount += qty;
                        cd.personalBack += Math.floor(price * qty * 0.6);
                    }

                    if (order.category === 'bottle') {
                        cd.bottles.push({
                            name: order.itemName || '',
                            price,
                            quantity: qty
                        });
                    }
                });
            }

            cd.totalSales += getSessionTotal(session);
        });

        const castDataArray = Object.values(castData).sort(
            (a, b) => Number(b.totalSales) - Number(a.totalSales)
        );
        console.log('[renderDailyReport] castDataArray length =', castDataArray.length);

        // ===== æç”» =====
        const content = `
            <div class="space-y-6">
                <!-- æ—¥æ¬¡ã‚µãƒãƒªãƒ¼ -->
                <div class="luxury-card rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-6 gold-accent">æ—¥æ¬¡å£²ä¸Šã‚µãƒãƒªãƒ¼</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">ç·å£²ä¸Š</p>
                            <p class="text-2xl font-bold gold-accent">
                                Â¥${Number(totalSales).toLocaleString()}
                            </p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">ç²—åˆ©</p>
                            <p class="text-2xl font-bold text-green-400">
                                Â¥${Number(grossProfit).toLocaleString()}
                            </p>
                            <p class="text-xs text-gray-500">åŸä¾¡: Â¥${Number(totalCost).toLocaleString()} / äººä»¶è²»: Â¥${Number(todayStaffCost).toLocaleString()} / ã‚­ãƒ£ã‚¹ãƒˆ: Â¥${Number(castPayrollTotal).toLocaleString()}</p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">å®¢å˜ä¾¡ï¼ˆäººï¼‰</p>
                            <p class="text-2xl font-bold text-blue-300">
                                Â¥${Number(avgSpendPerPerson).toLocaleString()}
                            </p>
                            <p class="text-xs text-gray-500">æ¥å®¢æ•°: ${totalGuestCount}å</p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">æ¥åº—çµ„æ•°</p>
                            <p class="text-2xl font-bold text-gray-200">
                                ${totalCustomers}çµ„
                            </p>
                        </div>
                    </div>
                    
                    <!-- ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯å†…è¨³ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                        <div class="bg-amber-900/30 rounded-xl p-4 border border-amber-700/30">
                            <p class="text-sm text-amber-400 mb-1">ğŸ’° åŒä¼´ãƒãƒƒã‚¯</p>
                            <p class="text-xl font-bold text-amber-300">
                                Â¥${Number(companionBackTotal).toLocaleString()}
                            </p>
                        </div>
                        <div class="bg-purple-900/30 rounded-xl p-4 border border-purple-700/30">
                            <p class="text-sm text-purple-400 mb-1">ğŸ’ æŒ‡åãƒãƒƒã‚¯</p>
                            <p class="text-xl font-bold text-purple-300">
                                Â¥${Number(nominationBackTotal).toLocaleString()}
                            </p>
                        </div>
                        <div class="bg-blue-900/30 rounded-xl p-4 border border-blue-700/30">
                            <p class="text-sm text-blue-400 mb-1">ğŸ¸ ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯</p>
                            <p class="text-xl font-bold text-blue-300">
                                Â¥${Number(drinkBackTotal).toLocaleString()}
                            </p>
                        </div>
                        <div class="bg-green-900/30 rounded-xl p-4 border border-green-700/30">
                            <p class="text-sm text-green-400 mb-1">ğŸ“ˆ å£²ä¸Šãƒãƒƒã‚¯</p>
                            <p class="text-xl font-bold text-green-300">
                                Â¥${Number(salesBackTotal).toLocaleString()}
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">æŒ‡åç·æ•°</p>
                            <p class="text-xl font-bold text-purple-300">
                                ${totalNominations}æœ¬
                            </p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">æœ¬æŒ‡å</p>
                            <p class="text-xl font-bold text-purple-400">
                                ${mainNominationCount}æœ¬
                            </p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">å ´å†…æŒ‡å</p>
                            <p class="text-xl font-bold text-purple-300">
                                ${inHouseNominationCount}æœ¬
                            </p>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <p class="text-sm text-gray-400 mb-1">åŒä¼´</p>
                            <p class="text-xl font-bold text-pink-400">
                                ${companionCount}çµ„
                            </p>
                        </div>
                    </div>

                    <div class="mt-4 bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">å»¶é•·ç·æ•°</p>
                        <p class="text-xl font-bold text-yellow-400">
                            ${totalExtensions}æœ¬
                        </p>
                    </div>
                </div>

                <!-- ã‚­ãƒ£ã‚¹ãƒˆåˆ¥å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                <div class="luxury-card rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-6 gold-accent">
                        ã‚­ãƒ£ã‚¹ãƒˆåˆ¥å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°
                    </h2>
                    <div class="space-y-4">
                        ${castDataArray.map((cast, index) => `
                            <div class="bg-gray-800/50 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">
                                            ${
                                                index === 0 ? 'ğŸ¥‡'
                                                : index === 1 ? 'ğŸ¥ˆ'
                                                : index === 2 ? 'ğŸ¥‰'
                                                : `${index + 1}ä½`
                                            }
                                        </span>
                                        <span class="text-xl font-bold text-gray-200">
                                            ${cast.name}
                                        </span>
                                    </div>
                                    <span class="text-2xl font-bold gold-accent">
                                        Â¥${Number(cast.totalSales).toLocaleString()}
                                    </span>
                                </div>
                                <div class="text-xs text-gray-400">
                                    å€‹äººãƒãƒƒã‚¯: Â¥${Number(cast.personalBack).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = content;
        console.log('[renderDailyReport] finished');
    } catch (e) {
        console.error('[renderDailyReport] error', e);
        container.innerHTML = `
            <div style="color:#fff; padding:16px;">
                æ—¥å ±ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${e.message}
            </div>
        `;
    }
}

// ===== æœˆå ±æ©Ÿèƒ½ =====
let currentReportMode = 'daily';

function switchReportMode(mode) {
    currentReportMode = mode;
    const btnDaily = document.getElementById('btnDailyReport');
    const btnMonthly = document.getElementById('btnMonthlyReport');
    const monthSelector = document.getElementById('monthSelector');
    const dailyContent = document.getElementById('dailyReportContent');
    const monthlyContent = document.getElementById('monthlyReportContent');
    
    if (mode === 'daily') {
        btnDaily.classList.add('bg-amber-500', 'text-black');
        btnDaily.classList.remove('text-gray-400');
        btnMonthly.classList.remove('bg-amber-500', 'text-black');
        btnMonthly.classList.add('text-gray-400');
        monthSelector.classList.add('hidden');
        dailyContent.classList.remove('hidden');
        monthlyContent.classList.add('hidden');
        renderDailyReport();
    } else {
        btnMonthly.classList.add('bg-amber-500', 'text-black');
        btnMonthly.classList.remove('text-gray-400');
        btnDaily.classList.remove('bg-amber-500', 'text-black');
        btnDaily.classList.add('text-gray-400');
        monthSelector.classList.remove('hidden');
        dailyContent.classList.add('hidden');
        monthlyContent.classList.remove('hidden');
        initMonthSelector();
        loadMonthlyReport();
    }
}

function initMonthSelector() {
    const yearSelect = document.getElementById('reportYear');
    const monthSelect = document.getElementById('reportMonth');
    const now = new Date();
    
    // å¹´é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆç¾åœ¨å¹´ã‹ã‚‰éå»3å¹´ï¼‰
    if (yearSelect.options.length === 0) {
        for (let y = now.getFullYear(); y >= now.getFullYear() - 3; y--) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = `${y}å¹´`;
            yearSelect.appendChild(opt);
        }
    }
    
    // ç¾åœ¨ã®æœˆã‚’é¸æŠ
    monthSelect.value = now.getMonth() + 1;
}

async function loadMonthlyReport() {
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;
    const container = document.getElementById('monthlyReportContent');
    
    container.innerHTML = '<div class="text-center py-8 text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    try {
        let data;
        if (appState.apiConnected) {
            data = await apiRequest(`/monthly-report?year=${year}&month=${month}`);
        } else {
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
            data = generateDemoMonthlyReport(parseInt(year), parseInt(month));
        }
        renderMonthlyReport(data);
    } catch (e) {
        console.error('æœˆå ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = `<div class="text-red-400 py-8">æœˆå ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}</div>`;
    }
}

function generateDemoMonthlyReport(year, month) {
    const daysInMonth = new Date(year, month, 0).getDate();
    const dailySales = [];
    let totalSales = 0;
    
    for (let d = 1; d <= daysInMonth; d++) {
        const sales = Math.floor(Math.random() * 200000) + 50000;
        totalSales += sales;
        dailySales.push({
            date: `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`,
            sales: sales
        });
    }
    
    return {
        year, month,
        period: `${year}å¹´${month}æœˆ`,
        session_count: Math.floor(Math.random() * 100) + 50,
        total_guests: Math.floor(Math.random() * 300) + 100,
        total_sales: totalSales,
        total_cost: Math.floor(totalSales * 0.25),
        companion_count: Math.floor(Math.random() * 30) + 10,
        nomination_count: Math.floor(Math.random() * 50) + 20,
        extension_count: Math.floor(Math.random() * 40) + 15,
        cast_payroll: {
            companion_back: Math.floor(Math.random() * 100000) + 30000,
            nomination_back: Math.floor(Math.random() * 80000) + 20000,
            drink_back: Math.floor(Math.random() * 150000) + 50000,
            sales_back: Math.floor(Math.random() * 50000) + 10000,
            total: 0
        },
        staff_cost: Math.floor(Math.random() * 200000) + 100000,
        gross_profit: 0,
        gross_profit_rate: 0,
        avg_per_group: Math.floor(totalSales / 80),
        avg_per_person: Math.floor(totalSales / 200),
        daily_sales: dailySales,
        cast_ranking: [
            { name: 'ã‚ŠãŠ', sales: 850000, nominations: 25, companions: 12, drink_count: 45 },
            { name: 'ã‚Œãª', sales: 720000, nominations: 20, companions: 8, drink_count: 38 },
            { name: 'ã‹ãª', sales: 650000, nominations: 18, companions: 10, drink_count: 32 },
            { name: 'ã‚ã„ã‚Š', sales: 480000, nominations: 12, companions: 5, drink_count: 28 },
            { name: 'ã¿ã‚†', sales: 420000, nominations: 10, companions: 4, drink_count: 22 }
        ]
    };
}

function renderMonthlyReport(data) {
    const container = document.getElementById('monthlyReportContent');
    
    // ç²—åˆ©è¨ˆç®—ï¼ˆAPIã‹ã‚‰æ¥ãªã„å ´åˆï¼‰
    const castPayrollTotal = data.cast_payroll?.total || 
        (data.cast_payroll?.companion_back || 0) + 
        (data.cast_payroll?.nomination_back || 0) + 
        (data.cast_payroll?.drink_back || 0) + 
        (data.cast_payroll?.sales_back || 0);
    
    const grossProfit = data.gross_profit || 
        (data.total_sales - (data.total_cost || 0) - castPayrollTotal - (data.staff_cost || 0));
    
    const grossProfitRate = data.total_sales > 0 ? 
        Math.round(grossProfit / data.total_sales * 100) : 0;
    
    // æ—¥åˆ¥å£²ä¸Šã®æœ€å¤§å€¤ï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰
    const maxDailySales = Math.max(...(data.daily_sales || []).map(d => d.sales), 1);
    
    const content = `
        <div class="space-y-6">
            <!-- æœˆæ¬¡ã‚µãƒãƒªãƒ¼ -->
            <div class="luxury-card rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-6 gold-accent">${data.period} æœˆæ¬¡ã‚µãƒãƒªãƒ¼</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">æœˆé–“å£²ä¸Š</p>
                        <p class="text-2xl font-bold gold-accent">
                            Â¥${Number(data.total_sales).toLocaleString()}
                        </p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">ç²—åˆ©</p>
                        <p class="text-2xl font-bold text-green-400">
                            Â¥${Number(grossProfit).toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">ç²—åˆ©ç‡ ${grossProfitRate}%</p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">æ¥å®¢æ•°</p>
                        <p class="text-2xl font-bold text-blue-300">
                            ${data.session_count}çµ„ / ${data.total_guests}å
                        </p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">å®¢å˜ä¾¡</p>
                        <p class="text-2xl font-bold text-gray-200">
                            Â¥${Number(data.avg_per_person || 0).toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">çµ„å˜ä¾¡: Â¥${Number(data.avg_per_group || 0).toLocaleString()}</p>
                    </div>
                </div>
                
                <!-- ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯å†…è¨³ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <div class="bg-amber-900/30 rounded-xl p-4 border border-amber-700/30">
                        <p class="text-sm text-amber-400 mb-1">ğŸ’° åŒä¼´ãƒãƒƒã‚¯</p>
                        <p class="text-xl font-bold text-amber-300">
                            Â¥${Number(data.cast_payroll?.companion_back || 0).toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">${data.companion_count}å›</p>
                    </div>
                    <div class="bg-purple-900/30 rounded-xl p-4 border border-purple-700/30">
                        <p class="text-sm text-purple-400 mb-1">ğŸ’ æŒ‡åãƒãƒƒã‚¯</p>
                        <p class="text-xl font-bold text-purple-300">
                            Â¥${Number(data.cast_payroll?.nomination_back || 0).toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">${data.nomination_count}å›</p>
                    </div>
                    <div class="bg-blue-900/30 rounded-xl p-4 border border-blue-700/30">
                        <p class="text-sm text-blue-400 mb-1">ğŸ¸ ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯</p>
                        <p class="text-xl font-bold text-blue-300">
                            Â¥${Number(data.cast_payroll?.drink_back || 0).toLocaleString()}
                        </p>
                    </div>
                    <div class="bg-green-900/30 rounded-xl p-4 border border-green-700/30">
                        <p class="text-sm text-green-400 mb-1">ğŸ“ˆ å£²ä¸Šãƒãƒƒã‚¯</p>
                        <p class="text-xl font-bold text-green-300">
                            Â¥${Number(data.cast_payroll?.sales_back || 0).toLocaleString()}
                        </p>
                    </div>
                </div>
                
                <!-- ã‚³ã‚¹ãƒˆå†…è¨³ -->
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">åŸä¾¡</p>
                        <p class="text-xl font-bold text-red-400">
                            Â¥${Number(data.total_cost || 0).toLocaleString()}
                        </p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯è¨ˆ</p>
                        <p class="text-xl font-bold text-orange-400">
                            Â¥${Number(castPayrollTotal).toLocaleString()}
                        </p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <p class="text-sm text-gray-400 mb-1">ã‚¹ã‚¿ãƒƒãƒ•äººä»¶è²»</p>
                        <p class="text-xl font-bold text-yellow-400">
                            Â¥${Number(data.staff_cost || 0).toLocaleString()}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- æ—¥åˆ¥å£²ä¸Šã‚°ãƒ©ãƒ• -->
            <div class="luxury-card rounded-xl p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-200">ğŸ“Š æ—¥åˆ¥å£²ä¸Šæ¨ç§»</h3>
                <div class="overflow-x-auto">
                    <div class="flex items-end gap-1 h-48 min-w-max">
                        ${(data.daily_sales || []).map(d => {
                            const height = Math.max((d.sales / maxDailySales) * 100, 2);
                            const day = new Date(d.date).getDate();
                            return `
                                <div class="flex flex-col items-center">
                                    <div class="w-6 bg-gradient-to-t from-amber-600 to-amber-400 rounded-t transition-all hover:from-amber-500 hover:to-amber-300" 
                                         style="height: ${height}%" 
                                         title="${d.date}: Â¥${Number(d.sales).toLocaleString()}">
                                    </div>
                                    <span class="text-xs text-gray-500 mt-1">${day}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
            
            <!-- ã‚­ãƒ£ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
            <div class="luxury-card rounded-xl p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-200">ğŸ† ã‚­ãƒ£ã‚¹ãƒˆæœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div class="space-y-4">
                    ${(data.cast_ranking || []).map((cast, index) => `
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">
                                        ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}ä½`}
                                    </span>
                                    <span class="text-xl font-bold text-gray-200">${cast.name}</span>
                                </div>
                                <span class="text-2xl font-bold gold-accent">
                                    Â¥${Number(cast.sales).toLocaleString()}
                                </span>
                            </div>
                            <div class="flex gap-4 text-sm text-gray-400">
                                <span>ğŸ’ æŒ‡å ${cast.nominations}å›</span>
                                <span>ğŸ’° åŒä¼´ ${cast.companions}å›</span>
                                <span>ğŸ¸ DB ${cast.drink_count}æ¯</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = content;
}


        function printFullDailyReport() {
            // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
            const isDailyMode = currentReportMode === 'daily';
            const content = isDailyMode 
                ? document.getElementById('dailyReportContent').innerHTML
                : document.getElementById('monthlyReportContent').innerHTML;
            
            const title = isDailyMode ? 'æ—¥å ±' : 'æœˆå ±';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cabax ${title}</title>
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            padding: 20px; 
                            max-width: 800px; 
                            margin: 0 auto;
                            color: #333;
                        }
                        h1, h2, h3 { margin: 0 0 10px 0; }
                        .luxury-card { 
                            border: 1px solid #ddd; 
                            border-radius: 8px; 
                            margin-bottom: 16px; 
                            padding: 16px;
                            background: #fff;
                        }
                        .grid { display: grid; gap: 16px; }
                        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
                        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
                        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .text-xl { font-size: 1.25rem; }
                        .text-2xl { font-size: 1.5rem; }
                        .text-3xl { font-size: 1.875rem; }
                        .font-bold { font-weight: bold; }
                        .mb-2 { margin-bottom: 0.5rem; }
                        .mb-4 { margin-bottom: 1rem; }
                        .mb-6 { margin-bottom: 1.5rem; }
                        .p-4 { padding: 1rem; }
                        .rounded-xl { border-radius: 0.75rem; }
                        .space-y-2 > * + * { margin-top: 0.5rem; }
                        .space-y-4 > * + * { margin-top: 1rem; }
                        .flex { display: flex; }
                        .justify-between { justify-content: space-between; }
                        .items-center { align-items: center; }
                        .gap-3 { gap: 0.75rem; }
                        .gap-4 { gap: 1rem; }
                        .border-t { border-top: 1px solid #ddd; padding-top: 1rem; }
                        .border-b { border-bottom: 1px solid #ddd; padding-bottom: 1rem; }
                        .bg-gray-800\\/50, .bg-gray-900\\/50 { background: #f5f5f5; }
                        .gold-accent { color: #b8860b; }
                        .text-green-400, .text-green-300 { color: #22c55e; }
                        .text-red-400 { color: #ef4444; }
                        .text-blue-300, .text-blue-400 { color: #3b82f6; }
                        .text-amber-300, .text-amber-400 { color: #f59e0b; }
                        .text-purple-300, .text-purple-400 { color: #a855f7; }
                        .text-gray-400, .text-gray-500 { color: #666; }
                        .text-gray-200 { color: #333; }
                        .hidden { display: none; }
                        @media print { 
                            body { padding: 10px; }
                            .luxury-card { break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1 style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                        Cabax ${title}
                    </h1>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 300);
        }

        // ãƒ¬ãƒãƒ¼ãƒˆ
        let salesTrendChart = null;
        let categorySalesChart = null;
        let hourlyChart = null;
        
        function renderReports() {
            const period = document.getElementById('reportPeriod')?.value || 'month';
            
            // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            const totalSales = allSessions.reduce((sum, s) => {
                const total = s.currentTotal || s.current_total || s.totalAmount || s.total_amount || 0;
                return sum + Number(total);
            }, 0);
            const totalCustomers = allSessions.length;
            const avgSpend = totalCustomers > 0 ? Math.floor(totalSales / totalCustomers) : 0;
            const grossProfit = Math.floor(totalSales * 0.6); // ç²—åˆ©ç‡60%
            
            // ã‚µãƒãƒªãƒ¼æ›´æ–°
            document.getElementById('reportTotalSales').textContent = `Â¥${totalSales.toLocaleString()}`;
            document.getElementById('reportTotalCustomers').textContent = `${totalCustomers}çµ„`;
            document.getElementById('reportAvgSpend').textContent = `Â¥${avgSpend.toLocaleString()}`;
            document.getElementById('reportGrossProfit').textContent = `Â¥${grossProfit.toLocaleString()}`;
            
            // å‰æœˆæ¯”ï¼ˆãƒ‡ãƒ¢ï¼‰
            document.getElementById('reportSalesChange').textContent = 'å‰æœˆæ¯” +15.3%';
            document.getElementById('reportCustomersChange').textContent = 'å‰æœˆæ¯” +8.5%';
            document.getElementById('reportAvgChange').textContent = 'å‰æœˆæ¯” +6.2%';
            document.getElementById('reportProfitRate').textContent = 'ç²—åˆ©ç‡ 60%';
            
            // ã‚°ãƒ©ãƒ•æç”»
            renderSalesTrendChart(period);
            renderCategorySalesChart(allSessions);
            renderHourlyChart();
            renderCostRateList();
            renderCatchStaffTable(allSessions);
            renderTopProducts(allSessions);
        }
        
        function renderSalesTrendChart(period) {
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (salesTrendChart) {
                salesTrendChart.destroy();
            }
            
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            let labels, data;
            
            if (period === 'today') {
                // æ™‚é–“å¸¯åˆ¥ã®å£²ä¸Šã‚’è¨ˆç®—ï¼ˆ20æ™‚ã€œç¿Œ2æ™‚ï¼‰
                const hourlyData = {};
                const hours = ['20:00', '21:00', '22:00', '23:00', '24:00', '1:00', '2:00'];
                hours.forEach(h => hourlyData[h] = 0);
                
                allSessions.forEach(session => {
                    const checkoutTime = session.checkoutTime || session.checkout_time || session.startTime || session.start_time;
                    if (checkoutTime) {
                        const date = new Date(checkoutTime);
                        let hour = date.getHours();
                        // æ™‚é–“å¸¯ã‚’ç‰¹å®š
                        let key = null;
                        if (hour >= 20) key = `${hour}:00`;
                        else if (hour === 0) key = '24:00';
                        else if (hour <= 2) key = `${hour}:00`;
                        
                        if (key && hourlyData.hasOwnProperty(key)) {
                            const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                            hourlyData[key] += Number(total);
                        }
                    }
                });
                
                // ç´¯è¨ˆã«å¤‰æ›
                labels = hours;
                let cumulative = 0;
                data = hours.map(h => {
                    cumulative += hourlyData[h];
                    return cumulative;
                });
            } else if (period === 'week') {
                // æ›œæ—¥åˆ¥ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°0ï¼‰
                labels = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
                const dayData = [0, 0, 0, 0, 0, 0, 0];
                
                allSessions.forEach(session => {
                    const checkoutTime = session.checkoutTime || session.checkout_time;
                    if (checkoutTime) {
                        const date = new Date(checkoutTime);
                        const dayIndex = (date.getDay() + 6) % 7; // æœˆæ›œ=0
                        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                        dayData[dayIndex] += Number(total);
                    }
                });
                data = dayData;
            } else if (period === 'month') {
                labels = ['1é€±', '2é€±', '3é€±', '4é€±'];
                const weekData = [0, 0, 0, 0];
                
                allSessions.forEach(session => {
                    const checkoutTime = session.checkoutTime || session.checkout_time;
                    if (checkoutTime) {
                        const date = new Date(checkoutTime);
                        const weekIndex = Math.min(Math.floor((date.getDate() - 1) / 7), 3);
                        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                        weekData[weekIndex] += Number(total);
                    }
                });
                data = weekData;
            } else {
                labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                const monthData = new Array(12).fill(0);
                
                allSessions.forEach(session => {
                    const checkoutTime = session.checkoutTime || session.checkout_time;
                    if (checkoutTime) {
                        const date = new Date(checkoutTime);
                        const monthIndex = date.getMonth();
                        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                        monthData[monthIndex] += Number(total);
                    }
                });
                data = monthData;
            }
            
            salesTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å£²ä¸Š',
                        data: data,
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#d4af37',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: 'rgba(212, 175, 55, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Â¥' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return 'Â¥' + (value / 1000) + 'K';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        function renderCategorySalesChart(sessions) {
            const ctx = document.getElementById('categorySalesChart');
            if (!ctx) return;
            
            if (categorySalesChart) {
                categorySalesChart.destroy();
            }
            
            // 6ã‚«ãƒ†ã‚´ãƒªå¯¾å¿œ
            const categoryTotals = {
                set: 0,
                bottle: 0,
                champagne: 0,
                wine: 0,
                drink: 0,
                food: 0
            };
            
            sessions.forEach(session => {
                if (session.orders) {
                    session.orders.forEach(order => {
                        const itemName = order.item_name || order.itemName || '';
                        const cat = normalizeCategory(order.category, itemName);
                        if (categoryTotals.hasOwnProperty(cat)) {
                            categoryTotals[cat] += (order.price || 0) * (order.quantity || 1);
                        }
                    });
                }
            });
            
            categorySalesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ã‚»ãƒƒãƒˆ', 'ãƒœãƒˆãƒ«', 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³', 'ãƒ¯ã‚¤ãƒ³', 'ãƒ‰ãƒªãƒ³ã‚¯', 'ãƒ•ãƒ¼ãƒ‰'],
                    datasets: [{
                        data: [
                            categoryTotals.set,
                            categoryTotals.bottle,
                            categoryTotals.champagne,
                            categoryTotals.wine,
                            categoryTotals.drink,
                            categoryTotals.food
                        ],
                        backgroundColor: [
                            'rgba(234, 179, 8, 0.8)',   // ã‚»ãƒƒãƒˆ - é»„è‰²
                            'rgba(147, 51, 234, 0.8)', // ãƒœãƒˆãƒ« - ç´«
                            'rgba(251, 191, 36, 0.8)', // ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ - ã‚´ãƒ¼ãƒ«ãƒ‰
                            'rgba(239, 68, 68, 0.8)',  // ãƒ¯ã‚¤ãƒ³ - èµ¤
                            'rgba(59, 130, 246, 0.8)', // ãƒ‰ãƒªãƒ³ã‚¯ - é’
                            'rgba(34, 197, 94, 0.8)'   // ãƒ•ãƒ¼ãƒ‰ - ç·‘
                        ],
                        borderColor: [
                            'rgba(234, 179, 8, 1)',
                            'rgba(147, 51, 234, 1)',
                            'rgba(251, 191, 36, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(34, 197, 94, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#9ca3af',
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: 'rgba(212, 175, 55, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return context.label + ': Â¥' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderHourlyChart() {
            const ctx = document.getElementById('hourlyChart');
            if (!ctx) return;
            
            if (hourlyChart) {
                hourlyChart.destroy();
            }
            
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            
            // æ™‚é–“å¸¯åˆ¥å£²ä¸Šã‚’é›†è¨ˆï¼ˆ20æ™‚ã€œç¿Œ5æ™‚ï¼‰
            const hours = ['20:00', '21:00', '22:00', '23:00', '24:00', '1:00', '2:00', '3:00', '4:00', '5:00'];
            const hourlyData = {};
            hours.forEach(h => hourlyData[h] = 0);
            
            allSessions.forEach(session => {
                const checkoutTime = session.checkoutTime || session.checkout_time || session.startTime || session.start_time;
                if (checkoutTime) {
                    const date = new Date(checkoutTime);
                    let hour = date.getHours();
                    let key = null;
                    
                    if (hour >= 20 && hour <= 23) {
                        key = `${hour}:00`;
                    } else if (hour === 0) {
                        key = '24:00';
                    } else if (hour >= 1 && hour <= 5) {
                        key = `${hour}:00`;
                    }
                    
                    if (key && hourlyData.hasOwnProperty(key)) {
                        const total = session.totalAmount || session.currentTotal || session.current_total || 0;
                        hourlyData[key] += Number(total);
                    }
                }
            });
            
            const salesData = hours.map(h => hourlyData[h]);
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'å£²ä¸Š',
                        data: salesData,
                        backgroundColor: 'rgba(212, 175, 55, 0.8)',
                        borderColor: 'rgba(212, 175, 55, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: 'rgba(212, 175, 55, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Â¥' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return 'Â¥' + (value / 1000) + 'K';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function renderCostRateList() {
            const container = document.getElementById('costRateList');
            if (!container) return;
            
            // 6ã‚«ãƒ†ã‚´ãƒªå¯¾å¿œï¼ˆåŸä¾¡ç‡ã¯ä»®ã®å€¤ï¼‰
            const categories = [
                { name: 'ã‚»ãƒƒãƒˆ', costRate: 20, color: 'bg-yellow-500' },
                { name: 'ãƒœãƒˆãƒ«', costRate: 30, color: 'bg-purple-500' },
                { name: 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³', costRate: 25, color: 'bg-amber-400' },
                { name: 'ãƒ¯ã‚¤ãƒ³', costRate: 35, color: 'bg-red-500' },
                { name: 'ãƒ‰ãƒªãƒ³ã‚¯', costRate: 35, color: 'bg-blue-500' },
                { name: 'ãƒ•ãƒ¼ãƒ‰', costRate: 45, color: 'bg-green-500' }
            ];
            
            container.innerHTML = categories.map(cat => `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">${cat.name}</span>
                        <span class="font-semibold text-gray-200">${cat.costRate}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="${cat.color} h-2 rounded-full" style="width: ${cat.costRate}%"></div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderCatchStaffTable(sessions) {
            const tbody = document.getElementById('catchStaffTableBody');
            
            // ã‚­ãƒ£ãƒƒãƒã‚¹ã‚¿ãƒƒãƒ•åˆ¥é›†è¨ˆ
            const staffMap = {};
            sessions.forEach(session => {
                const staff = session.catchStaff || 'æœªè¨­å®š';
                if (!staffMap[staff]) {
                    staffMap[staff] = {
                        name: staff,
                        count: 0,
                        totalSales: 0
                    };
                }
                staffMap[staff].count++;
                staffMap[staff].totalSales += session.currentTotal || session.totalAmount || 0;
            });
            
            const staffList = Object.values(staffMap).sort((a, b) => b.totalSales - a.totalSales);
            const totalSales = staffList.reduce((sum, s) => sum + s.totalSales, 0);
            
            if (staffList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            
            tbody.innerHTML = staffList.map((staff, index) => {
                const avgSpend = Math.floor(staff.totalSales / staff.count);
                const contribution = ((staff.totalSales / totalSales) * 100).toFixed(1);
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                
                return `
                    <tr class="border-b border-gray-800">
                        <td class="py-3 px-4 text-gray-300">${medal} ${staff.name}</td>
                        <td class="py-3 px-4 text-center text-gray-300">${staff.count}çµ„</td>
                        <td class="py-3 px-4 text-right font-bold gold-accent">Â¥${staff.totalSales.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right text-gray-300">Â¥${avgSpend.toLocaleString()}</td>
                        <td class="py-3 px-4 text-center text-blue-300">${contribution}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderTopProducts(sessions) {
            // å•†å“åˆ¥é›†è¨ˆ
            const productMap = {};
            
            sessions.forEach(session => {
                if (session.orders) {
                    session.orders.forEach(order => {
                        const key = order.itemName;
                        const category = normalizeCategory(order.category) || 'drink';
                        
                        if (!productMap[key]) {
                            productMap[key] = {
                                name: order.itemName,
                                category: category,
                                quantity: 0,
                                totalSales: 0
                            };
                        }
                        productMap[key].quantity += order.quantity || 1;
                        productMap[key].totalSales += (order.price || 0) * (order.quantity || 1);
                    });
                }
            });
            
            const products = Object.values(productMap);
            
            // ãƒœãƒˆãƒ«ãƒ»ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒ»ãƒ¯ã‚¤ãƒ³ã‚’ã¾ã¨ã‚ã¦ã€Œãƒœãƒˆãƒ«ç³»TOP5ã€
            const bottles = products
                .filter(p => ['bottle', 'champagne', 'wine'].includes(p.category))
                .sort((a, b) => b.totalSales - a.totalSales)
                .slice(0, 5);
            
            const drinks = products
                .filter(p => p.category === 'drink')
                .sort((a, b) => b.totalSales - a.totalSales)
                .slice(0, 5);
            
            const foods = products
                .filter(p => p.category === 'food')
                .sort((a, b) => b.totalSales - a.totalSales)
                .slice(0, 5);
            
            // ãƒœãƒˆãƒ«ç³»TOP5
            document.getElementById('topBottles').innerHTML = bottles.length > 0 
                ? bottles.map((p, i) => renderProductRank(p, i)).join('')
                : '<p class="text-gray-500 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
            
            // ãƒ‰ãƒªãƒ³ã‚¯TOP5
            document.getElementById('topDrinks').innerHTML = drinks.length > 0
                ? drinks.map((p, i) => renderProductRank(p, i)).join('')
                : '<p class="text-gray-500 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
            
            // ãƒ•ãƒ¼ãƒ‰TOP5
            document.getElementById('topFoods').innerHTML = foods.length > 0
                ? foods.map((p, i) => renderProductRank(p, i)).join('')
                : '<p class="text-gray-500 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
        }
        
        function renderProductRank(product, index) {
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            const rank = medals[index] || `${index + 1}ä½`;
            
            return `
                <div class="flex justify-between items-center p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                    <div>
                        <p class="text-sm font-semibold text-gray-200">${rank} ${product.name}</p>
                        <p class="text-xs text-gray-400">${product.quantity}å€‹</p>
                    </div>
                    <p class="font-bold text-pink-300">Â¥${product.totalSales.toLocaleString()}</p>
                </div>
            `;
        }
        
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        
        function updateDashboard() {
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            const totalSales = allSessions.reduce((sum, s) => {
                const total = s.currentTotal || s.current_total || s.totalAmount || s.total_amount || 0;
                return sum + Number(total);
            }, 0);
            const totalCustomers = allSessions.length;
            const workingCasts = (appState.attendances || []).filter(a => a.status === 'working').length;
            const averageSpend = totalCustomers > 0 ? Math.floor(totalSales / totalCustomers) : 0;
            
            document.getElementById('totalSales').textContent = `Â¥${totalSales.toLocaleString()}`;
            document.getElementById('totalCustomers').textContent = `${totalCustomers}çµ„`;
            document.getElementById('workingCasts').textContent = `${workingCasts}å`;
            document.getElementById('averageSpend').textContent = `Â¥${averageSpend.toLocaleString()}`;
            
            const activities = document.getElementById('recentActivities');
            activities.innerHTML = '<p class="text-sm text-gray-400">æœ€æ–°ã®æ´»å‹•ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>';
        }
let salesChartInstance = null;
// ä»–ã«ã‚‚ xxxChartInstance ãŒå‡ºã¦ãã‚‹ãªã‚‰åŒã˜ã‚ˆã†ã«ç”¨æ„
// ä¾‹:
// let visitsChartInstance = null;
// let ordersChartInstance = null;

// ãƒãƒ£ãƒ¼ãƒˆã¯ä¸€æ—¦ã‚ªãƒ•ã«ã—ã¦ãŠãï¼ˆå¾Œã§å¾©æ´»ã•ã›ã‚‹ç”¨ï¼‰
function setupCharts() {
    // TODO: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å¾©æ´»ã•ã›ã‚‹
}


        async function printDailyReport() {
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç›´æ¥æ—¥å ±ã‚’å°åˆ·
            const today = new Date().toISOString().split('T')[0];
            
            let data;
            try {
                if (appState.apiConnected) {
                    data = await apiRequest(`/daily-report?date=${today}`);
                } else {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”Ÿæˆ
                    const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
                    const todaySessions = allSessions.filter(s => {
                        const time = s.checkoutTime || s.start_time;
                        return time && time.startsWith(today);
                    });
                    const totalSales = todaySessions.reduce((sum, s) => sum + (s.current_total || s.total || 0), 0);
                    data = {
                        date: today,
                        total_sales: totalSales,
                        session_count: todaySessions.length,
                        total_guests: todaySessions.reduce((sum, s) => sum + (s.guests || 1), 0),
                        gross_profit: totalSales,
                        cast_payroll: { total: 0 },
                        staff_cost: 0
                    };
                }
            } catch (e) {
                console.error('æ—¥å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                showNotification('æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cabax æ—¥å ± - ${data.date}</title>
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            padding: 20px; 
                            max-width: 800px; 
                            margin: 0 auto;
                            color: #333;
                        }
                        h1 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .section { margin-bottom: 20px; }
                        .section-title { font-weight: bold; font-size: 1.2em; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
                        .label { color: #666; }
                        .value { font-weight: bold; }
                        .highlight { font-size: 1.3em; color: #b8860b; }
                        @media print { body { padding: 10px; } }
                    </style>
                </head>
                <body>
                    <h1>ğŸ“Š æ—¥å ± - ${data.date}</h1>
                    
                    <div class="section">
                        <div class="section-title">å£²ä¸Šã‚µãƒãƒªãƒ¼</div>
                        <div class="row">
                            <span class="label">ç·å£²ä¸Š</span>
                            <span class="value highlight">Â¥${(data.total_sales || 0).toLocaleString()}</span>
                        </div>
                        <div class="row">
                            <span class="label">åŸä¾¡</span>
                            <span class="value">Â¥${(data.total_cost || 0).toLocaleString()}</span>
                        </div>
                        <div class="row">
                            <span class="label">ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯</span>
                            <span class="value">Â¥${(data.cast_payroll?.total || 0).toLocaleString()}</span>
                        </div>
                        <div class="row">
                            <span class="label">ã‚¹ã‚¿ãƒƒãƒ•äººä»¶è²»</span>
                            <span class="value">Â¥${(data.staff_cost || 0).toLocaleString()}</span>
                        </div>
                        <div class="row">
                            <span class="label">ç²—åˆ©</span>
                            <span class="value highlight">Â¥${(data.gross_profit || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">æ¥å®¢æƒ…å ±</div>
                        <div class="row">
                            <span class="label">æ¥åº—çµ„æ•°</span>
                            <span class="value">${data.session_count || 0}çµ„</span>
                        </div>
                        <div class="row">
                            <span class="label">æ¥å®¢æ•°</span>
                            <span class="value">${data.total_guests || 0}å</span>
                        </div>
                        <div class="row">
                            <span class="label">å®¢å˜ä¾¡ï¼ˆçµ„ï¼‰</span>
                            <span class="value">Â¥${(data.avg_per_group || 0).toLocaleString()}</span>
                        </div>
                        <div class="row">
                            <span class="label">å®¢å˜ä¾¡ï¼ˆäººï¼‰</span>
                            <span class="value">Â¥${(data.avg_per_person || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">ã‚­ãƒ£ã‚¹ãƒˆãƒãƒƒã‚¯å†…è¨³</div>
                        <div class="row">
                            <span class="label">åŒä¼´ãƒãƒƒã‚¯</span>
                            <span class="value">Â¥${(data.cast_payroll?.companion_back || 0).toLocaleString()}</span>
                        </div>
                        <div class="row">
                            <span class="label">æŒ‡åãƒãƒƒã‚¯</span>
                            <span class="value">Â¥${(data.cast_payroll?.nomination_back || 0).toLocaleString()}</span>
                        </div>
                        <div class="row">
                            <span class="label">ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯</span>
                            <span class="value">Â¥${(data.cast_payroll?.drink_back || 0).toLocaleString()}</span>
                        </div>
                        <div class="row">
                            <span class="label">å£²ä¸Šãƒãƒƒã‚¯</span>
                            <span class="value">Â¥${(data.cast_payroll?.sales_back || 0).toLocaleString()}</span>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 300);
        }

        function exportCSV() {
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›
            const allSessions = [...(appState.activeSessions || []), ...(appState.checkoutHistory || [])];
            
            if (allSessions.length === 0) {
                showNotification('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                return;
            }
            
            const headers = ['ID', 'æ—¥æ™‚', 'ãƒ†ãƒ¼ãƒ–ãƒ«', 'æ‹…å½“', 'äººæ•°', 'æŒ‡å', 'åŒä¼´', 'å£²ä¸Š'];
            const rows = allSessions.map(s => [
                s.id || '',
                s.start_time || s.startTime || s.checkoutTime || '',
                s.tableName || `ãƒ†ãƒ¼ãƒ–ãƒ«${s.tableId || s.table_id}`,
                s.castName || s.cast_name || '',
                s.guests || 0,
                s.nomination_type || 'ãƒ•ãƒªãƒ¼',
                s.has_companion ? 'ã‚ã‚Š' : 'ãªã—',
                s.current_total || s.currentTotal || s.total || 0
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const today = new Date().toISOString().split('T')[0];
            downloadCSV(`å£²ä¸Šãƒ‡ãƒ¼ã‚¿_${today}.csv`, csvContent);
            showNotification('å£²ä¸Šãƒ‡ãƒ¼ã‚¿CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        // UIé–¢æ•°
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            const navBtns = document.querySelectorAll(`.nav-btn, .bottom-nav-btn`);
            navBtns.forEach(btn => {
                if (btn.getAttribute('onclick')?.includes(tabName)) {
                    btn.classList.add('active');
                }
            });
            
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth < 768) {
                sidebar.classList.remove('active');
            }
            
            if (tabName === 'daily-report') {
                renderDailyReport();
            }
            
            // ä¼šè¨ˆå±¥æ­´ã‚¿ãƒ–ã‚’é–‹ã„ãŸã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
            if (tabName === 'checkout-history') {
                renderCheckoutHistory();
            }
            
            // ã‚ªãƒ¼ãƒ€ãƒ¼ç®¡ç†ã‚¿ãƒ–ã‚’é–‹ã„ãŸã‚‰ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
            if (tabName === 'orders') {
                loadOrdersFromApi();
            }
            
            // åº—èˆ—è¨­å®šã‚¿ãƒ–ã‚’é–‹ã„ãŸã‚‰ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            if (tabName === 'store-settings') {
                loadStaffList();
                loadStaffAttendances();
            }
        }

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-50 no-print`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            const isLoggedIn = sessionStorage.getItem('cabax_logged_in');
            if (isLoggedIn === 'true') {
                showMainApp();
                initializeApp();
            }
        });
    </script>

    <!-- ä¼ç¥¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="receiptModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-auto">
            <div id="receiptContent" class="p-6 text-black">
                <!-- ä¼ç¥¨å†…å®¹ãŒã“ã“ã«å…¥ã‚‹ -->
            </div>
            <div class="flex gap-2 p-4 border-t bg-gray-100 no-print">
                <button onclick="printReceipt()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">
                    ğŸ–¨ï¸ å°åˆ·
                </button>
                <button onclick="closeReceiptModal()" class="flex-1 bg-gray-600 text-white py-3 rounded-xl font-bold">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #receiptModal, #receiptModal * {
                visibility: visible;
            }
            #receiptModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
            }
            #receiptModal .no-print {
                display: none !important;
            }
            #receiptContent {
                padding: 10mm;
            }
        }
    </style>
</body>
</html>