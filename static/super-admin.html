<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabax Super Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .status-active { color: #22c55e; }
        .status-expired { color: #ef4444; }
        .status-suspended { color: #f59e0b; }
        .gold-accent { color: #d4af37; }
    </style>
</head>
<body class="text-white">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 w-96">
            <h1 class="text-3xl font-bold text-center gold-accent mb-6">ğŸ” Super Admin</h1>
            <p class="text-gray-400 text-center mb-6">ç®¡ç†è€…ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <input type="password" id="adminKeyInput" 
                   class="w-full px-4 py-3 bg-gray-800 rounded-xl text-white mb-4"
                   placeholder="Admin Key" onkeypress="if(event.key==='Enter')login()">
            <button onclick="login()" 
                    class="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-600 rounded-xl font-bold hover:opacity-90">
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <p id="loginError" class="text-red-400 text-center mt-4 hidden">ç„¡åŠ¹ãªã‚­ãƒ¼ã§ã™</p>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="hidden">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="glass-card px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold gold-accent">Cabax Super Admin</h1>
            <div class="flex items-center gap-4">
                <span id="storeCount" class="text-gray-400">åº—èˆ—æ•°: 0</span>
                <button onclick="logout()" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </header>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="p-6 max-w-6xl mx-auto">
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">åº—èˆ—ä¸€è¦§</h2>
                <button onclick="showAddModal()" 
                        class="px-6 py-3 bg-gradient-to-r from-amber-500 to-yellow-600 rounded-xl font-bold hover:opacity-90">
                    â• æ–°è¦åº—èˆ—ç™»éŒ²
                </button>
            </div>

            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-card rounded-xl p-4 text-center">
                    <p class="text-gray-400 text-sm">ç·åº—èˆ—æ•°</p>
                    <p id="totalStores" class="text-3xl font-bold gold-accent">0</p>
                </div>
                <div class="glass-card rounded-xl p-4 text-center">
                    <p class="text-gray-400 text-sm">æœ‰åŠ¹</p>
                    <p id="activeStores" class="text-3xl font-bold text-green-400">0</p>
                </div>
                <div class="glass-card rounded-xl p-4 text-center">
                    <p class="text-gray-400 text-sm">æœŸé™åˆ‡ã‚Œ</p>
                    <p id="expiredStores" class="text-3xl font-bold text-red-400">0</p>
                </div>
                <div class="glass-card rounded-xl p-4 text-center">
                    <p class="text-gray-400 text-sm">æœˆé–“åç›Š</p>
                    <p id="monthlyRevenue" class="text-3xl font-bold gold-accent">Â¥0</p>
                </div>
            </div>

            <!-- åº—èˆ—ãƒªã‚¹ãƒˆ -->
            <div id="storeList" class="space-y-4">
                <!-- åº—èˆ—ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
        </main>
    </div>

    <!-- æ–°è¦åº—èˆ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold gold-accent mb-4">æ–°è¦åº—èˆ—ç™»éŒ²</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-gray-400 text-sm">åº—èˆ—å *</label>
                    <input type="text" id="newStoreName" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div class="border-t border-gray-700 pt-4 mt-4">
                    <p class="text-amber-400 text-sm font-bold mb-2">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±</p>
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ãƒ¦ãƒ¼ã‚¶ãƒ¼å *</label>
                    <input type="text" id="newUsername" class="w-full px-4 py-2 bg-gray-800 rounded-lg" placeholder="åº—èˆ—ç”¨ãƒ­ã‚°ã‚¤ãƒ³ID">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                    <input type="text" id="newPassword" class="w-full px-4 py-2 bg-gray-800 rounded-lg" placeholder="åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                </div>
                <div class="border-t border-gray-700 pt-4 mt-4">
                    <p class="text-gray-500 text-sm mb-2">ğŸ“‹ åº—èˆ—æƒ…å ±</p>
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ã‚ªãƒ¼ãƒŠãƒ¼å</label>
                    <input type="text" id="newOwnerName" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">é›»è©±ç•ªå·</label>
                    <input type="text" id="newPhone" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ãƒ¡ãƒ¼ãƒ«</label>
                    <input type="email" id="newEmail" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ä½æ‰€</label>
                    <input type="text" id="newAddress" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ãƒ—ãƒ©ãƒ³</label>
                    <select id="newPlan" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                        <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</option>
                        <option value="premium">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </option>
                    </select>
                </div>
                <div>
                    <label class="text-gray-400 text-sm">æœˆé¡æ–™é‡‘</label>
                    <input type="number" id="newMonthlyFee" value="30000" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ãƒ¡ãƒ¢</label>
                    <textarea id="newNotes" rows="2" class="w-full px-4 py-2 bg-gray-800 rounded-lg"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideAddModal()" class="flex-1 py-3 bg-gray-700 rounded-xl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="createStore()" class="flex-1 py-3 bg-gradient-to-r from-amber-500 to-yellow-600 rounded-xl font-bold">
                    ç™»éŒ²
                </button>
            </div>
        </div>
    </div>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold gold-accent mb-4">åº—èˆ—è©³ç´°</h3>
            <div id="detailContent" class="space-y-4">
                <!-- è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideDetailModal()" class="flex-1 py-3 bg-gray-700 rounded-xl">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- å»¶é•·ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="extendModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-6 w-96 mx-4">
            <h3 class="text-xl font-bold gold-accent mb-4">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å»¶é•·</h3>
            <p id="extendStoreName" class="text-gray-400 mb-4"></p>
            <div class="space-y-3">
                <button onclick="extendLicense(1)" class="w-full py-3 bg-gray-700 rounded-xl hover:bg-gray-600">
                    1ãƒ¶æœˆå»¶é•·
                </button>
                <button onclick="extendLicense(3)" class="w-full py-3 bg-gray-700 rounded-xl hover:bg-gray-600">
                    3ãƒ¶æœˆå»¶é•·
                </button>
                <button onclick="extendLicense(6)" class="w-full py-3 bg-gray-700 rounded-xl hover:bg-gray-600">
                    6ãƒ¶æœˆå»¶é•·
                </button>
                <button onclick="extendLicense(12)" class="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-600 rounded-xl font-bold">
                    12ãƒ¶æœˆå»¶é•·
                </button>
            </div>
            <button onclick="hideExtendModal()" class="w-full py-3 bg-gray-800 rounded-xl mt-4">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold gold-accent mb-4">åº—èˆ—ç·¨é›†</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-gray-400 text-sm">åº—èˆ—å</label>
                    <input type="text" id="editStoreName" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div class="border-t border-gray-700 pt-4 mt-4">
                    <p class="text-amber-400 text-sm font-bold mb-2">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±</p>
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                    <input type="text" id="editUsername" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ã™ã‚‹å ´åˆã®ã¿ï¼‰</label>
                    <input type="text" id="editPassword" class="w-full px-4 py-2 bg-gray-800 rounded-lg" placeholder="ç©ºæ¬„ãªã‚‰å¤‰æ›´ãªã—">
                </div>
                <div class="border-t border-gray-700 pt-4 mt-4">
                    <p class="text-gray-500 text-sm mb-2">ğŸ“‹ åº—èˆ—æƒ…å ±</p>
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ã‚ªãƒ¼ãƒŠãƒ¼å</label>
                    <input type="text" id="editOwnerName" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">é›»è©±ç•ªå·</label>
                    <input type="text" id="editPhone" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ãƒ¡ãƒ¼ãƒ«</label>
                    <input type="email" id="editEmail" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">æœˆé¡æ–™é‡‘</label>
                    <input type="number" id="editMonthlyFee" class="w-full px-4 py-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label class="text-gray-400 text-sm">ãƒ¡ãƒ¢</label>
                    <textarea id="editNotes" rows="2" class="w-full px-4 py-2 bg-gray-800 rounded-lg"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideEditModal()" class="flex-1 py-3 bg-gray-700 rounded-xl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="updateStore()" class="flex-1 py-3 bg-gradient-to-r from-amber-500 to-yellow-600 rounded-xl font-bold">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <script>
        let adminKey = '';
        let stores = [];
        let selectedStoreId = null;
        const API_BASE = '/api';

        // ãƒ­ã‚°ã‚¤ãƒ³
        async function login() {
            const key = document.getElementById('adminKeyInput').value;
            try {
                const res = await fetch(`${API_BASE}/stores?admin_key=${encodeURIComponent(key)}`);
                if (res.ok) {
                    adminKey = key;
                    stores = await res.json();
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainScreen').classList.remove('hidden');
                    renderStores();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            adminKey = '';
            stores = [];
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('adminKeyInput').value = '';
        }

        // åº—èˆ—ä¸€è¦§å–å¾—
        async function loadStores() {
            try {
                const res = await fetch(`${API_BASE}/stores?admin_key=${encodeURIComponent(adminKey)}`);
                if (res.ok) {
                    stores = await res.json();
                    renderStores();
                }
            } catch (e) {
                console.error(e);
            }
        }

        // åº—èˆ—ä¸€è¦§æç”»
        function renderStores() {
            const container = document.getElementById('storeList');
            
            // ã‚µãƒãƒªãƒ¼æ›´æ–°
            const active = stores.filter(s => s.status === 'active' && s.days_remaining >= 0).length;
            const expired = stores.filter(s => s.days_remaining < 0 || s.status === 'expired').length;
            const revenue = stores.filter(s => s.status === 'active').reduce((sum, s) => sum + s.monthly_fee, 0);
            
            document.getElementById('totalStores').textContent = stores.length;
            document.getElementById('activeStores').textContent = active;
            document.getElementById('expiredStores').textContent = expired;
            document.getElementById('monthlyRevenue').textContent = `Â¥${revenue.toLocaleString()}`;
            document.getElementById('storeCount').textContent = `åº—èˆ—æ•°: ${stores.length}`;

            if (stores.length === 0) {
                container.innerHTML = `
                    <div class="glass-card rounded-xl p-8 text-center">
                        <p class="text-gray-400">ç™»éŒ²ã•ã‚ŒãŸåº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = stores.map(store => {
                const statusClass = store.days_remaining < 0 ? 'status-expired' : 
                                   store.status === 'suspended' ? 'status-suspended' : 'status-active';
                const statusText = store.days_remaining < 0 ? 'æœŸé™åˆ‡ã‚Œ' :
                                  store.status === 'suspended' ? 'åœæ­¢ä¸­' : 'æœ‰åŠ¹';
                const daysText = store.days_remaining >= 0 ? `æ®‹ã‚Š${store.days_remaining}æ—¥` : `${Math.abs(store.days_remaining)}æ—¥è¶…é`;
                const warningClass = store.days_remaining <= 7 && store.days_remaining >= 0 ? 'text-yellow-400' : '';

                return `
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-bold">${store.name}</h3>
                                    <span class="px-2 py-1 rounded text-xs ${statusClass} bg-gray-800">${statusText}</span>
                                </div>
                                <div class="flex gap-4 text-sm text-gray-400">
                                    <span class="font-mono">${store.license_key}</span>
                                    ${store.username ? `<span>ğŸ” ${store.username}</span>` : '<span class="text-red-400">âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³æœªè¨­å®š</span>'}
                                </div>
                                <div class="flex gap-4 mt-2 text-sm">
                                    <span class="${warningClass}">${daysText}</span>
                                    <span class="text-gray-500">Â¥${store.monthly_fee.toLocaleString()}/æœˆ</span>
                                    ${store.owner_name ? `<span class="text-gray-500">${store.owner_name}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="showExtendModal(${store.id}, '${store.name}')" 
                                        class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-500 text-sm">
                                    å»¶é•·
                                </button>
                                <button onclick="showEditModal(${store.id})" 
                                        class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 text-sm">
                                    ç·¨é›†
                                </button>
                                <button onclick="showDetail(${store.id})" 
                                        class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">
                                    è©³ç´°
                                </button>
                                ${store.status === 'active' ? `
                                    <button onclick="suspendStore(${store.id})" 
                                            class="px-4 py-2 bg-yellow-600 rounded-lg hover:bg-yellow-500 text-sm">
                                        åœæ­¢
                                    </button>
                                ` : `
                                    <button onclick="activateStore(${store.id})" 
                                            class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 text-sm">
                                        å†é–‹
                                    </button>
                                `}
                                <button onclick="deleteStore(${store.id}, '${store.name}')" 
                                        class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-500 text-sm">
                                    å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ–°è¦åº—èˆ—ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
        }
        function hideAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }

        async function createStore() {
            const name = document.getElementById('newStoreName').value;
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            
            if (!name) {
                alert('åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!username || !password) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const data = {
                name,
                username,
                password,
                owner_name: document.getElementById('newOwnerName').value || null,
                phone: document.getElementById('newPhone').value || null,
                email: document.getElementById('newEmail').value || null,
                address: document.getElementById('newAddress').value || null,
                plan: document.getElementById('newPlan').value,
                monthly_fee: parseInt(document.getElementById('newMonthlyFee').value) || 30000,
                notes: document.getElementById('newNotes').value || null
            };

            try {
                const res = await fetch(`${API_BASE}/stores?admin_key=${encodeURIComponent(adminKey)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    const result = await res.json();
                    alert(`åº—èˆ—ã‚’ç™»éŒ²ã—ã¾ã—ãŸ\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${result.username}\nãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼: ${result.license_key}`);
                    hideAddModal();
                    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('newStoreName').value = '';
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('newOwnerName').value = '';
                    document.getElementById('newPhone').value = '';
                    document.getElementById('newEmail').value = '';
                    document.getElementById('newAddress').value = '';
                    document.getElementById('newNotes').value = '';
                    document.getElementById('newMonthlyFee').value = '30000';
                    loadStores();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) {
                console.error(e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showDetail(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (!store) return;

            const expiresAt = new Date(store.expires_at).toLocaleString('ja-JP');
            const createdAt = new Date(store.created_at).toLocaleString('ja-JP');

            const orderUrl = `${window.location.origin}/static/order.html?store_id=${store.id}`;
            const adminUrl = `${window.location.origin}/admin?store_id=${store.id}`;
            
            document.getElementById('detailContent').innerHTML = `
                <div class="space-y-3">
                    <!-- æ³¨æ–‡ç”¨URL & QRã‚³ãƒ¼ãƒ‰ -->
                    <div class="bg-gradient-to-r from-amber-500/20 to-yellow-600/20 rounded-xl p-4 mb-4">
                        <p class="text-amber-400 font-bold mb-2">ğŸ“± æ³¨æ–‡ç”¨URL</p>
                        <div class="flex items-center gap-2 mb-3">
                            <input type="text" readonly value="${orderUrl}" 
                                   class="flex-1 px-3 py-2 bg-gray-900 rounded-lg text-sm font-mono text-gray-300"
                                   id="orderUrlInput_${store.id}">
                            <button onclick="copyOrderUrl(${store.id})" 
                                    class="px-3 py-2 bg-amber-500 rounded-lg hover:bg-amber-600 text-black font-bold text-sm">
                                ğŸ“‹ ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                        <div class="flex justify-center bg-white rounded-xl p-4">
                            <div id="qrcode_${store.id}"></div>
                        </div>
                        <p class="text-gray-400 text-xs text-center mt-2">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨­ç½®ã—ã¦ãã ã•ã„</p>
                    </div>
                    
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">åº—èˆ—å</span>
                        <span class="font-bold">${store.name}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼</span>
                        <span class="font-mono text-sm">${store.license_key}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                        <span class="font-mono">${store.username || 'æœªè¨­å®š'}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">æœ‰åŠ¹æœŸé™</span>
                        <span>${expiresAt}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">æ®‹ã‚Šæ—¥æ•°</span>
                        <span>${store.days_remaining}æ—¥</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">ãƒ—ãƒ©ãƒ³</span>
                        <span>${store.plan === 'premium' ? 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ' : 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰'}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">æœˆé¡</span>
                        <span>Â¥${store.monthly_fee.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">ã‚ªãƒ¼ãƒŠãƒ¼</span>
                        <span>${store.owner_name || '-'}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">é›»è©±</span>
                        <span>${store.phone || '-'}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">ãƒ¡ãƒ¼ãƒ«</span>
                        <span>${store.email || '-'}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">ä½æ‰€</span>
                        <span>${store.address || '-'}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">ç™»éŒ²æ—¥</span>
                        <span>${createdAt}</span>
                    </div>
                    ${store.notes ? `
                        <div class="border-b border-gray-700 pb-2">
                            <span class="text-gray-400 block mb-1">ãƒ¡ãƒ¢</span>
                            <span class="text-sm">${store.notes}</span>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');
            
            // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
            setTimeout(() => {
                const qrContainer = document.getElementById(`qrcode_${store.id}`);
                if (qrContainer && typeof QRCode !== 'undefined') {
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, {
                        text: orderUrl,
                        width: 200,
                        height: 200
                    });
                }
            }, 100);
        }
        
        function copyOrderUrl(storeId) {
            const input = document.getElementById(`orderUrlInput_${storeId}`);
            if (input) {
                input.select();
                document.execCommand('copy');
                alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }
        
        function hideDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // å»¶é•·ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showExtendModal(storeId, storeName) {
            selectedStoreId = storeId;
            document.getElementById('extendStoreName').textContent = storeName;
            document.getElementById('extendModal').classList.remove('hidden');
        }
        function hideExtendModal() {
            document.getElementById('extendModal').classList.add('hidden');
            selectedStoreId = null;
        }

        async function extendLicense(months) {
            if (!selectedStoreId) return;
            
            try {
                const res = await fetch(`${API_BASE}/stores/${selectedStoreId}/extend?months=${months}&admin_key=${encodeURIComponent(adminKey)}`, {
                    method: 'POST'
                });
                
                if (res.ok) {
                    const result = await res.json();
                    alert(result.message);
                    hideExtendModal();
                    loadStores();
                } else {
                    alert('å»¶é•·ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) {
                console.error(e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showEditModal(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (!store) return;
            
            selectedStoreId = storeId;
            document.getElementById('editStoreName').value = store.name || '';
            document.getElementById('editUsername').value = store.username || '';
            document.getElementById('editPassword').value = '';
            document.getElementById('editOwnerName').value = store.owner_name || '';
            document.getElementById('editPhone').value = store.phone || '';
            document.getElementById('editEmail').value = store.email || '';
            document.getElementById('editMonthlyFee').value = store.monthly_fee || 30000;
            document.getElementById('editNotes').value = store.notes || '';
            
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        function hideEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            selectedStoreId = null;
        }
        
        async function updateStore() {
            if (!selectedStoreId) return;
            
            const data = {
                name: document.getElementById('editStoreName').value,
                username: document.getElementById('editUsername').value || null,
                owner_name: document.getElementById('editOwnerName').value || null,
                phone: document.getElementById('editPhone').value || null,
                email: document.getElementById('editEmail').value || null,
                monthly_fee: parseInt(document.getElementById('editMonthlyFee').value) || 30000,
                notes: document.getElementById('editNotes').value || null
            };
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å…¥åŠ›ã•ã‚ŒãŸå ´åˆã®ã¿é€ä¿¡
            const password = document.getElementById('editPassword').value;
            if (password) {
                data.password = password;
            }
            
            try {
                const res = await fetch(`${API_BASE}/stores/${selectedStoreId}?admin_key=${encodeURIComponent(adminKey)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('æ›´æ–°ã—ã¾ã—ãŸ');
                    hideEditModal();
                    loadStores();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) {
                console.error(e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // åœæ­¢/å†é–‹
        async function suspendStore(storeId) {
            if (!confirm('ã“ã®åº—èˆ—ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/stores/${storeId}/suspend?admin_key=${encodeURIComponent(adminKey)}`, {
                    method: 'POST'
                });
                if (res.ok) loadStores();
            } catch (e) {
                console.error(e);
            }
        }

        async function activateStore(storeId) {
            try {
                const res = await fetch(`${API_BASE}/stores/${storeId}/activate?admin_key=${encodeURIComponent(adminKey)}`, {
                    method: 'POST'
                });
                if (res.ok) loadStores();
            } catch (e) {
                console.error(e);
            }
        }

        // å‰Šé™¤
        async function deleteStore(storeId, storeName) {
            if (!confirm(`ã€Œ${storeName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\nâ€»é–¢é€£ã™ã‚‹å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€æ³¨æ–‡å±¥æ­´ç­‰ï¼‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/stores/${storeId}?admin_key=${encodeURIComponent(adminKey)}`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadStores();
                } else {
                    const err = await res.json().catch(() => ({}));
                    alert('å‰Šé™¤å¤±æ•—: ' + (err.detail || res.status));
                }
            } catch (e) {
                console.error(e);
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }
    </script>
</body>
</html>
