<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cabax Order - Luxury Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&display=swap');
        
        * { 
            font-family: 'Noto Serif JP', serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --luxury-black: #0a0a0a;
            --luxury-dark: #1a1a1a;
            --luxury-gray: #2a2a2a;
            --luxury-gold: #d4af37;
            --luxury-light: #f5f5f5;
        }
        
        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #f5f5f5;
            overflow-x: hidden;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .gold-accent {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .luxury-card {
            background: rgba(26, 26, 26, 0.6);
            border: 1px solid rgba(212, 175, 55, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .luxury-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.12);
            transform: translateY(-2px);
        }
        
        .luxury-btn {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            touch-action: manipulation;
            min-height: 56px;
        }
        
        .luxury-btn:active {
            transform: scale(0.98);
        }
        
        .luxury-btn:hover {
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.35);
        }
        
        .cart-fixed {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 400px;
            background: linear-gradient(180deg, rgba(10, 10, 10, 0.98) 0%, rgba(26, 26, 26, 0.98) 100%);
            border-left: 1px solid rgba(212, 175, 55, 0.15);
            backdrop-filter: blur(20px);
            z-index: 50;
            overflow-y: auto;
        }
        
        @media (max-width: 1024px) {
            .cart-fixed {
                width: 100%;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }
            .cart-fixed.active {
                transform: translateX(0);
            }
        }
        
        .category-tab {
            padding: 16px 32px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .category-tab.active {
            border-bottom-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
            color: #f4d03f;
        }
        
        .menu-item-card {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.15);
            transition: all 0.3s ease;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .menu-item-card:active {
            transform: scale(0.98);
        }
        
        .menu-item-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.12);
        }
        
        .cart-item {
            background: rgba(42, 42, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            animation: slideDown 0.3s ease-out;
            min-width: 400px;
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
        }
        
        .quantity-btn {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        
        .quantity-btn:active {
            transform: scale(0.95);
        }
        
        .quantity-btn:hover {
            background: rgba(212, 175, 55, 0.25);
        }
        
        .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        input[type="number"] {
            background: rgba(255, 255, 255, 0.04) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #f5f5f5 !important;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            width: 80px;
            height: 48px;
            border-radius: 12px;
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0a0a0a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }
        
        /* iPhoneå¯¾å¿œ */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
        }
        
        /* ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œ */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .safe-area-top {
            padding-top: env(safe-area-inset-top, 0px);
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
        @media (max-width: 640px) {
            .category-tab {
                padding: 10px 14px;
                font-size: 12px;
                white-space: nowrap;
            }
            
            .menu-item-card {
                padding: 16px;
            }
            
            .menu-item-card h3 {
                font-size: 16px;
            }
            
            .menu-item-card .text-3xl {
                font-size: 22px;
            }
            
            #tablesGrid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .table-card {
                padding: 20px;
            }
            
            .table-card .text-6xl {
                font-size: 36px;
            }
            
            /* ã‚«ãƒ¼ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ */
            .cart-slide {
                max-height: 85vh;
            }
            
            /* ãƒ˜ãƒƒãƒ€ãƒ¼èª¿æ•´ */
            .fixed.top-0 {
                padding-top: env(safe-area-inset-top, 0px);
            }
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-6 sm:p-8 w-full max-w-sm">
            <div class="text-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold gold-accent mb-2">Cabax</h1>
                <p class="text-gray-400 text-sm">æ³¨æ–‡ã‚·ã‚¹ãƒ†ãƒ </p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                    <input type="text" id="loginUsername" 
                           class="w-full px-4 py-3 bg-gray-800/50 rounded-xl text-white border border-gray-700 focus:border-yellow-600 focus:outline-none"
                           placeholder="åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-2">PIN</label>
                    <input type="password" id="loginPin" 
                           class="w-full px-4 py-3 bg-gray-800/50 rounded-xl text-white border border-gray-700 focus:border-yellow-600 focus:outline-none"
                           placeholder="ã‚¹ã‚¿ãƒƒãƒ•PINã¾ãŸã¯çµŒå–¶è€…PIN"
                           onkeypress="if(event.key==='Enter')handleLogin()">
                </div>
                <button onclick="handleLogin()" class="luxury-btn w-full py-4 rounded-xl text-lg">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
                <p id="loginError" class="text-red-400 text-center text-sm hidden">ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºï¼‰ -->
    <div id="mainAppContent" class="hidden">
    <div id="notificationArea"></div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠç”»é¢ -->
    <div id="tableSelectScreen" class="screen active min-h-screen p-4 sm:p-8 safe-area-top safe-area-bottom">
        <div class="w-full max-w-4xl mx-auto pt-8 sm:pt-16">
            <div class="text-center mb-8 sm:mb-12">
                <h1 class="text-4xl sm:text-6xl font-bold gold-accent mb-3 sm:mb-4">Cabax</h1>
                <div class="w-16 sm:w-20 h-1 bg-gradient-to-r from-transparent via-yellow-600 to-transparent mx-auto mb-4 sm:mb-6"></div>
                <p class="text-lg sm:text-2xl text-gray-400">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            </div>

            <div id="tablesGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-6"></div>
        </div>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠç”»é¢ -->
    <div id="menuScreen" class="screen">
               <div class="fixed top-0 left-0 right-0 bg-gradient-to-b from-black via-black/95 to-transparent z-40 pb-4 safe-area-top">
            <div class="flex flex-wrap items-center justify-between gap-2 sm:gap-4 px-4 sm:px-8 py-4 sm:py-6">
                <div class="flex-1 min-w-0">
                    <h2 class="text-xl sm:text-3xl font-bold gold-accent truncate" id="currentTableName">ãƒ†ãƒ¼ãƒ–ãƒ« A1</h2>
                    <p class="text-gray-400 mt-1 text-xs sm:text-base" id="sessionInfo">ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</p>
                </div>
                <div class="flex gap-2 sm:gap-3 flex-shrink-0">
                    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼šã‚«ãƒ¼ãƒˆï¼†å±¥æ­´ãƒœã‚¿ãƒ³ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯éè¡¨ç¤ºï¼‰ -->
                    <button onclick="toggleCart()" class="lg:hidden luxury-btn px-4 sm:px-6 py-2 sm:py-3 rounded-xl relative text-sm sm:text-base">
                        ğŸ›’ <span class="hidden sm:inline">ã‚«ãƒ¼ãƒˆ</span>
                        <span id="cartBadgeMobile" class="badge hidden">0</span>
                    </button>
                    <button onclick="showHistory()" class="lg:hidden bg-gray-800 text-gray-300 px-4 sm:px-6 py-2 sm:py-3 rounded-xl hover:bg-gray-700 transition font-semibold text-sm sm:text-base">
                        ğŸ“‹ <span class="hidden sm:inline">æ³¨æ–‡å±¥æ­´</span>
                    </button>
                </div>
            </div>


            <!-- ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
            <div class="flex gap-2 px-4 sm:px-8 overflow-x-auto hide-scrollbar" id="categoryTabs">
              <button onclick="filterCategory('all')" class="category-tab active" data-category="all">
    ã™ã¹ã¦
</button>
<button onclick="filterCategory('tableset')" class="category-tab" data-category="tableset">
    å“ã‚»ãƒƒãƒˆ
</button>
<button onclick="filterCategory('drink')" class="category-tab" data-category="drink">
    ãƒ‰ãƒªãƒ³ã‚¯
</button>
<button onclick="filterCategory('castdrink')" class="category-tab" data-category="castdrink">
    ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•
</button>
<button onclick="filterCategory('shochu')" class="category-tab" data-category="shochu">
    ç„¼é…
</button>
<button onclick="filterCategory('whisky')" class="category-tab" data-category="whisky">
    ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼
</button>
<button onclick="filterCategory('champagne')" class="category-tab" data-category="champagne">
    ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³
</button>
<button onclick="filterCategory('wine')" class="category-tab" data-category="wine">
    ãƒ¯ã‚¤ãƒ³
</button>
<button onclick="filterCategory('food')" class="category-tab" data-category="food">
    ãƒ•ãƒ¼ãƒ‰
</button>
<button onclick="showNominationModal()" class="category-tab" data-category="nomination">
    å ´å†…æŒ‡å
</button>
            </div>
        </div>



        <!-- ã‚«ãƒ¼ãƒˆï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¯å›ºå®šã€ãƒ¢ãƒã‚¤ãƒ«ã¯ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ -->
                    <div class="sticky top-0 bg-gradient-to-b from-black to-transparent p-6 border-b border-gray-800">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold gold-accent">ğŸ›’ æ³¨æ–‡ã‚«ãƒ¼ãƒˆ</h3>
                    <div class="flex items-center gap-3">
                        <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼šæ³¨æ–‡å±¥æ­´ãƒœã‚¿ãƒ³ -->
                        <button onclick="showHistory()" class="hidden lg:inline-flex items-center px-4 py-2 rounded-lg bg-gray-800 text-gray-200 text-sm hover:bg-gray-700 transition">
                            ğŸ“‹ æ³¨æ–‡å±¥æ­´
                        </button>
                        <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼šã‚«ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
                        <button onclick="toggleCart()" class="lg:hidden text-gray-400 text-2xl">âœ•</button>
                    </div>
                </div>
                <div class="text-sm text-gray-400">
                    <span id="cartItemCount">0</span> å“
                </div>
            </div>


            <div id="cartItems" class="p-6 space-y-4 min-h-[300px]">
                <div class="text-center text-gray-500 py-12">
                    ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™
                </div>
            </div>

            <div class="sticky bottom-0 bg-gradient-to-t from-black to-transparent p-6 border-t border-gray-800 space-y-4">
                <div class="flex justify-between items-center text-2xl font-bold">
                    <span class="text-gray-300">åˆè¨ˆ</span>
                    <span class="gold-accent" id="cartTotal">Â¥0</span>
                </div>
                <button onclick="submitOrder()" id="orderButton" class="w-full luxury-btn py-5 rounded-xl text-lg font-bold" disabled>
                    æ³¨æ–‡ã™ã‚‹
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="callStaff()" class="bg-blue-900/30 border border-blue-700/50 text-blue-400 py-4 rounded-xl hover:bg-blue-900/50 transition font-semibold">
                        ğŸ”” ã‚¹ã‚¿ãƒƒãƒ•
                    </button>
                    <button onclick="exitTable()" class="bg-gray-900/30 border border-gray-700/50 text-gray-400 py-4 rounded-xl hover:bg-gray-900/50 transition font-semibold">
                        ğŸšª çµ‚äº†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ³¨æ–‡å±¥æ­´ç”»é¢ -->
    <div id="historyScreen" class="screen min-h-screen p-8">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-4xl font-bold gold-accent">ğŸ“‹ æ³¨æ–‡å±¥æ­´</h2>
                <button onclick="backToMenu()" class="bg-gray-800 text-gray-300 px-8 py-4 rounded-xl hover:bg-gray-700 transition font-semibold">
                    â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
                </button>
            </div>

            <div id="historyList" class="space-y-4"></div>

            <div class="luxury-card rounded-2xl p-8 mt-8">
                <div class="flex justify-between items-center text-3xl font-bold">
                    <span class="text-gray-300">ç¾åœ¨ã®åˆè¨ˆ</span>
                    <span class="gold-accent" id="historyTotal">Â¥0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
// ã‚ªãƒ¼ãƒ€ãƒ¼ç”»é¢
// APIãƒ™ãƒ¼ã‚¹URLã‚’å‹•çš„ã«è¨­å®š
const API_BASE = (() => {
    // æœ¬ç•ªç’°å¢ƒ: åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®APIã‚’ä½¿ç”¨
    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        return `${window.location.origin}/api`;
    }
    // é–‹ç™ºç’°å¢ƒ
    return 'http://localhost:8000/api';
})();

console.log('[Cabax] API_BASE:', API_BASE);  

// â˜… åº—èˆ—IDã‚’å–å¾—ï¼ˆsessionStorageã¾ãŸã¯URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰
function getStoreId() {
    // sessionStorageã‹ã‚‰å–å¾—ï¼ˆadmin.htmlã§ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ä¿å­˜ã•ã‚Œã‚‹ï¼‰
    const stored = sessionStorage.getItem('cabax_store_id');
    if (stored) return stored;
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆorder.html?store_id=1ï¼‰
    const urlParams = new URLSearchParams(window.location.search);
    const urlStoreId = urlParams.get('store_id');
    if (urlStoreId) {
        sessionStorage.setItem('cabax_store_id', urlStoreId);
        return urlStoreId;
    }
    
    return null;
}

// â˜… APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆè‡ªå‹•ã§X-Store-Idãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ï¼‰
async function apiRequest(url, options = {}) {
    const headers = { ...(options.headers || {}) };
    
    // Content-TypeãŒãªã‘ã‚Œã°è¿½åŠ 
    if (!headers['Content-Type'] && options.body) {
        headers['Content-Type'] = 'application/json';
    }
    
    // Store IDã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ 
    const storeId = getStoreId();
    if (storeId) {
        headers['X-Store-Id'] = storeId;
    }
    
    // â˜… JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ 
    const token = localStorage.getItem('cabax_token');
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }
    
    return fetch(url, { ...options, headers });
}

console.log('[Cabax] Store ID:', getStoreId());  
        
      const appState = {
    selectedTable: null,
    sessionId: null,
    menuItems: [],
    cart: [],
    orders: [],
    currentCategory: 'all',   // â˜… ã“ã“ã«ã‚«ãƒ³ãƒï¼
    activeSessions: [],       // ã“ã‚Œã§OK
};


        // åˆæœŸåŒ–
async function init() {
    console.log('[order] init start');
    try {
        await loadTables();          // æ—¢å­˜
        await loadMenu();            // â˜… ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿é–¢æ•°ãŒã‚ã‚‹ãªã‚‰ã“ã“ã§
        await loadActiveSessions();  // â˜… ã•ã£ãè¶³ã—ãŸã‚„ã¤

        console.log('[order] init finished');
    } catch (error) {
        console.error('[order] init error', error);
    }
}
async function handleAddOrder() {
    // ã“ã“ã¯ç”»é¢ã®æ§‹é€ ã«åˆã‚ã›ã¦å¤‰æ›´
    const menuSelect = document.getElementById('menuSelect');
    const qtyInput = document.getElementById('orderQuantity');

    const menuItemId = menuSelect ? Number(menuSelect.value) : null;
    const quantity = qtyInput ? Number(qtyInput.value || '1') : 1;

    if (!menuItemId) {
        alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    if (!quantity || quantity <= 0) {
        alert('æ•°é‡ãŒä¸æ­£ã§ã™');
        return;
    }

    try {
        await createOrderForCurrentTable(menuItemId, quantity, {
            isDrinkBack: false,
            castName: null,
        });
        alert('æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸ');

        if (qtyInput) qtyInput.value = '1';
    } catch (e) {
        console.error('[order] handleAddOrder error', e);
    }
}

// ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦æ³¨æ–‡ã‚’ä½œæˆã—ã¦ API ã«é€ã‚‹
async function createOrderForCurrentTable(menuItemId, quantity, options = {}) {
    const { isDrinkBack = false, castName = null } = options;

    const tableId = appState.selectedTable;
    if (!tableId) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        throw new Error('no selectedTable');
    }

    // ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¢ã™
    const session = appState.activeSessions.find(s => s.tableId === tableId);
    if (!session) {
        alert('ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…¥åº—å‡¦ç†ãŒã¾ã ï¼‰');
        throw new Error('no active session for table ' + tableId);
    }

    const payload = {
        session_id: session.id,
        menu_item_id: menuItemId,
        quantity: quantity,
        is_drink_back: isDrinkBack,
        cast_name: castName,
    };

    const res = await apiRequest(`${API_BASE}/orders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
    });

    if (!res.ok) {
        const text = await res.text().catch(() => '');
        console.error('[order] createOrder error', res.status, text);
        alert('æ³¨æ–‡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        throw new Error('order error ' + res.status);
    }

    const order = await res.json().catch(() => null);
    console.log('[order] createOrder success', order);

    // é‡‘é¡ãªã©æœ€æ–°åŒ–
    await loadActiveSessions();

    return order;
}

// â˜… ã‚«ãƒ¼ãƒˆå†…ã®å…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’ /api/orders ã«é€ä¿¡ã™ã‚‹
async function submitCartOrders() {
    if (!appState.selectedTable) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    if (!appState.cart || appState.cart.length === 0) {
        alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
        return;
    }

    try {
        // å¿µã®ãŸã‚æœ€æ–°ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
        await loadActiveSessions();

        // ã‚«ãƒ¼ãƒˆå†…ã‚¢ã‚¤ãƒ†ãƒ ã‚’1ä»¶ãšã¤ /api/orders ã«é€ä¿¡
        for (const item of appState.cart) {
            // cart ã®æ§‹é€ ã«åˆã‚ã›ã¦IDã¨æ•°é‡ã‚’å–ã‚Šå‡ºã™
            const menuItemId = item.menuItemId ?? item.id;
            const quantity = item.quantity ?? item.qty ?? 1;

            await createOrderForCurrentTable(menuItemId, quantity, {
                isDrinkBack: false,
                castName: null,
            });
        }

        // é€ä¿¡å®Œäº†ã—ãŸã‚‰ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã—ã¦ç”»é¢æ›´æ–°
        appState.cart = [];
        renderCart();

        alert('æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
    } catch (e) {
        console.error('[order] submitCartOrders error', e);
        alert('æ³¨æ–‡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹APIã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

// ç¨¼åƒä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’ API ã‹ã‚‰å–å¾—ã—ã¦ state ã«åæ˜ ï¼ˆæ³¨æ–‡ã‚¢ãƒ—ãƒªå´ï¼‰
async function loadActiveSessions() {
    try {
        const res = await apiRequest(`${API_BASE}/sessions/active`);
        if (!res.ok) {
            throw new Error(`active sessions error: ${res.status}`);
        }
        const data = await res.json();

        if (!Array.isArray(data)) {
            console.error('[order] activeSessions is not array', data);
            return;
        }

        appState.activeSessions = data.map(s => ({
            id: s.id,
            tableId: s.table_id ?? s.tableId,
            castName: s.cast_name ?? s.castName ?? (s.cast && s.cast.name) ?? 'æœªè¨­å®š',
            guests: s.guests ?? s.guest_count ?? 0,
            currentTotal: s.current_total ?? s.total_amount ?? 0,
        }));

        console.log('[order] activeSessions loaded', appState.activeSessions);
    } catch (e) {
        console.error('[order] loadActiveSessions error', e);
    }
}

// å›ºå®šãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã« /tables ãŒç„¡ã„å ´åˆã«ä½¿ã†ï¼‰
const STATIC_TABLES = [
    { id: 1, table_name: '1', capacity: 4, is_vip: false, status: 'available' },
    { id: 2, table_name: '2', capacity: 4, is_vip: false, status: 'available' },
    { id: 3, table_name: '3', capacity: 4, is_vip: false, status: 'available' },
    { id: 4, table_name: 'VIP-1', capacity: 6, is_vip: true,  status: 'available' },
    { id: 5, table_name: 'VIP-2', capacity: 6, is_vip: true,  status: 'available' },
    { id: 6, table_name: 'BOX-1', capacity: 5, is_vip: false, status: 'available' },
    { id: 7, table_name: 'BOX-2', capacity: 5, is_vip: false, status: 'available' },
    { id: 8, table_name: 'BOX-3', capacity: 5, is_vip: false, status: 'available' }
];
// å›ºå®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ï¼ˆAPIã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå–ã‚Œãªã„ã¨ãã«ä½¿ã†ï¼‰
const STATIC_MENU_ITEMS = [
    // ã‚»ãƒƒãƒˆ
    {
        id: 101,
        name: '60åˆ†ã‚»ãƒƒãƒˆï¼ˆç„¼é…ãƒ»ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼é£²ã¿æ”¾é¡Œï¼‰',
        price: 8000,
        category: 'ã‚»ãƒƒãƒˆ',
        description: 'ã‚¢ã‚¤ã‚¹ãƒ»ãƒŸãƒãƒ»å‰²ã‚Šç‰©è¾¼ã¿ / ã‚µè¾¼ç¨åˆ¥',
        premium: false
    },
    {
        id: 102,
        name: '90åˆ†ã‚»ãƒƒãƒˆï¼ˆã‚†ã£ãŸã‚Šã‚³ãƒ¼ã‚¹ï¼‰',
        price: 12000,
        category: 'ã‚»ãƒƒãƒˆ',
        description: 'ç„¼é…ãƒ»ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼é£²ã¿æ”¾é¡Œ / ã‚µè¾¼ç¨åˆ¥',
        premium: true
    },

    // ãƒœãƒˆãƒ«
    {
        id: 201,
        name: 'é¡æœˆ',
        price: 4000,
        category: 'ãƒœãƒˆãƒ«',
        description: 'ç„¼é…ãƒœãƒˆãƒ«',
        premium: false
    },
    {
        id: 202,
        name: 'é»’éœ§å³¶',
        price: 6000,
        category: 'ãƒœãƒˆãƒ«',
        description: 'èŠ‹ç„¼é…ãƒœãƒˆãƒ«',
        premium: false
    },
    {
        id: 203,
        name: 'ãƒ¢ã‚¨ãƒ»ã‚¨ãƒ»ã‚·ãƒ£ãƒ³ãƒ‰ãƒ³',
        price: 25000,
        category: 'ãƒœãƒˆãƒ«',
        description: 'å®šç•ªã‚·ãƒ£ãƒ³ãƒ‘ãƒ³',
        premium: true
    },

    // ãƒ‰ãƒªãƒ³ã‚¯
    {
        id: 301,
        name: 'ç”Ÿãƒ“ãƒ¼ãƒ«',
        price: 900,
        category: 'ãƒ‰ãƒªãƒ³ã‚¯',
        description: '',
        premium: false
    },
    {
        id: 302,
        name: 'ãƒã‚¤ãƒœãƒ¼ãƒ«',
        price: 900,
        category: 'ãƒ‰ãƒªãƒ³ã‚¯',
        description: '',
        premium: false
    },
    {
        id: 303,
        name: 'ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ãƒ‰ãƒªãƒ³ã‚¯',
        price: 1500,
        category: 'ãƒ‰ãƒªãƒ³ã‚¯',
        description: 'ã‚­ãƒ£ã‚¹ãƒˆç”¨ãƒ‰ãƒªãƒ³ã‚¯',
        premium: false
    },

    // ãƒ•ãƒ¼ãƒ‰
    {
        id: 401,
        name: 'æè±†',
        price: 600,
        category: 'ãƒ•ãƒ¼ãƒ‰',
        description: '',
        premium: false
    },
    {
        id: 402,
        name: 'ãƒãƒ†ãƒˆãƒ•ãƒ©ã‚¤',
        price: 800,
        category: 'ãƒ•ãƒ¼ãƒ‰',
        description: '',
        premium: false
    },
    {
        id: 403,
        name: 'ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ç››ã‚Šåˆã‚ã›',
        price: 1200,
        category: 'ãƒ•ãƒ¼ãƒ‰',
        description: '',
        premium: false
    }
];

// ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§å–å¾—
async function loadTables() {
    console.log('[order] loadTables', API_BASE);
    try {
        const response = await apiRequest(`${API_BASE}/tables`);
        console.log('[order] /tables status', response.status);

        let tables;

        if (response.ok) {
            const data = await response.json();
            console.log('[order] /tables data', data);
            tables = Array.isArray(data) ? data : (data.tables || []);
        } else if (response.status === 404) {
            // APIã« /tables ãŒç„¡ã„å ´åˆ â†’ å›ºå®šãƒ†ãƒ¼ãƒ–ãƒ«ã§ä»£ç”¨
            console.warn('[order] /tables 404, using STATIC_TABLES fallback');
            tables = STATIC_TABLES;
        } else {
            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ä¾‹å¤–ã¨ã—ã¦æ‰±ã†
            const errData = await response.json().catch(() => ({}));
            console.error('[order] /tables error response', errData);
             if (errData.detail) {
        console.error('ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:');
        console.error(JSON.stringify(errData.detail, null, 2));
    }
            throw new Error('ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const grid = document.getElementById('tablesGrid');
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦äººæ•°ã‚’è¡¨ç¤º
        let activeSessions = [];
        try {
            const sessRes = await apiRequest(`${API_BASE}/sessions/active`);
            if (sessRes.ok) {
                activeSessions = await sessRes.json();
            }
        } catch (e) {
            console.warn('[order] sessions/active fetch failed:', e);
        }
        
        grid.innerHTML = tables
            .filter(t => t.status === 'available' || t.status === 'occupied' || !t.status)
            // â˜… ãƒ†ãƒ¼ãƒ–ãƒ«åã§ã‚½ãƒ¼ãƒˆï¼ˆæ•°å­—ã¨ã—ã¦æ¯”è¼ƒï¼‰
            .sort((a, b) => {
                const nameA = a.table_name || a.table_number || a.name || '';
                const nameB = b.table_name || b.table_number || b.name || '';
                // æ•°å­—éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦æ¯”è¼ƒ
                const numA = parseInt(nameA.replace(/\D/g, '')) || 0;
                const numB = parseInt(nameB.replace(/\D/g, '')) || 0;
                // VIPã¯å¾Œã‚ã«
                if (a.is_vip && !b.is_vip) return 1;
                if (!a.is_vip && b.is_vip) return -1;
                return numA - numB;
            })
            .map(table => {
                const status = table.status || 'available';
                const statusClass = status === 'available'
                    ? 'bg-green-900/20 border-green-700/40'
                    : 'bg-red-900/20 border-red-700/40';

                const statusText = status === 'available' ? 'ç©ºå¸­' : 'ä½¿ç”¨ä¸­';
                
                // ä½¿ç”¨ä¸­ã®å ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰äººæ•°ã‚’å–å¾—
                let guestsText = '';
                if (status === 'occupied') {
                    const session = activeSessions.find(s => 
                        Number(s.table_id) === Number(table.id)
                    );
                    const guests = session ? (session.guests || 0) : 0;
                    guestsText = guests > 0 ? `${guests}åæ§˜` : '';
                }

                return `
                    <div onclick="selectTable('${table.id}')"
                         class="luxury-card ${statusClass} rounded-3xl p-12 cursor-pointer text-center w-full">
                        ${table.is_vip ? '<div class="text-sm gold-accent font-bold mb-3">â­ VIP</div>' : ''}
                        <div class="text-5xl font-bold text-gray-100 mb-2">
                            ${table.table_name || table.table_number || table.name || 'ãƒ†ãƒ¼ãƒ–ãƒ«'}
                        </div>
                        <div class="text-lg text-gray-400">${statusText}</div>
                        ${guestsText ? `<div class="text-sm text-gray-500 mt-2">${guestsText}</div>` : ''}
                    </div>
                `;
            }).join('');
    } catch (error) {
        console.error('[order] loadTables error', error);
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã© â†’ æœ€å¾Œã®ä¿é™ºã¨ã—ã¦å›ºå®šãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã†
        const grid = document.getElementById('tablesGrid');
        grid.innerHTML = STATIC_TABLES.map(table => `
            <div onclick="selectTable('${table.id}')"
                 class="luxury-card bg-green-900/20 border-green-700/40 rounded-3xl p-12 cursor-pointer text-center w-full">
                ${table.is_vip ? '<div class="text-sm gold-accent font-bold mb-3">â­ VIP</div>' : ''}
                <div class="text-5xl font-bold text-gray-100 mb-2">
                    ${table.table_name}
                </div>
                <div class="text-lg text-gray-400">ç©ºå¸­</div>
            </div>
        `).join('');

        showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ãŸãŸã‚ã€å›ºå®šãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™', 'error');
    }
}

// â˜… ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠï¼šè‡ªå‹•ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ä½œã‚‰ãªã„ï¼ˆç®¡ç†å´ã§å…¥åº—ã—ã¦ã‹ã‚‰æ³¨æ–‡ã™ã‚‹ï¼‰
async function selectTable(tableId) {
    console.log('[order] selectTable', tableId);

    appState.selectedTable = tableId;
    appState.cart = [];

    // ãƒ†ãƒ¼ãƒ–ãƒ«åè¡¨ç¤º
    const tableNameEl = document.getElementById('currentTableName');
    if (tableNameEl) tableNameEl.textContent = tableId;

    let sessionId = null;

    // 1) æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¢ã™
    try {
        const res = await apiRequest(`${API_BASE}/sessions/active`);
        if (res.ok) {
            const sessions = await res.json();
            const session = sessions.find(
                s => Number(s.table_id ?? s.tableId) === Number(tableId)
            );
            if (session) {
                sessionId = session.id;
                console.log('[order] active session found for table', tableId, '=> sessionId', sessionId);
            } else {
                console.log('[order] no active session for table', tableId);
            }
        } else {
            console.error('[order] /sessions/active error', res.status);
        }
    } catch (e) {
        console.error('[order] selectTable /sessions/active error', e);
    }

    // 2) â˜…ç„¡ã‘ã‚Œã°ä½œã‚‰ãªã„ï¼ˆã“ã“ãŒé‡è¦ï¼‰
    if (!sessionId) {
        appState.sessionId = null;
        appState.selectedTable = null;

        const infoEl = document.getElementById('sessionInfo');
        if (infoEl) infoEl.textContent = 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆç®¡ç†ã§å…¥åº—ã—ã¦ãã ã•ã„ï¼‰';

        showNotification('ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æœªå…¥åº—ã§ã™ã€‚ç®¡ç†ç”»é¢ã§å…¥åº—ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‰ã—ã¦ãã ã•ã„ã€‚', 'error');
        // ç”»é¢ã¯åˆ‡ã‚Šæ›¿ãˆãªã„ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã®ã¾ã¾ï¼‰
        return;
    }

    // 3) appState ã«åæ˜ 
    appState.sessionId = sessionId;

    const infoEl = document.getElementById('sessionInfo');
    if (infoEl) infoEl.textContent = `ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${sessionId}`;

    // 4) ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ï¼†ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    await loadMenu();
    showScreen('menuScreen');
    showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸ', 'info');
}


// ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿
async function loadMenu() {
    console.log('[order] loadMenu');
    
    try {
        const response = await apiRequest(`${API_BASE}/menu`);
        console.log('[order] /menu URL:', `${API_BASE}/menu`);
        console.log('[order] /menu status', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('[order] /menu data', data);
            appState.menuItems = data;
            renderMenu();
        } else {
            throw new Error(`Menu fetch failed: ${response.status}`);
        }
    } catch (error) {
        console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        appState.menuItems = [
            { id: 1, name: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', category: 'drink', price: 800 },
            { id: 2, name: 'ãƒ“ãƒ¼ãƒ«', category: 'drink', price: 700 },
            { id: 3, name: 'ã‚«ã‚·ã‚¹ã‚ªãƒ¬ãƒ³ã‚¸', category: 'drink', price: 800 },
            { id: 4, name: 'ãƒ•ãƒ«ãƒ¼ãƒ„ç››ã‚Šåˆã‚ã›', category: 'food', price: 8000 }
        ];
        renderMenu();
        showNotification('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰', 'warning');
    }
}
// ã‚«ãƒ†ã‚´ãƒªå¤‰æ›é–¢æ•°
function convertCategory(category) {
    const categoryMap = {
        'drink': 'ãƒ‰ãƒªãƒ³ã‚¯',
        'food': 'ãƒ•ãƒ¼ãƒ‰',
        'bottle': 'ãƒœãƒˆãƒ«',
        'set': 'ã‚»ãƒƒãƒˆ',
        'ãƒ‰ãƒªãƒ³ã‚¯': 'ãƒ‰ãƒªãƒ³ã‚¯',
        'ãƒ•ãƒ¼ãƒ‰': 'ãƒ•ãƒ¼ãƒ‰',
        'ãƒœãƒˆãƒ«': 'ãƒœãƒˆãƒ«',
        'ã‚»ãƒƒãƒˆ': 'ã‚»ãƒƒãƒˆ'
    };
    return categoryMap[category] || category;
}
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
function renderMenu() {
    // â˜… ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠã‚’æ¢ã™ï¼ˆæ—¢å­˜ã®IDã«ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    let grid =
        document.getElementById('menuGrid') ||      // æ–°ã—ãç½®ã„ãŸãƒ–ãƒ­ãƒƒã‚¯
        document.getElementById('menuList') ||      // ã‚‚ã¨ã‚‚ã¨ã®IDå€™è£œ
        document.getElementById('menuContainer');   // ä»–ã«ä½¿ã£ã¦ã„ãã†ãªIDå€™è£œ

    // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ–°ã—ãä½œã‚‹
    if (!grid) {
        console.warn('[order] ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºç”¨ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚‰ãªã„ã®ã§æ–°ã—ãä½œæˆã—ã¾ã™');

        // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®ã™ãä¸‹ã«å·®ã—è¾¼ã‚€
        const categoryTabs = document.getElementById('categoryTabs');
        const parent = categoryTabs ? categoryTabs.parentElement : document.body;

        const wrapper = document.createElement('div');
        wrapper.className = 'pt-40 sm:pt-48 pb-24 px-4 sm:px-8 safe-area-bottom';

        grid = document.createElement('div');
        grid.id = 'menuGrid';
        grid.className = 'grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-6';

        wrapper.appendChild(grid);
        parent.insertAdjacentElement('afterend', wrapper);
    }

    // â˜… ã“ã“ã‹ã‚‰ä¸‹ã¯å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ãã®ã¾ã¾ã§OK
    const filtered =
        appState.currentCategory === 'all'
            ? appState.menuItems
            : appState.menuItems.filter(
                  (item) => (item.category || '').toLowerCase() === appState.currentCategory.toLowerCase()
              );

    grid.className = 'grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-6';
    grid.innerHTML = filtered
        .map(
            (item) => {
                const category = (item.category || '').toLowerCase();
                // ã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ã®ã¿ä¾¡æ ¼è¡¨ç¤º
                const isGlassWine = item.description === 'glasswine';
                const isShot = item.description === 'shot';
                const isDrinkCategory = category === 'drink';
                const isCastDrink = category === 'castdrink';
                const isTableSet = category === 'tableset';
                // ãƒ‰ãƒªãƒ³ã‚¯ãƒ»ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒªãƒ³ã‚¯ãƒ»å“ã‚»ãƒƒãƒˆã¯ä¾¡æ ¼éè¡¨ç¤ºï¼ˆã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ä»¥å¤–ï¼‰
                const showPrice = !(isDrinkCategory || isCastDrink || isTableSet) || isGlassWine || isShot;
                
                return `
                    <div onclick="openDrinkModal(${item.id})" class="menu-item-card rounded-2xl p-4 sm:p-6 cursor-pointer flex flex-col min-h-[100px] sm:min-h-[140px]">
                        ${
                            item.premium
                                ? '<div class="mb-2 sm:mb-3"><span class="premium-badge">â­ PREMIUM</span></div>'
                                : ''
                        }
                        <h3 class="text-base sm:text-xl font-bold text-gray-200 mb-1 sm:mb-2 line-clamp-2">${item.name}</h3>
                        ${
                            item.description && !['shochu','whisky','beer','cocktail','soft','glasswine','shot','ãŠå®¢æ§˜ç”¨','å‰²ã‚Šç‰©','ã‚°ãƒ©ã‚¹ãƒ»ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«ãƒ»æ°·','ã‚°ãƒ©ã‚¹ã®è¿½åŠ ','æ°·ã®è¿½åŠ '].includes(item.description)
                                ? `<p class="text-xs sm:text-sm text-gray-400 mb-2 sm:mb-4 line-clamp-2">${item.description}</p>`
                                : ''
                        }
                        <div class="mt-auto">
                            ${showPrice ? `<div class="text-xl sm:text-3xl font-bold gold-accent">Â¥${item.price.toLocaleString()}</div>` : ''}
                        </div>
                    </div>
                `;
            }
        )
        .join('');
}


        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterCategory(category) {
            appState.currentCategory = category;
            
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.category === category) {
                    tab.classList.add('active');
                }
            });
            
            renderMenu();
        }

        // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
        function addToCart(itemId) {
            const item = appState.menuItems.find(m => m.id === itemId);
            if (!item) return;
            
            const existingItem = appState.cart.find(c => c.id === itemId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                appState.cart.push({
                    ...item,
                    quantity: 1
                });
            }
            
            renderCart();
            showNotification(`${item.name} ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
        }

        // ã‚«ãƒ¼ãƒˆè¡¨ç¤º
        function renderCart() {
            const container = document.getElementById('cartItems');
            const total = appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = appState.cart.reduce((sum, item) => sum + item.quantity, 0);
            
            document.getElementById('cartItemCount').textContent = itemCount;
            document.getElementById('cartTotal').textContent = `Â¥${total.toLocaleString()}`;
            
            const badge = document.getElementById('cartBadgeMobile');
            if (itemCount > 0) {
                badge.textContent = itemCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            const orderBtn = document.getElementById('orderButton');
            orderBtn.disabled = appState.cart.length === 0;
            
            if (appState.cart.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</div>';
                return;
            }
            
            container.innerHTML = appState.cart.map((item, idx) => `
                <div class="cart-item rounded-xl p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-200 mb-1">${item.name}</h4>
                            ${item.personName ? `<p class="text-sm text-gray-400 mb-1">â†’ ${item.personName}</p>` : ''}
                            <p class="text-lg gold-accent font-semibold">Â¥${item.price.toLocaleString()}</p>
                        </div>
                        <button onclick="removeFromCartByIndex(${idx})" class="text-red-400 text-xl ml-2">âœ•</button>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <button onclick="decreaseQuantityByIndex(${idx})" class="quantity-btn">âˆ’</button>
                            <span class="text-2xl font-bold text-gray-200 w-12 text-center">${item.quantity}</span>
                            <button onclick="increaseQuantityByIndex(${idx})" class="quantity-btn">+</button>
                        </div>
                        <div class="text-xl font-bold gold-accent">
                            Â¥${(item.price * item.quantity).toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ã‚«ãƒ¼ãƒˆæ“ä½œï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ï¼‰
        function increaseQuantityByIndex(idx) {
            if (appState.cart[idx]) {
                appState.cart[idx].quantity++;
                renderCart();
            }
        }

        function decreaseQuantityByIndex(idx) {
            if (appState.cart[idx] && appState.cart[idx].quantity > 1) {
                appState.cart[idx].quantity--;
                renderCart();
            }
        }

        function removeFromCartByIndex(idx) {
            appState.cart.splice(idx, 1);
            renderCart();
        }

        // æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        function increaseQuantity(itemId) {
            const item = appState.cart.find(c => c.id === itemId);
            if (item) {
                item.quantity++;
                renderCart();
            }
        }

        function decreaseQuantity(itemId) {
            const item = appState.cart.find(c => c.id === itemId);
            if (item && item.quantity > 1) {
                item.quantity--;
                renderCart();
            }
        }

        function removeFromCart(itemId) {
            appState.cart = appState.cart.filter(c => c.id !== itemId);
            renderCart();
            showNotification('ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
        }

        function toggleCart() {
            document.getElementById('cart').classList.toggle('active');
        }

// æ³¨æ–‡é€ä¿¡
async function submitOrder() {
    const btn = document.getElementById('orderButton');
    
    // é€£æ‰“é˜²æ­¢
    if (btn.disabled) return;
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚«ãƒ¼ãƒˆã®ãƒã‚§ãƒƒã‚¯
    if (appState.selectedTable == null) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    if (!appState.cart || appState.cart.length === 0) {
        alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
        return;
    }

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    btn.disabled = true;
    btn.textContent = 'é€ä¿¡ä¸­...';

    try {
        // æœ€æ–°ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
        await loadActiveSessions();

        // â˜… selectedTable ã‚’æ•°å­—ã«ãã‚ãˆã‚‹
        const selectedTableId = Number(appState.selectedTable);
        console.log('[order] selectedTableId:', selectedTableId, typeof selectedTableId);
        console.log('[order] activeSessions:', appState.activeSessions);

        // â˜… tableId å´ã‚‚ Number() ã—ã¦æ¯”è¼ƒ
        const session = appState.activeSessions.find(
            s => Number(s.tableId) === selectedTableId
        );

        if (!session) {
            alert('ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…¥åº—å‡¦ç†ãŒã¾ã ï¼‰');
            return;
        }

        // ã‚«ãƒ¼ãƒˆå†…ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’1ä»¶ãšã¤ /api/orders ã«é€ä¿¡
        for (const item of appState.cart) {
            const menuItemId = item.menuItemId ?? item.id;
            const quantity   = item.quantity   ?? item.qty ?? 1;

            const payload = {
                session_id:    session.id,
                menu_item_id:  menuItemId,
                quantity:      quantity,
                is_drink_back: item.isDrinkBack || false,
                cast_name:     item.personName || null,
                item_name:     item.name || null,  // ã‚«ã‚¹ã‚¿ãƒ å•†å“åã‚’é€ä¿¡
            };

            const res = await apiRequest(`${API_BASE}/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!res.ok) {
                const text = await res.text().catch(() => '');
                console.error('[order] /api/orders error', res.status, text);
                throw new Error('order error ' + res.status);
            }

            const order = await res.json().catch(() => null);
            console.log('[order] createOrder success', order);
        }

        // é€ä¿¡æˆåŠŸ â†’ ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã—ã¦å†æç”»
        appState.cart = [];
        renderCart();

        showNotification('æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
    } catch (e) {
        console.error('[order] submitOrder error', e);
        alert('æ³¨æ–‡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    } finally {
        // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
        btn.disabled = false;
        btn.textContent = 'æ³¨æ–‡ã™ã‚‹';
    }
}

async function showHistory() {
    await loadOrderHistory();
    showScreen('historyScreen');
}

async function loadOrderHistory() {
    console.log('[order] loadOrderHistory sessionId', appState.sessionId);
    
    if (!appState.sessionId) {
        console.log('[order] No sessionId, skip loading history');
        return;
    }
    
    try {
        const response = await apiRequest(`${API_BASE}/sessions/${appState.sessionId}/orders`);
        if (response.ok) {
            const data = await response.json();
            appState.orders = Array.isArray(data) ? data : [];
            console.log('[order] æ³¨æ–‡å±¥æ­´å–å¾—:', appState.orders.length, 'ä»¶');
            renderHistory();
        }
    } catch (error) {
        console.error('å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
}


        function renderHistory() {
    const container = document.getElementById('historyList');
    const total = appState.orders.reduce((sum, order) => sum + ((order.price || 0) * (order.quantity || 1)), 0);
    
    document.getElementById('historyTotal').textContent = `Â¥${total.toLocaleString()}`;
    
    if (appState.orders.length === 0) {
        container.innerHTML = '<div class="luxury-card rounded-2xl p-12 text-center text-gray-500">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    
    container.innerHTML = appState.orders.map(order => {
        const itemName = order.item_name || 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼';
        const subtotal = (order.price || 0) * (order.quantity || 1);
        
        return `
            <div class="luxury-card rounded-2xl p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-sm text-gray-400">${order.created_at ? new Date(order.created_at).toLocaleTimeString('ja-JP') : ''}</p>
                    </div>
                    <span class="px-4 py-2 rounded-full text-sm font-semibold ${order.is_served ? 'bg-green-900/30 text-green-400' : 'bg-yellow-900/30 text-yellow-400'}">
                        ${order.is_served ? 'æä¾›æ¸ˆã¿' : 'æº–å‚™ä¸­'}
                    </span>
                </div>
                <div class="space-y-2 mb-4">
                    <div class="flex justify-between text-gray-300">
                        <span>${itemName} Ã— ${order.quantity}</span>
                        <span>Â¥${subtotal.toLocaleString()}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

        function getStatusText(status) {
            const statusMap = {
                'pending': 'æº–å‚™ä¸­',
                'accepted': 'æ‰¿èªæ¸ˆã¿',
                'preparing': 'èª¿ç†ä¸­',
                'delivered': 'æä¾›æ¸ˆã¿',
                'cancelled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
            };
            return statusMap[status] || status;
        }

        // ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã—
        async function callStaff() {
            try {
                if (!appState.sessionId) {
                    showNotification('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                // ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã—ã‚’DBã«è¨˜éŒ²ï¼ˆæ³¨æ–‡é€šçŸ¥ã§æ¤œçŸ¥ã•ã‚Œã‚‹ï¼‰
                const response = await apiRequest(`${API_BASE}/sessions/${appState.sessionId}/add-charge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_name: 'ğŸ”” ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã—',
                        price: 0,
                        quantity: 1
                    })
                });
                
                if (response.ok) {
                    showNotification('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‘¼ã³å‡ºã—ã¾ã—ãŸ', 'success');
                } else {
                    throw new Error('API Error');
                }
            } catch (error) {
                console.error('ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // â˜… çµ‚äº†å‡¦ç†ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠç”»é¢ã«æˆ»ã‚‹ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯çµ‚äº†ã—ãªã„ï¼‰
function exitTable() {
    if (confirm('æ³¨æ–‡ç”»é¢ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ç¶™ç¶šã—ã¾ã™ï¼‰')) {
        // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        appState.sessionId = null;
        appState.selectedTable = null;
        appState.cart = [];
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠç”»é¢ã«æˆ»ã‚‹
        showScreen('tableSelectScreen');
        loadTables();
        
        showNotification('æ³¨æ–‡ç”»é¢ã‚’çµ‚äº†ã—ã¾ã—ãŸ', 'info');
    }
}

        // ç”»é¢åˆ‡æ›¿
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function backToMenu() {
            showScreen('menuScreen');
        }

        // é€šçŸ¥
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-900/90 border-green-700',
                error: 'bg-red-900/90 border-red-700',
                warning: 'bg-yellow-900/90 border-yellow-700',
                info: 'bg-blue-900/90 border-blue-700'
            };
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${colors[type]} border px-6 py-4 rounded-xl shadow-2xl backdrop-blur-sm`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${icons[type]}</span>
                    <span class="text-gray-200 font-medium text-lg">${message}</span>
                </div>
            `;
            
            document.getElementById('notificationArea').appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // åˆæœŸåŒ–ã¯ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«checkLoginState()ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
    </script>
    
    <!-- ãƒ‰ãƒªãƒ³ã‚¯æ³¨æ–‡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="drinkOrderModal" class="fixed inset-0 z-50 items-center justify-center bg-black/80 p-2 sm:p-4 hidden">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl max-h-[85vh] overflow-y-auto safe-area-bottom">
            <div class="border-b border-gray-700 px-4 sm:px-6 py-4 sm:py-5 flex items-center justify-between sticky top-0 bg-gray-900/95 backdrop-blur z-10">
                <h2 id="drinkModalTitle" class="text-lg sm:text-xl font-bold gold-accent">ãƒ‰ãƒªãƒ³ã‚¯æ³¨æ–‡</h2>
                <button onclick="closeDrinkModal()" class="text-gray-400 hover:text-gray-200 text-2xl p-2">âœ•</button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                <input type="hidden" id="drinkModalItemId">
                
                <!-- å•†å“æƒ…å ± -->
                <div class="text-center">
                    <h3 id="drinkModalItemName" class="text-xl sm:text-2xl font-bold text-gray-200 mb-2"></h3>
                    <p id="drinkModalItemPrice" class="text-2xl sm:text-3xl font-bold gold-accent"></p>
                </div>
                
                <!-- å‰²ã‚Šæ–¹é¸æŠï¼ˆç„¼é…ãƒ»ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ãƒ»ãƒ“ãƒ¼ãƒ«ç”¨ï¼‰ -->
                <div id="mixStyleSectionOrder" class="hidden">
                    <div class="text-sm text-gray-400 mb-2">å‰²ã‚Šæ–¹ã‚’é¸æŠ</div>
                    <div id="mixStyleOptionsOrder" class="grid grid-cols-2 gap-2">
                        <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ãƒ‰ãƒªãƒ³ã‚¯ã‚µã‚¤ã‚ºé¸æŠï¼ˆã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•ç”¨ï¼‰ -->
                <div id="drinkSizeSectionOrder" class="hidden">
                    <div class="text-sm text-gray-400 mb-2">ãƒ‰ãƒªãƒ³ã‚¯ã‚µã‚¤ã‚º</div>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="drink-size-order-label flex flex-col items-center justify-center p-2 sm:p-3 rounded-xl bg-black/20 border-2 border-amber-500 bg-amber-500/20 cursor-pointer">
                            <input type="radio" name="drinkSizeOrder" value="single" checked onchange="updateDrinkSizeOrderStyle(); updateDrinkModalPrice()" class="hidden">
                            <span class="text-white font-semibold text-xs sm:text-base">ã‚·ãƒ³ã‚°ãƒ«</span>
                            <span class="text-amber-400 font-bold text-sm sm:text-lg">Â¥1,000</span>
                        </label>
                        <label class="drink-size-order-label flex flex-col items-center justify-center p-2 sm:p-3 rounded-xl bg-black/20 border border-white/10 cursor-pointer">
                            <input type="radio" name="drinkSizeOrder" value="double" onchange="updateDrinkSizeOrderStyle(); updateDrinkModalPrice()" class="hidden">
                            <span class="text-white font-semibold">ãƒ€ãƒ–ãƒ«</span>
                            <span class="text-amber-400 font-bold text-lg">Â¥2,000</span>
                        </label>
                        <label class="drink-size-order-label flex flex-col items-center justify-center p-3 rounded-xl bg-black/20 border border-white/10 cursor-pointer">
                            <input type="radio" name="drinkSizeOrder" value="triple" onchange="updateDrinkSizeOrderStyle(); updateDrinkModalPrice()" class="hidden">
                            <span class="text-white font-semibold">ãƒˆãƒªãƒ—ãƒ«</span>
                            <span class="text-amber-400 font-bold text-lg">Â¥3,000</span>
                        </label>
                    </div>
                </div>
                
                <!-- èª°ãŒé£²ã‚€ã‹é¸æŠ -->
                <div id="drinkForSectionOrder">
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <label class="drink-for-order-label flex flex-col items-center justify-center p-3 rounded-xl bg-black/20 border-2 border-blue-500 bg-blue-500/20 cursor-pointer">
                            <input type="radio" name="drinkForOrder" value="customer" checked onchange="onDrinkForOrderChange(); updateDrinkForOrderStyle()" class="hidden">
                            <span class="text-white text-sm">ãŠå®¢æ§˜</span>
                        </label>
                        <label class="drink-for-order-label flex flex-col items-center justify-center p-3 rounded-xl bg-black/20 border border-white/10 cursor-pointer">
                            <input type="radio" name="drinkForOrder" value="staff" onchange="onDrinkForOrderChange(); updateDrinkForOrderStyle()" class="hidden">
                            <span class="text-white text-sm">ã‚¹ã‚¿ãƒƒãƒ•</span>
                        </label>
                        <label class="drink-for-order-label flex flex-col items-center justify-center p-2 sm:p-3 rounded-xl bg-black/20 border border-white/10 cursor-pointer">
                            <input type="radio" name="drinkForOrder" value="cast" onchange="onDrinkForOrderChange(); updateDrinkForOrderStyle()" class="hidden">
                            <span class="text-white text-xs sm:text-sm">ã‚­ãƒ£ã‚¹ãƒˆ</span>
                        </label>
                    </div>
                    
                    <!-- ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ -->
                    <div id="personSelectSectionOrder" class="hidden">
                        <select id="selDrinkPersonOrder" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200 text-base">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                        <div id="drinkBackInfoOrder" class="mt-2 text-sm text-purple-400 hidden">
                            
                        </div>
                    </div>
                </div>
                
                <!-- æ•°é‡ -->
                <div>
                    <div class="text-sm text-gray-400 mb-2">æ•°é‡</div>
                    <div class="flex items-center justify-center gap-3 sm:gap-4">
                        <button onclick="changeDrinkQty(-1)" class="w-12 h-12 sm:w-14 sm:h-14 rounded-xl bg-gray-700 text-xl sm:text-2xl font-bold text-white active:bg-gray-600">âˆ’</button>
                        <span id="drinkModalQty" class="text-3xl sm:text-4xl font-bold text-white w-14 sm:w-16 text-center">1</span>
                        <button onclick="changeDrinkQty(1)" class="w-12 h-12 sm:w-14 sm:h-14 rounded-xl bg-gray-700 text-xl sm:text-2xl font-bold text-white active:bg-gray-600">+</button>
                    </div>
                </div>
                
                <!-- è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <button onclick="confirmDrinkOrder()" class="w-full luxury-btn py-3 sm:py-4 rounded-xl text-base sm:text-lg font-bold">
                    ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
                </button>
            </div>
        </div>
    </div>
    
    <!-- ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="iceSetModal" class="fixed inset-0 z-50 items-center justify-center bg-black/80 p-2 sm:p-4 hidden">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl">
            <div class="border-b border-gray-700 px-4 sm:px-6 py-4 sm:py-5 flex items-center justify-between">
                <h2 class="text-lg sm:text-xl font-bold gold-accent">ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆ</h2>
                <button onclick="closeIceSetModal()" class="text-gray-400 hover:text-gray-200 text-2xl p-2">âœ•</button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                <p class="text-gray-400 text-sm text-center">ã‚°ãƒ©ã‚¹ãƒ»ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«ãƒ»æ°·ã‚’ã‚»ãƒƒãƒˆã§ãŠå±Šã‘ã—ã¾ã™</p>
                
                <!-- ã‚°ãƒ©ã‚¹å€‹æ•° -->
                <div>
                    <div class="text-sm text-gray-400 mb-2">ã‚°ãƒ©ã‚¹æ•°</div>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="adjustIceSetQty('glass', -1)" class="w-12 h-12 rounded-full bg-gray-700 text-white text-2xl font-bold hover:bg-gray-600">-</button>
                        <span id="iceSetGlassQty" class="text-3xl font-bold text-white w-16 text-center">2</span>
                        <button onclick="adjustIceSetQty('glass', 1)" class="w-12 h-12 rounded-full bg-gray-700 text-white text-2xl font-bold hover:bg-gray-600">+</button>
                    </div>
                </div>
                
                <!-- ã‚¢ã‚¤ã‚¹å€‹æ•° -->
                <div>
                    <div class="text-sm text-gray-400 mb-2">ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«æ•°</div>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="adjustIceSetQty('ice', -1)" class="w-12 h-12 rounded-full bg-gray-700 text-white text-2xl font-bold hover:bg-gray-600">-</button>
                        <span id="iceSetIceQty" class="text-3xl font-bold text-white w-16 text-center">1</span>
                        <button onclick="adjustIceSetQty('ice', 1)" class="w-12 h-12 rounded-full bg-gray-700 text-white text-2xl font-bold hover:bg-gray-600">+</button>
                    </div>
                </div>
                
                <!-- è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <button onclick="confirmIceSet()" class="w-full luxury-btn py-3 sm:py-4 rounded-xl text-base sm:text-lg font-bold">
                    ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
                </button>
            </div>
        </div>
    </div>
    
    <!-- å ´å†…æŒ‡åãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="nominationModal" class="fixed inset-0 z-50 items-center justify-center bg-black/80 p-2 sm:p-4 hidden">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="border-b border-gray-700 px-4 sm:px-6 py-4 sm:py-5 flex items-center justify-between sticky top-0 bg-gray-900/95 backdrop-blur">
                <h2 class="text-lg sm:text-xl font-bold gold-accent">å ´å†…æŒ‡å</h2>
                <button onclick="closeNominationModal()" class="text-gray-400 hover:text-gray-200 text-2xl p-2">âœ•</button>
            </div>
            <div class="p-4 sm:p-6 space-y-4">
                <p class="text-gray-400 text-sm text-center">æŒ‡åã™ã‚‹ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <p class="text-center gold-accent font-bold text-lg">å ´å†…æŒ‡åæ–™ï¼šÂ¥2,000</p>
                
                <!-- ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ -->
                <div id="nominationCastList" class="space-y-3">
                    <!-- ã‚­ãƒ£ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ãƒ‰ãƒªãƒ³ã‚¯æ³¨æ–‡ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®çŠ¶æ…‹
        let drinkModalState = {
            itemId: null,
            item: null,
            quantity: 1,
            isDrinkCategory: false
        };
        
        // ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆç”¨ã®çŠ¶æ…‹
        let iceSetState = {
            glassQty: 2,
            iceQty: 1
        };
        
        // ã‚­ãƒ£ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿
        let staffList = [];
        let castList = [];
        
        // å ´å†…æŒ‡åæ–™
        const NOMINATION_FEE = 2000;
        
        // å ´å†…æŒ‡åãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showNominationModal() {
            if (!appState.selectedTable || !appState.sessionId) {
                alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const modal = document.getElementById('nominationModal');
            const listContainer = document.getElementById('nominationCastList');
            
            // æœ‰åŠ¹ãªã‚­ãƒ£ã‚¹ãƒˆã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
            const validCasts = castList.filter(c => c && c.stage_name);
            console.log('[order] å ´å†…æŒ‡åãƒ¢ãƒ¼ãƒ€ãƒ« - ã‚­ãƒ£ã‚¹ãƒˆ:', validCasts);
            
            // ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
            if (validCasts.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500">ã‚­ãƒ£ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            } else {
                listContainer.innerHTML = validCasts.map(cast => {
                    const name = cast.stage_name || 'åå‰ãªã—';
                    const escapedName = name.replace(/'/g, "\\'");
                    return `
                    <div class="flex items-center justify-between bg-gray-800/50 rounded-xl p-4 border border-gray-700 hover:border-amber-500 transition cursor-pointer"
                         onclick="confirmNomination(${cast.id}, '${escapedName}')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-500 to-yellow-600 flex items-center justify-center text-black font-bold text-lg">
                                ${name.charAt(0)}
                            </div>
                            <div>
                                <p class="font-bold text-white">${name}</p>
                                <p class="text-sm text-gray-400">${cast.rank || 'ã‚­ãƒ£ã‚¹ãƒˆ'}</p>
                            </div>
                        </div>
                        <button class="px-4 py-2 bg-gradient-to-r from-amber-500 to-yellow-600 rounded-lg text-black font-bold text-sm">
                            æŒ‡åã™ã‚‹
                        </button>
                    </div>
                `}).join('');
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        // å ´å†…æŒ‡åãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeNominationModal() {
            const modal = document.getElementById('nominationModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        // å ´å†…æŒ‡åã‚’ç¢ºå®š
        // å ´å†…æŒ‡åã‚’ç¢ºå®š
        let nominationProcessing = false;
        async function confirmNomination(castId, castName) {
            if (!appState.sessionId) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // é€£æ‰“é˜²æ­¢
            if (nominationProcessing) return;
            
            if (!confirm(`${castName}ã•ã‚“ã‚’å ´å†…æŒ‡åã—ã¾ã™ã‹ï¼Ÿ\næŒ‡åæ–™ï¼šÂ¥${NOMINATION_FEE.toLocaleString()}`)) {
                return;
            }
            
            nominationProcessing = true;
            
            try {
                // å ´å†…æŒ‡åæ–™ã‚’æ³¨æ–‡ã¨ã—ã¦è¿½åŠ 
                const res = await apiRequest(`${API_BASE}/sessions/${appState.sessionId}/add-charge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_name: `å ´å†…æŒ‡åæ–™ï¼ˆ${castName}ï¼‰`,
                        price: NOMINATION_FEE,
                        quantity: 1
                    })
                });
                
                if (res.ok) {
                    showNotification(`${castName}ã•ã‚“ã‚’å ´å†…æŒ‡åã—ã¾ã—ãŸï¼`, 'success');
                    closeNominationModal();
                    // å±¥æ­´ã‚’æ›´æ–°
                    if (typeof loadOrderHistory === 'function') {
                        loadOrderHistory(appState.sessionId);
                    }
                } else {
                    const error = await res.json();
                    alert('æŒ‡åã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.detail || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (e) {
                console.error('å ´å†…æŒ‡åã‚¨ãƒ©ãƒ¼:', e);
                alert('æŒ‡åã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                nominationProcessing = false;
            }
        }
        
        // ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’å–å¾—
        async function loadCastsForOrder() {
            try {
                const res = await apiRequest(`${API_BASE}/casts`);
                if (res.ok) {
                    castList = await res.json();
                    console.log('[order] ã‚­ãƒ£ã‚¹ãƒˆå–å¾—:', castList.length, 'ä»¶');
                }
            } catch (e) {
                console.warn('ã‚­ãƒ£ã‚¹ãƒˆå–å¾—å¤±æ•—:', e);
            }
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã‚’å–å¾—
        async function loadStaffForOrder() {
            try {
                const res = await apiRequest(`${API_BASE}/staff`);
                if (res.ok) {
                    staffList = await res.json();
                    console.log('[order] ã‚¹ã‚¿ãƒƒãƒ•å–å¾—:', staffList.length, 'ä»¶');
                }
            } catch (e) {
                console.warn('ã‚¹ã‚¿ãƒƒãƒ•å–å¾—å¤±æ•—:', e);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorageã‹ã‚‰å–å¾—
                staffList = JSON.parse(localStorage.getItem('cabax_staff') || '[]');
            }
        }
        
        // åˆæœŸåŒ–æ™‚ã«ä¸¡æ–¹èª­ã¿è¾¼ã‚€
        loadCastsForOrder();
        loadStaffForOrder();
        
        // å‰²ã‚Šæ–¹ãƒ»ç¨®é¡ã®å®šç¾©
        // ãƒ‰ãƒªãƒ³ã‚¯ã‚¿ãƒ–ç”¨ï¼ˆãŠå®¢æ§˜ç”¨ï¼‰
        const mixStyles = {
            'ãƒ“ãƒ¼ãƒ«': ['ç”Ÿãƒ“ãƒ¼ãƒ«', 'ã‚¢ã‚¤ã‚¹ãƒ“ãƒ¼ãƒ«', 'ã‚·ãƒ£ãƒ³ãƒ‡ã‚£ã‚¬ãƒ•', 'ãƒ¬ãƒƒãƒ‰ã‚¢ã‚¤'],
            'ã‚«ã‚¯ãƒ†ãƒ«': ['ã‚«ã‚·ã‚¹ã‚ªãƒ¬ãƒ³ã‚¸', 'ã‚«ã‚·ã‚¹ã‚½ãƒ¼ãƒ€', 'ã‚«ã‚·ã‚¹ã‚¦ãƒ¼ãƒ­ãƒ³', 'ãƒ”ãƒ¼ãƒã‚ªãƒ¬ãƒ³ã‚¸', 'ãƒ”ãƒ¼ãƒã‚¦ãƒ¼ãƒ­ãƒ³', 'ãƒ•ã‚¡ã‚¸ãƒ¼ãƒãƒ¼ãƒ–ãƒ«', 'ã‚«ãƒ«ãƒ¼ã‚¢ãƒŸãƒ«ã‚¯'],
            'ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯': ['ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶', 'ç·‘èŒ¶', 'ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹', 'ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¸ãƒ¥ãƒ¼ã‚¹', 'ã‚³ãƒ¼ãƒ©', 'ã‚¸ãƒ³ã‚¸ãƒ£ã‚¨ãƒ¼ãƒ«', 'ç‚­é…¸æ°´', 'ã‚«ãƒ«ãƒ”ã‚¹', 'ã‚«ãƒ«ãƒ”ã‚¹ã‚½ãƒ¼ãƒ€'],
            'ã‚·ãƒ§ãƒƒãƒˆ': ['ãƒ†ã‚­ãƒ¼ãƒ©', 'ã‚¤ã‚§ãƒ¼ã‚¬ãƒ¼', 'ã‚³ã‚«ãƒ¬ãƒ­', 'ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼'],
            'ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³': ['ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼ˆèµ¤ï¼‰', 'ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼ˆç™½ï¼‰', 'ã‚­ãƒ†ã‚£', 'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼']
        };
        
        // ã‚­ãƒ£ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ç”¨ï¼ˆãƒãƒƒã‚¯è¨˜éŒ²ç”¨ï¼‰
        const castDrinkMixStyles = {
            'éº¦ç„¼é…': ['ãƒ­ãƒƒã‚¯', 'æ°´å‰²ã‚Š', 'ã‚½ãƒ¼ãƒ€å‰²ã‚Š', 'ç·‘èŒ¶å‰²ã‚Š', 'ç´…èŒ¶å‰²ã‚Š', 'ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶å‰²ã‚Š', 'ã‚¸ãƒ£ã‚¹ãƒŸãƒ³å‰²ã‚Š', 'ã‚³ãƒ¼ãƒ’ãƒ¼å‰²ã‚Š', 'ãŠæ¹¯å‰²ã‚Š', 'ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼'],
            'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼': ['ãƒ­ãƒƒã‚¯', 'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ', 'æ°´å‰²ã‚Š', 'ãƒã‚¤ãƒœãƒ¼ãƒ«', 'ã‚³ãƒ¼ã‚¯å‰²ã‚Š', 'ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼å‰²ã‚Š']
        };
        
        // æœ‰æ–™ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆãŠå®¢æ§˜ã‚‚ã‚»ãƒƒãƒˆè¾¼ã¿ã§ã¯ãªãèª²é‡‘ï¼‰
        const paidDrinks = ['ã‚·ãƒ§ãƒƒãƒˆ', 'ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³'];
        
        // ã‚­ãƒ£ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•å°‚ç”¨ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆãŠå®¢æ§˜é¸æŠãªã—ï¼‰
        const castOnlyDrinks = ['éº¦ç„¼é…', 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼'];
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openDrinkModal(itemId) {
            const item = appState.menuItems.find(m => m.id === itemId);
            if (!item) return;
            
            const category = (item.category || '').toLowerCase();
            const isCastDrink = category === 'castdrink';
            const isTableSet = category === 'tableset';
            const isDrinkCategory = ['drink', 'castdrink', 'bottle', 'champagne', 'wine'].includes(category);
            const isDrinkOnly = ['drink', 'castdrink'].includes(category);
            
            // å‰²ã‚Šæ–¹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆé€šå¸¸ãƒ‰ãƒªãƒ³ã‚¯ or ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒªãƒ³ã‚¯ï¼‰
            const hasMixStyle = isCastDrink 
                ? castDrinkMixStyles[item.name] !== undefined 
                : mixStyles[item.name] !== undefined;
            const currentMixStyles = isCastDrink ? castDrinkMixStyles : mixStyles;
            
            // å“ã‚»ãƒƒãƒˆã®å ´åˆ
            if (isTableSet) {
                if (item.name === 'ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆ') {
                    // ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆã¯å€‹æ•°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                    openIceSetModal(itemId);
                } else {
                    // ä»–ã®å“ã‚»ãƒƒãƒˆã¯ç›´æ¥ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
                    addToCart(itemId);
                }
                return;
            }
            
            // ãƒ‰ãƒªãƒ³ã‚¯ç³»ã§ãªã„å ´åˆã¯ç›´æ¥ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
            if (!isDrinkCategory) {
                addToCart(itemId);
                return;
            }
            
            drinkModalState = {
                itemId: itemId,
                item: item,
                quantity: 1,
                isDrinkCategory: isDrinkCategory,
                isDrinkOnly: isDrinkOnly,
                isCastDrink: isCastDrink,
                hasMixStyle: hasMixStyle,
                selectedMixStyle: null
            };
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            document.getElementById('drinkModalItemId').value = itemId;
            document.getElementById('drinkModalTitle').textContent = isCastDrink ? 'ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯' : (isDrinkOnly ? 'ãƒ‰ãƒªãƒ³ã‚¯æ³¨æ–‡' : item.category + 'æ³¨æ–‡');
            document.getElementById('drinkModalItemName').textContent = item.name;
            document.getElementById('drinkModalQty').textContent = '1';
            
            // å‰²ã‚Šæ–¹é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const mixStyleSection = document.getElementById('mixStyleSectionOrder');
            const mixStyleOptions = document.getElementById('mixStyleOptionsOrder');
            
            if (hasMixStyle) {
                mixStyleSection.classList.remove('hidden');
                const styles = currentMixStyles[item.name];
                mixStyleOptions.innerHTML = styles.map((style, index) => `
                    <label class="mix-style-label flex items-center justify-center p-3 rounded-xl bg-black/20 ${index === 0 ? 'border-2 border-amber-500 bg-amber-500/20' : 'border border-white/10'} cursor-pointer">
                        <input type="radio" name="mixStyleOrder" value="${style}" ${index === 0 ? 'checked' : ''} onchange="updateMixStyleOrderStyle()" class="hidden">
                        <span class="text-white font-semibold text-sm">${style}</span>
                    </label>
                `).join('');
                drinkModalState.selectedMixStyle = styles[0];
            } else {
                mixStyleSection.classList.add('hidden');
                mixStyleOptions.innerHTML = '';
            }
            
            // èª°ãŒé£²ã‚€ã‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const drinkForSection = document.getElementById('drinkForSectionOrder');
            const customerLabel = document.querySelector('.drink-for-order-label input[value="customer"]')?.parentElement;
            
            if (isCastDrink) {
                // ã‚­ãƒ£ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ã¯ãŠå®¢æ§˜é¸æŠãªã—
                if (customerLabel) customerLabel.classList.add('hidden');
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ
                document.querySelector('input[name="drinkForOrder"][value="cast"]').checked = true;
                updateDrinkForOrderStyle();
                // ã‚µã‚¤ã‚ºé¸æŠã‚’è¡¨ç¤º
                document.getElementById('drinkSizeSectionOrder').classList.remove('hidden');
                document.querySelector('input[name="drinkSizeOrder"][value="single"]').checked = true;
                updateDrinkSizeOrderStyle();
                updateDrinkModalPrice();
                // äººç‰©é¸æŠã‚’è¡¨ç¤º
                onDrinkForOrderChange();
            } else {
                // é€šå¸¸ãƒ‰ãƒªãƒ³ã‚¯ã¯ãŠå®¢æ§˜é¸æŠã‚ã‚Š
                if (customerLabel) customerLabel.classList.remove('hidden');
                document.querySelector('input[name="drinkForOrder"][value="customer"]').checked = true;
                updateDrinkForOrderStyle();
                // ã‚µã‚¤ã‚ºé¸æŠã¯éè¡¨ç¤ºï¼ˆãŠå®¢æ§˜ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                document.getElementById('drinkSizeSectionOrder').classList.add('hidden');
                document.getElementById('personSelectSectionOrder').classList.add('hidden');
                document.getElementById('drinkBackInfoOrder').classList.add('hidden');
            }
            
            // åˆæœŸä¾¡æ ¼è¨­å®š
            const isPaidDrink = paidDrinks.includes(item.name);
            const isBottleOrChampagne = ['bottle', 'champagne', 'wine'].includes(category);
            
            if (isPaidDrink || isBottleOrChampagne) {
                // ã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ãƒ»ãƒœãƒˆãƒ«ãƒ»ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒ»ãƒ¯ã‚¤ãƒ³ã¯ä¾¡æ ¼è¡¨ç¤º
                document.getElementById('drinkModalItemPrice').textContent = 'Â¥' + item.price.toLocaleString();
            } else if (isCastDrink) {
                // ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒªãƒ³ã‚¯ã¯ã‚µã‚¤ã‚ºåˆ¥ä¾¡æ ¼
                updateDrinkModalPrice();
            } else {
                // ãŠå®¢æ§˜ã®ãƒ‰ãƒªãƒ³ã‚¯ã¯ã‚»ãƒƒãƒˆæ–™é‡‘è¾¼ã¿
                document.getElementById('drinkModalItemPrice').textContent = 'ã‚»ãƒƒãƒˆæ–™é‡‘è¾¼';
            }
            
            document.getElementById('drinkOrderModal').classList.remove('hidden');
            document.getElementById('drinkOrderModal').classList.add('flex');
        }
        
        function updateMixStyleOrderStyle() {
            document.querySelectorAll('.mix-style-label').forEach(label => {
                const input = label.querySelector('input');
                if (input?.checked) {
                    label.classList.remove('border', 'border-white/10');
                    label.classList.add('border-2', 'border-amber-500', 'bg-amber-500/20');
                    drinkModalState.selectedMixStyle = input.value;
                } else {
                    label.classList.remove('border-2', 'border-amber-500', 'bg-amber-500/20');
                    label.classList.add('border', 'border-white/10');
                }
            });
        }
        
        function closeDrinkModal() {
            document.getElementById('drinkOrderModal').classList.add('hidden');
            document.getElementById('drinkOrderModal').classList.remove('flex');
        }
        
        // ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function openIceSetModal(itemId) {
            iceSetState.glassQty = 2;
            iceSetState.iceQty = 1;
            document.getElementById('iceSetGlassQty').textContent = iceSetState.glassQty;
            document.getElementById('iceSetIceQty').textContent = iceSetState.iceQty;
            document.getElementById('iceSetModal').classList.remove('hidden');
            document.getElementById('iceSetModal').classList.add('flex');
        }
        
        function closeIceSetModal() {
            document.getElementById('iceSetModal').classList.add('hidden');
            document.getElementById('iceSetModal').classList.remove('flex');
        }
        
        function adjustIceSetQty(type, delta) {
            if (type === 'glass') {
                iceSetState.glassQty = Math.max(1, iceSetState.glassQty + delta);
                document.getElementById('iceSetGlassQty').textContent = iceSetState.glassQty;
            } else if (type === 'ice') {
                iceSetState.iceQty = Math.max(1, iceSetState.iceQty + delta);
                document.getElementById('iceSetIceQty').textContent = iceSetState.iceQty;
            }
        }
        
        function confirmIceSet() {
            // ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ï¼ˆã‚°ãƒ©ã‚¹æ•°ãƒ»ã‚¢ã‚¤ã‚¹æ•°ã‚’åå‰ã«å«ã‚ã‚‹ï¼‰
            const glassItem = appState.menuItems.find(m => m.name === 'ã‚°ãƒ©ã‚¹ï¼ˆè¿½åŠ ï¼‰');
            const iceItem = appState.menuItems.find(m => m.name === 'ã‚¢ã‚¤ã‚¹ï¼ˆè¿½åŠ ï¼‰');
            
            // ã‚°ãƒ©ã‚¹ã‚’è¿½åŠ 
            if (glassItem && iceSetState.glassQty > 0) {
                const existingGlass = appState.cart.find(c => c.id === glassItem.id);
                if (existingGlass) {
                    existingGlass.quantity += iceSetState.glassQty;
                } else {
                    appState.cart.push({
                        id: glassItem.id,
                        name: glassItem.name,
                        price: glassItem.price,
                        quantity: iceSetState.glassQty,
                        category: glassItem.category
                    });
                }
            }
            
            // ã‚¢ã‚¤ã‚¹ã‚’è¿½åŠ 
            if (iceItem && iceSetState.iceQty > 0) {
                const existingIce = appState.cart.find(c => c.id === iceItem.id);
                if (existingIce) {
                    existingIce.quantity += iceSetState.iceQty;
                } else {
                    appState.cart.push({
                        id: iceItem.id,
                        name: iceItem.name,
                        price: iceItem.price,
                        quantity: iceSetState.iceQty,
                        category: iceItem.category
                    });
                }
            }
            
            renderCart();
            closeIceSetModal();
            showNotification(`ã‚¢ã‚¤ã‚¹ã‚»ãƒƒãƒˆï¼ˆã‚°ãƒ©ã‚¹${iceSetState.glassQty}å€‹ãƒ»ã‚¢ã‚¤ã‚¹${iceSetState.iceQty}å€‹ï¼‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }
        
        function changeDrinkQty(delta) {
            drinkModalState.quantity = Math.max(1, drinkModalState.quantity + delta);
            document.getElementById('drinkModalQty').textContent = drinkModalState.quantity;
        }
        
        function updateDrinkModalPrice() {
            if (drinkModalState.isDrinkOnly) {
                const size = document.querySelector('input[name="drinkSizeOrder"]:checked')?.value || 'single';
                const prices = { single: 1000, double: 2000, triple: 3000 };
                document.getElementById('drinkModalItemPrice').textContent = 'Â¥' + prices[size].toLocaleString();
            }
        }
        
        function updateDrinkSizeOrderStyle() {
            document.querySelectorAll('.drink-size-order-label').forEach(label => {
                const input = label.querySelector('input');
                if (input?.checked) {
                    label.classList.remove('border', 'border-white/10');
                    label.classList.add('border-2', 'border-amber-500', 'bg-amber-500/20');
                } else {
                    label.classList.remove('border-2', 'border-amber-500', 'bg-amber-500/20');
                    label.classList.add('border', 'border-white/10');
                }
            });
        }
        
        function updateDrinkForOrderStyle() {
            const colors = {
                'customer': { border: 'border-blue-500', bg: 'bg-blue-500/20' },
                'staff': { border: 'border-green-500', bg: 'bg-green-500/20' },
                'cast': { border: 'border-purple-500', bg: 'bg-purple-500/20' }
            };
            
            document.querySelectorAll('.drink-for-order-label').forEach(label => {
                const input = label.querySelector('input');
                const value = input?.value;
                const color = colors[value] || colors['customer'];
                
                label.classList.remove('border-2', 'border-blue-500', 'border-green-500', 'border-purple-500', 
                                       'bg-blue-500/20', 'bg-green-500/20', 'bg-purple-500/20');
                
                if (input?.checked) {
                    label.classList.remove('border', 'border-white/10');
                    label.classList.add('border-2', color.border, color.bg);
                } else {
                    label.classList.add('border', 'border-white/10');
                }
            });
        }
        
        function onDrinkForOrderChange() {
            const drinkFor = document.querySelector('input[name="drinkForOrder"]:checked')?.value || 'customer';
            const personSection = document.getElementById('personSelectSectionOrder');
            const personSelect = document.getElementById('selDrinkPersonOrder');
            const drinkBackInfo = document.getElementById('drinkBackInfoOrder');
            const sizeSection = document.getElementById('drinkSizeSectionOrder');
            
            // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ å–å¾—
            const item = appState.menuItems.find(m => m.id === drinkModalState.itemId);
            const isPaidDrink = item && paidDrinks.includes(item.name);
            const category = (item?.category || '').toLowerCase();
            const isBottleOrChampagne = ['bottle', 'champagne', 'wine'].includes(category);
            
            if (drinkFor === 'customer') {
                // ãŠå®¢æ§˜ï¼šäººç‰©é¸æŠä¸è¦
                personSection.classList.add('hidden');
                drinkBackInfo.classList.add('hidden');
                sizeSection.classList.add('hidden');
                
                if (isPaidDrink || isBottleOrChampagne) {
                    // ã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ãƒ»ãƒœãƒˆãƒ«ãƒ»ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒ»ãƒ¯ã‚¤ãƒ³ã¯ä¾¡æ ¼è¡¨ç¤º
                    document.getElementById('drinkModalItemPrice').textContent = 'Â¥' + item.price.toLocaleString();
                } else {
                    // ä»–ã®ãƒ‰ãƒªãƒ³ã‚¯ã¯ã‚»ãƒƒãƒˆæ–™é‡‘è¾¼ã¿
                    document.getElementById('drinkModalItemPrice').textContent = 'ã‚»ãƒƒãƒˆæ–™é‡‘è¾¼';
                }
            } else {
                // ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•ï¼šäººç‰©é¸æŠå¿…è¦
                personSection.classList.remove('hidden');
                
                if (isPaidDrink) {
                    // ã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ã¯ã‚µã‚¤ã‚ºé¸æŠãªã—ã€çµ±ä¸€ä¾¡æ ¼
                    sizeSection.classList.add('hidden');
                    document.getElementById('drinkModalItemPrice').textContent = 'Â¥' + item.price.toLocaleString();
                } else if (drinkModalState.isDrinkOnly) {
                    // ä»–ã®ãƒ‰ãƒªãƒ³ã‚¯ã¯ã‚µã‚¤ã‚ºé¸æŠã‚ã‚Š
                    sizeSection.classList.remove('hidden');
                    updateDrinkModalPrice();
                }
                
                let options = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                
                if (drinkFor === 'cast') {
                    castList.forEach(c => {
                        const name = c.stage_name || c.name || `Cast#${c.id}`;
                        options += `<option value="${name}">${name}</option>`;
                    });
                    drinkBackInfo.classList.remove('hidden');
                } else if (drinkFor === 'staff') {
                    staffList.forEach(s => {
                        const roleLabels = { waiter: 'ãƒœãƒ¼ã‚¤', kitchen: 'ã‚­ãƒƒãƒãƒ³', manager: 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', catch: 'ã‚­ãƒ£ãƒƒãƒ', driver: 'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼', other: 'ãã®ä»–' };
                        options += `<option value="${s.name}">${s.name}ï¼ˆ${roleLabels[s.role] || s.role}ï¼‰</option>`;
                    });
                    drinkBackInfo.classList.add('hidden');
                }
                
                personSelect.innerHTML = options;
            }
        }
        
        function confirmDrinkOrder() {
            const item = drinkModalState.item;
            if (!item) return;
            
            // å‰²ã‚Šæ–¹ãŒå¿…è¦ãªå ´åˆã€é¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (drinkModalState.hasMixStyle) {
                const mixStyle = document.querySelector('input[name="mixStyleOrder"]:checked')?.value;
                if (!mixStyle) {
                    showNotification('å‰²ã‚Šæ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                drinkModalState.selectedMixStyle = mixStyle;
            }
            
            const drinkFor = document.querySelector('input[name="drinkForOrder"]:checked')?.value || 'customer';
            let personName = null;
            let isDrinkBack = false;
            
            if (drinkFor === 'cast' || drinkFor === 'staff') {
                personName = document.getElementById('selDrinkPersonOrder')?.value;
                if (!personName) {
                    showNotification('ã‚­ãƒ£ã‚¹ãƒˆã¾ãŸã¯ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                isDrinkBack = (drinkFor === 'cast');
            }
            
            // ä¾¡æ ¼æ±ºå®š
            let finalPrice = 0;
            let itemNameSuffix = '';
            
            // å‰²ã‚Šæ–¹ãŒã‚ã‚‹å ´åˆã¯åå‰ã«è¿½åŠ 
            if (drinkModalState.hasMixStyle && drinkModalState.selectedMixStyle) {
                itemNameSuffix = 'ï¼ˆ' + drinkModalState.selectedMixStyle + 'ï¼‰';
            }
            
            // æœ‰æ–™ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼‰ã¯ãŠå®¢æ§˜ã§ã‚‚èª²é‡‘
            const isPaidDrink = paidDrinks.includes(item.name);
            const category = (item.category || '').toLowerCase();
            const isBottleOrChampagne = ['bottle', 'champagne', 'wine'].includes(category);
            
            if (isPaidDrink || isBottleOrChampagne) {
                // ã‚·ãƒ§ãƒƒãƒˆãƒ»ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ãƒ»ãƒœãƒˆãƒ«ãƒ»ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒ»ãƒ¯ã‚¤ãƒ³ã¯èª°ãŒé£²ã‚“ã§ã‚‚çµ±ä¸€ä¾¡æ ¼
                finalPrice = item.price;
            } else if (drinkFor === 'customer') {
                // ãŠå®¢æ§˜ã®é€šå¸¸ãƒ‰ãƒªãƒ³ã‚¯ã¯ã‚»ãƒƒãƒˆæ–™é‡‘è¾¼ã¿ â†’ 0å††
                finalPrice = 0;
            } else if (drinkModalState.isDrinkOnly) {
                // ã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•ã®ãƒ‰ãƒªãƒ³ã‚¯ã¯ã‚µã‚¤ã‚ºã§ä¾¡æ ¼æ±ºå®š
                const size = document.querySelector('input[name="drinkSizeOrder"]:checked')?.value || 'single';
                const prices = { single: 1000, double: 2000, triple: 3000 };
                finalPrice = prices[size];
                const sizeLabel = size === 'single' ? 'ã‚·ãƒ³ã‚°ãƒ«' : size === 'double' ? 'ãƒ€ãƒ–ãƒ«' : 'ãƒˆãƒªãƒ—ãƒ«';
                // å‰²ã‚Šæ–¹ãŒã‚ã‚‹å ´åˆã¯ã€Œéº¦ç„¼é…ï¼ˆãƒ­ãƒƒã‚¯ãƒ»ã‚·ãƒ³ã‚°ãƒ«ï¼‰ã€ã®ã‚ˆã†ã«è¡¨ç¤º
                if (drinkModalState.hasMixStyle) {
                    itemNameSuffix = 'ï¼ˆ' + drinkModalState.selectedMixStyle + 'ãƒ»' + sizeLabel + 'ï¼‰';
                } else {
                    itemNameSuffix = 'ï¼ˆ' + sizeLabel + 'ï¼‰';
                }
            } else {
                // ãƒœãƒˆãƒ«ã€ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ç­‰ã¯ãã®ã¾ã¾ã®ä¾¡æ ¼
                finalPrice = item.price;
            }
            
            // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
            const cartItem = {
                id: item.id,
                name: item.name + itemNameSuffix,
                originalName: item.name,
                price: finalPrice,
                quantity: drinkModalState.quantity,
                category: item.category,
                drinkFor: drinkFor,
                personName: personName,
                isDrinkBack: isDrinkBack,
                mixStyle: drinkModalState.selectedMixStyle || null
            };
            
            // åŒã˜è¨­å®šã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Œã°æ•°é‡è¿½åŠ 
            const existingIndex = appState.cart.findIndex(c => 
                c.id === cartItem.id && 
                c.name === cartItem.name && 
                c.drinkFor === cartItem.drinkFor && 
                c.personName === cartItem.personName
            );
            
            if (existingIndex >= 0) {
                appState.cart[existingIndex].quantity += cartItem.quantity;
            } else {
                appState.cart.push(cartItem);
            }
            
            renderCart();
            closeDrinkModal();
            
            let msg = `${cartItem.name} ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`;
            if (personName) {
                msg += `ï¼ˆ${personName}ï¼‰`;
            }
            showNotification(msg, 'success');
        }
        
        // â˜… ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const pin = document.getElementById('loginPin').value.trim();
            
            if (!username || !pin) {
                document.getElementById('loginError').textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                document.getElementById('loginError').classList.remove('hidden');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password: pin })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    
                    // ãƒˆãƒ¼ã‚¯ãƒ³ã¨store_idã‚’ä¿å­˜
                    localStorage.setItem('cabax_token', data.access_token);
                    sessionStorage.setItem('cabax_store_id', data.store_id);
                    sessionStorage.setItem('cabax_store_name', data.store_name || username);
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’éš ã—ã¦ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainAppContent').classList.remove('hidden');
                    
                    // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
                    init();
                } else {
                    document.getElementById('loginError').textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯PINãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Login error:', e);
                document.getElementById('loginError').textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }
        
        // â˜… åˆæœŸåŒ–æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        function checkLoginState() {
            const storeId = getStoreId();
            const token = localStorage.getItem('cabax_token');
            
            if (storeId && token) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainAppContent').classList.remove('hidden');
                init();
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainAppContent').classList.add('hidden');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        document.addEventListener('DOMContentLoaded', checkLoginState);
    </script>
    </div><!-- mainAppContent -->
</body>
</html>